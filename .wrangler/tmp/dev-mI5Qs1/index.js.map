{
  "version": 3,
  "sources": ["../../../workers/auth.ts", "../../../workers/cache.ts", "../../../workers/hubspot-service.ts", "../../../workers/outbound-webhooks.ts", "../../../workers/outbound-webhooks-api.ts", "../../../workers/salesforce-service.ts", "../../../workers/dynamics-service.ts", "../../../workers/index.ts", "../../../../../../.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../../../../.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-0Xm69E/middleware-insertion-facade.js", "../../../../../../.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/common.ts", "../bundle-0Xm69E/middleware-loader.entry.ts"],
  "sourceRoot": "/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/.wrangler/tmp/dev-mI5Qs1",
  "sourcesContent": ["// Authentication utilities for Cloudflare Workers\n\n/**\n * Generate a random ID\n */\nexport function generateId(): string {\n  return crypto.randomUUID();\n}\n\n/**\n * Hash a password using SHA-256\n */\nexport async function hashPassword(password: string): Promise<string> {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(password);\n  const hash = await crypto.subtle.digest('SHA-256', data);\n  return Array.from(new Uint8Array(hash))\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n}\n\n/**\n * Verify a password against a hash\n */\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\n  const passwordHash = await hashPassword(password);\n  return passwordHash === hash;\n}\n\n/**\n * Generate a JWT token (simplified - no external libraries)\n * Format: header.payload.signature (base64url encoded)\n */\nexport async function generateToken(userId: string, secret: string): Promise<string> {\n  const header = {\n    alg: 'HS256',\n    typ: 'JWT'\n  };\n\n  const payload = {\n    userId,\n    iat: Math.floor(Date.now() / 1000),\n    exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60) // 7 days\n  };\n\n  const encodedHeader = btoa(JSON.stringify(header));\n  const encodedPayload = btoa(JSON.stringify(payload));\n  const data = `${encodedHeader}.${encodedPayload}`;\n\n  // Sign with HMAC SHA-256\n  const encoder = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    encoder.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n\n  const signature = await crypto.subtle.sign(\n    'HMAC',\n    key,\n    encoder.encode(data)\n  );\n\n  const encodedSignature = btoa(String.fromCharCode(...new Uint8Array(signature)));\n  return `${data}.${encodedSignature}`;\n}\n\n/**\n * Verify and decode a JWT token\n */\nexport async function verifyToken(token: string, secret: string): Promise<{ userId: string } | null> {\n  try {\n    const parts = token.split('.');\n    if (parts.length !== 3) return null;\n\n    const [encodedHeader, encodedPayload, encodedSignature] = parts;\n    const data = `${encodedHeader}.${encodedPayload}`;\n\n    // Verify signature\n    const encoder = new TextEncoder();\n    const key = await crypto.subtle.importKey(\n      'raw',\n      encoder.encode(secret),\n      { name: 'HMAC', hash: 'SHA-256' },\n      false,\n      ['verify']\n    );\n\n    const signature = Uint8Array.from(atob(encodedSignature), c => c.charCodeAt(0));\n    const valid = await crypto.subtle.verify(\n      'HMAC',\n      key,\n      signature,\n      encoder.encode(data)\n    );\n\n    if (!valid) return null;\n\n    // Decode payload\n    const payload = JSON.parse(atob(encodedPayload));\n\n    // Check expiration\n    if (payload.exp && payload.exp < Math.floor(Date.now() / 1000)) {\n      return null;\n    }\n\n    return { userId: payload.userId };\n  } catch (error) {\n    return null;\n  }\n}\n\n/**\n * Encrypt data using AES-GCM\n */\nexport async function encrypt(text: string, password: string, salt: string): Promise<string> {\n  const encoder = new TextEncoder();\n  \n  // Derive key from password using PBKDF2\n  const keyMaterial = await crypto.subtle.importKey(\n    'raw',\n    encoder.encode(password),\n    'PBKDF2',\n    false,\n    ['deriveBits', 'deriveKey']\n  );\n\n  const key = await crypto.subtle.deriveKey(\n    {\n      name: 'PBKDF2',\n      salt: encoder.encode(salt),\n      iterations: 100000,\n      hash: 'SHA-256'\n    },\n    keyMaterial,\n    { name: 'AES-GCM', length: 256 },\n    false,\n    ['encrypt']\n  );\n\n  // Generate random IV\n  const iv = crypto.getRandomValues(new Uint8Array(12));\n\n  // Encrypt\n  const encrypted = await crypto.subtle.encrypt(\n    { name: 'AES-GCM', iv },\n    key,\n    encoder.encode(text)\n  );\n\n  // Combine IV and encrypted data\n  const combined = new Uint8Array(iv.length + encrypted.byteLength);\n  combined.set(iv);\n  combined.set(new Uint8Array(encrypted), iv.length);\n\n  // Return as base64\n  return btoa(String.fromCharCode(...combined));\n}\n\n/**\n * Decrypt data using AES-GCM\n */\nexport async function decrypt(encryptedText: string, password: string, salt: string): Promise<string> {\n  const encoder = new TextEncoder();\n  const decoder = new TextDecoder();\n\n  // Decode from base64\n  const combined = Uint8Array.from(atob(encryptedText), c => c.charCodeAt(0));\n\n  // Extract IV and encrypted data\n  const iv = combined.slice(0, 12);\n  const encrypted = combined.slice(12);\n\n  // Derive key from password\n  const keyMaterial = await crypto.subtle.importKey(\n    'raw',\n    encoder.encode(password),\n    'PBKDF2',\n    false,\n    ['deriveBits', 'deriveKey']\n  );\n\n  const key = await crypto.subtle.deriveKey(\n    {\n      name: 'PBKDF2',\n      salt: encoder.encode(salt),\n      iterations: 100000,\n      hash: 'SHA-256'\n    },\n    keyMaterial,\n    { name: 'AES-GCM', length: 256 },\n    false,\n    ['decrypt']\n  );\n\n  // Decrypt\n  const decrypted = await crypto.subtle.decrypt(\n    { name: 'AES-GCM', iv },\n    key,\n    encrypted\n  );\n\n  return decoder.decode(decrypted);\n}\n\n/**\n * Generate a random salt for encryption\n */\nexport function generateSalt(): string {\n  const array = new Uint8Array(16);\n  crypto.getRandomValues(array);\n  return Array.from(array)\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n}\n\n/**\n * Generate a secure temporary password\n * Format: 3 random words + 2 digits + 1 special char\n * Example: \"Cloud-Secure-Voice-42!\"\n */\nexport function generateTemporaryPassword(): string {\n  const words = [\n    'Cloud', 'Secure', 'Voice', 'Team', 'Digital', 'Smart', 'Quick', 'Bright',\n    'Swift', 'Prime', 'Elite', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Omega',\n    'Nexus', 'Quantum', 'Stellar', 'Cosmic', 'Cyber', 'Pixel', 'Matrix', 'Vertex'\n  ];\n\n  const specialChars = '!@#$%^&*';\n\n  // Pick 3 random words\n  const word1 = words[Math.floor(Math.random() * words.length)];\n  const word2 = words[Math.floor(Math.random() * words.length)];\n  const word3 = words[Math.floor(Math.random() * words.length)];\n\n  // Generate 2 random digits\n  const digits = Math.floor(Math.random() * 100).toString().padStart(2, '0');\n\n  // Pick 1 special character\n  const special = specialChars[Math.floor(Math.random() * specialChars.length)];\n\n  return `${word1}-${word2}-${word3}-${digits}${special}`;\n}\n\n", "/**\n * KV Cache Service for Voice AI Dashboard\n * Provides intelligent caching for recordings and intent analysis data\n */\n\nexport interface CacheOptions {\n  ttl?: number; // Time to live in seconds\n  tags?: string[]; // Tags for cache invalidation\n}\n\nexport interface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  ttl: number;\n  tags?: string[];\n}\n\nexport class VoiceAICache {\n  private kv: KVNamespace;\n  private defaultTTL: number;\n\n  constructor(kv: KVNamespace, defaultTTL: number = 300) {\n    this.kv = kv;\n    this.defaultTTL = defaultTTL;\n  }\n\n  /**\n   * Generate cache key for recordings page\n   */\n  private getRecordingsKey(userId: string, page: number = 1, limit: number = 50): string {\n    return `recordings:user:${userId}:page:${page}:limit:${limit}`;\n  }\n\n  /**\n   * Generate cache key for individual call details\n   */\n  private getCallKey(userId: string, callId: string): string {\n    return `recordings:user:${userId}:call:${callId}`;\n  }\n\n  /**\n   * Generate cache key for intent analysis\n   */\n  private getIntentKey(userId: string, callId: string): string {\n    return `intent:user:${userId}:analysis:${callId}`;\n  }\n\n  /**\n   * Generate cache key for intent dashboard summary\n   */\n  private getIntentSummaryKey(userId: string): string {\n    return `intent:user:${userId}:summary`;\n  }\n\n  /**\n   * Generate cache key for enhanced data\n   */\n  private getEnhancedDataKey(userId: string, callId: string): string {\n    return `enhanced:user:${userId}:call:${callId}`;\n  }\n\n  /**\n   * Get data from cache\n   */\n  async get<T>(key: string): Promise<T | null> {\n    try {\n      const cached = await this.kv.get(key, 'json') as CacheEntry<T> | null;\n      \n      if (!cached) {\n        return null;\n      }\n\n      // Check if expired\n      const now = Math.floor(Date.now() / 1000);\n      if (cached.timestamp + cached.ttl < now) {\n        // Expired, delete and return null\n        await this.kv.delete(key);\n        return null;\n      }\n\n      return cached.data;\n    } catch (error) {\n      console.error('Cache get error:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Set data in cache\n   */\n  async set<T>(key: string, data: T, options: CacheOptions = {}): Promise<void> {\n    try {\n      const ttl = options.ttl || this.defaultTTL;\n      const entry: CacheEntry<T> = {\n        data,\n        timestamp: Math.floor(Date.now() / 1000),\n        ttl,\n        tags: options.tags\n      };\n\n      await this.kv.put(key, JSON.stringify(entry), {\n        expirationTtl: ttl\n      });\n    } catch (error) {\n      console.error('Cache set error:', error);\n    }\n  }\n\n  /**\n   * Delete data from cache\n   */\n  async delete(key: string): Promise<void> {\n    try {\n      await this.kv.delete(key);\n    } catch (error) {\n      console.error('Cache delete error:', error);\n    }\n  }\n\n  /**\n   * Invalidate cache by pattern (for user-specific data)\n   */\n  async invalidateUserCache(userId: string): Promise<void> {\n    try {\n      // List all keys for this user\n      const list = await this.kv.list({ prefix: `recordings:user:${userId}:` });\n      const intentList = await this.kv.list({ prefix: `intent:user:${userId}:` });\n      const enhancedList = await this.kv.list({ prefix: `enhanced:user:${userId}:` });\n\n      // Delete all user-related cache entries\n      const keysToDelete = [\n        ...list.keys.map(k => k.name),\n        ...intentList.keys.map(k => k.name),\n        ...enhancedList.keys.map(k => k.name)\n      ];\n\n      await Promise.all(keysToDelete.map(key => this.kv.delete(key)));\n    } catch (error) {\n      console.error('Cache invalidation error:', error);\n    }\n  }\n\n  /**\n   * Cache recordings page data\n   */\n  async cacheRecordings(\n    userId: string, \n    recordings: any[], \n    page: number = 1, \n    limit: number = 50,\n    ttl: number = 300 // 5 minutes\n  ): Promise<void> {\n    const key = this.getRecordingsKey(userId, page, limit);\n    await this.set(key, recordings, { ttl });\n  }\n\n  /**\n   * Get cached recordings page data\n   */\n  async getCachedRecordings(userId: string, page: number = 1, limit: number = 50): Promise<any[] | null> {\n    const key = this.getRecordingsKey(userId, page, limit);\n    return await this.get<any[]>(key);\n  }\n\n  /**\n   * Cache individual call details\n   */\n  async cacheCall(userId: string, callId: string, callData: any, ttl: number = 600): Promise<void> {\n    const key = this.getCallKey(userId, callId);\n    await this.set(key, callData, { ttl });\n  }\n\n  /**\n   * Get cached call details\n   */\n  async getCachedCall(userId: string, callId: string): Promise<any | null> {\n    const key = this.getCallKey(userId, callId);\n    return await this.get<any>(key);\n  }\n\n  /**\n   * Cache intent analysis data\n   */\n  async cacheIntentAnalysis(userId: string, callId: string, intentData: any, ttl: number = 600): Promise<void> {\n    const key = this.getIntentKey(userId, callId);\n    await this.set(key, intentData, { ttl });\n  }\n\n  /**\n   * Get cached intent analysis\n   */\n  async getCachedIntentAnalysis(userId: string, callId: string): Promise<any | null> {\n    const key = this.getIntentKey(userId, callId);\n    return await this.get<any>(key);\n  }\n\n  /**\n   * Cache intent dashboard summary\n   */\n  async cacheIntentSummary(userId: string, summaryData: any, ttl: number = 120): Promise<void> {\n    const key = this.getIntentSummaryKey(userId);\n    await this.set(key, summaryData, { ttl });\n  }\n\n  /**\n   * Get cached intent summary\n   */\n  async getCachedIntentSummary(userId: string): Promise<any | null> {\n    const key = this.getIntentSummaryKey(userId);\n    return await this.get<any>(key);\n  }\n\n  /**\n   * Cache enhanced data\n   */\n  async cacheEnhancedData(userId: string, callId: string, enhancedData: any, ttl: number = 1800): Promise<void> {\n    const key = this.getEnhancedDataKey(userId, callId);\n    await this.set(key, enhancedData, { ttl });\n  }\n\n  /**\n   * Get cached enhanced data\n   */\n  async getCachedEnhancedData(userId: string, callId: string): Promise<any | null> {\n    const key = this.getEnhancedDataKey(userId, callId);\n    return await this.get<any>(key);\n  }\n\n  /**\n   * Invalidate specific call cache\n   */\n  async invalidateCallCache(userId: string, callId: string): Promise<void> {\n    await Promise.all([\n      this.delete(this.getCallKey(userId, callId)),\n      this.delete(this.getIntentKey(userId, callId)),\n      this.delete(this.getEnhancedDataKey(userId, callId))\n    ]);\n  }\n\n  /**\n   * Get cache statistics\n   */\n  async getCacheStats(): Promise<{\n    totalKeys: number;\n    recordingsKeys: number;\n    intentKeys: number;\n    enhancedKeys: number;\n  }> {\n    try {\n      const recordingsList = await this.kv.list({ prefix: 'recordings:' });\n      const intentList = await this.kv.list({ prefix: 'intent:' });\n      const enhancedList = await this.kv.list({ prefix: 'enhanced:' });\n\n      return {\n        totalKeys: recordingsList.keys.length + intentList.keys.length + enhancedList.keys.length,\n        recordingsKeys: recordingsList.keys.length,\n        intentKeys: intentList.keys.length,\n        enhancedKeys: enhancedList.keys.length\n      };\n    } catch (error) {\n      console.error('Cache stats error:', error);\n      return {\n        totalKeys: 0,\n        recordingsKeys: 0,\n        intentKeys: 0,\n        enhancedKeys: 0\n      };\n    }\n  }\n}\n\n/**\n * Cache TTL constants\n */\nexport const CACHE_TTL = {\n  RECORDINGS: 300,      // 5 minutes\n  CALL_DETAILS: 600,    // 10 minutes\n  INTENT_ANALYSIS: 600, // 10 minutes\n  INTENT_SUMMARY: 120,  // 2 minutes\n  ENHANCED_DATA: 1800,  // 30 minutes\n} as const;\n", "/**\n * HubSpot Integration Service\n *\n * Handles OAuth 2.0 authentication and REST API interactions with HubSpot\n * - OAuth: Authorization code flow with token refresh\n * - Search: Phone number search for Contacts\n * - Sync: Create Engagements (notes) with call summary and recording URL\n */\n\ninterface D1Database {\n  prepare(query: string): any;\n}\n\ninterface Env {\n  HUBSPOT_CLIENT_ID: string;\n  HUBSPOT_CLIENT_SECRET: string;\n}\n\n// ============================================\n// CONFIGURATION\n// ============================================\n\nconst OAUTH_CALLBACK_URL = 'https://api.voice-config.channelautomation.com/api/hubspot/oauth/callback';\n\n// HubSpot OAuth endpoints\nconst HUBSPOT_AUTH_URL = 'https://app.hubspot.com/oauth/authorize';\nconst HUBSPOT_TOKEN_URL = 'https://api.hubapi.com/oauth/v1/token';\n\n// ============================================\n// OAUTH 2.0 FLOW\n// ============================================\n\n/**\n * Step 1: Generate OAuth authorization URL\n * User will be redirected here to approve access\n */\nexport function buildAuthUrl(workspaceId: string, env: Env): string {\n  const scopes = [\n    'crm.objects.contacts.read',   // Search and read contact data\n    'crm.objects.contacts.write',  // Update contact data\n    'crm.objects.custom.write',    // Required by HubSpot app configuration\n    'oauth',                       // OAuth scope\n  ];\n\n  const params = new URLSearchParams({\n    client_id: env.HUBSPOT_CLIENT_ID,\n    redirect_uri: OAUTH_CALLBACK_URL,\n    scope: scopes.join(' '),\n    state: workspaceId, // Pass workspace ID to identify user on callback\n  });\n\n  return `${HUBSPOT_AUTH_URL}?${params.toString()}`;\n}\n\n/**\n * Step 2: Exchange authorization code for access & refresh tokens\n * Called after user approves and HubSpot redirects back with code\n */\nexport async function exchangeCodeForToken(code: string, env: Env): Promise<{\n  access_token: string;\n  refresh_token: string;\n  expires_in: number;\n}> {\n  const params = new URLSearchParams({\n    grant_type: 'authorization_code',\n    code,\n    client_id: env.HUBSPOT_CLIENT_ID,\n    client_secret: env.HUBSPOT_CLIENT_SECRET,\n    redirect_uri: OAUTH_CALLBACK_URL,\n  });\n\n  const response = await fetch(HUBSPOT_TOKEN_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`HubSpot OAuth token exchange failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    refresh_token: data.refresh_token,\n    expires_in: Math.floor(Date.now() / 1000) + data.expires_in,\n  };\n}\n\n/**\n * Step 3: Refresh access token when it expires\n * Access tokens expire in ~6 hours, use refresh token to get new one\n */\nexport async function refreshAccessToken(refreshToken: string, env: Env): Promise<{\n  access_token: string;\n  expires_in: number;\n}> {\n  const params = new URLSearchParams({\n    grant_type: 'refresh_token',\n    refresh_token: refreshToken,\n    client_id: env.HUBSPOT_CLIENT_ID,\n    client_secret: env.HUBSPOT_CLIENT_SECRET,\n  });\n\n  const response = await fetch(HUBSPOT_TOKEN_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`HubSpot token refresh failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    expires_in: Math.floor(Date.now() / 1000) + data.expires_in,\n  };\n}\n\n/**\n * Helper: Check if access token is expired and refresh if needed\n */\nexport async function ensureValidToken(\n  db: D1Database,\n  userId: string,\n  workspaceId: string,\n  env: Env\n): Promise<string> {\n  // Get current tokens from database\n  const token = await db.prepare(\n    'SELECT access_token, refresh_token, expires_at FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n  ).bind(userId, workspaceId).first();\n\n  if (!token || !token.refresh_token) {\n    throw new Error('HubSpot not connected for this user');\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  const expiresAt = token.expires_at || 0;\n\n  // If token expires in less than 5 minutes, refresh it\n  if (now >= expiresAt - 300) {\n    console.log('[HubSpot] Access token expired, refreshing...');\n    const newTokens = await refreshAccessToken(token.refresh_token, env);\n\n    // Update database with new tokens\n    await db.prepare(\n      'UPDATE hubspot_oauth_tokens SET access_token = ?, expires_at = ?, updated_at = ? WHERE user_id = ? AND workspace_id = ?'\n    ).bind(\n      newTokens.access_token,\n      newTokens.expires_in,\n      Date.now(),\n      userId,\n      workspaceId\n    ).run();\n\n    return newTokens.access_token;\n  }\n\n  return token.access_token;\n}\n\n// ============================================\n// PHONE NUMBER SEARCH\n// ============================================\n\n/**\n * Search for Contact by phone number using HubSpot Search API\n * Searches in phone and mobilephone properties with multiple fallback strategies\n */\nexport async function searchContactByPhone(\n  accessToken: string,\n  phoneNumber: string\n): Promise<{ vid: number; phone?: string } | null> {\n  // Clean phone number (remove non-digits)\n  const digitsOnly = phoneNumber.replace(/\\D/g, '');\n  const last10 = digitsOnly.length >= 10 ? digitsOnly.slice(-10) : digitsOnly;\n\n  console.log('[HubSpot] Searching for phone:', phoneNumber, '| All digits:', digitsOnly, '| Last 10:', last10);\n\n  // Generate possible phone format variations for EQ operator\n  const phoneFormats = [];\n  if (digitsOnly.length === 11 && digitsOnly.startsWith('1')) {\n    // US number with country code\n    const areaCode = last10.slice(0, 3);\n    const prefix = last10.slice(3, 6);\n    const line = last10.slice(6, 10);\n    phoneFormats.push(\n      `+1 (${areaCode}) ${prefix}-${line}`,  // +1 (626) 313-3690\n      `+1${areaCode}${prefix}${line}`,       // +16263133690\n      `1${areaCode}${prefix}${line}`,        // 16263133690\n      `${areaCode}${prefix}${line}`,         // 6263133690\n      `(${areaCode}) ${prefix}-${line}`,     // (626) 313-3690\n      `${areaCode}-${prefix}-${line}`        // 626-313-3690\n    );\n  } else if (digitsOnly.length === 10) {\n    // US number without country code\n    const areaCode = digitsOnly.slice(0, 3);\n    const prefix = digitsOnly.slice(3, 6);\n    const line = digitsOnly.slice(6, 10);\n    phoneFormats.push(\n      `+1 (${areaCode}) ${prefix}-${line}`,\n      `(${areaCode}) ${prefix}-${line}`,\n      `${areaCode}-${prefix}-${line}`,\n      `${areaCode}${prefix}${line}`\n    );\n  }\n\n  // Strategy 1: Use area code + prefix (first 6 digits of last 10) for broad search\n  const searchDigits = last10.substring(0, 6); // e.g., \"626313\" for (626) 313-3690\n  console.log('[HubSpot] Strategy 1: Searching with first 6 digits:', searchDigits);\n\n  let searchPayload = {\n    query: searchDigits,\n    filterGroups: [],\n    properties: ['phone', 'mobilephone', 'firstname', 'lastname', 'email'],\n    limit: 100, // Get more results to filter through\n  };\n\n  let response = await fetch('https://api.hubapi.com/crm/v3/objects/contacts/search', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(searchPayload),\n  });\n\n  if (response.ok) {\n    const data = await response.json();\n    console.log(`[HubSpot] Query search found ${data.results?.length || 0} results`);\n\n    if (data.results && data.results.length > 0) {\n      // Filter through results to find exact match\n      for (const contact of data.results) {\n        const contactPhone = contact.properties.phone || '';\n        const contactMobile = contact.properties.mobilephone || '';\n        const cleanContactPhone = contactPhone.replace(/\\D/g, '');\n        const cleanContactMobile = contactMobile.replace(/\\D/g, '');\n\n        console.log('[HubSpot] Checking contact:', contact.id, '| Phone:', contactPhone, '| Mobile:', contactMobile);\n\n        // Match if last 10 digits are the same\n        if (cleanContactPhone.slice(-10) === last10 || cleanContactMobile.slice(-10) === last10) {\n          console.log(`[HubSpot] Found match via query search:`, contact.id);\n          return {\n            vid: parseInt(contact.id),\n            phone: contactPhone || contactMobile\n          };\n        }\n      }\n    }\n  }\n\n  // Strategy 2: CONTAINS_TOKEN with last 10 digits\n  console.log('[HubSpot] Strategy 2: Trying CONTAINS_TOKEN with last 10 digits:', last10);\n\n  searchPayload = {\n    filterGroups: [\n      {\n        filters: [{ propertyName: 'phone', operator: 'CONTAINS_TOKEN', value: last10 }]\n      },\n      {\n        filters: [{ propertyName: 'mobilephone', operator: 'CONTAINS_TOKEN', value: last10 }]\n      }\n    ],\n    properties: ['phone', 'mobilephone', 'firstname', 'lastname', 'email'],\n    limit: 10,\n  };\n\n  response = await fetch('https://api.hubapi.com/crm/v3/objects/contacts/search', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(searchPayload),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error('[HubSpot] Contact search failed:', error);\n    throw new Error(`HubSpot contact search failed: ${error}`);\n  }\n\n  let data2 = await response.json();\n  console.log(`[HubSpot] CONTAINS_TOKEN search response:`, JSON.stringify(data2));\n\n  // Check results and find best match\n  if (data2.results && data2.results.length > 0) {\n    console.log(`[HubSpot] Found ${data2.results.length} potential matches with CONTAINS_TOKEN`);\n\n    for (const contact of data2.results) {\n      const contactPhone = contact.properties.phone || '';\n      const contactMobile = contact.properties.mobilephone || '';\n      const cleanContactPhone = contactPhone.replace(/\\D/g, '');\n      const cleanContactMobile = contactMobile.replace(/\\D/g, '');\n\n      console.log('[HubSpot] Checking:', contact.id, '| Phone:', contactPhone, '| Mobile:', contactMobile);\n      console.log('[HubSpot] Clean digits - Contact Phone:', cleanContactPhone, '| Contact Mobile:', cleanContactMobile, '| Looking for last10:', last10);\n\n      // Match if last 10 digits are the same\n      const contactLast10Phone = cleanContactPhone.slice(-10);\n      const contactLast10Mobile = cleanContactMobile.slice(-10);\n\n      console.log('[HubSpot] Last 10 comparison - Contact Phone:', contactLast10Phone, '| Contact Mobile:', contactLast10Mobile, '| Target:', last10);\n\n      if (contactLast10Phone === last10 || contactLast10Mobile === last10) {\n        console.log(`[HubSpot] Found matching contact: ${contact.id}`);\n        return {\n          vid: parseInt(contact.id),\n          phone: contactPhone || contactMobile\n        };\n      }\n    }\n  }\n\n  console.log('[HubSpot] No contact found for phone:', phoneNumber);\n  return null;\n}\n\n// ============================================\n// ENGAGEMENT CREATION (NOTES)\n// ============================================\n\n/**\n * Create an Engagement (Note) with call summary, structured data, and conversation transcript\n * Note appears in contact's timeline\n */\nexport async function createEngagement(\n  accessToken: string,\n  contactId: number,\n  summary: string,\n  structuredData?: Record<string, any>,\n  conversation?: Array<{ role: string; message: string }>,\n  structuredOutputs?: Record<string, any>\n): Promise<{ id: number }> {\n  let noteBody = `**Call Summary:**\\n\\n${summary}`;\n\n  // Add structured data if available\n  if (structuredData && Object.keys(structuredData).length > 0) {\n    noteBody += '\\n\\n**Call Details:**\\n';\n\n    for (const [key, value] of Object.entries(structuredData)) {\n      if (value !== null && value !== undefined && value !== '') {\n        // Convert camelCase or snake_case to Title Case\n        const formattedKey = key\n          .replace(/([A-Z])/g, ' $1')\n          .replace(/_/g, ' ')\n          .replace(/\\b\\w/g, (l) => l.toUpperCase())\n          .trim();\n\n        // Format the value\n        let formattedValue = value;\n        if (typeof value === 'object') {\n          formattedValue = JSON.stringify(value, null, 2);\n        }\n\n        noteBody += `\\n- **${formattedKey}:** ${formattedValue}`;\n      }\n    }\n  }\n\n  // Add structured outputs if available (from VAPI structured output)\n  if (structuredOutputs && Object.keys(structuredOutputs).length > 0) {\n    noteBody += '\\n\\n**Structured Outputs:**\\n';\n\n    for (const [key, value] of Object.entries(structuredOutputs)) {\n      if (value !== null && value !== undefined) {\n        // Extract clean field name and value\n        let fieldName = key;\n        let fieldValue = value;\n\n        if (typeof value === 'object' && value !== null) {\n          // Check if it has name and result properties (structured output format)\n          if ('name' in value && 'result' in value) {\n            fieldName = value.name;\n            fieldValue = value.result;\n          } else {\n            fieldValue = JSON.stringify(value, null, 2);\n          }\n        }\n\n        // Format the value for display\n        let displayValue = fieldValue;\n        if (typeof fieldValue === 'boolean') {\n          displayValue = fieldValue ? 'Yes' : 'No';\n        } else if (typeof fieldValue === 'string') {\n          displayValue = fieldValue;\n        } else if (typeof fieldValue === 'number') {\n          displayValue = fieldValue.toString();\n        } else {\n          displayValue = JSON.stringify(fieldValue);\n        }\n\n        noteBody += `\\n- **${fieldName}:** ${displayValue}`;\n      }\n    }\n  }\n\n  // Add conversation transcript if available\n  if (conversation && conversation.length > 0) {\n    noteBody += '\\n\\n**Conversation Transcript:**\\n';\n\n    for (const turn of conversation) {\n      const speaker = turn.role === 'assistant' ? 'AI Assistant' : 'Customer';\n      noteBody += `\\n**${speaker}:** ${turn.message}\\n`;\n    }\n  }\n\n  const engagementPayload = {\n    engagement: {\n      active: true,\n      type: 'NOTE',\n      timestamp: Date.now(),\n    },\n    associations: {\n      contactIds: [contactId],\n    },\n    metadata: {\n      body: noteBody,\n    },\n  };\n\n  const response = await fetch('https://api.hubapi.com/engagements/v1/engagements', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(engagementPayload),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error('[HubSpot] Engagement creation failed:', error);\n    throw new Error(`HubSpot engagement creation failed: ${error}`);\n  }\n\n  const result = await response.json();\n  console.log('[HubSpot] Engagement created:', result.engagement.id);\n  return { id: result.engagement.id };\n}\n\n// ============================================\n// MAIN SYNC FUNCTION\n// ============================================\n\n/**\n * Main function: Sync call to HubSpot\n * 1. Search for Contact by phone\n * 2. Create Engagement (note) with call summary, structured data, and recording URL\n */\nexport async function syncCallToHubSpot(\n  db: D1Database,\n  userId: string,\n  workspaceId: string,\n  callId: string,\n  callData: {\n    phoneNumber: string;\n    summary: string;\n    structuredData?: Record<string, any>;\n    conversation?: Array<{ role: string; message: string }>;\n    structuredOutputs?: Record<string, any>;\n  },\n  env: Env\n): Promise<{\n  success: boolean;\n  contactId?: number;\n  engagementId?: number;\n  error?: string;\n}> {\n  try {\n    // Step 1: Ensure we have valid access token\n    const accessToken = await ensureValidToken(db, userId, workspaceId, env);\n\n    // Step 2: Search for Contact by phone\n    const contact = await searchContactByPhone(accessToken, callData.phoneNumber);\n\n    if (!contact) {\n      // Log as \"skipped\" - phone number not found in HubSpot\n      await db.prepare(\n        'INSERT INTO hubspot_sync_logs (id, user_id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n      ).bind(\n        `hs_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,\n        userId,\n        workspaceId,\n        callId,\n        'skipped',\n        'Phone number not found in HubSpot',\n        callData.phoneNumber,\n        Date.now()\n      ).run();\n\n      return {\n        success: false,\n        error: 'Phone number not found in HubSpot',\n      };\n    }\n\n    // Step 3: Create Engagement (note)\n    const engagement = await createEngagement(\n      accessToken,\n      contact.vid,\n      callData.summary,\n      callData.structuredData,\n      callData.conversation,\n      callData.structuredOutputs\n    );\n\n    // Step 4: Log success\n    await db.prepare(\n      'INSERT INTO hubspot_sync_logs (id, user_id, workspace_id, call_id, contact_id, engagement_id, status, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `hs_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      userId,\n      workspaceId,\n      callId,\n      contact.vid.toString(),\n      engagement.id.toString(),\n      'success',\n      callData.phoneNumber,\n      Date.now()\n    ).run();\n\n    console.log('[HubSpot] Sync completed successfully');\n    return {\n      success: true,\n      contactId: contact.vid,\n      engagementId: engagement.id,\n    };\n  } catch (error: any) {\n    // Log error\n    await db.prepare(\n      'INSERT INTO hubspot_sync_logs (id, user_id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `hs_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      userId,\n      workspaceId,\n      callId,\n      'error',\n      error.message,\n      callData.phoneNumber,\n      Date.now()\n    ).run();\n\n    console.error('[HubSpot] Sync failed:', error.message);\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n", "/**\n * Outbound Webhook Dispatcher\n * Handles sending real-time call events to user-configured webhook endpoints\n */\n\nimport type { Env } from './index';\nimport { syncCallToHubSpot } from './hubspot-service';\n\n// Helper to generate unique ID\nfunction generateId(): string {\n  return `obwh_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\nfunction generateLogId(): string {\n  return `obwhlog_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\nfunction now(): number {\n  return Math.floor(Date.now() / 1000);\n}\n\n/**\n * Download VAPI recording and save to R2\n */\nasync function downloadAndSaveRecording(\n  env: Env,\n  recordingUrl: string,\n  callId: string\n): Promise<string | null> {\n  if (!recordingUrl) return null;\n\n  try {\n    console.log(`[R2] Downloading recording from VAPI: ${recordingUrl}`);\n\n    // Download recording from VAPI\n    const response = await fetch(recordingUrl);\n    if (!response.ok) {\n      console.error(`[R2] Failed to download recording: ${response.status}`);\n      return null;\n    }\n\n    // Generate R2 key\n    const r2Key = `recordings/${callId}.wav`;\n\n    // Upload to R2\n    await env.RECORDINGS.put(r2Key, response.body, {\n      httpMetadata: {\n        contentType: 'audio/wav',\n      },\n    });\n\n    console.log(`[R2] Saved recording to R2: ${r2Key}`);\n\n    // Return public URL using custom domain\n    return `https://call-recording.channelautomation.com/${r2Key}`;\n  } catch (error) {\n    console.error('[R2] Error saving recording:', error);\n    return null;\n  }\n}\n\n/**\n * Build simplified payload for outbound webhook\n */\nfunction buildOutboundPayload(\n  eventType: 'call.started' | 'call.ended',\n  data: {\n    callId: string;\n    customerPhone?: string | null;\n    assistantName?: string;\n    durationSeconds?: number | null;\n    endedReason?: string;\n    summary?: string;\n    structuredData?: any;\n    conversation?: Array<{ role: string; message: string }>;\n    structuredOutputs?: any;\n    recordingUrl?: string | null;\n  }\n): any {\n  const basePayload = {\n    event: eventType,\n    timestamp: new Date().toISOString(),\n    call_id: data.callId,\n    customer_phone: data.customerPhone || null,\n    assistant_name: data.assistantName || 'AI Assistant',\n  };\n\n  if (eventType === 'call.started') {\n    return {\n      ...basePayload,\n      status: 'ringing',\n    };\n  }\n\n  // call.ended event - formatted like HubSpot sync\n  return {\n    ...basePayload,\n    duration_seconds: data.durationSeconds || 0,\n    ended_reason: data.endedReason || 'unknown',\n    call_summary: data.summary || '',\n    call_details: data.structuredData || {},\n    structured_outputs: data.structuredOutputs || {},\n    conversation_transcript: data.conversation || [],\n    recording_url: data.recordingUrl || null,\n  };\n}\n\n/**\n * Extract clean conversation from VAPI messages\n */\nfunction extractConversation(messages: any[]): Array<{ role: string; message: string }> {\n  if (!messages || !Array.isArray(messages)) return [];\n\n  return messages\n    .filter((msg: any) => msg.role === 'user' || msg.role === 'bot' || msg.role === 'assistant')\n    .map((msg: any) => ({\n      role: msg.role === 'bot' ? 'assistant' : msg.role,\n      message: msg.message || msg.content || '',\n    }));\n}\n\n/**\n * Dispatch webhook to user's endpoint\n */\nasync function dispatchOutboundWebhook(\n  env: Env,\n  outboundWebhook: any,\n  payload: any,\n  eventType: string,\n  callId: string\n): Promise<void> {\n  const logId = generateLogId();\n  const timestamp = now();\n\n  try {\n    console.log(`[Outbound Webhook] Dispatching ${eventType} to ${outboundWebhook.destination_url}`);\n\n    const response = await fetch(outboundWebhook.destination_url, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'User-Agent': 'Voice-AI-Dashboard/1.0',\n      },\n      body: JSON.stringify(payload),\n      signal: AbortSignal.timeout(10000), // 10 second timeout\n    });\n\n    const responseText = await response.text();\n\n    // Log success\n    await env.DB.prepare(\n      `INSERT INTO outbound_webhook_logs\n       (id, outbound_webhook_id, event_type, call_id, status, http_status, response_body, created_at)\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n    ).bind(\n      logId,\n      outboundWebhook.id,\n      eventType,\n      callId,\n      response.ok ? 'success' : 'failed',\n      response.status,\n      responseText.substring(0, 1000), // Limit response body to 1000 chars\n      timestamp\n    ).run();\n\n    console.log(`[Outbound Webhook] Response ${response.status}: ${responseText.substring(0, 100)}`);\n  } catch (error: any) {\n    console.error(`[Outbound Webhook] Error:`, error);\n\n    // Log failure\n    await env.DB.prepare(\n      `INSERT INTO outbound_webhook_logs\n       (id, outbound_webhook_id, event_type, call_id, status, http_status, error_message, created_at)\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n    ).bind(\n      logId,\n      outboundWebhook.id,\n      eventType,\n      callId,\n      'failed',\n      0,\n      error.message || String(error),\n      timestamp\n    ).run();\n  }\n}\n\n/**\n * Main function: Dispatch to all active outbound webhooks for a user\n */\nexport async function dispatchToOutboundWebhooks(\n  env: Env,\n  userId: string,\n  eventType: 'call.started' | 'call.ended',\n  callData: {\n    callId: string;\n    customerPhone?: string | null;\n    assistantName?: string;\n    durationSeconds?: number | null;\n    endedReason?: string;\n    summary?: string;\n    structuredData?: any;\n    rawPayload?: any;\n    recordingUrl?: string | null;\n  }\n): Promise<void> {\n  console.log(`[DEBUG] dispatchToOutboundWebhooks called for user ${userId}, event: ${eventType}`);\n  try {\n    // Get all active outbound webhooks for this user\n    const webhooks = await env.DB.prepare(\n      `SELECT id, destination_url, events FROM outbound_webhooks\n       WHERE user_id = ? AND is_active = 1`\n    ).bind(userId).all();\n\n    if (!webhooks.results || webhooks.results.length === 0) {\n      console.log(`[Outbound Webhook] No active webhooks for user ${userId}`);\n      return;\n    }\n\n    console.log(`[Outbound Webhook] Found ${webhooks.results.length} active webhook(s) for user ${userId}`);\n\n    // For call.ended, download and save recording to R2 ONCE before processing webhooks\n    let r2RecordingUrl = callData.recordingUrl;\n    if (eventType === 'call.ended' && callData.recordingUrl) {\n      const savedUrl = await downloadAndSaveRecording(env, callData.recordingUrl, callData.callId);\n      if (savedUrl) {\n        r2RecordingUrl = savedUrl;\n        console.log('[R2] Using R2 recording URL for all webhooks:', r2RecordingUrl);\n      }\n    }\n\n    // Sync to HubSpot AFTER recording is uploaded to R2 (once per call)\n    console.log('[HubSpot] Checking sync - eventType:', eventType, 'hasRecording:', !!r2RecordingUrl, 'hasPhone:', !!callData.customerPhone, 'hasSummary:', !!callData.summary);\n\n    // Debug: Log to database to see what's happening\n    try {\n      await env.DB.prepare(\n        'INSERT INTO hubspot_sync_logs (id, user_id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n      ).bind(\n        `debug_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`,\n        userId,\n        'debug',\n        callData.callId,\n        'debug',\n        `Event:${eventType} RecURL:${r2RecordingUrl ? 'YES' : 'NO'} Phone:${callData.customerPhone || 'NO'} Summary:${callData.summary ? 'YES' : 'NO'}`,\n        callData.customerPhone || 'none',\n        Date.now()\n      ).run();\n    } catch (e) {\n      console.error('[DEBUG] Failed to log debug info:', e);\n    }\n\n    if (eventType === 'call.ended' && r2RecordingUrl && callData.customerPhone && callData.summary) {\n      try {\n        // Get workspace settings\n        const wsSettings = await env.DB.prepare(\n          'SELECT workspace_id FROM user_settings WHERE user_id = ? LIMIT 1'\n        ).bind(userId).first() as any;\n\n        console.log('[HubSpot] Workspace settings:', wsSettings);\n\n        // Check if HubSpot is connected\n        const hubspotTokens = await env.DB.prepare(\n          'SELECT access_token FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n        ).bind(userId, wsSettings?.workspace_id).first() as any;\n\n        console.log('[HubSpot] HubSpot tokens:', hubspotTokens ? 'Found' : 'Not found');\n\n        if (hubspotTokens) {\n          console.log('[HubSpot] Syncing call with R2 recording URL:', r2RecordingUrl);\n          await syncCallToHubSpot(\n            env.DB,\n            userId,\n            wsSettings?.workspace_id || '',\n            callData.callId,\n            {\n              phoneNumber: callData.customerPhone,\n              summary: callData.summary,\n              recordingUrl: r2RecordingUrl, // Use R2 URL\n            },\n            env\n          );\n        } else {\n          console.log('[HubSpot] Skipping sync - HubSpot not connected for user:', userId);\n        }\n      } catch (hubspotError) {\n        console.error('[HubSpot] Sync error in outbound webhook:', hubspotError);\n      }\n    } else {\n      console.log('[HubSpot] Skipping sync - missing required fields');\n    }\n\n    // Now dispatch to all webhooks with the R2 URL\n    for (const webhook of webhooks.results) {\n      // Check if this webhook is subscribed to this event type\n      const subscribedEvents = webhook.events?.split(',') || ['call.ended'];\n      if (!subscribedEvents.includes(eventType)) {\n        console.log(`[Outbound Webhook] Skipping ${webhook.destination_url} - not subscribed to ${eventType}`);\n        continue;\n      }\n\n      // Extract conversation and structured outputs from raw payload if available\n      let conversation: Array<{ role: string; message: string }> = [];\n      let structuredOutputs: any = {};\n\n      if (eventType === 'call.ended' && callData.rawPayload) {\n        const messages = callData.rawPayload?.message?.artifact?.messages || [];\n        conversation = extractConversation(messages);\n\n        // Extract structured outputs from VAPI payload\n        const analysis = callData.rawPayload?.message?.analysis || {};\n        const artifact = callData.rawPayload?.message?.artifact || {};\n        structuredOutputs = analysis?.structuredOutputs || artifact?.structuredOutputs || {};\n      }\n\n      // Build payload\n      const payload = buildOutboundPayload(eventType, {\n        ...callData,\n        conversation,\n        structuredOutputs,\n        recordingUrl: r2RecordingUrl,\n      });\n\n      // Dispatch webhook\n      await dispatchOutboundWebhook(env, webhook, payload, eventType, callData.callId);\n    }\n  } catch (error) {\n    console.error('[Outbound Webhook] Error in dispatchToOutboundWebhooks:', error);\n  }\n}\n", "/**\n * Outbound Webhooks API Endpoints\n * CRUD operations for managing user's outbound webhook configurations\n */\n\nimport type { Env } from './index';\n\nfunction generateId(): string {\n  return `obwh_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\nfunction now(): number {\n  return Math.floor(Date.now() / 1000);\n}\n\nfunction jsonResponse(data: any, status = 200) {\n  const corsHeaders = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': 'GET, POST, PUT, PATCH, DELETE, OPTIONS',\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n  };\n\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: {\n      'Content-Type': 'application/json',\n      ...corsHeaders,\n    },\n  });\n}\n\n/**\n * Create a new outbound webhook\n * POST /api/outbound-webhooks\n */\nexport async function createOutboundWebhook(request: Request, env: Env, userId: string): Promise<Response> {\n  try {\n    const body = await request.json() as any;\n    const { name, destination_url, events } = body;\n\n    if (!name || !destination_url) {\n      return jsonResponse({ error: 'Missing required fields: name, destination_url' }, 400);\n    }\n\n    // Validate destination URL\n    try {\n      new URL(destination_url);\n    } catch (e) {\n      return jsonResponse({ error: 'Invalid destination_url' }, 400);\n    }\n\n    // Validate events (optional, defaults to 'call.ended')\n    const validEvents = ['call.started', 'call.ended'];\n    const eventList = events ? events.split(',').map((e: string) => e.trim()) : ['call.ended'];\n    for (const event of eventList) {\n      if (!validEvents.includes(event)) {\n        return jsonResponse({ error: `Invalid event: ${event}. Valid events: ${validEvents.join(', ')}` }, 400);\n      }\n    }\n\n    const webhookId = generateId();\n    const timestamp = now();\n\n    await env.DB.prepare(\n      `INSERT INTO outbound_webhooks\n       (id, user_id, name, destination_url, is_active, events, created_at, updated_at)\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n    ).bind(\n      webhookId,\n      userId,\n      name,\n      destination_url,\n      1, // active by default\n      eventList.join(','),\n      timestamp,\n      timestamp\n    ).run();\n\n    return jsonResponse({\n      id: webhookId,\n      name,\n      destination_url,\n      is_active: true,\n      events: eventList,\n      created_at: timestamp,\n    }, 201);\n  } catch (error: any) {\n    console.error('[Outbound Webhooks API] Create error:', error);\n    return jsonResponse({ error: error.message || 'Failed to create outbound webhook' }, 500);\n  }\n}\n\n/**\n * List all outbound webhooks for user\n * GET /api/outbound-webhooks\n */\nexport async function listOutboundWebhooks(env: Env, userId: string): Promise<Response> {\n  try {\n    const { results } = await env.DB.prepare(\n      `SELECT id, name, destination_url, is_active, events, created_at, updated_at\n       FROM outbound_webhooks\n       WHERE user_id = ?\n       ORDER BY created_at DESC`\n    ).bind(userId).all();\n\n    // Parse events string to array\n    const webhooks = (results || []).map((webhook: any) => ({\n      ...webhook,\n      events: webhook.events ? webhook.events.split(',') : ['call.ended'],\n      is_active: Boolean(webhook.is_active),\n    }));\n\n    return jsonResponse({ webhooks });\n  } catch (error: any) {\n    console.error('[Outbound Webhooks API] List error:', error);\n    return jsonResponse({ error: error.message || 'Failed to list outbound webhooks' }, 500);\n  }\n}\n\n/**\n * Update an outbound webhook\n * PATCH /api/outbound-webhooks/:id\n */\nexport async function updateOutboundWebhook(request: Request, env: Env, userId: string, webhookId: string): Promise<Response> {\n  try {\n    // Verify ownership\n    const webhook = await env.DB.prepare(\n      'SELECT user_id FROM outbound_webhooks WHERE id = ?'\n    ).bind(webhookId).first() as any;\n\n    if (!webhook) {\n      return jsonResponse({ error: 'Outbound webhook not found' }, 404);\n    }\n\n    if (webhook.user_id !== userId) {\n      return jsonResponse({ error: 'Forbidden' }, 403);\n    }\n\n    const body = await request.json() as any;\n    const { name, destination_url, is_active, events } = body;\n\n    // Build update query dynamically\n    const updates: string[] = [];\n    const params: any[] = [];\n\n    if (name !== undefined) {\n      updates.push('name = ?');\n      params.push(name);\n    }\n\n    if (destination_url !== undefined) {\n      try {\n        new URL(destination_url);\n      } catch (e) {\n        return jsonResponse({ error: 'Invalid destination_url' }, 400);\n      }\n      updates.push('destination_url = ?');\n      params.push(destination_url);\n    }\n\n    if (is_active !== undefined) {\n      updates.push('is_active = ?');\n      params.push(is_active ? 1 : 0);\n    }\n\n    if (events !== undefined) {\n      const validEvents = ['call.started', 'call.ended'];\n      const eventList = Array.isArray(events) ? events : events.split(',').map((e: string) => e.trim());\n      for (const event of eventList) {\n        if (!validEvents.includes(event)) {\n          return jsonResponse({ error: `Invalid event: ${event}` }, 400);\n        }\n      }\n      updates.push('events = ?');\n      params.push(eventList.join(','));\n    }\n\n    if (updates.length === 0) {\n      return jsonResponse({ error: 'No fields to update' }, 400);\n    }\n\n    updates.push('updated_at = ?');\n    params.push(now());\n\n    params.push(webhookId);\n\n    await env.DB.prepare(\n      `UPDATE outbound_webhooks SET ${updates.join(', ')} WHERE id = ?`\n    ).bind(...params).run();\n\n    return jsonResponse({ message: 'Outbound webhook updated successfully' });\n  } catch (error: any) {\n    console.error('[Outbound Webhooks API] Update error:', error);\n    return jsonResponse({ error: error.message || 'Failed to update outbound webhook' }, 500);\n  }\n}\n\n/**\n * Delete an outbound webhook\n * DELETE /api/outbound-webhooks/:id\n */\nexport async function deleteOutboundWebhook(env: Env, userId: string, webhookId: string): Promise<Response> {\n  try {\n    // Verify ownership\n    const webhook = await env.DB.prepare(\n      'SELECT user_id FROM outbound_webhooks WHERE id = ?'\n    ).bind(webhookId).first() as any;\n\n    if (!webhook) {\n      return jsonResponse({ error: 'Outbound webhook not found' }, 404);\n    }\n\n    if (webhook.user_id !== userId) {\n      return jsonResponse({ error: 'Forbidden' }, 403);\n    }\n\n    await env.DB.prepare(\n      'DELETE FROM outbound_webhooks WHERE id = ?'\n    ).bind(webhookId).run();\n\n    return jsonResponse({ message: 'Outbound webhook deleted successfully' });\n  } catch (error: any) {\n    console.error('[Outbound Webhooks API] Delete error:', error);\n    return jsonResponse({ error: error.message || 'Failed to delete outbound webhook' }, 500);\n  }\n}\n\n/**\n * Get outbound webhook delivery logs\n * GET /api/outbound-webhooks/:id/logs\n */\nexport async function getOutboundWebhookLogs(env: Env, userId: string, webhookId: string): Promise<Response> {\n  try {\n    // Verify ownership\n    const webhook = await env.DB.prepare(\n      'SELECT user_id FROM outbound_webhooks WHERE id = ?'\n    ).bind(webhookId).first() as any;\n\n    if (!webhook) {\n      return jsonResponse({ error: 'Outbound webhook not found' }, 404);\n    }\n\n    if (webhook.user_id !== userId) {\n      return jsonResponse({ error: 'Forbidden' }, 403);\n    }\n\n    // Get logs\n    const { results } = await env.DB.prepare(\n      `SELECT id, event_type, call_id, status, http_status, response_body, error_message, retry_count, created_at\n       FROM outbound_webhook_logs\n       WHERE outbound_webhook_id = ?\n       ORDER BY created_at DESC\n       LIMIT 100`\n    ).bind(webhookId).all();\n\n    return jsonResponse({ logs: results || [] });\n  } catch (error: any) {\n    console.error('[Outbound Webhooks API] Get logs error:', error);\n    return jsonResponse({ error: error.message || 'Failed to get webhook logs' }, 500);\n  }\n}\n", "/**\n * Salesforce Integration Service\n *\n * Handles OAuth 2.0 authentication and REST API interactions with Salesforce\n * - OAuth: Authorization code flow with token refresh\n * - Search: SOSL phone number search across Leads & Contacts\n * - Sync: Create Tasks (call logs) and Events (appointments)\n */\n\ninterface D1Database {\n  prepare(query: string): any;\n}\n\ninterface Env {\n  SALESFORCE_CLIENT_ID: string;\n  SALESFORCE_CLIENT_SECRET: string;\n}\n\n// ============================================\n// CONFIGURATION\n// ============================================\n\nconst OAUTH_CALLBACK_URL = 'https://api.voice-config.channelautomation.com/api/salesforce/oauth/callback';\n\n// Salesforce OAuth endpoints (use login.salesforce.com for production, test.salesforce.com for sandbox)\nconst SALESFORCE_AUTH_URL = 'https://login.salesforce.com/services/oauth2/authorize';\nconst SALESFORCE_TOKEN_URL = 'https://login.salesforce.com/services/oauth2/token';\n\n// ============================================\n// OAUTH 2.0 FLOW\n// ============================================\n\n/**\n * Step 1: Generate OAuth authorization URL\n * User will be redirected here to approve access\n */\nexport function buildAuthUrl(workspaceId: string, env: Env): string {\n  const params = new URLSearchParams({\n    response_type: 'code',\n    client_id: env.SALESFORCE_CLIENT_ID,\n    redirect_uri: OAUTH_CALLBACK_URL,\n    scope: 'api refresh_token',\n    state: workspaceId, // Pass workspace ID to identify user on callback\n  });\n\n  return `${SALESFORCE_AUTH_URL}?${params.toString()}`;\n}\n\n/**\n * Step 2: Exchange authorization code for access & refresh tokens\n * Called after user approves and Salesforce redirects back with code\n */\nexport async function exchangeCodeForToken(code: string, env: Env): Promise<{\n  access_token: string;\n  refresh_token: string;\n  instance_url: string;\n  expires_in: number;\n}> {\n  const params = new URLSearchParams({\n    grant_type: 'authorization_code',\n    code,\n    client_id: env.SALESFORCE_CLIENT_ID,\n    client_secret: env.SALESFORCE_CLIENT_SECRET,\n    redirect_uri: OAUTH_CALLBACK_URL,\n  });\n\n  const response = await fetch(SALESFORCE_TOKEN_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Salesforce OAuth token exchange failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    refresh_token: data.refresh_token,\n    instance_url: data.instance_url,\n    expires_in: data.issued_at ? Math.floor(Date.now() / 1000) + 7200 : Math.floor(Date.now() / 1000) + 7200, // 2 hours\n  };\n}\n\n/**\n * Step 3: Refresh access token when it expires\n * Access tokens expire in ~2 hours, use refresh token to get new one\n */\nexport async function refreshAccessToken(refreshToken: string, env: Env): Promise<{\n  access_token: string;\n  instance_url: string;\n  expires_in: number;\n}> {\n  const params = new URLSearchParams({\n    grant_type: 'refresh_token',\n    refresh_token: refreshToken,\n    client_id: env.SALESFORCE_CLIENT_ID,\n    client_secret: env.SALESFORCE_CLIENT_SECRET,\n  });\n\n  const response = await fetch(SALESFORCE_TOKEN_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Salesforce token refresh failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    instance_url: data.instance_url,\n    expires_in: Math.floor(Date.now() / 1000) + 7200, // 2 hours\n  };\n}\n\n/**\n * Helper: Check if access token is expired and refresh if needed\n */\nexport async function ensureValidToken(\n  db: D1Database,\n  workspaceId: string,\n  env: Env\n): Promise<{ instanceUrl: string; accessToken: string }> {\n  // Get current tokens from database\n  const settings = await db.prepare(\n    'SELECT salesforce_instance_url, salesforce_access_token, salesforce_refresh_token, salesforce_token_expires_at FROM workspace_settings WHERE workspace_id = ?'\n  ).bind(workspaceId).first();\n\n  if (!settings || !settings.salesforce_refresh_token) {\n    throw new Error('Salesforce not connected for this workspace');\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  const expiresAt = settings.salesforce_token_expires_at || 0;\n\n  // If token expires in less than 5 minutes, refresh it\n  if (now >= expiresAt - 300) {\n    console.log('[Salesforce] Access token expired, refreshing...');\n    const newTokens = await refreshAccessToken(settings.salesforce_refresh_token, env);\n\n    // Update database with new tokens\n    await db.prepare(\n      'UPDATE workspace_settings SET salesforce_access_token = ?, salesforce_instance_url = ?, salesforce_token_expires_at = ? WHERE workspace_id = ?'\n    ).bind(\n      newTokens.access_token,\n      newTokens.instance_url,\n      newTokens.expires_in,\n      workspaceId\n    ).run();\n\n    return {\n      instanceUrl: newTokens.instance_url,\n      accessToken: newTokens.access_token,\n    };\n  }\n\n  return {\n    instanceUrl: settings.salesforce_instance_url,\n    accessToken: settings.salesforce_access_token,\n  };\n}\n\n// ============================================\n// PHONE NUMBER SEARCH (SOSL)\n// ============================================\n\n/**\n * Search for Lead or Contact by phone number using SOSL\n * SOSL automatically handles different phone formats\n * Priority: Leads first (new prospects), then Contacts (existing customers)\n */\nexport async function searchByPhone(\n  instanceUrl: string,\n  accessToken: string,\n  phoneNumber: string\n): Promise<{ id: string; type: 'Lead' | 'Contact' } | null> {\n  // Clean phone number (remove non-digits)\n  const cleanPhone = phoneNumber.replace(/\\D/g, '');\n\n  // SOSL query: Search in Phone and MobilePhone fields\n  // Returns Leads first, then Contacts\n  const soslQuery = `FIND {${cleanPhone}} IN PHONE FIELDS RETURNING Lead(Id, Phone, MobilePhone), Contact(Id, Phone, MobilePhone)`;\n\n  const searchUrl = `${instanceUrl}/services/data/v59.0/search?q=${encodeURIComponent(soslQuery)}`;\n\n  const response = await fetch(searchUrl, {\n    method: 'GET',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error('[Salesforce] Phone search failed:', error);\n    throw new Error(`Salesforce phone search failed: ${error}`);\n  }\n\n  const data = await response.json();\n\n  // Check if any Leads found (priority)\n  if (data.searchRecords && data.searchRecords.length > 0) {\n    const firstResult = data.searchRecords[0];\n\n    // Determine type from attributes\n    const type = firstResult.attributes?.type as 'Lead' | 'Contact';\n\n    console.log(`[Salesforce] Found ${type}: ${firstResult.Id}`);\n    return {\n      id: firstResult.Id,\n      type: type,\n    };\n  }\n\n  console.log('[Salesforce] No Lead or Contact found for phone:', phoneNumber);\n  return null;\n}\n\n// ============================================\n// TASK CREATION (CALL LOGS)\n// ============================================\n\n/**\n * Create a Task (call log) on Lead or Contact record\n * Task appears in Salesforce Activity History\n */\nexport async function createCallLogTask(\n  instanceUrl: string,\n  accessToken: string,\n  leadOrContactId: string,\n  callData: {\n    phoneNumber: string;\n    duration: number; // seconds\n    summary: string;\n    callType: 'inbound' | 'outbound';\n    callStartTime: string; // ISO 8601\n  }\n): Promise<string> {\n  const taskPayload = {\n    WhoId: leadOrContactId, // Links to Lead (00Q) or Contact (003)\n    Subject: 'Inbound Call',\n    Type: 'Call',\n    CallType: callData.callType === 'inbound' ? 'Inbound' : 'Outbound',\n    Status: 'Completed',\n    ActivityDate: callData.callStartTime.split('T')[0], // Just the date part\n    Description: `Call Duration: ${Math.floor(callData.duration / 60)} min ${callData.duration % 60} sec\\nPhone: ${callData.phoneNumber}\\n\\n${callData.summary}`,\n    TaskSubtype: 'Call',\n    Priority: 'Normal',\n  };\n\n  const response = await fetch(`${instanceUrl}/services/data/v59.0/sobjects/Task`, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(taskPayload),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error('[Salesforce] Task creation failed:', error);\n    throw new Error(`Salesforce task creation failed: ${error}`);\n  }\n\n  const result = await response.json();\n  console.log('[Salesforce] Task created:', result.id);\n  return result.id; // Returns Task ID (starts with 00T)\n}\n\n// ============================================\n// EVENT CREATION (APPOINTMENTS)\n// ============================================\n\n/**\n * Parse appointment date and time strings into Date object\n */\nfunction parseAppointmentDateTime(date: string, time: string): Date {\n  // date format: \"2025-01-15\" or \"January 15, 2025\"\n  // time format: \"2:00 PM\" or \"14:00\"\n\n  // Try to parse date\n  let dateObj: Date;\n\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(date)) {\n    // ISO format: \"2025-01-15\"\n    dateObj = new Date(date);\n  } else {\n    // Try natural language: \"January 15, 2025\"\n    dateObj = new Date(date);\n  }\n\n  // Parse time (handle AM/PM)\n  const timeMatch = time.match(/(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (!timeMatch) {\n    throw new Error(`Invalid time format: ${time}`);\n  }\n\n  let hours = parseInt(timeMatch[1]);\n  const minutes = parseInt(timeMatch[2] || '0');\n  const ampm = timeMatch[3]?.toLowerCase();\n\n  // Convert to 24-hour format\n  if (ampm === 'pm' && hours !== 12) {\n    hours += 12;\n  } else if (ampm === 'am' && hours === 12) {\n    hours = 0;\n  }\n\n  dateObj.setHours(hours, minutes, 0, 0);\n  return dateObj;\n}\n\n/**\n * Create an Event (appointment) on Lead or Contact record\n * Event appears in Salesforce Calendar and syncs to Outlook/Google Calendar\n */\nexport async function createAppointmentEvent(\n  instanceUrl: string,\n  accessToken: string,\n  leadOrContactId: string,\n  appointmentData: {\n    date: string;           // \"2025-01-15\"\n    time: string;           // \"2:00 PM\"\n    type?: string;          // \"Consultation\"\n    notes?: string;         // \"Bring ID\"\n    duration?: number;      // 60 (minutes)\n  },\n  callSummary: string\n): Promise<string | null> {\n  try {\n    // Parse date and time\n    const startDateTime = parseAppointmentDateTime(\n      appointmentData.date,\n      appointmentData.time\n    );\n\n    // Calculate end time (default 1 hour)\n    const duration = appointmentData.duration || 60;\n    const endDateTime = new Date(startDateTime.getTime() + duration * 60000);\n\n    // Build Event payload\n    const eventPayload = {\n      WhoId: leadOrContactId,\n      Subject: `${appointmentData.type || 'Appointment'} - Scheduled via Voice AI`,\n      StartDateTime: startDateTime.toISOString(),\n      EndDateTime: endDateTime.toISOString(),\n      Description: `Appointment scheduled during call.\\n\\n${appointmentData.notes ? `Notes: ${appointmentData.notes}\\n\\n` : ''}Call Summary:\\n${callSummary}`,\n      IsReminderSet: true,\n      ReminderDateTime: new Date(startDateTime.getTime() - 3600000).toISOString(), // 1 hour before\n      Type: 'Meeting',\n      ShowAs: 'Busy',\n    };\n\n    const response = await fetch(`${instanceUrl}/services/data/v59.0/sobjects/Event`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(eventPayload),\n    });\n\n    if (!response.ok) {\n      const error = await response.text();\n      console.error('[Salesforce] Event creation failed:', error);\n      throw new Error(`Salesforce event creation failed: ${error}`);\n    }\n\n    const result = await response.json();\n    console.log('[Salesforce] Event created:', result.id);\n    return result.id; // Returns Event ID (starts with 00U)\n  } catch (error: any) {\n    console.error('[Salesforce] Appointment creation error:', error.message);\n    return null; // Don't fail the whole sync if appointment fails\n  }\n}\n\n// ============================================\n// MAIN SYNC FUNCTION\n// ============================================\n\n/**\n * Main function: Sync call to Salesforce\n * 1. Search for Lead/Contact by phone\n * 2. Create Task (call log)\n * 3. Create Event (if appointment data exists)\n */\nexport async function syncCallToSalesforce(\n  db: D1Database,\n  workspaceId: string,\n  callId: string,\n  callData: {\n    phoneNumber: string;\n    duration: number;\n    summary: string;\n    callType: 'inbound' | 'outbound';\n    callStartTime: string;\n    appointmentData?: {\n      date: string;\n      time: string;\n      type?: string;\n      notes?: string;\n      duration?: number;\n    };\n  },\n  env: Env\n): Promise<{\n  success: boolean;\n  salesforceRecordId?: string;\n  salesforceTaskId?: string;\n  salesforceEventId?: string;\n  error?: string;\n}> {\n  try {\n    // Step 1: Ensure we have valid access token\n    const { instanceUrl, accessToken } = await ensureValidToken(db, workspaceId, env);\n\n    // Step 2: Search for Lead/Contact by phone\n    const record = await searchByPhone(instanceUrl, accessToken, callData.phoneNumber);\n\n    if (!record) {\n      // Log as \"skipped\" - phone number not found in Salesforce\n      await db.prepare(\n        'INSERT INTO salesforce_sync_logs (id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\n      ).bind(\n        `sf_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        workspaceId,\n        callId,\n        'skipped',\n        'Phone number not found in Salesforce',\n        callData.phoneNumber,\n        Math.floor(Date.now() / 1000)\n      ).run();\n\n      return {\n        success: false,\n        error: 'Phone number not found in Salesforce',\n      };\n    }\n\n    // Step 3: Create Task (call log)\n    const taskId = await createCallLogTask(instanceUrl, accessToken, record.id, callData);\n\n    // Step 4: Create Event (if appointment data exists)\n    let eventId: string | null = null;\n    if (callData.appointmentData) {\n      eventId = await createAppointmentEvent(\n        instanceUrl,\n        accessToken,\n        record.id,\n        callData.appointmentData,\n        callData.summary\n      );\n    }\n\n    // Step 5: Log success\n    await db.prepare(\n      'INSERT INTO salesforce_sync_logs (id, workspace_id, call_id, salesforce_record_id, salesforce_task_id, salesforce_event_id, appointment_created, status, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `sf_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      workspaceId,\n      callId,\n      record.id,\n      taskId,\n      eventId,\n      eventId ? 1 : 0,\n      'success',\n      callData.phoneNumber,\n      Math.floor(Date.now() / 1000)\n    ).run();\n\n    console.log('[Salesforce] Sync completed successfully');\n    return {\n      success: true,\n      salesforceRecordId: record.id,\n      salesforceTaskId: taskId,\n      salesforceEventId: eventId || undefined,\n    };\n  } catch (error: any) {\n    // Log error\n    await db.prepare(\n      'INSERT INTO salesforce_sync_logs (id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `sf_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      workspaceId,\n      callId,\n      'error',\n      error.message,\n      callData.phoneNumber,\n      Math.floor(Date.now() / 1000)\n    ).run();\n\n    console.error('[Salesforce] Sync failed:', error.message);\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n", "/**\n * Microsoft Dynamics 365 Integration Service\n *\n * Handles OAuth 2.0 authentication and REST API interactions with Dynamics 365\n * - OAuth: Authorization code flow with token refresh\n * - Search: Phone number search across Leads & Contacts\n * - Sync: Create Phone Call activities (call logs) and Appointments\n */\n\ninterface D1Database {\n  prepare(query: string): any;\n}\n\ninterface Env {\n  DYNAMICS_CLIENT_ID: string;\n  DYNAMICS_CLIENT_SECRET: string;\n  DYNAMICS_TENANT_ID: string;\n}\n\n// ============================================\n// CONFIGURATION\n// ============================================\n\nconst OAUTH_CALLBACK_URL = 'https://api.voice-config.channelautomation.com/api/dynamics/oauth/callback';\n\n// Microsoft Dynamics 365 OAuth endpoints\nconst DYNAMICS_AUTH_URL = 'https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize';\nconst DYNAMICS_TOKEN_URL = 'https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token';\n\n// ============================================\n// OAUTH 2.0 FLOW\n// ============================================\n\n/**\n * Step 1: Generate OAuth authorization URL\n * User will be redirected here to approve access\n */\nexport function buildAuthUrl(workspaceId: string, env: Env, instanceUrl: string): string {\n  const authUrl = DYNAMICS_AUTH_URL.replace('{tenant}', env.DYNAMICS_TENANT_ID);\n\n  const params = new URLSearchParams({\n    client_id: env.DYNAMICS_CLIENT_ID,\n    response_type: 'code',\n    redirect_uri: OAUTH_CALLBACK_URL,\n    response_mode: 'query',\n    scope: `${instanceUrl}/user_impersonation offline_access`,\n    state: `${workspaceId}|${instanceUrl}`, // Pass workspace ID and instance URL\n  });\n\n  return `${authUrl}?${params.toString()}`;\n}\n\n/**\n * Step 2: Exchange authorization code for access & refresh tokens\n * Called after user approves and Microsoft redirects back with code\n */\nexport async function exchangeCodeForToken(\n  code: string,\n  env: Env,\n  instanceUrl: string\n): Promise<{\n  access_token: string;\n  refresh_token: string;\n  expires_in: number;\n}> {\n  const tokenUrl = DYNAMICS_TOKEN_URL.replace('{tenant}', env.DYNAMICS_TENANT_ID);\n\n  const params = new URLSearchParams({\n    client_id: env.DYNAMICS_CLIENT_ID,\n    client_secret: env.DYNAMICS_CLIENT_SECRET,\n    grant_type: 'authorization_code',\n    code,\n    redirect_uri: OAUTH_CALLBACK_URL,\n    scope: `${instanceUrl}/user_impersonation offline_access`,\n  });\n\n  const response = await fetch(tokenUrl, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Dynamics 365 OAuth token exchange failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    refresh_token: data.refresh_token,\n    expires_in: Math.floor(Date.now() / 1000) + (data.expires_in || 3600),\n  };\n}\n\n/**\n * Step 3: Refresh access token when it expires\n * Access tokens expire in ~1 hour, use refresh token to get new one\n */\nexport async function refreshAccessToken(\n  refreshToken: string,\n  env: Env,\n  instanceUrl: string\n): Promise<{\n  access_token: string;\n  expires_in: number;\n}> {\n  const tokenUrl = DYNAMICS_TOKEN_URL.replace('{tenant}', env.DYNAMICS_TENANT_ID);\n\n  const params = new URLSearchParams({\n    client_id: env.DYNAMICS_CLIENT_ID,\n    client_secret: env.DYNAMICS_CLIENT_SECRET,\n    grant_type: 'refresh_token',\n    refresh_token: refreshToken,\n    scope: `${instanceUrl}/user_impersonation offline_access`,\n  });\n\n  const response = await fetch(tokenUrl, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n    },\n    body: params.toString(),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(`Dynamics 365 token refresh failed: ${error}`);\n  }\n\n  const data = await response.json();\n  return {\n    access_token: data.access_token,\n    expires_in: Math.floor(Date.now() / 1000) + (data.expires_in || 3600),\n  };\n}\n\n/**\n * Helper: Check if access token is expired and refresh if needed\n */\nexport async function ensureValidToken(\n  db: D1Database,\n  workspaceId: string,\n  env: Env\n): Promise<{ instanceUrl: string; accessToken: string }> {\n  // Get current tokens from database\n  const settings = await db.prepare(\n    'SELECT dynamics_instance_url, dynamics_access_token, dynamics_refresh_token, dynamics_token_expires_at FROM workspace_settings WHERE workspace_id = ?'\n  ).bind(workspaceId).first();\n\n  if (!settings || !settings.dynamics_refresh_token) {\n    throw new Error('Dynamics 365 not connected for this workspace');\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  const expiresAt = settings.dynamics_token_expires_at || 0;\n\n  // If token expires in less than 5 minutes, refresh it\n  if (now >= expiresAt - 300) {\n    console.log('[Dynamics 365] Access token expired, refreshing...');\n    const newTokens = await refreshAccessToken(\n      settings.dynamics_refresh_token,\n      env,\n      settings.dynamics_instance_url\n    );\n\n    // Update database with new tokens\n    await db.prepare(\n      'UPDATE workspace_settings SET dynamics_access_token = ?, dynamics_token_expires_at = ? WHERE workspace_id = ?'\n    ).bind(\n      newTokens.access_token,\n      newTokens.expires_in,\n      workspaceId\n    ).run();\n\n    return {\n      instanceUrl: settings.dynamics_instance_url,\n      accessToken: newTokens.access_token,\n    };\n  }\n\n  return {\n    instanceUrl: settings.dynamics_instance_url,\n    accessToken: settings.dynamics_access_token,\n  };\n}\n\n// ============================================\n// PHONE NUMBER SEARCH\n// ============================================\n\n/**\n * Search for Lead or Contact by phone number\n * Searches in telephone1, mobilephone, and telephone2 fields\n * Priority: Leads first (new prospects), then Contacts (existing customers)\n */\nexport async function searchByPhone(\n  instanceUrl: string,\n  accessToken: string,\n  phoneNumber: string\n): Promise<{ id: string; type: 'lead' | 'contact' } | null> {\n  // Clean phone number (remove non-digits)\n  const cleanPhone = phoneNumber.replace(/\\D/g, '');\n\n  // Try searching Leads first\n  const leadFilter = `$filter=contains(telephone1,'${cleanPhone}') or contains(mobilephone,'${cleanPhone}') or contains(telephone2,'${cleanPhone}')&$select=leadid,fullname,telephone1,mobilephone`;\n\n  const leadResponse = await fetch(\n    `${instanceUrl}/api/data/v9.2/leads?${leadFilter}`,\n    {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Accept': 'application/json',\n        'OData-MaxVersion': '4.0',\n        'OData-Version': '4.0',\n      },\n    }\n  );\n\n  if (leadResponse.ok) {\n    const leadData = await leadResponse.json();\n    if (leadData.value && leadData.value.length > 0) {\n      console.log(`[Dynamics 365] Found Lead: ${leadData.value[0].leadid}`);\n      return {\n        id: leadData.value[0].leadid,\n        type: 'lead',\n      };\n    }\n  }\n\n  // If no lead found, search Contacts\n  const contactFilter = `$filter=contains(telephone1,'${cleanPhone}') or contains(mobilephone,'${cleanPhone}') or contains(telephone2,'${cleanPhone}')&$select=contactid,fullname,telephone1,mobilephone`;\n\n  const contactResponse = await fetch(\n    `${instanceUrl}/api/data/v9.2/contacts?${contactFilter}`,\n    {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Accept': 'application/json',\n        'OData-MaxVersion': '4.0',\n        'OData-Version': '4.0',\n      },\n    }\n  );\n\n  if (contactResponse.ok) {\n    const contactData = await contactResponse.json();\n    if (contactData.value && contactData.value.length > 0) {\n      console.log(`[Dynamics 365] Found Contact: ${contactData.value[0].contactid}`);\n      return {\n        id: contactData.value[0].contactid,\n        type: 'contact',\n      };\n    }\n  }\n\n  console.log('[Dynamics 365] No Lead or Contact found for phone:', phoneNumber);\n  return null;\n}\n\n// ============================================\n// CREATE NEW LEAD\n// ============================================\n\n/**\n * Create a new Lead in Dynamics 365 when no existing contact is found\n */\nexport async function createNewLead(\n  instanceUrl: string,\n  accessToken: string,\n  leadData: {\n    phoneNumber: string;\n    fullName?: string;\n    companyName?: string;\n    subject?: string;\n  }\n): Promise<string> {\n  // Generate a subject/description for the lead\n  const subject = leadData.subject || `Voice AI Call - ${leadData.phoneNumber}`;\n\n  const payload: any = {\n    telephone1: leadData.phoneNumber,\n    subject: subject,\n    leadsourcecode: 3, // Phone (valid values: 1-10, 3 typically = Phone)\n    description: `Lead created from voice AI call on ${new Date().toLocaleString()}`,\n  };\n\n  // Add full name if provided (split into first/last name)\n  if (leadData.fullName) {\n    const nameParts = leadData.fullName.trim().split(' ');\n    if (nameParts.length === 1) {\n      payload.lastname = nameParts[0];\n    } else {\n      payload.firstname = nameParts.slice(0, -1).join(' ');\n      payload.lastname = nameParts[nameParts.length - 1];\n    }\n  } else {\n    // If no name provided, use phone number as last name\n    payload.lastname = leadData.phoneNumber;\n  }\n\n  // Add company name if provided\n  if (leadData.companyName) {\n    payload.companyname = leadData.companyName;\n  }\n\n  console.log('[Dynamics 365] Creating new Lead:', payload);\n\n  const response = await fetch(`${instanceUrl}/api/data/v9.2/leads`, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Accept': 'application/json',\n      'Content-Type': 'application/json',\n      'OData-MaxVersion': '4.0',\n      'OData-Version': '4.0',\n      'Prefer': 'return=representation',\n    },\n    body: JSON.stringify(payload),\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    throw new Error(`Failed to create Lead: ${response.status} ${errorText}`);\n  }\n\n  const newLead = await response.json();\n  const leadId = newLead.leadid;\n\n  console.log(`[Dynamics 365] Successfully created Lead: ${leadId}`);\n  return leadId;\n}\n\n// ============================================\n// PHONE CALL ACTIVITY CREATION (CALL LOGS)\n// ============================================\n\n/**\n * Create a Phone Call activity on Lead or Contact record\n * Phone Call appears in Dynamics 365 Activity History\n */\nexport async function createCallLogActivity(\n  instanceUrl: string,\n  accessToken: string,\n  recordId: string,\n  recordType: 'lead' | 'contact',\n  callData: {\n    phoneNumber: string;\n    duration: number; // seconds\n    summary: string;\n    callType: 'inbound' | 'outbound';\n    callStartTime: string; // ISO 8601\n  }\n): Promise<string> {\n  const durationMinutes = Math.floor(callData.duration / 60);\n\n  // Determine the regarding field based on record type\n  const regardingField = recordType === 'lead'\n    ? 'regardingobjectid_lead_phonecall@odata.bind'\n    : 'regardingobjectid_contact_phonecall@odata.bind';\n\n  const regardingValue = recordType === 'lead'\n    ? `/leads(${recordId})`\n    : `/contacts(${recordId})`;\n\n  const activityPayload = {\n    subject: 'Inbound Call',\n    [regardingField]: regardingValue,\n    phonenumber: callData.phoneNumber,\n    actualdurationminutes: durationMinutes,\n    actualstart: callData.callStartTime,\n    actualend: new Date(new Date(callData.callStartTime).getTime() + callData.duration * 1000).toISOString(),\n    description: `Call Duration: ${durationMinutes} min ${callData.duration % 60} sec\\nPhone: ${callData.phoneNumber}\\n\\n${callData.summary}`,\n    directioncode: callData.callType === 'inbound',\n    statecode: 1, // Completed\n    statuscode: 4, // Received (valid status for completed state)\n  };\n\n  const response = await fetch(`${instanceUrl}/api/data/v9.2/phonecalls`, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Accept': 'application/json',\n      'Content-Type': 'application/json',\n      'OData-MaxVersion': '4.0',\n      'OData-Version': '4.0',\n    },\n    body: JSON.stringify(activityPayload),\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    console.error('[Dynamics 365] Phone Call creation failed:', error);\n    throw new Error(`Dynamics 365 phone call creation failed: ${error}`);\n  }\n\n  const activityId = response.headers.get('OData-EntityId')?.match(/\\(([^)]+)\\)/)?.[1] || '';\n  console.log('[Dynamics 365] Phone Call created:', activityId);\n  return activityId;\n}\n\n// ============================================\n// APPOINTMENT CREATION\n// ============================================\n\n/**\n * Parse appointment date and time strings into Date object\n */\nfunction parseAppointmentDateTime(date: string, time: string): Date {\n  let dateObj: Date;\n\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(date)) {\n    dateObj = new Date(date);\n  } else {\n    dateObj = new Date(date);\n  }\n\n  const timeMatch = time.match(/(\\d{1,2}):?(\\d{2})?\\s*(am|pm)?/i);\n  if (!timeMatch) {\n    throw new Error(`Invalid time format: ${time}`);\n  }\n\n  let hours = parseInt(timeMatch[1]);\n  const minutes = parseInt(timeMatch[2] || '0');\n  const ampm = timeMatch[3]?.toLowerCase();\n\n  if (ampm === 'pm' && hours !== 12) {\n    hours += 12;\n  } else if (ampm === 'am' && hours === 12) {\n    hours = 0;\n  }\n\n  dateObj.setHours(hours, minutes, 0, 0);\n  return dateObj;\n}\n\n/**\n * Create an Appointment activity on Lead or Contact record\n * Appointment appears in Dynamics 365 Calendar\n */\nexport async function createAppointmentActivity(\n  instanceUrl: string,\n  accessToken: string,\n  recordId: string,\n  recordType: 'lead' | 'contact',\n  appointmentData: {\n    date: string;\n    time: string;\n    type?: string;\n    notes?: string;\n    duration?: number;\n  },\n  callSummary: string\n): Promise<string | null> {\n  try {\n    const startDateTime = parseAppointmentDateTime(\n      appointmentData.date,\n      appointmentData.time\n    );\n\n    const duration = appointmentData.duration || 60;\n    const endDateTime = new Date(startDateTime.getTime() + duration * 60000);\n\n    const regardingField = recordType === 'lead'\n      ? 'regardingobjectid_lead_appointment@odata.bind'\n      : 'regardingobjectid_contact_appointment@odata.bind';\n\n    const regardingValue = recordType === 'lead'\n      ? `/leads(${recordId})`\n      : `/contacts(${recordId})`;\n\n    const appointmentPayload = {\n      subject: `${appointmentData.type || 'Appointment'} - Scheduled via Voice AI`,\n      [regardingField]: regardingValue,\n      scheduledstart: startDateTime.toISOString(),\n      scheduledend: endDateTime.toISOString(),\n      description: `Appointment scheduled during call.\\n\\n${appointmentData.notes ? `Notes: ${appointmentData.notes}\\n\\n` : ''}Call Summary:\\n${callSummary}`,\n      statecode: 0, // Open\n      statuscode: 1, // Free\n    };\n\n    const response = await fetch(`${instanceUrl}/api/data/v9.2/appointments`, {\n      method: 'POST',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Accept': 'application/json',\n        'Content-Type': 'application/json',\n        'OData-MaxVersion': '4.0',\n        'OData-Version': '4.0',\n      },\n      body: JSON.stringify(appointmentPayload),\n    });\n\n    if (!response.ok) {\n      const error = await response.text();\n      console.error('[Dynamics 365] Appointment creation failed:', error);\n      throw new Error(`Dynamics 365 appointment creation failed: ${error}`);\n    }\n\n    const activityId = response.headers.get('OData-EntityId')?.match(/\\(([^)]+)\\)/)?.[1] || '';\n    console.log('[Dynamics 365] Appointment created:', activityId);\n    return activityId;\n  } catch (error: any) {\n    console.error('[Dynamics 365] Appointment creation error:', error.message);\n    return null;\n  }\n}\n\n// ============================================\n// MAIN SYNC FUNCTION\n// ============================================\n\n/**\n * Main function: Sync call to Dynamics 365\n * 1. Search for Lead/Contact by phone\n * 2. Create Phone Call activity (call log)\n * 3. Create Appointment (if appointment data exists)\n */\nexport async function syncCallToDynamics(\n  db: D1Database,\n  workspaceId: string,\n  callId: string,\n  callData: {\n    phoneNumber: string;\n    duration: number;\n    summary: string;\n    callType: 'inbound' | 'outbound';\n    callStartTime: string;\n    appointmentData?: {\n      date: string;\n      time: string;\n      type?: string;\n      notes?: string;\n      duration?: number;\n    };\n  },\n  env: Env\n): Promise<{\n  success: boolean;\n  dynamicsRecordId?: string;\n  dynamicsActivityId?: string;\n  dynamicsAppointmentId?: string;\n  error?: string;\n}> {\n  try {\n    // Step 1: Ensure we have valid access token\n    const { instanceUrl, accessToken } = await ensureValidToken(db, workspaceId, env);\n\n    // Step 2: Search for Lead/Contact by phone\n    let record = await searchByPhone(instanceUrl, accessToken, callData.phoneNumber);\n    let leadCreated = false;\n\n    if (!record) {\n      // No existing Lead/Contact found - create a new Lead\n      console.log('[Dynamics 365] No contact found, creating new Lead for:', callData.phoneNumber);\n\n      try {\n        const newLeadId = await createNewLead(instanceUrl, accessToken, {\n          phoneNumber: callData.phoneNumber,\n          subject: `Voice AI Call - ${callData.phoneNumber}`,\n        });\n\n        record = {\n          id: newLeadId,\n          type: 'lead',\n        };\n        leadCreated = true;\n\n        console.log('[Dynamics 365] Created new Lead:', newLeadId);\n      } catch (createError: any) {\n        console.error('[Dynamics 365] Failed to create new Lead:', createError.message);\n\n        // Log as \"error\" - failed to create Lead\n        await db.prepare(\n          'INSERT INTO dynamics_sync_logs (id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\n        ).bind(\n          `dyn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n          workspaceId,\n          callId,\n          'error',\n          `Failed to create Lead: ${createError.message}`,\n          callData.phoneNumber,\n          Math.floor(Date.now() / 1000)\n        ).run();\n\n        return {\n          success: false,\n          error: `Failed to create Lead: ${createError.message}`,\n        };\n      }\n    }\n\n    // Step 3: Create Phone Call activity (call log)\n    const activityId = await createCallLogActivity(\n      instanceUrl,\n      accessToken,\n      record.id,\n      record.type,\n      callData\n    );\n\n    // Step 4: Create Appointment (if appointment data exists)\n    let appointmentId: string | null = null;\n    if (callData.appointmentData) {\n      appointmentId = await createAppointmentActivity(\n        instanceUrl,\n        accessToken,\n        record.id,\n        record.type,\n        callData.appointmentData,\n        callData.summary\n      );\n    }\n\n    // Step 5: Log success\n    await db.prepare(\n      'INSERT INTO dynamics_sync_logs (id, workspace_id, call_id, dynamics_record_id, dynamics_activity_id, dynamics_appointment_id, appointment_created, lead_created, status, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `dyn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      workspaceId,\n      callId,\n      record.id,\n      activityId,\n      appointmentId,\n      appointmentId ? 1 : 0,\n      leadCreated ? 1 : 0,\n      'success',\n      callData.phoneNumber,\n      Math.floor(Date.now() / 1000)\n    ).run();\n\n    console.log('[Dynamics 365] Sync completed successfully');\n    return {\n      success: true,\n      dynamicsRecordId: record.id,\n      dynamicsActivityId: activityId,\n      dynamicsAppointmentId: appointmentId || undefined,\n    };\n  } catch (error: any) {\n    // Log error\n    await db.prepare(\n      'INSERT INTO dynamics_sync_logs (id, workspace_id, call_id, status, error_message, phone_number, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\n    ).bind(\n      `dyn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      workspaceId,\n      callId,\n      'error',\n      error.message,\n      callData.phoneNumber,\n      Math.floor(Date.now() / 1000)\n    ).run();\n\n    console.error('[Dynamics 365] Sync failed:', error.message);\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n", "/**\n * Cloudflare Worker API for Voice AI Dashboard\n * Provides D1 database access and authentication\n */\n\nimport {\n  generateId,\n  hashPassword,\n  verifyPassword,\n  generateToken,\n  verifyToken,\n  encrypt,\n  decrypt,\n  generateSalt,\n  generateTemporaryPassword\n} from './auth';\nimport { VoiceAICache, CACHE_TTL } from './cache';\nimport { dispatchToOutboundWebhooks } from './outbound-webhooks';\nimport {\n  createOutboundWebhook,\n  listOutboundWebhooks,\n  updateOutboundWebhook,\n  deleteOutboundWebhook,\n  getOutboundWebhookLogs\n} from './outbound-webhooks-api';\nimport {\n  buildAuthUrl,\n  exchangeCodeForToken,\n  ensureValidToken\n} from './salesforce-service';\nimport {\n  buildAuthUrl as buildHubSpotAuthUrl,\n  exchangeCodeForToken as exchangeHubSpotCodeForToken,\n  ensureValidToken as ensureValidHubSpotToken,\n  syncCallToHubSpot\n} from './hubspot-service';\nimport {\n  buildAuthUrl as buildDynamicsAuthUrl,\n  exchangeCodeForToken as exchangeDynamicsCodeForToken,\n  ensureValidToken as ensureValidDynamicsToken,\n  syncCallToDynamics\n} from './dynamics-service';\n\n// Cloudflare Worker types\ninterface D1Database {\n  prepare(query: string): D1PreparedStatement;\n}\n\ninterface D1PreparedStatement {\n  bind(...values: any[]): D1PreparedStatement;\n  all(): Promise<D1Result>;\n  first(): Promise<any>;\n  run(): Promise<D1Result>;\n}\n\ninterface D1Result {\n  results: any[];\n  success: boolean;\n  meta: any;\n}\n\ninterface KVNamespace {\n  get(key: string, type?: 'text' | 'json' | 'arrayBuffer' | 'stream'): Promise<any>;\n  put(key: string, value: string, options?: { expirationTtl?: number }): Promise<void>;\n  delete(key: string): Promise<void>;\n  list(options?: { prefix?: string }): Promise<{ keys: Array<{ name: string }> }>;\n}\n\ninterface R2Bucket {\n  put(key: string, value: ReadableStream | ArrayBuffer | string, options?: any): Promise<R2Object>;\n  get(key: string): Promise<R2Object | null>;\n  delete(key: string): Promise<void>;\n  head(key: string): Promise<R2Object | null>;\n}\n\ninterface R2Object {\n  key: string;\n  size: number;\n  etag: string;\n  httpEtag: string;\n  uploaded: Date;\n  body?: ReadableStream;\n  arrayBuffer(): Promise<ArrayBuffer>;\n}\n\ninterface ExecutionContext {\n  waitUntil(promise: Promise<any>): void;\n}\n\ninterface ScheduledEvent {\n  scheduledTime: number;\n  cron: string;\n}\n\nexport interface Env {\n  DB: D1Database;\n  CACHE: KVNamespace;\n  RECORDINGS: R2Bucket;\n  JWT_SECRET: string; // Set this in wrangler.toml as a secret\n  SALESFORCE_CLIENT_ID: string;\n  SALESFORCE_CLIENT_SECRET: string;\n  HUBSPOT_CLIENT_ID: string;\n  HUBSPOT_CLIENT_SECRET: string;\n  DYNAMICS_CLIENT_ID: string;\n  DYNAMICS_CLIENT_SECRET: string;\n  DYNAMICS_TENANT_ID: string;\n}\n\n// CORS headers\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': '*',\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, PATCH, DELETE, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type, Authorization',\n};\n\n// Helper: JSON response with CORS\nfunction jsonResponse(data: any, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: {\n      'Content-Type': 'application/json',\n      ...corsHeaders,\n    },\n  });\n}\n\n// Helper: Get current timestamp\nfunction now(): number {\n  return Math.floor(Date.now() / 1000);\n}\n\n// Helper: Analyze call with OpenAI\ninterface CallAnalysisResult {\n  intent: string;\n  sentiment: string;\n  outcome: string;\n  customer_name?: string;\n  customer_email?: string;\n  appointment_date?: string;\n  appointment_time?: string;\n  appointment_type?: string;\n  appointment_notes?: string;\n}\n\nasync function analyzeCallWithOpenAI(\n  summary: string,\n  transcript: string,\n  openaiApiKey: string\n): Promise<CallAnalysisResult | null> {\n  try {\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${openaiApiKey}`\n      },\n      body: JSON.stringify({\n        model: 'gpt-4o-mini',\n        messages: [\n          {\n            role: 'system',\n            content: `You are an AI that analyzes customer service call recordings. Analyze the call and respond with a JSON object containing:\n\nREQUIRED FIELDS:\n- intent: The customer's primary intent (e.g., \"Scheduling\", \"Information\", \"Complaint\", \"Purchase\", \"Support\")\n- sentiment: The overall sentiment of the call (\"Positive\", \"Neutral\", or \"Negative\")\n- outcome: The call outcome (\"Successful\", \"Unsuccessful\", \"Follow-up Required\", \"Abandoned\")\n\nOPTIONAL FIELDS (extract if mentioned in the call):\n- customer_name: The customer's full name (if mentioned)\n- customer_email: The customer's email address (if mentioned)\n\nAPPOINTMENT FIELDS (ONLY if intent is \"Scheduling\" and appointment was successfully booked):\n- appointment_date: The appointment date in ISO format (YYYY-MM-DD). Extract from phrases like \"tomorrow\", \"next Monday\", \"January 15th\", etc.\n- appointment_time: The appointment time in 12-hour format (e.g., \"2:00 PM\", \"10:30 AM\")\n- appointment_type: Type of appointment (e.g., \"Consultation\", \"Service Call\", \"Follow-up\", \"Installation\")\n- appointment_notes: Any special notes about the appointment (e.g., \"Bring ID\", \"Gate code: 1234\")\n\nIMPORTANT: Only include appointment fields if an appointment was ACTUALLY SCHEDULED. If the customer just inquired about scheduling but didn't book, do NOT include appointment fields.\n\nOnly respond with the JSON object, no additional text.`\n          },\n          {\n            role: 'user',\n            content: `Call Summary: ${summary}\\n\\nFull Transcript:\\n${transcript}`\n          }\n        ],\n        temperature: 0.3,\n        response_format: { type: 'json_object' }\n      })\n    });\n\n    if (!response.ok) {\n      console.error('OpenAI API error:', await response.text());\n      return null;\n    }\n\n    const data = await response.json() as any;\n    const result = JSON.parse(data.choices[0].message.content);\n\n    return {\n      intent: result.intent || 'Unknown',\n      sentiment: result.sentiment || 'Neutral',\n      outcome: result.outcome || 'Unknown',\n      customer_name: result.customer_name || null,\n      customer_email: result.customer_email || null,\n      appointment_date: result.appointment_date || null,\n      appointment_time: result.appointment_time || null,\n      appointment_type: result.appointment_type || null,\n      appointment_notes: result.appointment_notes || null\n    };\n  } catch (error) {\n    console.error('Error analyzing call with OpenAI:', error);\n    return null;\n  }\n}\n\n// Helper: Extract keywords from transcript\nfunction extractKeywords(transcript: string): string[] {\n  if (!transcript || transcript.trim().length === 0) {\n    return [];\n  }\n\n  // Common stop words to filter out\n  const stopWords = new Set([\n    'i', 'me', 'my', 'myself', 'we', 'our', 'ours', 'ourselves', 'you', 'your', 'yours',\n    'yourself', 'yourselves', 'he', 'him', 'his', 'himself', 'she', 'her', 'hers',\n    'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves',\n    'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are',\n    'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does',\n    'did', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until',\n    'while', 'of', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into',\n    'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down',\n    'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here',\n    'there', 'when', 'where', 'why', 'how', 'all', 'both', 'each', 'few', 'more', 'most',\n    'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than',\n    'too', 'very', 's', 't', 'can', 'will', 'just', 'don', 'should', 'now', 'yeah',\n    'yes', 'okay', 'ok', 'um', 'uh', 'like', 'know', 'think', 'get', 'got', 'would',\n    'could', 'want', 'need', 'see', 'go', 'going', 'come', 'let', 'one', 'two', 'make'\n  ]);\n\n  // Convert to lowercase and split into words\n  const words = transcript\n    .toLowerCase()\n    .replace(/[^\\w\\s]/g, ' ') // Replace punctuation with spaces\n    .split(/\\s+/)\n    .filter(word =>\n      word.length > 3 && // At least 4 characters\n      !stopWords.has(word) &&\n      !/^\\d+$/.test(word) // Not just numbers\n    );\n\n  // Count word frequency\n  const wordCount = new Map<string, number>();\n  words.forEach(word => {\n    wordCount.set(word, (wordCount.get(word) || 0) + 1);\n  });\n\n  // Get top keywords (mentioned at least twice, sorted by frequency)\n  const keywords = Array.from(wordCount.entries())\n    .filter(([_, count]) => count >= 2)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 20) // Top 20 keywords\n    .map(([word]) => word);\n\n  return keywords;\n}\n\n// Helper: Store keywords in database with sentiment tracking\nasync function storeKeywords(\n  keywords: string[],\n  userId: string,\n  sentiment: string,\n  db: D1Database\n): Promise<void> {\n  if (keywords.length === 0) return;\n\n  const timestamp = Date.now();\n\n  // Convert sentiment string to numeric score for averaging\n  // Positive = 1, Neutral = 0, Negative = -1\n  let sentimentScore = 0;\n  if (sentiment === 'Positive') sentimentScore = 1;\n  else if (sentiment === 'Negative') sentimentScore = -1;\n\n  for (const keyword of keywords) {\n    try {\n      // Check if keyword already exists for this user\n      const existing = await db.prepare(\n        `SELECT id, count, positive_count, neutral_count, negative_count, avg_sentiment\n         FROM call_keywords WHERE user_id = ? AND keyword = ?`\n      ).bind(userId, keyword).first() as any;\n\n      if (existing) {\n        // Calculate new counts\n        const newPositiveCount = existing.positive_count + (sentiment === 'Positive' ? 1 : 0);\n        const newNeutralCount = existing.neutral_count + (sentiment === 'Neutral' ? 1 : 0);\n        const newNegativeCount = existing.negative_count + (sentiment === 'Negative' ? 1 : 0);\n        const newTotalCount = existing.count + 1;\n\n        // Calculate new average sentiment\n        const newAvgSentiment = ((existing.avg_sentiment * existing.count) + sentimentScore) / newTotalCount;\n\n        // Update with new sentiment data\n        await db.prepare(\n          `UPDATE call_keywords\n           SET count = ?, positive_count = ?, neutral_count = ?, negative_count = ?,\n               avg_sentiment = ?, last_detected_at = ?\n           WHERE id = ?`\n        ).bind(\n          newTotalCount,\n          newPositiveCount,\n          newNeutralCount,\n          newNegativeCount,\n          newAvgSentiment,\n          timestamp,\n          existing.id\n        ).run();\n      } else {\n        // Insert new keyword with sentiment\n        const initialPositiveCount = sentiment === 'Positive' ? 1 : 0;\n        const initialNeutralCount = sentiment === 'Neutral' ? 1 : 0;\n        const initialNegativeCount = sentiment === 'Negative' ? 1 : 0;\n\n        await db.prepare(\n          `INSERT INTO call_keywords\n           (id, user_id, keyword, count, positive_count, neutral_count, negative_count,\n            avg_sentiment, last_detected_at, created_at)\n           VALUES (?, ?, ?, 1, ?, ?, ?, ?, ?, ?)`\n        ).bind(\n          generateId(),\n          userId,\n          keyword,\n          initialPositiveCount,\n          initialNeutralCount,\n          initialNegativeCount,\n          sentimentScore,\n          timestamp,\n          timestamp\n        ).run();\n      }\n    } catch (error) {\n      console.error('Error storing keyword:', keyword, error);\n    }\n  }\n}\n\n// Helper: Lookup caller info using Twilio API\ninterface TwilioCallerInfo {\n  callerName: string | null;\n  callerType: string | null;\n  carrierName: string | null;\n  lineType: string | null;\n}\n\nasync function lookupCallerWithTwilio(\n  phoneNumber: string,\n  twilioAccountSid: string,\n  twilioAuthToken: string\n): Promise<TwilioCallerInfo | null> {\n  try {\n    // Twilio Lookup API requires phone number in E.164 format (+1234567890)\n    const cleanNumber = phoneNumber.replace(/[^\\d+]/g, '');\n\n    const response = await fetch(\n      `https://lookups.twilio.com/v2/PhoneNumbers/${encodeURIComponent(cleanNumber)}?Fields=caller_name,line_type_intelligence`,\n      {\n        method: 'GET',\n        headers: {\n          'Authorization': 'Basic ' + btoa(`${twilioAccountSid}:${twilioAuthToken}`)\n        }\n      }\n    );\n\n    if (!response.ok) {\n      console.error('Twilio API error:', response.status, await response.text());\n      return null;\n    }\n\n    const data = await response.json() as any;\n\n    return {\n      callerName: data.caller_name?.caller_name || null,\n      callerType: data.caller_name?.caller_type || null,\n      carrierName: data.line_type_intelligence?.carrier_name || null,\n      lineType: data.line_type_intelligence?.type || null\n    };\n  } catch (error) {\n    console.error('Error looking up caller with Twilio:', error);\n    return null;\n  }\n}\n\n// Helper: Trigger scheduling webhook when appointment is booked\nasync function triggerSchedulingWebhook(env: Env, userId: string, callId: string): Promise<void> {\n  try {\n    // Get active scheduling triggers for this user\n    const triggers = await env.DB.prepare(\n      'SELECT * FROM scheduling_triggers WHERE user_id = ? AND is_active = 1'\n    ).bind(userId).all();\n\n    if (!triggers.results || triggers.results.length === 0) {\n      console.log('No active scheduling triggers found for user:', userId);\n      return;\n    }\n\n    // Get call data with enhanced data\n    const call = await env.DB.prepare(`\n      SELECT\n        wc.*,\n        ar.result_data as enhanced_data\n      FROM webhook_calls wc\n      LEFT JOIN addon_results ar ON ar.call_id = wc.id AND ar.addon_type = 'enhanced_data'\n      WHERE wc.id = ?\n    `).bind(callId).first() as any;\n\n    if (!call) {\n      console.error('Call not found:', callId);\n      return;\n    }\n\n    // Build webhook payload\n    const payload: any = {\n      name: call.customer_name || 'Unknown',\n      email: call.customer_email || null,\n      phone: call.customer_number || call.phone_number || null,\n      phone_being_called: call.phone_number || null,\n      appointment_date: call.appointment_date,\n      appointment_time: call.appointment_time,\n      appointment_type: call.appointment_type || null,\n      appointment_notes: call.appointment_notes || null,\n      recording: call.recording_url || null,\n      call_summary: call.summary || null,\n      call_id: call.id,\n      intent: call.intent,\n      sentiment: call.sentiment,\n      outcome: call.outcome\n    };\n\n    // Add enhanced data if available and trigger is configured to send it\n    for (const trigger of triggers.results) {\n      const triggerData = trigger as any;\n\n      if (triggerData.send_enhanced_data && call.enhanced_data) {\n        try {\n          payload.enhanced_data = JSON.parse(call.enhanced_data);\n        } catch (e) {\n          console.error('Error parsing enhanced data:', e);\n        }\n      }\n\n      // Send webhook\n      try {\n        const response = await fetch(triggerData.destination_url, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'X-Trigger-Type': 'appointment-scheduled',\n            'X-Call-ID': callId\n          },\n          body: JSON.stringify(payload)\n        });\n\n        const responseBody = await response.text();\n        const logId = generateId();\n\n        // Log the webhook delivery\n        await env.DB.prepare(\n          `INSERT INTO scheduling_trigger_logs\n           (id, trigger_id, call_id, status, http_status, response_body, error_message, payload_sent, created_at)\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n        ).bind(\n          logId,\n          triggerData.id,\n          callId,\n          response.ok ? 'success' : 'error',\n          response.status,\n          responseBody.substring(0, 1000), // Limit response body size\n          response.ok ? null : `HTTP ${response.status}: ${responseBody}`,\n          JSON.stringify(payload),\n          now()\n        ).run();\n\n        console.log(`Scheduling webhook sent to ${triggerData.destination_url}: ${response.status}`);\n      } catch (error: any) {\n        const logId = generateId();\n\n        // Log the error\n        await env.DB.prepare(\n          `INSERT INTO scheduling_trigger_logs\n           (id, trigger_id, call_id, status, http_status, response_body, error_message, payload_sent, created_at)\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n        ).bind(\n          logId,\n          triggerData.id,\n          callId,\n          'error',\n          null,\n          null,\n          error.message || 'Unknown error',\n          JSON.stringify(payload),\n          now()\n        ).run();\n\n        console.error('Error sending scheduling webhook:', error);\n      }\n    }\n  } catch (error) {\n    console.error('Error in triggerSchedulingWebhook:', error);\n  }\n}\n\n// Helper: Extract user from Authorization header\nasync function getUserFromToken(request: Request, env: Env): Promise<string | null> {\n  const authHeader = request.headers.get('Authorization');\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return null;\n  }\n\n  const token = authHeader.substring(7);\n  const secret = env.JWT_SECRET || 'default-secret-change-me';\n  const decoded = await verifyToken(token, secret);\n\n  if (!decoded) {\n    return null;\n  }\n\n  return decoded.userId;\n}\n\n// Helper: Get effective user ID for workspace context\n// Returns workspace owner's user_id if workspace is selected, otherwise the authenticated user's ID\nasync function getEffectiveUserId(env: Env, userId: string): Promise<{ effectiveUserId: string; isWorkspaceContext: boolean }> {\n  const settings = await env.DB.prepare(\n    'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n  ).bind(userId).first() as any;\n\n  if (!settings || !settings.selected_workspace_id) {\n    return { effectiveUserId: userId, isWorkspaceContext: false };\n  }\n\n  // Verify user has access to this workspace\n  const workspace = await env.DB.prepare(\n    'SELECT owner_user_id FROM workspaces WHERE id = ?'\n  ).bind(settings.selected_workspace_id).first() as any;\n\n  if (!workspace) {\n    return { effectiveUserId: userId, isWorkspaceContext: false };\n  }\n\n  // Check if user is owner or active member\n  const isOwner = workspace.owner_user_id === userId;\n  const membership = await env.DB.prepare(\n    'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n  ).bind(settings.selected_workspace_id, userId).first() as any;\n\n  if (isOwner || membership) {\n    return { effectiveUserId: workspace.owner_user_id, isWorkspaceContext: true };\n  }\n\n  // User doesn't have access, fall back to personal\n  return { effectiveUserId: userId, isWorkspaceContext: false };\n}\n\n// Helper: Get workspace settings for a user (finds their workspace and returns its credentials)\nasync function getWorkspaceSettingsForUser(env: Env, userId: string): Promise<{\n  private_key?: string;\n  openai_api_key?: string;\n  twilio_account_sid?: string;\n  twilio_auth_token?: string;\n  transfer_phone_number?: string;\n} | null> {\n  // Find user's workspace (they own it or are a member)\n  const userSettings = await env.DB.prepare(\n    'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n  ).bind(userId).first() as any;\n\n  if (!userSettings || !userSettings.selected_workspace_id) {\n    // User has no workspace, check if they own one\n    const ownedWorkspace = await env.DB.prepare(\n      'SELECT id FROM workspaces WHERE owner_user_id = ?'\n    ).bind(userId).first() as any;\n\n    if (ownedWorkspace) {\n      const wsSettings = await env.DB.prepare(\n        'SELECT workspace_id, private_key, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number FROM workspace_settings WHERE workspace_id = ?'\n      ).bind(ownedWorkspace.id).first() as any;\n      return wsSettings || null;\n    }\n    return null;\n  }\n\n  const workspaceId = userSettings.selected_workspace_id;\n  let wsSettings = await env.DB.prepare(\n    'SELECT workspace_id, private_key, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number FROM workspace_settings WHERE workspace_id = ?'\n  ).bind(workspaceId).first() as any;\n\n  // FALLBACK: If workspace_settings is empty, try user_settings (migration path)\n  if (!wsSettings || !wsSettings.private_key) {\n    const workspace = await env.DB.prepare(\n      'SELECT owner_user_id FROM workspaces WHERE id = ?'\n    ).bind(workspaceId).first() as any;\n\n    if (workspace) {\n      const ownerSettings = await env.DB.prepare(\n        'SELECT private_key, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number FROM user_settings WHERE user_id = ?'\n      ).bind(workspace.owner_user_id).first() as any;\n\n      if (ownerSettings && ownerSettings.private_key) {\n        wsSettings = ownerSettings;\n      }\n    }\n  }\n\n  return wsSettings || null;\n}\n\n// Helper: Enhanced Data addon - fetch phone number enrichment\nasync function executeEnhancedDataAddon(\n  phoneNumber: string\n): Promise<any> {\n  try {\n    const response = await fetch(\n      `https://enhance-data-production.up.railway.app/phone?phone=${encodeURIComponent(phoneNumber)}`,\n      {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      }\n    );\n\n    if (!response.ok) {\n      return null;\n    }\n\n    return await response.json();\n  } catch (error) {\n    console.error('Enhanced Data addon error:', error);\n    return null;\n  }\n}\n\n// Helper: Process addons for a call\nasync function processAddonsForCall(\n  env: Env,\n  userId: string,\n  callId: string,\n  customerPhone: string | null\n): Promise<void> {\n  if (!customerPhone) {\n    return;\n  }\n\n  try {\n    // Initialize cache\n    const cache = new VoiceAICache(env.CACHE);\n\n    // Get enabled addons for user\n    const enabledAddons = await env.DB.prepare(\n      'SELECT addon_type, settings FROM user_addons WHERE user_id = ? AND is_enabled = 1'\n    ).bind(userId).all();\n\n    if (!enabledAddons.results || enabledAddons.results.length === 0) {\n      return;\n    }\n\n    // Process each enabled addon\n    for (const addon of enabledAddons.results as any[]) {\n      const startTime = Date.now();\n      let status = 'failed';\n      let resultData = null;\n      let errorMessage: string | null = null;\n\n      try {\n        if (addon.addon_type === 'enhanced_data') {\n          // Check cache first\n          const cachedData = await cache.getCachedEnhancedData(userId, callId);\n          if (cachedData) {\n            console.log(`Cache HIT for enhanced data: callId=${callId}`);\n            resultData = cachedData;\n            status = 'success';\n          } else {\n            console.log(`Cache MISS for enhanced data: callId=${callId}`);\n            resultData = await executeEnhancedDataAddon(customerPhone);\n            status = resultData ? 'success' : 'failed';\n            if (!resultData) {\n              errorMessage = 'Failed to fetch enhanced data';\n            } else {\n              // Cache the result for 30 minutes\n              await cache.cacheEnhancedData(userId, callId, resultData, CACHE_TTL.ENHANCED_DATA);\n            }\n          }\n        }\n        // Add more addon types here in the future\n      } catch (error: any) {\n        errorMessage = error.message || 'Unknown error';\n      }\n\n      const executionTime = Date.now() - startTime;\n\n      // Store addon result\n      await env.DB.prepare(\n        `INSERT INTO addon_results (\n          id, call_id, user_id, addon_type, status, result_data, error_message, execution_time_ms, created_at\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`\n      ).bind(\n        generateId(),\n        callId,\n        userId,\n        addon.addon_type,\n        status,\n        resultData ? JSON.stringify(resultData) : null,\n        errorMessage,\n        executionTime,\n        now()\n      ).run();\n    }\n  } catch (error) {\n    console.error('Error processing addons:', error);\n  }\n}\n\nexport default {\n  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {\n    const url = new URL(request.url);\n\n    // Handle CORS preflight\n    if (request.method === 'OPTIONS') {\n      return new Response(null, { headers: corsHeaders });\n    }\n\n    try {\n      // ============================================\n      // AUTHENTICATION ENDPOINTS\n      // ============================================\n\n      // Register new user\n      if (url.pathname === '/api/auth/register' && request.method === 'POST') {\n        const { email, password, name } = await request.json() as any;\n\n        if (!email || !password) {\n          return jsonResponse({ error: 'Email and password required' }, 400);\n        }\n\n        // Check if user exists\n        const existing = await env.DB.prepare(\n          'SELECT id FROM users WHERE email = ?'\n        ).bind(email).first();\n\n        if (existing) {\n          return jsonResponse({ error: 'Email already registered' }, 409);\n        }\n\n        // Create user\n        const userId = generateId();\n        const passwordHash = await hashPassword(password);\n        const timestamp = now();\n\n        await env.DB.prepare(\n          'INSERT INTO users (id, email, password_hash, name, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)'\n        ).bind(userId, email, passwordHash, name || null, timestamp, timestamp).run();\n\n        // Generate token\n        const secret = env.JWT_SECRET || 'default-secret-change-me';\n        const token = await generateToken(userId, secret);\n\n        // Create session\n        const sessionId = generateId();\n        const tokenHash = await hashPassword(token);\n        const expiresAt = timestamp + (7 * 24 * 60 * 60); // 7 days\n\n        await env.DB.prepare(\n          'INSERT INTO sessions (id, user_id, token_hash, expires_at, created_at) VALUES (?, ?, ?, ?, ?)'\n        ).bind(sessionId, userId, tokenHash, expiresAt, timestamp).run();\n\n        // Check for pending invitations for this email\n        const pendingInvitations = await env.DB.prepare(\n          'SELECT id, workspace_id, role, token, expires_at FROM workspace_invitations WHERE email = ? AND status = \\\"pending\\\" AND expires_at > ?'\n        ).bind(email, timestamp).all();\n\n        let defaultWorkspaceId: string | null = null;\n\n        if (pendingInvitations.results && pendingInvitations.results.length > 0) {\n          // User has pending invitations - accept them automatically\n          for (const invitation of pendingInvitations.results as any[]) {\n            // Add user to workspace\n            const membershipId = generateId();\n            await env.DB.prepare(\n              'INSERT INTO workspace_members (id, workspace_id, user_id, role, status, invited_by_user_id, invited_at, joined_at, created_at, updated_at) VALUES (?, ?, ?, ?, \\\"active\\\", ?, ?, ?, ?, ?)'\n            ).bind(\n              membershipId,\n              invitation.workspace_id,\n              userId,\n              invitation.role,\n              null, // We don't have invited_by stored yet in old invitations\n              timestamp,\n              timestamp,\n              timestamp,\n              timestamp\n            ).run();\n\n            // Mark invitation as accepted\n            await env.DB.prepare(\n              'UPDATE workspace_invitations SET status = \\\"accepted\\\", accepted_at = ? WHERE id = ?'\n            ).bind(timestamp, invitation.id).run();\n\n            // Use first invited workspace as default\n            if (!defaultWorkspaceId) {\n              defaultWorkspaceId = invitation.workspace_id;\n            }\n          }\n        }\n\n        // Create default workspace for new user only if they don't have invitations\n        if (!defaultWorkspaceId) {\n          const workspaceId = 'ws_' + generateId();\n          const workspaceName = name?.trim() || email.split('@')[0] || 'My Workspace';\n          await env.DB.prepare(\n            'INSERT INTO workspaces (id, name, owner_user_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n          ).bind(workspaceId, workspaceName, userId, timestamp, timestamp).run();\n          defaultWorkspaceId = workspaceId;\n        }\n\n        // Create empty settings\n        const settingsId = generateId();\n        const encryptionSalt = generateSalt();\n\n        await env.DB.prepare(\n          'INSERT INTO user_settings (id, user_id, encryption_salt, selected_workspace_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)'\n        ).bind(settingsId, userId, encryptionSalt, defaultWorkspaceId, timestamp, timestamp).run();\n\n        return jsonResponse({\n          token,\n          user: {\n            id: userId,\n            email,\n            name: name || null\n          }\n        });\n      }\n\n      // Login\n      if (url.pathname === '/api/auth/login' && request.method === 'POST') {\n        const { email, password } = await request.json() as any;\n\n        if (!email || !password) {\n          return jsonResponse({ error: 'Email and password required' }, 400);\n        }\n\n        // Find user\n        const user = await env.DB.prepare(\n          'SELECT id, email, password_hash, name FROM users WHERE email = ?'\n        ).bind(email).first() as any;\n\n        if (!user) {\n          return jsonResponse({ error: 'Invalid credentials' }, 401);\n        }\n\n        // Verify password\n        const valid = await verifyPassword(password, user.password_hash);\n        if (!valid) {\n          return jsonResponse({ error: 'Invalid credentials' }, 401);\n        }\n\n        // Update last login\n        await env.DB.prepare(\n          'UPDATE users SET last_login_at = ? WHERE id = ?'\n        ).bind(now(), user.id).run();\n\n        // Generate token\n        const secret = env.JWT_SECRET || 'default-secret-change-me';\n        const token = await generateToken(user.id, secret);\n\n        // Create session\n        const sessionId = generateId();\n        const tokenHash = await hashPassword(token);\n        const timestamp = now();\n        const expiresAt = timestamp + (7 * 24 * 60 * 60); // 7 days\n\n        await env.DB.prepare(\n          'INSERT INTO sessions (id, user_id, token_hash, expires_at, created_at) VALUES (?, ?, ?, ?, ?)'\n        ).bind(sessionId, user.id, tokenHash, expiresAt, timestamp).run();\n\n        return jsonResponse({\n          token,\n          user: {\n            id: user.id,\n            email: user.email,\n            name: user.name\n          }\n        });\n      }\n\n      // Logout\n      if (url.pathname === '/api/auth/logout' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Delete all sessions for this user (optional: could delete just current session)\n        await env.DB.prepare(\n          'DELETE FROM sessions WHERE user_id = ?'\n        ).bind(userId).run();\n\n        return jsonResponse({ message: 'Logged out successfully' });\n      }\n\n      // Get current user\n      if (url.pathname === '/api/auth/me' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const user = await env.DB.prepare(\n          'SELECT id, email, name, created_at FROM users WHERE id = ?'\n        ).bind(userId).first() as any;\n\n        if (!user) {\n          return jsonResponse({ error: 'User not found' }, 404);\n        }\n\n        return jsonResponse({\n          id: user.id,\n          email: user.email,\n          name: user.name,\n          createdAt: user.created_at\n        });\n      }\n\n      // ============================================\n      // USER SETTINGS ENDPOINTS (Protected)\n      // ============================================\n\n      // Get user settings\n      // Get settings - workspace-scoped (returns workspace owner's credentials)\n      if (url.pathname === '/api/settings' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's selected workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          // No workspace selected, return empty settings\n          return jsonResponse({\n            privateKey: null,\n            publicKey: null,\n            selectedAssistantId: null,\n            selectedPhoneId: null,\n            selectedOrgId: null,\n            selectedWorkspaceId: null,\n            openaiApiKey: null,\n            twilioAccountSid: null,\n            twilioAuthToken: null,\n            transferPhoneNumber: null\n          });\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify user has access to this workspace\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        // Get workspace settings (workspace owner's credentials)\n        const wsSettings = await env.DB.prepare(\n          'SELECT private_key, public_key, selected_assistant_id, selected_phone_id, selected_org_id, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        // FALLBACK: If workspace_settings is empty, try to get from user_settings (migration path)\n        let finalSettings = wsSettings;\n        if (!wsSettings || !wsSettings.private_key) {\n          const ownerSettings = await env.DB.prepare(\n            'SELECT private_key, public_key, selected_assistant_id, selected_phone_id, selected_org_id, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number FROM user_settings WHERE user_id = ?'\n          ).bind(workspace.owner_user_id).first() as any;\n\n          if (ownerSettings && ownerSettings.private_key) {\n            finalSettings = ownerSettings;\n\n            // Auto-migrate to workspace_settings if user is owner\n            if (isOwner) {\n              const timestamp = Date.now();\n              const wsSettingsId = generateId();\n\n              await env.DB.prepare(\n                `INSERT OR REPLACE INTO workspace_settings (\n                  id, workspace_id, private_key, public_key, openai_api_key,\n                  twilio_account_sid, twilio_auth_token, transfer_phone_number,\n                  selected_assistant_id, selected_phone_id, selected_org_id,\n                  created_at, updated_at\n                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n              ).bind(\n                wsSettingsId,\n                workspaceId,\n                ownerSettings.private_key,\n                ownerSettings.public_key,\n                ownerSettings.openai_api_key,\n                ownerSettings.twilio_account_sid,\n                ownerSettings.twilio_auth_token,\n                ownerSettings.transfer_phone_number,\n                ownerSettings.selected_assistant_id,\n                ownerSettings.selected_phone_id,\n                ownerSettings.selected_org_id,\n                timestamp,\n                timestamp\n              ).run();\n\n              console.log(`Auto-migrated settings for workspace ${workspaceId}`);\n            }\n          }\n        }\n\n        return jsonResponse({\n          privateKey: finalSettings?.private_key || null,\n          publicKey: finalSettings?.public_key || null,\n          selectedAssistantId: finalSettings?.selected_assistant_id || null,\n          selectedPhoneId: finalSettings?.selected_phone_id || null,\n          selectedOrgId: finalSettings?.selected_org_id || null,\n          selectedWorkspaceId: workspaceId,\n          openaiApiKey: finalSettings?.openai_api_key || null,\n          twilioAccountSid: finalSettings?.twilio_account_sid || null,\n          twilioAuthToken: finalSettings?.twilio_auth_token || null,\n          transferPhoneNumber: finalSettings?.transfer_phone_number || null,\n          isWorkspaceOwner: isOwner\n        });\n      }\n\n      // Update settings - workspace-scoped (only workspace owner can update)\n      if (url.pathname === '/api/settings' && request.method === 'PUT') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const {\n          privateKey,\n          publicKey,\n          selectedAssistantId,\n          selectedPhoneId,\n          selectedOrgId,\n          selectedWorkspaceId,\n          openaiApiKey,\n          twilioAccountSid,\n          twilioAuthToken,\n          transferPhoneNumber\n        } = await request.json() as any;\n\n        // Validate workspace selection\n        if (!selectedWorkspaceId) {\n          return jsonResponse({ error: 'Workspace selection is required' }, 400);\n        }\n\n        // Verify user is workspace owner\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(selectedWorkspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        if (workspace.owner_user_id !== userId) {\n          return jsonResponse({ error: 'Only workspace owner can update API credentials' }, 403);\n        }\n\n        const timestamp = now();\n\n        // Update or insert workspace settings\n        const existing = await env.DB.prepare(\n          'SELECT id FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(selectedWorkspaceId).first() as any;\n\n        if (existing) {\n          await env.DB.prepare(\n            'UPDATE workspace_settings SET private_key = ?, public_key = ?, selected_assistant_id = ?, selected_phone_id = ?, selected_org_id = ?, openai_api_key = ?, twilio_account_sid = ?, twilio_auth_token = ?, transfer_phone_number = ?, updated_at = ? WHERE workspace_id = ?'\n          ).bind(\n            privateKey || null,\n            publicKey || null,\n            selectedAssistantId || null,\n            selectedPhoneId || null,\n            selectedOrgId || null,\n            openaiApiKey || null,\n            twilioAccountSid || null,\n            twilioAuthToken || null,\n            transferPhoneNumber || null,\n            timestamp,\n            selectedWorkspaceId\n          ).run();\n        } else {\n          const settingsId = generateId();\n          await env.DB.prepare(\n            'INSERT INTO workspace_settings (id, workspace_id, private_key, public_key, selected_assistant_id, selected_phone_id, selected_org_id, openai_api_key, twilio_account_sid, twilio_auth_token, transfer_phone_number, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'\n          ).bind(\n            settingsId,\n            selectedWorkspaceId,\n            privateKey || null,\n            publicKey || null,\n            selectedAssistantId || null,\n            selectedPhoneId || null,\n            selectedOrgId || null,\n            openaiApiKey || null,\n            twilioAccountSid || null,\n            twilioAuthToken || null,\n            transferPhoneNumber || null,\n            timestamp,\n            timestamp\n          ).run();\n        }\n\n        // Update user's selected workspace\n        await env.DB.prepare(\n          'UPDATE user_settings SET selected_workspace_id = ?, updated_at = ? WHERE user_id = ?'\n        ).bind(selectedWorkspaceId, timestamp, userId).run();\n\n        return jsonResponse({ message: 'Settings updated successfully' });\n      }\n\n      // ============================================\n      // TRANSLATION ENDPOINT (Protected)\n      // ============================================\n      if (url.pathname === '/api/translate' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { text, targetLanguage } = await request.json() as { text: string; targetLanguage: string };\n\n        if (!text || !targetLanguage) {\n          return jsonResponse({ error: 'Missing required fields: text, targetLanguage' }, 400);\n        }\n\n        // Get user's workspace settings to retrieve OpenAI API key\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceSettings = await env.DB.prepare(\n          'SELECT openai_api_key FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(userSettings.selected_workspace_id).first() as any;\n\n        if (!workspaceSettings || !workspaceSettings.openai_api_key) {\n          return jsonResponse({\n            success: false,\n            error: 'OpenAI API key not configured. Please add it in Settings.'\n          });\n        }\n\n        try {\n          // Call OpenAI API to translate\n          const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${workspaceSettings.openai_api_key}`\n            },\n            body: JSON.stringify({\n              model: 'gpt-4o-mini',\n              messages: [\n                {\n                  role: 'system',\n                  content: `You are a professional translator. Translate the following English text to ${targetLanguage}, maintaining the same tone and meaning.`\n                },\n                {\n                  role: 'user',\n                  content: text\n                }\n              ],\n              temperature: 0.3\n            })\n          });\n\n          if (!openaiResponse.ok) {\n            const errorText = await openaiResponse.text();\n            throw new Error(`OpenAI API error: ${openaiResponse.status} ${errorText}`);\n          }\n\n          const data = await openaiResponse.json() as any;\n          const translatedText = data.choices[0].message.content;\n\n          return jsonResponse({\n            success: true,\n            translatedText\n          });\n        } catch (error: any) {\n          console.error('[Translation] Error:', error);\n          return jsonResponse({\n            success: false,\n            error: error.message || 'Translation failed'\n          });\n        }\n      }\n\n      // ============================================\n      // SALESFORCE INTEGRATION ENDPOINTS (Protected)\n      // ============================================\n\n      // Initiate Salesforce OAuth flow\n      if (url.pathname === '/api/salesforce/oauth/initiate' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Generate OAuth URL\n        const authUrl = buildAuthUrl(workspaceId, env);\n\n        return jsonResponse({\n          success: true,\n          authUrl\n        });\n      }\n\n      // Handle Salesforce OAuth callback\n      if (url.pathname === '/api/salesforce/oauth/callback' && request.method === 'GET') {\n        try {\n          // Extract code and state from query params\n          const code = url.searchParams.get('code');\n          const workspaceId = url.searchParams.get('state'); // We passed workspace ID as state\n\n          if (!code || !workspaceId) {\n            return new Response('Missing code or state parameter', { status: 400 });\n          }\n\n          // Exchange code for tokens\n          const tokens = await exchangeCodeForToken(code, env);\n\n          // Store tokens in database\n          const timestamp = now();\n          await env.DB.prepare(\n            `UPDATE workspace_settings\n             SET salesforce_instance_url = ?,\n                 salesforce_access_token = ?,\n                 salesforce_refresh_token = ?,\n                 salesforce_token_expires_at = ?,\n                 updated_at = ?\n             WHERE workspace_id = ?`\n          ).bind(\n            tokens.instance_url,\n            tokens.access_token,\n            tokens.refresh_token,\n            tokens.expires_in,\n            timestamp,\n            workspaceId\n          ).run();\n\n          // Redirect to integration page with success message\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': 'https://voice-config.channelautomation.com/integrations?salesforce=connected'\n            }\n          });\n        } catch (error: any) {\n          console.error('[Salesforce OAuth] Error:', error);\n          // Redirect to integration page with error\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': `https://voice-config.channelautomation.com/integrations?salesforce=error&message=${encodeURIComponent(error.message)}`\n            }\n          });\n        }\n      }\n\n      // Get Salesforce connection status\n      if (url.pathname === '/api/salesforce/status' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get Salesforce settings\n        const settings = await env.DB.prepare(\n          `SELECT salesforce_instance_url, salesforce_access_token,\n                  salesforce_refresh_token, salesforce_token_expires_at\n           FROM workspace_settings\n           WHERE workspace_id = ?`\n        ).bind(workspaceId).first() as any;\n\n        const connected = !!(settings && settings.salesforce_refresh_token);\n        const tokenExpiresAt = settings?.salesforce_token_expires_at || null;\n\n        return jsonResponse({\n          success: true,\n          connected,\n          instanceUrl: connected ? settings.salesforce_instance_url : null,\n          tokenExpiresAt\n        });\n      }\n\n      // Disconnect Salesforce\n      if (url.pathname === '/api/salesforce/disconnect' && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Clear Salesforce tokens\n        const timestamp = now();\n        await env.DB.prepare(\n          `UPDATE workspace_settings\n           SET salesforce_instance_url = NULL,\n               salesforce_access_token = NULL,\n               salesforce_refresh_token = NULL,\n               salesforce_token_expires_at = NULL,\n               updated_at = ?\n           WHERE workspace_id = ?`\n        ).bind(timestamp, workspaceId).run();\n\n        return jsonResponse({\n          success: true,\n          message: 'Salesforce disconnected successfully'\n        });\n      }\n\n      // Get Salesforce sync logs\n      if (url.pathname === '/api/salesforce/sync-logs' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get query parameters\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n        const offset = parseInt(url.searchParams.get('offset') || '0');\n        const status = url.searchParams.get('status'); // 'success', 'error', 'skipped'\n\n        // Build query\n        let query = `\n          SELECT id, call_id, salesforce_record_id, salesforce_task_id,\n                 salesforce_event_id, appointment_created, status,\n                 error_message, phone_number, created_at\n          FROM salesforce_sync_logs\n          WHERE workspace_id = ?\n        `;\n        const params: any[] = [workspaceId];\n\n        if (status) {\n          query += ' AND status = ?';\n          params.push(status);\n        }\n\n        query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\n        params.push(limit, offset);\n\n        const logs = await env.DB.prepare(query).bind(...params).all();\n\n        // Get total count\n        let countQuery = 'SELECT COUNT(*) as count FROM salesforce_sync_logs WHERE workspace_id = ?';\n        const countParams: any[] = [workspaceId];\n\n        if (status) {\n          countQuery += ' AND status = ?';\n          countParams.push(status);\n        }\n\n        const countResult = await env.DB.prepare(countQuery).bind(...countParams).first() as any;\n\n        return jsonResponse({\n          success: true,\n          logs: logs.results || [],\n          total: countResult?.count || 0,\n          limit,\n          offset\n        });\n      }\n\n      // ============================================\n      // HUBSPOT INTEGRATION ENDPOINTS (Protected)\n      // ============================================\n\n      // Initiate HubSpot OAuth flow\n      if (url.pathname === '/api/hubspot/oauth/initiate' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Generate OAuth URL\n        const authUrl = buildHubSpotAuthUrl(workspaceId, env);\n\n        return jsonResponse({\n          success: true,\n          authUrl\n        });\n      }\n\n      // Handle HubSpot OAuth callback\n      if (url.pathname === '/api/hubspot/oauth/callback' && request.method === 'GET') {\n        try {\n          // Extract code and state from query params\n          const code = url.searchParams.get('code');\n          const workspaceId = url.searchParams.get('state'); // We passed workspace ID as state\n\n          if (!code || !workspaceId) {\n            return new Response('Missing code or state parameter', { status: 400 });\n          }\n\n          // Exchange code for tokens\n          const tokens = await exchangeHubSpotCodeForToken(code, env);\n\n          // Get workspace owner\n          const workspace = await env.DB.prepare(\n            'SELECT owner_user_id FROM workspaces WHERE id = ?'\n          ).bind(workspaceId).first() as any;\n\n          if (!workspace) {\n            return new Response('Workspace not found', { status: 404 });\n          }\n\n          const userId = workspace.owner_user_id;\n\n          // Check if token entry exists\n          const existing = await env.DB.prepare(\n            'SELECT id FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n          ).bind(userId, workspaceId).first();\n\n          const timestamp = now();\n          const tokenId = generateId();\n\n          if (existing) {\n            // Update existing tokens\n            await env.DB.prepare(\n              `UPDATE hubspot_oauth_tokens\n               SET access_token = ?,\n                   refresh_token = ?,\n                   expires_at = ?,\n                   updated_at = ?\n               WHERE user_id = ? AND workspace_id = ?`\n            ).bind(\n              tokens.access_token,\n              tokens.refresh_token,\n              tokens.expires_in,\n              timestamp,\n              userId,\n              workspaceId\n            ).run();\n          } else {\n            // Insert new tokens\n            await env.DB.prepare(\n              `INSERT INTO hubspot_oauth_tokens (\n                id, user_id, workspace_id, access_token, refresh_token,\n                expires_at, created_at, updated_at\n              ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n            ).bind(\n              tokenId,\n              userId,\n              workspaceId,\n              tokens.access_token,\n              tokens.refresh_token,\n              tokens.expires_in,\n              timestamp,\n              timestamp\n            ).run();\n          }\n\n          // Redirect back to integration page with success message\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': 'https://voice-config.channelautomation.com/?hubspot=connected',\n              ...corsHeaders\n            }\n          });\n        } catch (error: any) {\n          console.error('[HubSpot OAuth Error]:', error);\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': `https://voice-config.channelautomation.com/?hubspot=error&message=${encodeURIComponent(error.message)}`,\n              ...corsHeaders\n            }\n          });\n        }\n      }\n\n      // Get HubSpot connection status\n      if (url.pathname === '/api/hubspot/status' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get HubSpot tokens\n        const tokens = await env.DB.prepare(\n          'SELECT access_token, refresh_token, expires_at FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n        ).bind(userId, workspaceId).first() as any;\n\n        const connected = !!(tokens && tokens.refresh_token);\n        const tokenExpiresAt = tokens?.expires_at || null;\n\n        return jsonResponse({\n          success: true,\n          connected,\n          tokenExpiresAt\n        });\n      }\n\n      // Disconnect HubSpot\n      if (url.pathname === '/api/hubspot/disconnect' && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Delete HubSpot tokens\n        await env.DB.prepare(\n          'DELETE FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n        ).bind(userId, workspaceId).run();\n\n        return jsonResponse({\n          success: true,\n          message: 'HubSpot disconnected successfully'\n        });\n      }\n\n      // Get HubSpot sync logs\n      if (url.pathname === '/api/hubspot/sync-logs' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get query parameters\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n        const offset = parseInt(url.searchParams.get('offset') || '0');\n        const status = url.searchParams.get('status'); // 'success', 'error', 'skipped'\n\n        // Build query\n        let query = `\n          SELECT id, call_id, contact_id, engagement_id, status,\n                 error_message, phone_number, created_at\n          FROM hubspot_sync_logs\n          WHERE user_id = ? AND workspace_id = ?\n        `;\n        const params: any[] = [userId, workspaceId];\n\n        if (status) {\n          query += ' AND status = ?';\n          params.push(status);\n        }\n\n        query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\n        params.push(limit, offset);\n\n        const logs = await env.DB.prepare(query).bind(...params).all();\n\n        // Get total count\n        let countQuery = 'SELECT COUNT(*) as count FROM hubspot_sync_logs WHERE user_id = ? AND workspace_id = ?';\n        const countParams: any[] = [userId, workspaceId];\n\n        if (status) {\n          countQuery += ' AND status = ?';\n          countParams.push(status);\n        }\n\n        const countResult = await env.DB.prepare(countQuery).bind(...countParams).first() as any;\n\n        return jsonResponse({\n          success: true,\n          logs: logs.results || [],\n          total: countResult?.count || 0,\n          limit,\n          offset\n        });\n      }\n\n      // ============================================\n      // DYNAMICS 365 INTEGRATION ENDPOINTS (Protected)\n      // ============================================\n\n      // Initiate Dynamics 365 OAuth flow\n      if (url.pathname === '/api/dynamics/oauth/initiate' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get instance URL from query parameter (user must provide their D365 instance)\n        const instanceUrl = url.searchParams.get('instanceUrl');\n        if (!instanceUrl) {\n          return jsonResponse({ error: 'Instance URL is required' }, 400);\n        }\n\n        // Generate OAuth URL\n        const authUrl = buildDynamicsAuthUrl(workspaceId, env, instanceUrl);\n\n        return jsonResponse({\n          success: true,\n          authUrl\n        });\n      }\n\n      // Handle Dynamics 365 OAuth callback\n      if (url.pathname === '/api/dynamics/oauth/callback' && request.method === 'GET') {\n        try {\n          // Extract code and state from query params\n          const code = url.searchParams.get('code');\n          const state = url.searchParams.get('state'); // Contains \"workspaceId|instanceUrl\"\n\n          if (!code || !state) {\n            return new Response('Missing code or state parameter', { status: 400 });\n          }\n\n          // Parse state\n          const [workspaceId, instanceUrl] = state.split('|');\n\n          // Exchange code for tokens\n          const tokens = await exchangeDynamicsCodeForToken(code, env, instanceUrl);\n\n          // Store tokens in database\n          const timestamp = now();\n          await env.DB.prepare(\n            `UPDATE workspace_settings\n             SET dynamics_instance_url = ?,\n                 dynamics_access_token = ?,\n                 dynamics_refresh_token = ?,\n                 dynamics_token_expires_at = ?,\n                 updated_at = ?\n             WHERE workspace_id = ?`\n          ).bind(\n            instanceUrl,\n            tokens.access_token,\n            tokens.refresh_token,\n            tokens.expires_in,\n            timestamp,\n            workspaceId\n          ).run();\n\n          // Redirect to integration page with success message\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': 'https://voice-config.channelautomation.com/integrations?dynamics=connected'\n            }\n          });\n        } catch (error: any) {\n          console.error('[Dynamics 365 OAuth] Error:', error);\n          // Redirect to integration page with error\n          return new Response(null, {\n            status: 302,\n            headers: {\n              'Location': `https://voice-config.channelautomation.com/integrations?dynamics=error&message=${encodeURIComponent(error.message)}`\n            }\n          });\n        }\n      }\n\n      // Get Dynamics 365 connection status\n      if (url.pathname === '/api/dynamics/status' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get Dynamics 365 settings\n        const settings = await env.DB.prepare(\n          `SELECT dynamics_instance_url, dynamics_access_token,\n                  dynamics_refresh_token, dynamics_token_expires_at\n           FROM workspace_settings\n           WHERE workspace_id = ?`\n        ).bind(workspaceId).first() as any;\n\n        const connected = !!(settings && settings.dynamics_refresh_token);\n        const tokenExpiresAt = settings?.dynamics_token_expires_at || null;\n\n        return jsonResponse({\n          success: true,\n          connected,\n          instanceUrl: connected ? settings.dynamics_instance_url : null,\n          tokenExpiresAt\n        });\n      }\n\n      // Disconnect Dynamics 365\n      if (url.pathname === '/api/dynamics/disconnect' && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Clear Dynamics 365 tokens\n        const timestamp = now();\n        await env.DB.prepare(\n          `UPDATE workspace_settings\n           SET dynamics_instance_url = NULL,\n               dynamics_access_token = NULL,\n               dynamics_refresh_token = NULL,\n               dynamics_token_expires_at = NULL,\n               updated_at = ?\n           WHERE workspace_id = ?`\n        ).bind(timestamp, workspaceId).run();\n\n        return jsonResponse({\n          success: true,\n          message: 'Dynamics 365 disconnected successfully'\n        });\n      }\n\n      // Get Dynamics 365 sync logs\n      if (url.pathname === '/api/dynamics/sync-logs' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user's workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Get query parameters\n        const limit = Math.min(parseInt(url.searchParams.get('limit') || '50'), 100);\n        const offset = parseInt(url.searchParams.get('offset') || '0');\n        const status = url.searchParams.get('status'); // 'success', 'error', 'skipped'\n\n        // Build query\n        let query = `\n          SELECT id, call_id, dynamics_record_id, dynamics_activity_id,\n                 dynamics_appointment_id, appointment_created, status,\n                 error_message, phone_number, created_at\n          FROM dynamics_sync_logs\n          WHERE workspace_id = ?\n        `;\n        const params: any[] = [workspaceId];\n\n        if (status) {\n          query += ' AND status = ?';\n          params.push(status);\n        }\n\n        query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\n        params.push(limit, offset);\n\n        const logs = await env.DB.prepare(query).bind(...params).all();\n\n        // Get total count\n        let countQuery = 'SELECT COUNT(*) as count FROM dynamics_sync_logs WHERE workspace_id = ?';\n        const countParams: any[] = [workspaceId];\n\n        if (status) {\n          countQuery += ' AND status = ?';\n          countParams.push(status);\n        }\n\n        const countResult = await env.DB.prepare(countQuery).bind(...countParams).first() as any;\n\n        return jsonResponse({\n          success: true,\n          logs: logs.results || [],\n          total: countResult?.count || 0,\n          limit,\n          offset\n        });\n      }\n\n      // ============================================\n      // WORKSPACES ENDPOINTS (Protected)\n      // ============================================\n\n      // List workspaces for current user (owner or active member)\n      if (url.pathname === '/api/workspaces' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const query = `\n          SELECT DISTINCT w.id, w.name, w.owner_user_id, w.created_at, w.updated_at,\n            CASE WHEN w.owner_user_id = ? THEN 'owner' ELSE wm.role END AS role,\n            CASE WHEN w.owner_user_id = ? THEN 'active' ELSE wm.status END AS status\n          FROM workspaces w\n          LEFT JOIN workspace_members wm\n            ON wm.workspace_id = w.id AND wm.user_id = ?\n          WHERE w.owner_user_id = ? OR wm.user_id = ?\n          ORDER BY w.created_at DESC`;\n\n        const { results } = await env.DB.prepare(query).bind(userId, userId, userId, userId, userId).all();\n        return jsonResponse({ workspaces: results || [] });\n      }\n\n      // Create workspace - DISABLED: Users get one workspace automatically on registration\n      // Keeping endpoint for backward compatibility but returning error\n      if (url.pathname === '/api/workspaces' && request.method === 'POST') {\n        return jsonResponse({ error: 'Workspace creation is not allowed. Each user automatically gets one workspace on registration.' }, 403);\n      }\n\n      // Invite a member to a workspace by email (supports pending invitations for non-existing users)\n      if (url.pathname.startsWith('/api/workspaces/') && url.pathname.endsWith('/invite') && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const parts = url.pathname.split('/');\n        const workspaceId = parts[3];\n        const { email, role } = await request.json() as any;\n        if (!email) {\n          return jsonResponse({ error: 'Email is required' }, 400);\n        }\n\n        // Verify requester has permission (owner or admin)\n        const ws = await env.DB.prepare('SELECT owner_user_id FROM workspaces WHERE id = ?').bind(workspaceId).first() as any;\n        if (!ws) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n        if (ws.owner_user_id !== userId) {\n          const membership = await env.DB.prepare(\n            'SELECT role FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \\\"active\\\"'\n          ).bind(workspaceId, userId).first() as any;\n          if (!membership || (membership.role !== 'admin' && membership.role !== 'owner')) {\n            return jsonResponse({ error: 'Forbidden' }, 403);\n          }\n        }\n\n        const timestamp = now();\n\n        // Check if user exists\n        const user = await env.DB.prepare('SELECT id FROM users WHERE email = ?').bind(email).first() as any;\n\n        if (user) {\n          // User exists - add them directly as active member\n          const membershipId = generateId();\n          try {\n            await env.DB.prepare(\n              'INSERT INTO workspace_members (id, workspace_id, user_id, role, status, invited_by_user_id, invited_at, joined_at, created_at, updated_at) VALUES (?, ?, ?, ?, \\\"active\\\", ?, ?, ?, ?, ?)'\n            ).bind(membershipId, workspaceId, user.id, role || 'member', userId, timestamp, timestamp, timestamp, timestamp).run();\n          } catch (e) {\n            // If unique constraint, update status/role\n            await env.DB.prepare(\n              'UPDATE workspace_members SET role = ?, status = \\\"active\\\", invited_by_user_id = ?, invited_at = ?, joined_at = ?, updated_at = ? WHERE workspace_id = ? AND user_id = ?'\n            ).bind(role || 'member', userId, timestamp, timestamp, timestamp, workspaceId, user.id).run();\n          }\n          return jsonResponse({ success: true, message: 'User added to workspace' });\n        } else {\n          // User doesn't exist - create account with temporary password\n          const temporaryPassword = generateTemporaryPassword();\n          const passwordHash = await hashPassword(temporaryPassword);\n          const newUserId = generateId();\n\n          // Create user account\n          await env.DB.prepare(\n            'INSERT INTO users (id, email, password_hash, name, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(newUserId, email, passwordHash, null, timestamp, timestamp).run();\n\n          // Create default workspace for the new user\n          const newUserWorkspaceId = 'ws_' + generateId();\n          const workspaceName = email.split('@')[0] || 'My Workspace';\n          await env.DB.prepare(\n            'INSERT INTO workspaces (id, name, owner_user_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n          ).bind(newUserWorkspaceId, workspaceName, newUserId, timestamp, timestamp).run();\n\n          // Create user settings with the invited workspace as selected\n          const settingsId = generateId();\n          const encryptionSalt = generateSalt();\n          await env.DB.prepare(\n            'INSERT INTO user_settings (id, user_id, encryption_salt, selected_workspace_id, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(settingsId, newUserId, encryptionSalt, workspaceId, timestamp, timestamp).run();\n\n          // Add user to the workspace they were invited to\n          const membershipId = generateId();\n          await env.DB.prepare(\n            'INSERT INTO workspace_members (id, workspace_id, user_id, role, status, invited_by_user_id, invited_at, joined_at, created_at, updated_at) VALUES (?, ?, ?, ?, \\\"active\\\", ?, ?, ?, ?, ?)'\n          ).bind(membershipId, workspaceId, newUserId, role || 'member', userId, timestamp, timestamp, timestamp, timestamp).run();\n\n          // Mark any pending invitations as accepted\n          await env.DB.prepare(\n            'UPDATE workspace_invitations SET status = \\\"accepted\\\", accepted_at = ? WHERE email = ? AND workspace_id = ? AND status = \\\"pending\\\"'\n          ).bind(timestamp, email, workspaceId).run();\n\n          return jsonResponse({\n            success: true,\n            message: 'User account created and added to workspace',\n            credentials: {\n              email: email,\n              temporaryPassword: temporaryPassword\n            }\n          });\n        }\n      }\n\n      // Get workspace members\n      if (url.pathname.startsWith('/api/workspaces/') && url.pathname.endsWith('/members') && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const parts = url.pathname.split('/');\n        const workspaceId = parts[3];\n\n        // Verify user has access to this workspace\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id, name FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status, role FROM workspace_members WHERE workspace_id = ? AND user_id = ?'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && (!membership || membership.status !== 'active')) {\n          return jsonResponse({ error: 'Access denied' }, 403);\n        }\n\n        // Get owner info\n        const owner = await env.DB.prepare(\n          'SELECT id, email, name FROM users WHERE id = ?'\n        ).bind(workspace.owner_user_id).first() as any;\n\n        // Get all members including owner\n        const members = await env.DB.prepare(`\n          SELECT wm.id, wm.role, wm.status, wm.joined_at, wm.invited_at,\n                 u.id as user_id, u.email, u.name\n          FROM workspace_members wm\n          JOIN users u ON u.id = wm.user_id\n          WHERE wm.workspace_id = ? AND wm.status = 'active'\n          ORDER BY wm.joined_at DESC\n        `).bind(workspaceId).all() as any;\n\n        const membersList = (members.results || []).map((m: any) => ({\n          id: m.user_id,\n          email: m.email,\n          name: m.name,\n          role: m.role,\n          status: m.status,\n          joinedAt: m.joined_at,\n        }));\n\n        // Add owner to list if not already included\n        const ownerInList = membersList.find((m: any) => m.id === owner.id);\n        if (!ownerInList) {\n          membersList.unshift({\n            id: owner.id,\n            email: owner.email,\n            name: owner.name,\n            role: 'owner',\n            status: 'active',\n            joinedAt: null,\n          });\n        }\n\n        return jsonResponse({\n          workspace: { id: workspaceId, name: workspace.name },\n          members: membersList,\n        });\n      }\n\n      // Remove member from workspace\n      if (url.pathname.includes('/api/workspaces/') && url.pathname.includes('/members/') && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const parts = url.pathname.split('/');\n        const workspaceId = parts[3];\n        const memberId = parts[5];\n\n        // Verify user has permission (must be owner or admin)\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT role FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && (!membership || membership.role !== 'admin')) {\n          return jsonResponse({ error: 'Only owners and admins can remove members' }, 403);\n        }\n\n        // Cannot remove owner\n        if (memberId === workspace.owner_user_id) {\n          return jsonResponse({ error: 'Cannot remove workspace owner' }, 400);\n        }\n\n        // Get the member to remove\n        const member = await env.DB.prepare(\n          'SELECT user_id FROM workspace_members WHERE id = ? AND workspace_id = ?'\n        ).bind(memberId, workspaceId).first() as any;\n\n        if (!member) {\n          return jsonResponse({ error: 'Member not found' }, 404);\n        }\n\n        // Remove member\n        await env.DB.prepare(\n          'DELETE FROM workspace_members WHERE id = ? AND workspace_id = ?'\n        ).bind(memberId, workspaceId).run();\n\n        return jsonResponse({ success: true, message: 'Member removed successfully' });\n      }\n\n      // Update member role\n      if (url.pathname.includes('/api/workspaces/') && url.pathname.includes('/members/') && request.method === 'PATCH') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const parts = url.pathname.split('/');\n        const workspaceId = parts[3];\n        const memberId = parts[5];\n        const { role } = await request.json() as any;\n\n        if (!role || !['member', 'admin'].includes(role)) {\n          return jsonResponse({ error: 'Invalid role. Must be \"member\" or \"admin\"' }, 400);\n        }\n\n        // Verify user has permission (must be owner)\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        if (workspace.owner_user_id !== userId) {\n          return jsonResponse({ error: 'Only workspace owner can change roles' }, 403);\n        }\n\n        // Get the member to update\n        const member = await env.DB.prepare(\n          'SELECT user_id FROM workspace_members WHERE id = ? AND workspace_id = ?'\n        ).bind(memberId, workspaceId).first() as any;\n\n        if (!member) {\n          return jsonResponse({ error: 'Member not found' }, 404);\n        }\n\n        // Update role\n        const timestamp = now();\n        await env.DB.prepare(\n          'UPDATE workspace_members SET role = ?, updated_at = ? WHERE id = ? AND workspace_id = ?'\n        ).bind(role, timestamp, memberId, workspaceId).run();\n\n        return jsonResponse({ success: true, message: 'Member role updated successfully' });\n      }\n\n      // ============================================\n      // PHONE NUMBERS ENDPOINTS (Protected)\n      // ============================================\n\n      // Get Twilio phone numbers\n      if (url.pathname === '/api/twilio/phone-numbers' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected. Please select a workspace first.' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT twilio_account_sid, twilio_auth_token FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.twilio_account_sid || !settings.twilio_auth_token) {\n          return jsonResponse({ error: 'Twilio credentials not configured. Please add your Twilio Account SID and Auth Token in API Configuration.' }, 400);\n        }\n\n        try {\n          // Fetch Twilio phone numbers\n          const twilioUrl = `https://api.twilio.com/2010-04-01/Accounts/${settings.twilio_account_sid}/IncomingPhoneNumbers.json`;\n          const twilioAuth = btoa(`${settings.twilio_account_sid}:${settings.twilio_auth_token}`);\n          \n          const twilioResponse = await fetch(twilioUrl, {\n            headers: {\n              'Authorization': `Basic ${twilioAuth}`,\n            },\n          });\n\n          if (!twilioResponse.ok) {\n            const errorText = await twilioResponse.text();\n            return jsonResponse({ error: `Twilio API error: ${twilioResponse.status} - ${errorText}` }, 400);\n          }\n\n          const twilioData = await twilioResponse.json() as any;\n          \n          // Filter to voice-capable numbers only\n          const voiceNumbers = (twilioData.incoming_phone_numbers || []).filter((num: any) => \n            num.capabilities?.voice === true\n          ).map((num: any) => ({\n            sid: num.sid,\n            phoneNumber: num.phone_number,\n            friendlyName: num.friendly_name,\n            capabilities: {\n              voice: num.capabilities?.voice || false,\n              sms: num.capabilities?.sms || false,\n            }\n          }));\n\n          return jsonResponse(voiceNumbers);\n        } catch (error: any) {\n          console.error('Error fetching Twilio numbers:', error);\n          return jsonResponse({ error: `Failed to fetch Twilio numbers: ${error.message}` }, 500);\n        }\n      }\n\n      // Import Twilio number to Vapi\n      if (url.pathname === '/api/vapi/import-twilio' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { sid, phoneNumber, name } = await request.json() as any;\n\n        if (!sid && !phoneNumber) {\n          return jsonResponse({ error: 'Either sid or phoneNumber is required' }, 400);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected. Please select a workspace first.' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT private_key, twilio_account_sid, twilio_auth_token FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured. Please add your CHAU Voice Engine Private API Key in API Configuration.' }, 400);\n        }\n\n        if (!settings.twilio_account_sid || !settings.twilio_auth_token) {\n          return jsonResponse({ error: 'Twilio credentials not configured. Please add your Twilio Account SID and Auth Token in API Configuration.' }, 400);\n        }\n\n        try {\n          // Import phone number to CHAU Voice Engine\n          // According to Vapi docs, we need to POST to /phone-number with import parameters\n          const vapiUrl = 'https://api.vapi.ai/phone-number';\n          const payload: any = {\n            provider: 'twilio',\n            twilioAccountSid: settings.twilio_account_sid,\n            twilioAuthToken: settings.twilio_auth_token,\n          };\n\n          if (sid) {\n            payload.twilioPhoneNumberSid = sid;\n          } else if (phoneNumber) {\n            payload.number = phoneNumber;\n          }\n\n          if (name) {\n            payload.name = name;\n          }\n\n          // Ensure SMS is disabled, only voice\n          payload.smsEnabled = false;\n\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(payload),\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          const vapiData = await vapiResponse.json() as any;\n          \n          return jsonResponse({\n            id: vapiData.id,\n            number: vapiData.number || vapiData.phoneNumber,\n            name: vapiData.name || name,\n          });\n        } catch (error: any) {\n          console.error('Error importing Twilio number:', error);\n          return jsonResponse({ error: `Failed to import Twilio number: ${error.message}` }, 500);\n        }\n      }\n\n      // Create free CHAU Voice Engine phone number\n      if (url.pathname === '/api/vapi/phone-number' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { areaCode, name } = await request.json() as any;\n\n        if (!areaCode || !/^\\d{3}$/.test(areaCode)) {\n          return jsonResponse({ error: 'Valid 3-digit area code is required' }, 400);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected. Please select a workspace first.' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT private_key, transfer_phone_number FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured. Please add your CHAU Voice Engine Private API Key in API Configuration.' }, 400);\n        }\n\n        try {\n          // Create free CHAU Voice Engine phone number (provider: \"vapi\")\n          // CHAU Voice Engine provides free US phone numbers - no Twilio purchase needed\n          // Up to 10 free numbers per account\n          const vapiUrl = 'https://api.vapi.ai/phone-number';\n          const payload: any = {\n            provider: 'vapi',\n            numberDesiredAreaCode: areaCode, // Correct field name from Vapi dashboard\n          };\n\n          if (name) {\n            payload.name = name;\n          }\n\n          // Set fallback destination to transfer number if available\n          if (settings.transfer_phone_number) {\n            payload.fallbackDestination = {\n              type: 'number',\n              number: settings.transfer_phone_number,\n            };\n          }\n\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(payload),\n          });\n\n          if (!vapiResponse.ok) {\n            let errorText = await vapiResponse.text();\n            try {\n              // Try to parse error JSON to extract meaningful message\n              const errorJson = JSON.parse(errorText);\n              if (errorJson.message) {\n                errorText = errorJson.message;\n              } else if (errorJson.error) {\n                errorText = errorJson.error;\n              }\n            } catch {\n              // If not JSON, use error text as is\n            }\n            return jsonResponse({ error: errorText }, 400);\n          }\n\n          const vapiData = await vapiResponse.json() as any;\n          \n          return jsonResponse({\n            id: vapiData.id,\n            number: vapiData.number || vapiData.phoneNumber,\n            name: vapiData.name || name,\n          });\n        } catch (error: any) {\n          console.error('Error creating CHAU Voice Engine phone number:', error);\n          return jsonResponse({ error: `Failed to create phone number: ${error.message}` }, 500);\n        }\n      }\n\n      // Update phone number assistant assignment\n      if (url.pathname.startsWith('/api/vapi/phone-number/') && url.pathname.endsWith('/assistant') && request.method === 'PATCH') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Extract ID from /api/vapi/phone-number/{id}/assistant\n        const pathParts = url.pathname.split('/').filter(Boolean);\n        const phoneNumberId = pathParts.length >= 4 ? pathParts[3] : null; // ['api', 'vapi', 'phone-number', '{id}', 'assistant']\n        const { assistantId } = await request.json() as any;\n\n        if (!phoneNumberId) {\n          return jsonResponse({ error: 'Phone number ID required' }, 400);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected. Please select a workspace first.' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        let settings = await env.DB.prepare(\n          'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        // FALLBACK: If workspace_settings is empty, try user_settings\n        if (!settings || !settings.private_key) {\n          const ownerSettings = await env.DB.prepare(\n            'SELECT private_key FROM user_settings WHERE user_id = ?'\n          ).bind(workspace.owner_user_id).first() as any;\n\n          if (ownerSettings && ownerSettings.private_key) {\n            settings = ownerSettings;\n          }\n        }\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured. Please add your CHAU Voice Engine Private API Key in API Configuration.' }, 400);\n        }\n\n        try {\n          // Update phone number via Vapi API\n          const vapiUrl = `https://api.vapi.ai/phone-number/${phoneNumberId}`;\n          const payload: any = {};\n          \n          // If assistantId is null/undefined, set it to null to remove assignment\n          // If assistantId is provided, set it to assign\n          if (assistantId === null || assistantId === undefined || assistantId === '') {\n            payload.assistantId = null;\n          } else {\n            payload.assistantId = assistantId;\n          }\n\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'PATCH',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(payload),\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          const vapiData = await vapiResponse.json() as any;\n          \n          return jsonResponse({\n            success: true,\n            phoneNumber: {\n              id: vapiData.id,\n              number: vapiData.number || vapiData.phoneNumber,\n              assistantId: vapiData.assistantId || null,\n            }\n          });\n        } catch (error: any) {\n          console.error('Error updating phone number assistant:', error);\n          return jsonResponse({ error: `Failed to update phone number: ${error.message}` }, 500);\n        }\n      }\n\n      // ============================================\n      // ASSISTANTS ENDPOINTS (Protected with Caching)\n      // ============================================\n\n      // Get all assistants (cache-first, supports workspace context)\n      if (url.pathname === '/api/assistants' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get user settings including selected_workspace_id\n        const settings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!settings) {\n          return jsonResponse({ error: 'User settings not found' }, 404);\n        }\n\n        // Determine effective user ID for API key and cache lookup\n        let effectiveUserId = userId;\n        let privateKey: string | null = null;\n\n        // If workspace is selected, use workspace settings (workspace-scoped credentials)\n        if (settings.selected_workspace_id) {\n          // Verify user has access to this workspace\n          const workspace = await env.DB.prepare(\n            'SELECT owner_user_id FROM workspaces WHERE id = ?'\n          ).bind(settings.selected_workspace_id).first() as any;\n\n          if (workspace) {\n            // Check if user is owner or active member\n            const isOwner = workspace.owner_user_id === userId;\n            const membership = await env.DB.prepare(\n              'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n            ).bind(settings.selected_workspace_id, userId).first() as any;\n\n            if (isOwner || membership) {\n              // Use workspace settings (workspace-scoped credentials)\n              const wsSettings = await env.DB.prepare(\n                'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n              ).bind(settings.selected_workspace_id).first() as any;\n\n              if (wsSettings && wsSettings.private_key) {\n                privateKey = wsSettings.private_key;\n                effectiveUserId = workspace.owner_user_id;\n              } else {\n                // No workspace credentials - return empty list instead of error\n                return jsonResponse({ assistants: [] });\n              }\n            } else {\n              return jsonResponse({ error: 'Access denied to workspace' }, 403);\n            }\n          } else {\n            // Workspace not found - return empty list\n            return jsonResponse({ assistants: [] });\n          }\n        } else {\n          // No workspace selected - return empty list (credentials are now workspace-scoped only)\n          return jsonResponse({ assistants: [] });\n        }\n\n        if (!privateKey) {\n          // No credentials found - return empty list\n          return jsonResponse({ assistants: [] });\n        }\n\n        try {\n          // Check cache first - get ALL assistants for this user\n          const allCached = await env.DB.prepare(\n            'SELECT id, vapi_data, cached_at, updated_at FROM assistants_cache WHERE user_id = ? ORDER BY cached_at DESC'\n          ).bind(effectiveUserId).all();\n\n          // Check if we have fresh cache data (any assistant cached within last 5 minutes means full list is fresh)\n          if (allCached && allCached.results && allCached.results.length > 0) {\n            const cacheAgeLimit = now() - (5 * 60); // 5 minutes ago\n            const mostRecentCache = allCached.results[0] as any;\n\n            // If the most recently cached assistant is still fresh, return ALL cached assistants\n            if (mostRecentCache.cached_at > cacheAgeLimit) {\n              const assistants = allCached.results.map((row: any) => JSON.parse(row.vapi_data));\n              return jsonResponse({ assistants, cached: true });\n            }\n          }\n\n          // Cache miss or stale - fetch from Vapi\n          const vapiUrl = 'https://api.vapi.ai/assistant';\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${privateKey}`,\n              'Content-Type': 'application/json',\n            },\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          const assistants = await vapiResponse.json() as any[];\n          const timestamp = now();\n\n          // Update cache using effective user ID (workspace owner if applicable)\n          for (const assistant of assistants) {\n            await env.DB.prepare(\n              'INSERT OR REPLACE INTO assistants_cache (id, user_id, vapi_data, cached_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n            ).bind(\n              assistant.id,\n              effectiveUserId,\n              JSON.stringify(assistant),\n              timestamp,\n              new Date(assistant.updatedAt || assistant.createdAt).getTime() / 1000 || timestamp\n            ).run();\n          }\n\n          return jsonResponse({ assistants, cached: false });\n        } catch (error: any) {\n          console.error('Error fetching assistants:', error);\n          return jsonResponse({ error: `Failed to fetch assistants: ${error.message}` }, 500);\n        }\n      }\n\n      // Get single assistant (cache-first)\n      if (url.pathname.startsWith('/api/assistants/') && url.pathname !== '/api/assistants' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const assistantId = url.pathname.split('/').pop();\n        if (!assistantId) {\n          return jsonResponse({ error: 'Assistant ID required' }, 400);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured' }, 400);\n        }\n\n        const effectiveUserId = workspace.owner_user_id;\n\n        try {\n          // Check cache first (use workspace owner's user_id for cache)\n          const cached = await env.DB.prepare(\n            'SELECT vapi_data, cached_at FROM assistants_cache WHERE id = ? AND user_id = ?'\n          ).bind(assistantId, effectiveUserId).first() as any;\n\n          if (cached) {\n            const cacheAge = now() - cached.cached_at;\n            // If cached within last 5 minutes, use cache\n            if (cacheAge < 5 * 60) {\n              return jsonResponse({ assistant: JSON.parse(cached.vapi_data), cached: true });\n            }\n          }\n\n          // Cache miss or stale - fetch from Vapi\n          const vapiUrl = `https://api.vapi.ai/assistant/${assistantId}`;\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          const assistant = await vapiResponse.json() as any;\n          const timestamp = now();\n\n          // Update cache (use workspace owner's user_id for cache)\n          await env.DB.prepare(\n            'INSERT OR REPLACE INTO assistants_cache (id, user_id, vapi_data, cached_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n          ).bind(\n            assistant.id,\n            effectiveUserId,\n            JSON.stringify(assistant),\n            timestamp,\n            new Date(assistant.updatedAt || assistant.createdAt).getTime() / 1000 || timestamp\n          ).run();\n\n          return jsonResponse({ assistant, cached: false });\n        } catch (error: any) {\n          console.error('Error fetching assistant:', error);\n          return jsonResponse({ error: `Failed to fetch assistant: ${error.message}` }, 500);\n        }\n      }\n\n      // Update assistant (write-through cache)\n      if (url.pathname.startsWith('/api/assistants/') && url.pathname !== '/api/assistants' && request.method === 'PATCH') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const assistantId = url.pathname.split('/').pop();\n        const updates = await request.json() as any;\n\n        if (!assistantId) {\n          return jsonResponse({ error: 'Assistant ID required' }, 400);\n        }\n\n        // Get user's selected workspace\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        let settings;\n\n        // If user has selected a workspace, use workspace settings\n        if (userSettings?.selected_workspace_id) {\n          const workspaceId = userSettings.selected_workspace_id;\n\n          // Verify workspace access\n          const workspace = await env.DB.prepare(\n            'SELECT owner_user_id FROM workspaces WHERE id = ?'\n          ).bind(workspaceId).first() as any;\n\n          if (!workspace) {\n            return jsonResponse({ error: 'Workspace not found' }, 404);\n          }\n\n          const isOwner = workspace.owner_user_id === userId;\n          const membership = await env.DB.prepare(\n            'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n          ).bind(workspaceId, userId).first() as any;\n\n          if (!isOwner && !membership) {\n            return jsonResponse({ error: 'Access denied to workspace' }, 403);\n          }\n\n          // Get workspace settings\n          settings = await env.DB.prepare(\n            'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n          ).bind(workspaceId).first() as any;\n\n          // FALLBACK: If workspace_settings is empty, try user_settings\n          if (!settings || !settings.private_key) {\n            const ownerSettings = await env.DB.prepare(\n              'SELECT private_key FROM user_settings WHERE user_id = ?'\n            ).bind(workspace.owner_user_id).first() as any;\n\n            if (ownerSettings && ownerSettings.private_key) {\n              settings = ownerSettings;\n            }\n          }\n        } else {\n          // No workspace selected, use user settings\n          settings = await env.DB.prepare(\n            'SELECT private_key FROM user_settings WHERE user_id = ?'\n          ).bind(userId).first() as any;\n        }\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured' }, 400);\n        }\n\n        try {\n          // 1. Update in Vapi first (source of truth)\n          const vapiUrl = `https://api.vapi.ai/assistant/${assistantId}`;\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'PATCH',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(updates),\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          const updatedAssistant = await vapiResponse.json() as any;\n          const timestamp = now();\n\n          // 2. Update D1 cache (write-through)\n          await env.DB.prepare(\n            'INSERT OR REPLACE INTO assistants_cache (id, user_id, vapi_data, cached_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n          ).bind(\n            updatedAssistant.id,\n            userId,\n            JSON.stringify(updatedAssistant),\n            timestamp,\n            new Date(updatedAssistant.updatedAt || updatedAssistant.createdAt).getTime() / 1000 || timestamp\n          ).run();\n\n          return jsonResponse({ assistant: updatedAssistant });\n        } catch (error: any) {\n          console.error('Error updating assistant:', error);\n          return jsonResponse({ error: `Failed to update assistant: ${error.message}` }, 500);\n        }\n      }\n\n      // Create assistant (write-through cache)\n      if (url.pathname === '/api/assistants' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const assistantData = await request.json() as any;\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected. Please select a workspace first.' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured. Please configure workspace API keys in Settings.' }, 400);\n        }\n\n        try {\n          // 1. Create in Vapi first (source of truth)\n          const vapiUrl = 'https://api.vapi.ai/assistant';\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(assistantData),\n          });\n\n          if (!vapiResponse.ok) {\n            let errorText = await vapiResponse.text();\n            try {\n              // Try to parse error JSON to extract meaningful message\n              const errorJson = JSON.parse(errorText);\n              if (errorJson.message) {\n                errorText = errorJson.message;\n              } else if (errorJson.error) {\n                errorText = errorJson.error;\n              }\n            } catch {\n              // If not JSON, use error text as is\n            }\n            return jsonResponse({ error: errorText }, 400);\n          }\n\n          const newAssistant = await vapiResponse.json() as any;\n          const timestamp = now();\n\n          // 2. Add to D1 cache (write-through) - use workspace owner's user_id for cache\n          const effectiveUserId = workspace.owner_user_id;\n          await env.DB.prepare(\n            'INSERT OR REPLACE INTO assistants_cache (id, user_id, vapi_data, cached_at, updated_at) VALUES (?, ?, ?, ?, ?)'\n          ).bind(\n            newAssistant.id,\n            effectiveUserId,\n            JSON.stringify(newAssistant),\n            timestamp,\n            new Date(newAssistant.updatedAt || newAssistant.createdAt).getTime() / 1000 || timestamp\n          ).run();\n\n          return jsonResponse({ assistant: newAssistant });\n        } catch (error: any) {\n          console.error('Error creating assistant:', error);\n          return jsonResponse({ error: `Failed to create assistant: ${error.message}` }, 500);\n        }\n      }\n\n      // Delete assistant (write-through cache)\n      if (url.pathname.startsWith('/api/assistants/') && url.pathname !== '/api/assistants' && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const assistantId = url.pathname.split('/').pop();\n        if (!assistantId) {\n          return jsonResponse({ error: 'Assistant ID required' }, 400);\n        }\n\n        // Get workspace settings (workspace-scoped)\n        const userSettings = await env.DB.prepare(\n          'SELECT selected_workspace_id FROM user_settings WHERE user_id = ?'\n        ).bind(userId).first() as any;\n\n        if (!userSettings || !userSettings.selected_workspace_id) {\n          return jsonResponse({ error: 'No workspace selected' }, 400);\n        }\n\n        const workspaceId = userSettings.selected_workspace_id;\n\n        // Verify workspace access\n        const workspace = await env.DB.prepare(\n          'SELECT owner_user_id FROM workspaces WHERE id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!workspace) {\n          return jsonResponse({ error: 'Workspace not found' }, 404);\n        }\n\n        const isOwner = workspace.owner_user_id === userId;\n        const membership = await env.DB.prepare(\n          'SELECT status FROM workspace_members WHERE workspace_id = ? AND user_id = ? AND status = \"active\"'\n        ).bind(workspaceId, userId).first() as any;\n\n        if (!isOwner && !membership) {\n          return jsonResponse({ error: 'Access denied to workspace' }, 403);\n        }\n\n        const settings = await env.DB.prepare(\n          'SELECT private_key FROM workspace_settings WHERE workspace_id = ?'\n        ).bind(workspaceId).first() as any;\n\n        if (!settings || !settings.private_key) {\n          return jsonResponse({ error: 'CHAU Voice Engine API key not configured' }, 400);\n        }\n\n        const effectiveUserId = workspace.owner_user_id;\n\n        try {\n          // 1. Delete from Vapi first (source of truth)\n          const vapiUrl = `https://api.vapi.ai/assistant/${assistantId}`;\n          const vapiResponse = await fetch(vapiUrl, {\n            method: 'DELETE',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`,\n              'Content-Type': 'application/json',\n            },\n          });\n\n          if (!vapiResponse.ok) {\n            const errorText = await vapiResponse.text();\n            return jsonResponse({ error: `CHAU Voice Engine API error: ${vapiResponse.status} - ${errorText}` }, 400);\n          }\n\n          // 2. Delete from D1 cache (write-through) - use workspace owner's user_id\n          await env.DB.prepare(\n            'DELETE FROM assistants_cache WHERE id = ? AND user_id = ?'\n          ).bind(assistantId, effectiveUserId).run();\n\n          return jsonResponse({ success: true });\n        } catch (error: any) {\n          console.error('Error deleting assistant:', error);\n          return jsonResponse({ error: `Failed to delete assistant: ${error.message}` }, 500);\n        }\n      }\n\n      // ============================================\n      // ADDONS ENDPOINTS (Protected)\n      // ============================================\n\n      // Get user addons configuration\n      if (url.pathname === '/api/addons' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { results } = await env.DB.prepare(\n          'SELECT addon_type, is_enabled, settings FROM user_addons WHERE user_id = ?'\n        ).bind(userId).all();\n\n        return jsonResponse({ addons: results || [] });\n      }\n\n      // Toggle addon on/off\n      if (url.pathname === '/api/addons/toggle' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { addonType, enabled } = await request.json() as any;\n\n        if (!addonType) {\n          return jsonResponse({ error: 'addon_type required' }, 400);\n        }\n\n        const timestamp = now();\n\n        // Check if addon config exists\n        const existing = await env.DB.prepare(\n          'SELECT id FROM user_addons WHERE user_id = ? AND addon_type = ?'\n        ).bind(userId, addonType).first();\n\n        if (existing) {\n          // Update existing\n          await env.DB.prepare(\n            'UPDATE user_addons SET is_enabled = ?, updated_at = ? WHERE user_id = ? AND addon_type = ?'\n          ).bind(enabled ? 1 : 0, timestamp, userId, addonType).run();\n        } else {\n          // Create new\n          await env.DB.prepare(\n            'INSERT INTO user_addons (id, user_id, addon_type, is_enabled, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(generateId(), userId, addonType, enabled ? 1 : 0, timestamp, timestamp).run();\n        }\n\n        return jsonResponse({ message: 'Addon updated successfully', enabled });\n      }\n\n      // Get addon results for a call\n      if (url.pathname.startsWith('/api/addon-results/') && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const callId = url.pathname.split('/').pop();\n\n        const { results } = await env.DB.prepare(\n          'SELECT addon_type, status, result_data, error_message, execution_time_ms, created_at FROM addon_results WHERE call_id = ? AND user_id = ?'\n        ).bind(callId, userId).all();\n\n        return jsonResponse({ results: results || [] });\n      }\n\n      // ============================================\n      // SCHEDULING TRIGGERS ENDPOINTS (Protected)\n      // ============================================\n\n      // Get all scheduling triggers for user\n      if (url.pathname === '/api/scheduling-triggers' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { results } = await env.DB.prepare(\n          'SELECT * FROM scheduling_triggers WHERE user_id = ? ORDER BY created_at DESC'\n        ).bind(userId).all();\n\n        return jsonResponse(results || []);\n      }\n\n      // Create scheduling trigger\n      if (url.pathname === '/api/scheduling-triggers' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { name, destination_url, send_enhanced_data } = await request.json() as any;\n\n        if (!name || !destination_url) {\n          return jsonResponse({ error: 'Name and destination URL are required' }, 400);\n        }\n\n        const triggerId = generateId();\n        const timestamp = now();\n\n        await env.DB.prepare(\n          `INSERT INTO scheduling_triggers (id, user_id, name, destination_url, send_enhanced_data, is_active, created_at, updated_at)\n           VALUES (?, ?, ?, ?, ?, ?, ?, ?)`\n        ).bind(\n          triggerId,\n          userId,\n          name,\n          destination_url,\n          send_enhanced_data ? 1 : 0,\n          1, // active by default\n          timestamp,\n          timestamp\n        ).run();\n\n        return jsonResponse({ id: triggerId, message: 'Scheduling trigger created successfully' });\n      }\n\n      // Update scheduling trigger\n      if (url.pathname.startsWith('/api/scheduling-triggers/') && request.method === 'PUT') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const triggerId = url.pathname.split('/').pop();\n        const { name, destination_url, send_enhanced_data, is_active } = await request.json() as any;\n\n        await env.DB.prepare(\n          `UPDATE scheduling_triggers\n           SET name = ?, destination_url = ?, send_enhanced_data = ?, is_active = ?, updated_at = ?\n           WHERE id = ? AND user_id = ?`\n        ).bind(\n          name,\n          destination_url,\n          send_enhanced_data ? 1 : 0,\n          is_active ? 1 : 0,\n          now(),\n          triggerId,\n          userId\n        ).run();\n\n        return jsonResponse({ message: 'Scheduling trigger updated successfully' });\n      }\n\n      // Delete scheduling trigger\n      if (url.pathname.startsWith('/api/scheduling-triggers/') && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const triggerId = url.pathname.split('/').pop();\n\n        await env.DB.prepare(\n          'DELETE FROM scheduling_triggers WHERE id = ? AND user_id = ?'\n        ).bind(triggerId, userId).run();\n\n        return jsonResponse({ message: 'Scheduling trigger deleted successfully' });\n      }\n\n      // Get scheduling trigger logs\n      if (url.pathname === '/api/scheduling-trigger-logs' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const triggerId = url.searchParams.get('trigger_id');\n\n        let query = `\n          SELECT stl.*, st.name as trigger_name, wc.customer_name, wc.appointment_date, wc.appointment_time\n          FROM scheduling_trigger_logs stl\n          JOIN scheduling_triggers st ON st.id = stl.trigger_id\n          JOIN webhook_calls wc ON wc.id = stl.call_id\n          WHERE st.user_id = ?\n        `;\n\n        const params = [userId];\n\n        if (triggerId) {\n          query += ' AND stl.trigger_id = ?';\n          params.push(triggerId);\n        }\n\n        query += ' ORDER BY stl.created_at DESC LIMIT 100';\n\n        const { results } = await env.DB.prepare(query).bind(...params).all();\n\n        return jsonResponse(results || []);\n      }\n\n      // ============================================\n      // KNOWLEDGE BASE ENDPOINTS (Protected)\n      // ============================================\n\n      // List knowledge files for an agent\n      if (url.pathname.startsWith('/api/knowledge-files/') && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const agentId = url.pathname.split('/').pop();\n        \n        const { results } = await env.DB.prepare(\n          'SELECT * FROM agent_knowledge_files WHERE agent_id = ? ORDER BY created_at DESC'\n        ).bind(agentId).all();\n\n        return jsonResponse(results || []);\n      }\n\n      // Create knowledge file record\n      if (url.pathname === '/api/knowledge-files' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { agent_id, vapi_file_id, file_name, file_size, status } = await request.json() as any;\n\n        if (!agent_id || !vapi_file_id || !file_name) {\n          return jsonResponse({ error: 'Missing required fields' }, 400);\n        }\n\n        const id = generateId();\n        const timestamp = now();\n\n        await env.DB.prepare(\n          'INSERT INTO agent_knowledge_files (id, agent_id, vapi_file_id, file_name, file_size, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)'\n        ).bind(id, agent_id, vapi_file_id, file_name, file_size || 0, status || 'ready', timestamp, timestamp).run();\n\n        return jsonResponse({\n          id,\n          agent_id,\n          vapi_file_id,\n          file_name,\n          file_size: file_size || 0,\n          status: status || 'ready',\n          created_at: timestamp,\n          updated_at: timestamp\n        }, 201);\n      }\n\n      // Delete knowledge file record\n      if (url.pathname.startsWith('/api/knowledge-files/') && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const id = url.pathname.split('/').pop();\n\n        await env.DB.prepare(\n          'DELETE FROM agent_knowledge_files WHERE id = ?'\n        ).bind(id).run();\n\n        return jsonResponse({ message: 'File deleted successfully' });\n      }\n\n      // ============================================\n      // WEBHOOK ENDPOINTS\n      // ============================================\n\n      // Create new webhook\n      if (url.pathname === '/api/webhooks' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const { name } = await request.json() as any;\n\n        if (!name) {\n          return jsonResponse({ error: 'Webhook name required' }, 400);\n        }\n\n        // Generate unique webhook ID\n        const webhookId = 'wh_' + generateId();\n        const webhookUrl = `https://api.voice-config.channelautomation.com/webhook/${webhookId}`;\n        const timestamp = now();\n\n        await env.DB.prepare(\n          'INSERT INTO webhooks (id, user_id, webhook_url, name, is_active, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?)'\n        ).bind(webhookId, userId, webhookUrl, name, 1, timestamp, timestamp).run();\n\n        return jsonResponse({\n          id: webhookId,\n          url: webhookUrl,\n          name,\n          is_active: true,\n          created_at: timestamp\n        }, 201);\n      }\n\n      // List webhooks for user (supports workspace context)\n      if (url.pathname === '/api/webhooks' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        const { results } = await env.DB.prepare(\n          `SELECT\n            w.id,\n            w.webhook_url,\n            w.name,\n            w.is_active,\n            w.created_at,\n            COUNT(wc.id) as call_count\n          FROM webhooks w\n          LEFT JOIN webhook_calls wc ON w.id = wc.webhook_id\n          WHERE w.user_id = ?\n          GROUP BY w.id\n          ORDER BY w.created_at DESC`\n        ).bind(effectiveUserId).all();\n\n        return jsonResponse(results || []);\n      }\n\n      // Delete webhook\n      if (url.pathname.startsWith('/api/webhooks/') && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const webhookId = url.pathname.split('/').pop();\n\n        // Verify ownership\n        const webhook = await env.DB.prepare(\n          'SELECT user_id FROM webhooks WHERE id = ?'\n        ).bind(webhookId).first() as any;\n\n        if (!webhook) {\n          return jsonResponse({ error: 'Webhook not found' }, 404);\n        }\n\n        if (webhook.user_id !== userId) {\n          return jsonResponse({ error: 'Forbidden' }, 403);\n        }\n\n        // Delete webhook (cascade will delete calls and logs)\n        await env.DB.prepare(\n          'DELETE FROM webhooks WHERE id = ?'\n        ).bind(webhookId).run();\n\n        return jsonResponse({ message: 'Webhook deleted successfully' });\n      }\n\n      // ============================================\n      // OUTBOUND WEBHOOKS ENDPOINTS\n      // ============================================\n\n      // Create outbound webhook\n      if (url.pathname === '/api/outbound-webhooks' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n        return await createOutboundWebhook(request, env, userId);\n      }\n\n      // List outbound webhooks\n      if (url.pathname === '/api/outbound-webhooks' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n        return await listOutboundWebhooks(env, userId);\n      }\n\n      // Update outbound webhook\n      if (url.pathname.startsWith('/api/outbound-webhooks/') && request.method === 'PATCH') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n        const webhookId = url.pathname.split('/').pop()!;\n        return await updateOutboundWebhook(request, env, userId, webhookId);\n      }\n\n      // Delete outbound webhook\n      if (url.pathname.startsWith('/api/outbound-webhooks/') && request.method === 'DELETE') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n        const webhookId = url.pathname.split('/').pop()!;\n        return await deleteOutboundWebhook(env, userId, webhookId);\n      }\n\n      // Get outbound webhook logs\n      if (url.pathname.match(/^\\/api\\/outbound-webhooks\\/[^/]+\\/logs$/) && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n        const webhookId = url.pathname.split('/')[3];\n        return await getOutboundWebhookLogs(env, userId, webhookId);\n      }\n\n      // ============================================\n      // WEBHOOK CALLS\n      // ============================================\n\n      // Get webhook calls (with KV caching, supports workspace context)\n      if (url.pathname === '/api/webhook-calls' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        const webhookId = url.searchParams.get('webhook_id');\n        const limit = parseInt(url.searchParams.get('limit') || '100');\n        const offset = parseInt(url.searchParams.get('offset') || '0');\n        const page = Math.floor(offset / limit) + 1;\n\n        // Initialize cache\n        const cache = new VoiceAICache(env.CACHE);\n        \n        // Check if cache-busting parameter is present\n        const cacheBust = url.searchParams.get('_t');\n\n        // Try to get from cache first (only if no webhook filter, reasonable page size, and no cache-bust)\n        // Use effectiveUserId for cache key to scope by workspace owner\n        if (!webhookId && limit <= 100 && !cacheBust) {\n          const cached = await cache.getCachedRecordings(effectiveUserId, page, limit);\n          if (cached) {\n            console.log(`Cache HIT for recordings: user=${effectiveUserId}, page=${page}, limit=${limit}`);\n            return jsonResponse(cached);\n          }\n        }\n\n        console.log(`Cache MISS for recordings: user=${effectiveUserId}, page=${page}, limit=${limit}${cacheBust ? ' (cache-bust requested)' : ''}`);\n\n        // Fetch from database with enhanced data (using effectiveUserId for workspace context)\n        // Filter out test calls (those without customer_number)\n        let query = env.DB.prepare(\n          `SELECT\n            wc.id,\n            wc.webhook_id,\n            wc.vapi_call_id,\n            wc.phone_number,\n            wc.customer_number,\n            wc.recording_url,\n            wc.ended_reason,\n            wc.summary,\n            wc.structured_data,\n            wc.raw_payload,\n            wc.intent,\n            wc.sentiment,\n            wc.outcome,\n            wc.analysis_completed,\n            wc.analyzed_at,\n            wc.customer_name,\n            wc.caller_name,\n            wc.caller_type,\n            wc.carrier_name,\n            wc.line_type,\n            wc.created_at,\n            wc.duration_seconds,\n            ar.result_data as enhanced_data\n          FROM webhook_calls wc\n          LEFT JOIN addon_results ar ON ar.call_id = wc.id AND ar.addon_type = 'enhanced_data' AND ar.status = 'success'\n          WHERE wc.user_id = ?\n          AND wc.customer_number IS NOT NULL\n          ${webhookId ? 'AND wc.webhook_id = ?' : ''}\n          ORDER BY CASE\n            WHEN wc.created_at > 1000000000000 THEN wc.created_at / 1000\n            ELSE wc.created_at\n          END DESC\n          LIMIT ? OFFSET ?`\n        );\n\n        const params = webhookId\n          ? [effectiveUserId, webhookId, limit, offset]\n          : [effectiveUserId, limit, offset];\n\n        const { results } = await query.bind(...params).all();\n\n        // Parse structured_data, raw_payload, and enhanced_data JSON for each result\n        const parsedResults = (results || []).map((row: any) => ({\n          ...row,\n          structured_data: row.structured_data ? JSON.parse(row.structured_data) : null,\n          raw_payload: row.raw_payload ? JSON.parse(row.raw_payload) : null,\n          enhanced_data: row.enhanced_data ? JSON.parse(row.enhanced_data) : null\n        }));\n\n        // Cache the results (only if no webhook filter and reasonable page size)\n        // Use effectiveUserId for cache key to scope by workspace owner\n        if (!webhookId && limit <= 100) {\n          await cache.cacheRecordings(effectiveUserId, parsedResults, page, limit, CACHE_TTL.RECORDINGS);\n        }\n\n        return jsonResponse(parsedResults);\n      }\n\n      // Get intent analysis with caching\n      // Get active calls\n      // Get active calls (supports workspace context)\n      if (url.pathname === '/api/active-calls' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Fetch active calls from database (using effectiveUserId)\n        const { results } = await env.DB.prepare(\n          `SELECT\n            id,\n            vapi_call_id,\n            customer_number,\n            caller_name,\n            carrier_name,\n            line_type,\n            status,\n            started_at,\n            updated_at\n          FROM active_calls\n          WHERE user_id = ?\n          ORDER BY started_at DESC`\n        ).bind(effectiveUserId).all();\n\n        return jsonResponse(results);\n      }\n\n      // Cleanup stale active calls (manual trigger)\n      if (url.pathname === '/api/active-calls/cleanup' && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Clean up active calls older than 2 hours for this user\n        const twoHoursAgo = Math.floor(Date.now() / 1000) - (2 * 60 * 60);\n\n        const result = await env.DB.prepare(\n          `DELETE FROM active_calls WHERE user_id = ? AND updated_at < ?`\n        ).bind(effectiveUserId, twoHoursAgo).run();\n\n        console.log('[Manual Cleanup] Stale calls removed:', {\n          userId: effectiveUserId,\n          deletedCalls: result.meta.changes,\n          threshold: new Date(twoHoursAgo * 1000).toISOString()\n        });\n\n        return jsonResponse({\n          success: true,\n          deletedCalls: result.meta.changes,\n          message: `Removed ${result.meta.changes} stale call(s)`\n        });\n      }\n\n      // Get concurrent calls stats\n      // Get concurrent calls stats (supports workspace context)\n      if (url.pathname === '/api/concurrent-calls' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Get current concurrent calls (active calls)\n        const activeCallsResult = await env.DB.prepare(\n          `SELECT COUNT(*) as count FROM active_calls WHERE user_id = ?`\n        ).bind(effectiveUserId).first() as any;\n        \n        const currentConcurrent = activeCallsResult?.count || 0;\n\n        // Get historical peak concurrent calls\n        // We'll analyze webhook_calls to find the maximum number of overlapping calls\n        // Filter out test calls (those without customer_number)\n        const { results } = await env.DB.prepare(\n          `SELECT raw_payload, created_at\n          FROM webhook_calls\n          WHERE user_id = ?\n          AND raw_payload IS NOT NULL\n          AND customer_number IS NOT NULL\n          ORDER BY created_at DESC\n          LIMIT 1000`\n        ).bind(effectiveUserId).all();\n\n        let peakConcurrent = 0;\n        \n        if (results && results.length > 0) {\n          // Extract call time ranges from raw_payload\n          const callRanges: Array<{ start: number; end: number }> = [];\n          \n          for (const row of results as any[]) {\n            try {\n              const payload = typeof row.raw_payload === 'string' \n                ? JSON.parse(row.raw_payload) \n                : row.raw_payload;\n              \n              const startedAt = payload.message?.call?.startedAt;\n              const endedAt = payload.message?.call?.endedAt;\n              \n              if (startedAt && endedAt) {\n                const startTime = new Date(startedAt).getTime();\n                const endTime = new Date(endedAt).getTime();\n                if (startTime && endTime && startTime < endTime) {\n                  callRanges.push({ start: startTime, end: endTime });\n                }\n              }\n            } catch (error) {\n              // Skip invalid payloads\n              continue;\n            }\n          }\n\n          // Find peak concurrent calls by checking all time points\n          if (callRanges.length > 0) {\n            // Collect all unique time points (start and end times)\n            const timePoints = new Set<number>();\n            callRanges.forEach(range => {\n              timePoints.add(range.start);\n              timePoints.add(range.end);\n            });\n\n            // Check concurrent calls at each time point\n            const sortedTimePoints = Array.from(timePoints).sort((a, b) => a - b);\n            \n            for (const timePoint of sortedTimePoints) {\n              const concurrent = callRanges.filter(range => \n                range.start <= timePoint && range.end > timePoint\n              ).length;\n              \n              if (concurrent > peakConcurrent) {\n                peakConcurrent = concurrent;\n              }\n            }\n          }\n        }\n\n        return jsonResponse({\n          current: currentConcurrent,\n          peak: peakConcurrent\n        });\n      }\n\n      // Get concurrent calls time-series data\n      // Get concurrent calls timeseries (supports workspace context)\n      if (url.pathname === '/api/concurrent-calls/timeseries' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        const granularity = url.searchParams.get('granularity') || 'minute'; // minute, hour, day\n        const limit = parseInt(url.searchParams.get('limit') || '1000');\n\n        // Fetch recent calls with their time ranges (using effectiveUserId)\n        // Filter out test calls (those without customer_number)\n        const { results } = await env.DB.prepare(\n          `SELECT raw_payload, created_at\n          FROM webhook_calls\n          WHERE user_id = ?\n          AND raw_payload IS NOT NULL\n          AND customer_number IS NOT NULL\n          ORDER BY created_at DESC\n          LIMIT ?`\n        ).bind(effectiveUserId, limit).all();\n\n        if (!results || results.length === 0) {\n          return jsonResponse({ data: [], labels: [] });\n        }\n\n        // Extract call time ranges\n        const callRanges: Array<{ start: number; end: number }> = [];\n        \n        for (const row of results as any[]) {\n          try {\n            const payload = typeof row.raw_payload === 'string' \n              ? JSON.parse(row.raw_payload) \n              : row.raw_payload;\n            \n            const startedAt = payload.message?.call?.startedAt;\n            const endedAt = payload.message?.call?.endedAt;\n            \n            if (startedAt && endedAt) {\n              const startTime = new Date(startedAt).getTime();\n              const endTime = new Date(endedAt).getTime();\n              if (startTime && endTime && startTime < endTime) {\n                callRanges.push({ start: startTime, end: endTime });\n              }\n            }\n          } catch (error) {\n            continue;\n          }\n        }\n\n        if (callRanges.length === 0) {\n          return jsonResponse({ data: [], labels: [] });\n        }\n\n        // Determine time window\n        const allTimes = callRanges.flatMap(r => [r.start, r.end]);\n        const minTime = Math.min(...allTimes);\n        const maxTime = Math.max(...allTimes);\n\n        // Calculate time buckets based on granularity\n        let bucketSize: number;\n        let dateFormatter: (date: Date) => string;\n\n        if (granularity === 'minute') {\n          bucketSize = 60 * 1000; // 1 minute\n          dateFormatter = (d) => d.toISOString().slice(0, 16).replace('T', ' ');\n        } else if (granularity === 'hour') {\n          bucketSize = 60 * 60 * 1000; // 1 hour\n          dateFormatter = (d) => d.toISOString().slice(0, 13) + ':00';\n        } else { // day\n          bucketSize = 24 * 60 * 60 * 1000; // 1 day\n          dateFormatter = (d) => d.toISOString().split('T')[0];\n        }\n\n        // Create time buckets\n        const buckets = new Map<string, number>();\n        const bucketCount = Math.ceil((maxTime - minTime) / bucketSize);\n        \n        for (let i = 0; i <= bucketCount; i++) {\n          const bucketTime = minTime + (i * bucketSize);\n          const bucketKey = dateFormatter(new Date(bucketTime));\n          buckets.set(bucketKey, 0);\n        }\n\n        // Count concurrent calls at each bucket's midpoint\n        for (let i = 0; i <= bucketCount; i++) {\n          const bucketTime = minTime + (i * bucketSize);\n          const midpoint = bucketTime + (bucketSize / 2);\n          const concurrent = callRanges.filter(range => \n            range.start <= midpoint && range.end > midpoint\n          ).length;\n          \n          const bucketKey = dateFormatter(new Date(bucketTime));\n          buckets.set(bucketKey, concurrent);\n        }\n\n        // Convert to arrays\n        const labels = Array.from(buckets.keys());\n        const data = Array.from(buckets.values());\n\n        return jsonResponse({ data, labels });\n      }\n\n      // Get dashboard summary metrics with SQL aggregation (supports workspace context)\n      if (url.pathname === '/api/dashboard-summary' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Single SQL query to calculate all dashboard metrics\n        // This runs in <50ms on the database vs seconds of JavaScript processing\n        // Filter out test calls (those without customer_number)\n        const result = await env.DB.prepare(\n          `SELECT\n            COUNT(*) as total_calls,\n            COUNT(CASE WHEN recording_url IS NOT NULL THEN 1 END) as answered_calls,\n            COUNT(*) - COUNT(CASE WHEN recording_url IS NOT NULL THEN 1 END) as unanswered_calls,\n            ROUND(CAST(COUNT(CASE WHEN recording_url IS NOT NULL THEN 1 END) AS FLOAT) / NULLIF(COUNT(*), 0) * 100, 2) as answer_rate,\n            ROUND(AVG(CASE WHEN recording_url IS NOT NULL THEN duration_seconds END), 2) as avg_handling_time,\n            ROUND(AVG(LENGTH(summary)), 2) as avg_summary_length,\n            COUNT(CASE WHEN outcome = 'Successful' THEN 1 END) as qualified_leads_count,\n            COUNT(CASE WHEN intent = 'Scheduling' THEN 1 END) as appointments_detected,\n            ROUND(SUM(COALESCE(duration_seconds, 0)) / 60.0, 2) as total_call_minutes,\n            COUNT(CASE WHEN sentiment = 'Positive' THEN 1 END) as positive_calls,\n            COUNT(CASE WHEN sentiment = 'Negative' THEN 1 END) as negative_calls,\n            COUNT(*) - COUNT(CASE WHEN sentiment = 'Positive' THEN 1 END) - COUNT(CASE WHEN sentiment = 'Negative' THEN 1 END) as neutral_calls\n          FROM webhook_calls\n          WHERE user_id = ? AND customer_number IS NOT NULL`\n        ).bind(effectiveUserId).first() as any;\n\n        if (!result) {\n          // Return zeroed metrics if no data\n          return jsonResponse({\n            totalCalls: 0,\n            answeredCalls: 0,\n            unansweredCalls: 0,\n            answerRate: 0,\n            avgHandlingTime: 0,\n            avgSummaryLength: 0,\n            qualifiedLeadsCount: 0,\n            appointmentsDetected: 0,\n            totalCallMinutes: 0,\n            positiveCalls: 0,\n            negativeCalls: 0,\n            neutralCalls: 0\n          });\n        }\n\n        // Return camelCase format for frontend\n        return jsonResponse({\n          totalCalls: result.total_calls || 0,\n          answeredCalls: result.answered_calls || 0,\n          unansweredCalls: result.unanswered_calls || 0,\n          answerRate: result.answer_rate || 0,\n          avgHandlingTime: result.avg_handling_time || 0,\n          avgSummaryLength: result.avg_summary_length || 0,\n          qualifiedLeadsCount: result.qualified_leads_count || 0,\n          appointmentsDetected: result.appointments_detected || 0,\n          totalCallMinutes: result.total_call_minutes || 0,\n          positiveCalls: result.positive_calls || 0,\n          negativeCalls: result.negative_calls || 0,\n          neutralCalls: result.neutral_calls || 0\n        });\n      }\n\n      // Get agent distribution - call count by voice agent\n      if (url.pathname === '/api/agent-distribution' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Query to get call distribution by assistant\n        // Using JSON extraction to get assistant ID from raw_payload, then joining with assistants_cache\n        const { results } = await env.DB.prepare(\n          `SELECT\n            json_extract(ac.vapi_data, '$.name') as assistant_name,\n            COUNT(*) as call_count\n          FROM webhook_calls wc\n          JOIN assistants_cache ac ON json_extract(wc.raw_payload, '$.message.call.assistantId') = ac.id\n          WHERE wc.user_id = ?\n            AND wc.raw_payload IS NOT NULL\n            AND wc.customer_number IS NOT NULL\n          GROUP BY assistant_name\n          ORDER BY call_count DESC`\n        ).bind(effectiveUserId).all();\n\n        return jsonResponse(results || []);\n      }\n\n      // Get reason call ended data\n      // Get call ended reasons (supports workspace context)\n      if (url.pathname === '/api/call-ended-reasons' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        const startDate = url.searchParams.get('start_date');\n        const endDate = url.searchParams.get('end_date');\n\n        // Build query with optional date filtering\n        // Filter out rows where created_at is null or ended_reason is null\n        // Filter out test calls (those without customer_number)\n        let queryStr = `SELECT\n          ended_reason,\n          DATE(datetime(created_at, 'unixepoch')) as call_date,\n          COUNT(*) as count\n        FROM webhook_calls\n        WHERE user_id = ?\n        AND ended_reason IS NOT NULL\n        AND created_at IS NOT NULL\n        AND customer_number IS NOT NULL`;\n        \n        const params: any[] = [effectiveUserId];\n        \n        if (startDate) {\n          queryStr += ` AND DATE(datetime(created_at, 'unixepoch')) >= ?`;\n          params.push(startDate);\n        }\n        if (endDate) {\n          queryStr += ` AND DATE(datetime(created_at, 'unixepoch')) <= ?`;\n          params.push(endDate);\n        }\n        \n        queryStr += ` GROUP BY ended_reason, call_date ORDER BY call_date DESC, count DESC`;\n\n        const { results } = await env.DB.prepare(queryStr).bind(...params).all();\n\n        if (!results || results.length === 0) {\n          return jsonResponse({ dates: [], reasons: {}, colors: {} });\n        }\n\n        // Group data by date and reason\n        const dateSet = new Set<string>();\n        const reasonsSet = new Set<string>();\n        const dataMap = new Map<string, Map<string, number>>(); // date -> reason -> count\n\n        for (const row of results as any[]) {\n          const date = row.call_date;\n          const reason = row.ended_reason || 'unknown';\n          const count = row.count || 0;\n\n          dateSet.add(date);\n          reasonsSet.add(reason);\n\n          if (!dataMap.has(date)) {\n            dataMap.set(date, new Map());\n          }\n          dataMap.get(date)!.set(reason, count);\n        }\n\n        // Sort dates\n        const dates = Array.from(dateSet).sort();\n\n        // Create reason mapping with colors\n        const reasons = Array.from(reasonsSet);\n        const reasonColors: Record<string, string> = {};\n        const colorPalette = [\n          '#8b5cf6', // purple\n          '#3b82f6', // blue\n          '#10b981', // green\n          '#f59e0b', // amber\n          '#ef4444', // red\n          '#06b6d4', // cyan\n          '#ec4899', // pink\n          '#6366f1', // indigo\n        ];\n\n        reasons.forEach((reason, idx) => {\n          reasonColors[reason] = colorPalette[idx % colorPalette.length];\n        });\n\n        // Build the data structure\n        const reasonData: Record<string, number[]> = {};\n        reasons.forEach(reason => {\n          reasonData[reason] = dates.map(date => {\n            const dateData = dataMap.get(date);\n            return dateData?.get(reason) || 0;\n          });\n        });\n\n        return jsonResponse({\n          dates,\n          reasons: reasonData,\n          colors: reasonColors\n        });\n      }\n\n      // Get top keywords\n      // Get top keywords with sentiment (supports workspace context)\n      if (url.pathname === '/api/keywords' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Fetch top keywords from database with sentiment data (limit to top 20 for heat map)\n        const { results } = await env.DB.prepare(\n          `SELECT\n            keyword,\n            count,\n            positive_count,\n            neutral_count,\n            negative_count,\n            avg_sentiment,\n            last_detected_at\n          FROM call_keywords\n          WHERE user_id = ?\n          ORDER BY count DESC\n          LIMIT 20`\n        ).bind(effectiveUserId).all();\n\n        return jsonResponse(results);\n      }\n\n      // Get call listen URL for live audio streaming\n      if (url.pathname.startsWith('/api/calls/') && url.pathname.endsWith('/listen') && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const callId = url.pathname.split('/')[3];\n\n        console.log('[Call Streaming] Get listen URL request:', {\n          callId,\n          userId\n        });\n\n        // Get workspace settings (uses helper function with fallback to user_settings)\n        const settings = await getWorkspaceSettingsForUser(env, userId);\n\n        if (!settings?.private_key) {\n          console.log('[Call Streaming] VAPI credentials not configured for user:', userId);\n          return jsonResponse({ error: 'VAPI credentials not configured' }, 400);\n        }\n\n        // Get call details from VAPI to retrieve listenUrl\n        try {\n          console.log('[Call Streaming] Fetching call details from VAPI:', callId);\n\n          const getCallResponse = await fetch(`https://api.vapi.ai/call/${callId}`, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`\n            }\n          });\n\n          if (!getCallResponse.ok) {\n            const error = await getCallResponse.text();\n            console.error('[Call Streaming] Failed to get call details:', {\n              callId,\n              status: getCallResponse.status,\n              error\n            });\n            return jsonResponse({ error: 'Failed to get call details' }, getCallResponse.status);\n          }\n\n          const callDetails = await getCallResponse.json() as any;\n          const listenUrl = callDetails.monitor?.listenUrl;\n\n          console.log('[Call Streaming] Call details retrieved:', {\n            callId,\n            hasListenUrl: !!listenUrl\n          });\n\n          if (!listenUrl) {\n            console.error('[Call Streaming] No listenUrl found in call details');\n            return jsonResponse({ error: 'Listen URL not available for this call' }, 400);\n          }\n\n          return jsonResponse({\n            success: true,\n            listenUrl,\n            callId\n          });\n        } catch (error) {\n          console.error('[Call Streaming] Error getting listen URL:', {\n            callId,\n            error: error instanceof Error ? error.message : String(error)\n          });\n          return jsonResponse({ error: 'Failed to get listen URL' }, 500);\n        }\n      }\n\n      // End active call\n      if (url.pathname.startsWith('/api/calls/') && url.pathname.endsWith('/end') && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const callId = url.pathname.split('/')[3];\n\n        console.log('[Call Control] End call request received:', {\n          callId,\n          userId\n        });\n\n        // Get workspace settings (uses helper function with fallback to user_settings)\n        const settings = await getWorkspaceSettingsForUser(env, userId);\n\n        if (!settings?.private_key) {\n          console.log('[Call Control] VAPI credentials not configured for user:', userId);\n          return jsonResponse({ error: 'VAPI credentials not configured' }, 400);\n        }\n\n        // Call VAPI API to end the call\n        try {\n          // Step 1: Get the call details to retrieve controlUrl\n          console.log('[Call Control] Fetching call details for controlUrl:', callId);\n\n          const getCallResponse = await fetch(`https://api.vapi.ai/call/${callId}`, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`\n            }\n          });\n\n          if (!getCallResponse.ok) {\n            const error = await getCallResponse.text();\n            console.error('[Call Control] Failed to get call details:', {\n              callId,\n              status: getCallResponse.status,\n              error\n            });\n            return jsonResponse({ error: 'Failed to get call details' }, getCallResponse.status);\n          }\n\n          const callDetails = await getCallResponse.json() as any;\n          const controlUrl = callDetails.monitor?.controlUrl;\n\n          console.log('[Call Control] Call details retrieved:', {\n            callId,\n            hasControlUrl: !!controlUrl\n          });\n\n          if (!controlUrl) {\n            console.error('[Call Control] No controlUrl found in call details');\n            return jsonResponse({ error: 'Call control URL not available' }, 400);\n          }\n\n          // Step 2: Send end-call command to controlUrl\n          const endCallPayload = {\n            type: 'end-call'\n          };\n\n          console.log('[Call Control] Sending end-call command to controlUrl:', {\n            callId,\n            payload: endCallPayload\n          });\n\n          const endCallResponse = await fetch(controlUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(endCallPayload)\n          });\n\n          if (!endCallResponse.ok) {\n            const error = await endCallResponse.text();\n            console.error('[Call Control] End-call command failed:', {\n              callId,\n              status: endCallResponse.status,\n              error\n            });\n            return jsonResponse({ error: 'Failed to end call' }, endCallResponse.status);\n          }\n\n          console.log('[Call Control] Call ended successfully:', callId);\n\n          return jsonResponse({ success: true, message: 'Call ended successfully' });\n        } catch (error) {\n          console.error('[Call Control] Error ending call:', {\n            callId,\n            error: error instanceof Error ? error.message : String(error)\n          });\n          return jsonResponse({ error: 'Failed to end call' }, 500);\n        }\n      }\n\n      // Transfer active call\n      if (url.pathname.startsWith('/api/calls/') && url.pathname.endsWith('/transfer') && request.method === 'POST') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const callId = url.pathname.split('/')[3];\n        const body = await request.json() as any;\n        const transferNumber = body.phoneNumber;\n\n        console.log('[Call Control] Transfer call request received:', {\n          callId,\n          userId,\n          transferNumber\n        });\n\n        if (!transferNumber) {\n          console.log('[Call Control] Transfer number missing');\n          return jsonResponse({ error: 'Transfer phone number required' }, 400);\n        }\n\n        // Get workspace VAPI credentials (with fallback to user_settings for migration)\n        const settings = await getWorkspaceSettingsForUser(env, userId);\n\n        if (!settings?.private_key) {\n          console.log('[Call Control] VAPI credentials not configured for user:', userId);\n          return jsonResponse({ error: 'VAPI credentials not configured' }, 400);\n        }\n\n        // Call VAPI API to transfer the call\n        try {\n          // Step 1: Get the call details to retrieve controlUrl\n          console.log('[Call Control] Fetching call details for controlUrl:', callId);\n\n          const getCallResponse = await fetch(`https://api.vapi.ai/call/${callId}`, {\n            method: 'GET',\n            headers: {\n              'Authorization': `Bearer ${settings.private_key}`\n            }\n          });\n\n          if (!getCallResponse.ok) {\n            const error = await getCallResponse.text();\n            console.error('[Call Control] Failed to get call details:', {\n              callId,\n              status: getCallResponse.status,\n              error\n            });\n            return jsonResponse({ error: 'Failed to get call details' }, getCallResponse.status);\n          }\n\n          const callDetails = await getCallResponse.json() as any;\n          const controlUrl = callDetails.monitor?.controlUrl;\n\n          console.log('[Call Control] Call details retrieved:', {\n            callId,\n            hasControlUrl: !!controlUrl\n          });\n\n          if (!controlUrl) {\n            console.error('[Call Control] No controlUrl found in call details');\n            return jsonResponse({ error: 'Call control URL not available' }, 400);\n          }\n\n          // Step 2: Send transfer command to controlUrl\n          const transferPayload = {\n            type: 'transfer',\n            destination: {\n              type: 'number',\n              number: transferNumber\n            }\n          };\n\n          console.log('[Call Control] Sending transfer command to controlUrl:', {\n            callId,\n            transferNumber,\n            payload: transferPayload\n          });\n\n          const transferResponse = await fetch(controlUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json'\n            },\n            body: JSON.stringify(transferPayload)\n          });\n\n          if (!transferResponse.ok) {\n            const error = await transferResponse.text();\n            console.error('[Call Control] Transfer command failed:', {\n              callId,\n              transferNumber,\n              status: transferResponse.status,\n              error\n            });\n            return jsonResponse({ error: 'Failed to transfer call' }, transferResponse.status);\n          }\n\n          console.log('[Call Control] Call transferred successfully:', {\n            callId,\n            transferNumber\n          });\n\n          return jsonResponse({ success: true, message: 'Call transferred successfully' });\n        } catch (error) {\n          console.error('[Call Control] Error transferring call:', {\n            callId,\n            transferNumber,\n            error: error instanceof Error ? error.message : String(error)\n          });\n          return jsonResponse({ error: 'Failed to transfer call' }, 500);\n        }\n      }\n\n      // Get intent analysis (supports workspace context)\n      if (url.pathname === '/api/intent-analysis' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        const limit = parseInt(url.searchParams.get('limit') || '100');\n        const offset = parseInt(url.searchParams.get('offset') || '0');\n        const page = Math.floor(offset / limit) + 1;\n\n        // Initialize cache\n        const cache = new VoiceAICache(env.CACHE);\n\n        // Try to get from cache first (use effectiveUserId for cache key)\n        if (limit <= 100) {\n          const cached = await cache.getCachedIntentSummary(effectiveUserId);\n          if (cached) {\n            console.log(`Cache HIT for intent analysis: user=${effectiveUserId}`);\n            return jsonResponse(cached);\n          }\n        }\n\n        console.log(`Cache MISS for intent analysis: user=${effectiveUserId}`);\n\n        // Fetch analyzed calls from database with enhanced data (using effectiveUserId)\n        // Filter out test calls (those without customer_number)\n        const { results } = await env.DB.prepare(\n          `SELECT\n            wc.id,\n            wc.webhook_id,\n            wc.vapi_call_id,\n            wc.phone_number,\n            wc.customer_number,\n            wc.recording_url,\n            wc.ended_reason,\n            wc.summary,\n            wc.structured_data,\n            wc.raw_payload,\n            wc.intent,\n            wc.sentiment,\n            wc.outcome,\n            wc.analysis_completed,\n            wc.analyzed_at,\n            wc.customer_name,\n            wc.customer_email,\n            wc.appointment_date,\n            wc.appointment_time,\n            wc.appointment_type,\n            wc.appointment_notes,\n            wc.created_at,\n            ar.result_data as enhanced_data\n          FROM webhook_calls wc\n          LEFT JOIN addon_results ar ON ar.call_id = wc.id AND ar.addon_type = 'enhanced_data' AND ar.status = 'success'\n          WHERE wc.user_id = ? AND wc.analysis_completed = 1 AND wc.customer_number IS NOT NULL\n          ORDER BY wc.created_at DESC\n          LIMIT ? OFFSET ?`\n        ).bind(effectiveUserId, limit, offset).all();\n\n        // Get user email for demo data check\n        const userEmail = await env.DB.prepare(\n          'SELECT email FROM users WHERE id = ?'\n        ).bind(userId).first() as any;\n\n        // Helper function to generate mock enhanced data for demo\n        const generateMockEnhancedData = (index: number) => {\n          const mockProfiles = [\n            {\n              firstName: 'Sarah',\n              lastName: 'Johnson',\n              address: '4532 Maple Avenue',\n              city: 'San Francisco',\n              state: 'CA',\n              zip: '94102',\n              countyName: 'San Francisco',\n              gender: 'F',\n              age: 42,\n              phones: [{\n                phone: 4155551234,\n                carrier: 'AT&T Mobility',\n                phoneType: 1,\n                workPhone: false,\n                activityStatus: 'Active',\n                contactabilityScore: 'High'\n              }],\n              data: {\n                addressType: 'Single Family',\n                incomeLevel: '$75K-$100K',\n                creditRange: '720-780',\n                householdIncome: '$85,000-$95,000',\n                homeOwnership: 'Owner',\n                homePrice: 875000,\n                homeValue: 920000,\n                age: 42\n              },\n              properties: [{\n                propertyType: 'Single Family Residence',\n                value: 920000,\n                estimatedValue: 920000,\n                yearBuilt: 1998,\n                bedrooms: '3',\n                rooms: '7',\n                saleDate: '2019-05-15',\n                saleAmount: 785000\n              }]\n            },\n            {\n              firstName: 'Michael',\n              lastName: 'Rodriguez',\n              address: '1847 Oak Street',\n              city: 'Portland',\n              state: 'OR',\n              zip: '97201',\n              countyName: 'Multnomah',\n              gender: 'M',\n              age: 35,\n              phones: [{\n                phone: 5035559876,\n                carrier: 'Verizon',\n                phoneType: 1,\n                workPhone: false,\n                activityStatus: 'Active',\n                contactabilityScore: 'Medium'\n              }],\n              data: {\n                addressType: 'Condominium',\n                incomeLevel: '$100K-$150K',\n                creditRange: '680-720',\n                householdIncome: '$110,000-$125,000',\n                homeOwnership: 'Owner',\n                homePrice: 425000,\n                homeValue: 465000,\n                age: 35\n              },\n              properties: [{\n                propertyType: 'Condominium',\n                value: 465000,\n                estimatedValue: 465000,\n                yearBuilt: 2015,\n                bedrooms: '2',\n                rooms: '5',\n                saleDate: '2021-03-22',\n                saleAmount: 410000\n              }]\n            },\n            {\n              firstName: 'Jennifer',\n              lastName: 'Chen',\n              address: '2315 Pine Ridge Drive',\n              city: 'Seattle',\n              state: 'WA',\n              zip: '98101',\n              countyName: 'King',\n              gender: 'F',\n              age: 52,\n              phones: [{\n                phone: 2065557890,\n                carrier: 'T-Mobile',\n                phoneType: 1,\n                workPhone: false,\n                activityStatus: 'Active',\n                contactabilityScore: 'Very High'\n              }],\n              data: {\n                addressType: 'Single Family',\n                incomeLevel: '$150K+',\n                creditRange: '780-850',\n                householdIncome: '$175,000+',\n                homeOwnership: 'Owner',\n                homePrice: 1200000,\n                homeValue: 1350000,\n                age: 52\n              },\n              properties: [{\n                propertyType: 'Single Family Residence',\n                value: 1350000,\n                estimatedValue: 1350000,\n                yearBuilt: 2005,\n                bedrooms: '4',\n                rooms: '9',\n                saleDate: '2018-11-08',\n                saleAmount: 1050000\n              }]\n            }\n          ];\n\n          return {\n            identities: [mockProfiles[index % mockProfiles.length]]\n          };\n        };\n\n        // Parse structured_data, raw_payload, and enhanced_data JSON for each result\n        const parsedResults = (results || []).map((row: any, index: number) => {\n          let enhancedData = row.enhanced_data ? JSON.parse(row.enhanced_data) : null;\n\n          // Inject mock enhanced data for vic@channelautomation.com\n          if (userEmail?.email === 'vic@channelautomation.com' && !enhancedData) {\n            enhancedData = generateMockEnhancedData(index);\n          }\n\n          // Parse raw_payload to extract structured outputs\n          let structuredOutputs = {};\n          if (row.raw_payload) {\n            const rawPayload = JSON.parse(row.raw_payload);\n            const analysis = rawPayload?.message?.analysis || {};\n            const artifact = rawPayload?.message?.artifact || {};\n            structuredOutputs = analysis?.structuredOutputs || artifact?.structuredOutputs || {};\n          }\n\n          return {\n            ...row,\n            structured_data: row.structured_data ? JSON.parse(row.structured_data) : null,\n            raw_payload: row.raw_payload ? JSON.parse(row.raw_payload) : null,\n            enhanced_data: enhancedData,\n            structured_outputs: structuredOutputs\n          };\n        });\n\n        // Calculate summary statistics\n        const totalCalls = parsedResults.length;\n        const answeredCalls = parsedResults.filter(call => call.recording_url).length;\n        const avgConfidence = totalCalls > 0\n          ? parsedResults.reduce((sum, call) => sum + 85, 0) / totalCalls // Default confidence\n          : 0;\n\n        const intentDistribution = parsedResults.reduce((acc, call) => {\n          acc[call.intent] = (acc[call.intent] || 0) + 1;\n          return acc;\n        }, {} as Record<string, number>);\n\n        const summaryData = {\n          calls: parsedResults,\n          stats: {\n            totalCalls,\n            answeredCalls,\n            avgConfidence: Math.round(avgConfidence),\n            intentDistribution: Object.entries(intentDistribution).map(([intent, count]) => ({\n              intent,\n              count\n            }))\n          }\n        };\n\n        // Cache the results\n        if (limit <= 100) {\n          // Use effectiveUserId for cache key to scope by workspace owner\n          await cache.cacheIntentSummary(effectiveUserId, summaryData, CACHE_TTL.INTENT_SUMMARY);\n        }\n\n        return jsonResponse(summaryData);\n      }\n\n      // Get appointments data from structured outputs\n      if (url.pathname === '/api/appointments' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Get effective user ID for workspace context\n        const { effectiveUserId } = await getEffectiveUserId(env, userId);\n\n        // Fetch calls with structured outputs that contain appointment data\n        const { results } = await env.DB.prepare(\n          `SELECT\n            wc.id,\n            wc.vapi_call_id,\n            wc.phone_number,\n            wc.customer_number,\n            wc.customer_name,\n            wc.raw_payload,\n            wc.structured_data,\n            wc.created_at\n          FROM webhook_calls wc\n          WHERE wc.user_id = ?\n            AND wc.raw_payload IS NOT NULL\n            AND wc.customer_number IS NOT NULL\n          ORDER BY wc.created_at DESC\n          LIMIT 100`\n        ).bind(effectiveUserId).all();\n\n        // Parse and extract appointment data from structured outputs\n        const appointments = (results || []).map((row: any) => {\n          try {\n            const rawPayload = row.raw_payload ? JSON.parse(row.raw_payload) : null;\n            const structuredOutputs = rawPayload?.message?.analysis?.structuredOutputs ||\n                                     rawPayload?.message?.artifact?.structuredOutputs || {};\n\n            // Extract values from structured outputs\n            let appointmentDate = null;\n            let appointmentTime = null;\n            let qualityScore = null;\n            let issueType = null;\n            let customerFrustrated = null;\n            let escalationRequired = null;\n            let callSummary = null;\n            let product = null;\n\n            // Extract data from structured outputs\n            Object.entries(structuredOutputs).forEach(([key, value]: [string, any]) => {\n              if (typeof value === 'object' && value !== null && 'name' in value && 'result' in value) {\n                const name = value.name.toLowerCase();\n                const result = value.result;\n\n                if (name.includes('appointment date') || name.includes('appointmentdate')) {\n                  appointmentDate = result;\n                } else if (name.includes('appointment time') || name.includes('appointmenttime')) {\n                  appointmentTime = result;\n                } else if (name.includes('quality score') || name.includes('qualityscore')) {\n                  qualityScore = typeof result === 'number' ? result : parseInt(result);\n                } else if (name.includes('issue type') || name.includes('issuetype')) {\n                  issueType = result;\n                } else if (name.includes('customer frustrated') || name.includes('customerfrustrated')) {\n                  customerFrustrated = typeof result === 'boolean' ? result : result === 'true';\n                } else if (name.includes('escalation required') || name.includes('escalationrequired')) {\n                  escalationRequired = typeof result === 'boolean' ? result : result === 'true';\n                } else if (name.includes('call summary') || name.includes('callsummary') || name.includes('summary')) {\n                  callSummary = result;\n                } else if (name.includes('product')) {\n                  product = result;\n                }\n              }\n            });\n\n            // Also check structured_data for product and appointment time fields\n            if (row.structured_data) {\n              try {\n                const structuredData = JSON.parse(row.structured_data);\n                if (!product) {\n                  product = structuredData?.product || null;\n                }\n                if (!appointmentTime) {\n                  appointmentTime = structuredData?.['appointment time'] ||\n                                   structuredData?.['Appointment time'] ||\n                                   structuredData?.['appointmentTime'] || null;\n                }\n              } catch (e) {\n                // Ignore parse error\n              }\n            }\n\n            // Get phone number from customer number or phone_number field\n            const phoneNumber = row.customer_number || row.phone_number || null;\n\n            return {\n              id: row.id,\n              vapi_call_id: row.vapi_call_id,\n              phone_number: phoneNumber,\n              customer_name: row.customer_name,\n              appointment_date: appointmentDate,\n              appointment_time: appointmentTime,\n              quality_score: qualityScore,\n              issue_type: issueType,\n              customer_frustrated: customerFrustrated,\n              escalation_required: escalationRequired,\n              call_summary: callSummary,\n              product: product,\n              created_at: row.created_at\n            };\n          } catch (error) {\n            console.error('Error parsing appointment data:', error);\n            return null;\n          }\n        }).filter((apt: any) => {\n          if (!apt) return false;\n          if (!apt.appointment_date && !apt.call_summary) return false;\n\n          // Filter out appointments with dates in the past\n          if (apt.appointment_date) {\n            try {\n              const appointmentDate = new Date(apt.appointment_date);\n              const today = new Date();\n              today.setHours(0, 0, 0, 0); // Reset time to start of day\n\n              // Exclude if date is before today\n              if (appointmentDate < today) {\n                return false;\n              }\n            } catch (e) {\n              // If date parsing fails, keep the appointment\n            }\n          }\n\n          return true;\n        });\n\n        return jsonResponse(appointments);\n      }\n\n      // Generate demo data for vic@channelautomation.com\n      if (url.pathname === '/api/generate-demo-data' && request.method === 'POST') {\n        const currentUserId = await getUserFromToken(request, env);\n        if (!currentUserId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        // Use vic's userId for demo data\n        const vicUser = await env.DB.prepare(\n          'SELECT id FROM users WHERE email = ?'\n        ).bind('vic@channelautomation.com').first() as any;\n\n        if (!vicUser) {\n          return jsonResponse({ error: 'Demo account not found' }, 404);\n        }\n\n        const userId = vicUser.id;\n\n        // Get or create webhook for this user\n        let webhook = await env.DB.prepare(\n          'SELECT id FROM webhooks WHERE user_id = ? LIMIT 1'\n        ).bind(userId).first() as any;\n\n        if (!webhook) {\n          const webhookId = generateId();\n          await env.DB.prepare(\n            'INSERT INTO webhooks (id, user_id, webhook_url, name, is_active, created_at, updated_at) VALUES (?, ?, ?, ?, 1, ?, ?)'\n          ).bind(webhookId, userId, `https://api.voice-config.channelautomation.com/webhooks/${webhookId}`, 'Demo Webhook', Date.now(), Date.now()).run();\n          webhook = { id: webhookId };\n        }\n\n        const timestamp = Date.now();\n        const demoCalls = [\n          {\n            id: 'demo_001_' + timestamp,\n            name: 'Sarah Johnson',\n            phone: '+14155551234',\n            intent: 'Scheduling',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'Customer called to schedule a window replacement consultation. Showed strong interest in energy-efficient options.',\n            transcript: 'AI: Thank you for calling EcoView Windows and Doors. This is James. Customer: Hi, this is Sarah Johnson. I am interested in getting some windows replaced. AI: Great! Are you looking for a consultation? Customer: Yes, I am particularly interested in energy-efficient windows. AI: Perfect! Let me schedule that for you.',\n            appointmentDate: new Date(Date.now() + 5 * 86400000).toISOString().split('T')[0],\n            appointmentTime: '2:00 PM',\n            days_ago: 1\n          },\n          {\n            id: 'demo_002_' + timestamp,\n            name: 'Michael Rodriguez',\n            phone: '+15035559876',\n            intent: 'Information',\n            sentiment: 'Neutral',\n            outcome: 'Follow-up Required',\n            summary: 'Customer inquired about pricing for sliding glass doors. Asked about installation timeline and warranty.',\n            transcript: 'AI: Thank you for calling EcoView. This is Alex. Customer: Hi, I am interested in learning about sliding glass doors. Can you tell me about pricing? AI: Our doors range from $2,500 to $8,000. Customer: How long does installation take? AI: Usually one full day. Customer: I need to think about it.',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 2\n          },\n          {\n            id: 'demo_003_' + timestamp,\n            name: 'Jennifer Chen',\n            phone: '+12065557890',\n            intent: 'Scheduling',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'Existing customer scheduling installation of bay window. Very satisfied with previous service.',\n            transcript: 'AI: Thank you for calling EcoView. This is Maria. Customer: Hi Maria, this is Jennifer Chen. I ordered a bay window last month and want to schedule installation. AI: Of course! When works for you? Customer: Thursday morning around 10 AM. AI: Perfect! You are all set.',\n            appointmentDate: new Date(Date.now() + 3 * 86400000).toISOString().split('T')[0],\n            appointmentTime: '10:00 AM',\n            days_ago: 3\n          },\n          {\n            id: 'demo_004_' + timestamp,\n            name: 'Robert Martinez',\n            phone: '+13105554321',\n            intent: 'Support',\n            sentiment: 'Negative',\n            outcome: 'Follow-up Required',\n            summary: 'Customer reported condensation between window panes. Escalated to warranty department.',\n            transcript: 'AI: EcoView support. This is Tom. Customer: I have condensation between my window panes. AI: That indicates a seal failure. When were they installed? Customer: About 3 years ago. Is this covered? AI: Yes, fully covered. We will replace at no cost.',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 4\n          },\n          {\n            id: 'demo_005_' + timestamp,\n            name: 'Amanda Foster',\n            phone: '+14085556789',\n            intent: 'Information',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'Customer asking about French doors. Requested free estimate.',\n            transcript: 'AI: Good afternoon! This is Jessica. Customer: Hi! I am looking to replace my patio door with French doors. AI: Yes we offer those! Are you looking for inswing or outswing? Customer: What do you recommend? AI: For patios, outswing is better. Customer: How do I get an estimate? AI: We can schedule a free consultation.',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 5\n          },\n          {\n            id: 'demo_006_' + timestamp,\n            name: 'David Thompson',\n            phone: '+16195553456',\n            intent: 'Scheduling',\n            sentiment: 'Neutral',\n            outcome: 'Successful',\n            summary: 'Customer rescheduling consultation due to work conflict.',\n            transcript: 'AI: Scheduling department. This is Rachel. Customer: I need to reschedule my Wednesday appointment. AI: No problem! When works better? Customer: Friday afternoon around 3:30? AI: Perfect! You are all set for Friday at 3:30.',\n            appointmentDate: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0],\n            appointmentTime: '3:30 PM',\n            days_ago: 6\n          },\n          {\n            id: 'demo_007_' + timestamp,\n            name: 'Lisa Anderson',\n            phone: '+14155557777',\n            intent: 'Purchase',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'Customer ready for full house window replacement. Placing deposit.',\n            transcript: 'AI: Good morning! This is Brandon. Customer: I received my quote last week and I am ready to move forward! AI: Fantastic! Let me process your deposit. Customer: Can I pay with credit card? AI: Absolutely. You are making a great investment!',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 7\n          },\n          {\n            id: 'demo_008_' + timestamp,\n            name: 'James Wilson',\n            phone: '+15035558888',\n            intent: 'Information',\n            sentiment: 'Neutral',\n            outcome: 'Follow-up Required',\n            summary: 'Customer comparing window brands and prices.',\n            transcript: 'AI: Thank you for calling EcoView. This is Sarah. Customer: I am getting quotes from several companies. What brands do you carry? AI: We install Milgard and Pella. Customer: How do your prices compare? AI: We are very competitive. Customer: I am still getting other quotes.',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 8\n          },\n          {\n            id: 'demo_009_' + timestamp,\n            name: 'Patricia Lee',\n            phone: '+14085559999',\n            intent: 'Support',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'Customer asking about window maintenance. Provided care instructions.',\n            transcript: 'AI: Support team. This is Kevin. Customer: I just had windows installed and want to know how to care for them. AI: For glass, use regular cleaner quarterly. For frames, warm soapy water. Customer: What about tracks? AI: Vacuum monthly. Customer: Perfect, thank you!',\n            appointmentDate: null,\n            appointmentTime: null,\n            days_ago: 9\n          },\n          {\n            id: 'demo_010_' + timestamp,\n            name: 'Christopher Brown',\n            phone: '+16195551111',\n            intent: 'Scheduling',\n            sentiment: 'Positive',\n            outcome: 'Successful',\n            summary: 'New customer wants consultation for windows and doors. Motivated buyer.',\n            transcript: 'AI: Thank you for calling EcoView! This is Michelle. Customer: I just bought a house and want to replace all windows and the front door. AI: Congratulations! How many windows? Customer: About 15 windows and a nice entry door. AI: Perfect! Thursday at 11 AM work? Customer: Perfect!',\n            appointmentDate: new Date(Date.now() + 2 * 86400000).toISOString().split('T')[0],\n            appointmentTime: '11:00 AM',\n            days_ago: 10\n          }\n        ];\n\n        // Insert demo calls\n        for (const call of demoCalls) {\n          const callTimestamp = timestamp - (call.days_ago * 86400000);\n          const rawPayload = JSON.stringify({\n            message: {\n              artifact: {\n                transcript: call.transcript\n              }\n            }\n          });\n\n          await env.DB.prepare(\n            `INSERT INTO webhook_calls (\n              id, webhook_id, user_id, vapi_call_id, phone_number, customer_number,\n              recording_url, ended_reason, summary, intent, sentiment, outcome,\n              analysis_completed, analyzed_at, customer_name, customer_email,\n              appointment_date, appointment_time, appointment_type,\n              structured_data, raw_payload, created_at\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n          ).bind(\n            call.id,\n            webhook.id,\n            userId,\n            call.id,\n            '+18005551234',\n            call.phone,\n            null, // No recording URL for demo data - use actual recording URLs from real calls\n            'customer-ended-call',\n            call.summary,\n            call.intent,\n            call.sentiment,\n            call.outcome,\n            1,\n            Math.floor(callTimestamp / 1000),\n            call.name,\n            null,\n            call.appointmentDate,\n            call.appointmentTime,\n            call.appointmentDate ? 'Consultation' : null,\n            '{}',\n            rawPayload,\n            Math.floor(callTimestamp / 1000)\n          ).run();\n        }\n\n        // Invalidate cache\n        const cache = new VoiceAICache(env.CACHE);\n        await cache.invalidateUserCache(userId);\n\n        return jsonResponse({\n          success: true,\n          message: `Created ${demoCalls.length} demo calls for vic@channelautomation.com`,\n          callsCreated: demoCalls.length\n        });\n      }\n\n      // Get cache statistics\n      if (url.pathname === '/api/cache/stats' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const cache = new VoiceAICache(env.CACHE);\n        const stats = await cache.getCacheStats();\n\n        return jsonResponse({\n          ...stats,\n          ttl: {\n            recordings: CACHE_TTL.RECORDINGS,\n            callDetails: CACHE_TTL.CALL_DETAILS,\n            intentAnalysis: CACHE_TTL.INTENT_ANALYSIS,\n            intentSummary: CACHE_TTL.INTENT_SUMMARY,\n            enhancedData: CACHE_TTL.ENHANCED_DATA\n          }\n        });\n      }\n\n      // ============================================\n      // ADMIN ENDPOINTS\n      // ============================================\n\n      // Helper function to check if user is admin\n      const checkAdminAccess = async (userId: string | null): Promise<boolean> => {\n        if (!userId) return false;\n        \n        // Get user email to check admin status\n        const user = await env.DB.prepare(\n          'SELECT email FROM users WHERE id = ?'\n        ).bind(userId).first() as any;\n        \n        if (!user || !user.email) return false;\n        \n        // Check if email is in admin list (can be configured via env var or hardcoded)\n        // For now, check if email contains 'channelautomation.com' or 'admin'\n        // Hardcoded admin emails for now (can be moved to env var if needed)\n        const adminEmails = 'vic@channelautomation.com'.split(',').map(e => e.trim());\n        return adminEmails.some(adminEmail => \n          user.email.toLowerCase() === adminEmail.toLowerCase() || \n          user.email.toLowerCase().includes(adminEmail.toLowerCase())\n        );\n      };\n\n      // Admin Dashboard Overview\n      if (url.pathname === '/api/admin/dashboard' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const isAdmin = await checkAdminAccess(userId);\n        if (!isAdmin) {\n          return jsonResponse({ error: 'Admin access required' }, 403);\n        }\n\n        // Get basic stats\n        const totalUsers = await env.DB.prepare('SELECT COUNT(*) as count FROM users').first() as any;\n        const totalCalls = await env.DB.prepare('SELECT COUNT(*) as count FROM webhook_calls').first() as any;\n        const totalWebhooks = await env.DB.prepare('SELECT COUNT(*) as count FROM webhooks').first() as any;\n        const activeCalls = await env.DB.prepare('SELECT COUNT(*) as count FROM active_calls').first() as any;\n\n        // Get recent activity\n        const recentUsers = await env.DB.prepare(\n          'SELECT id, email, name, created_at, last_login_at FROM users ORDER BY created_at DESC LIMIT 10'\n        ).all();\n\n        return jsonResponse({\n          success: true,\n          data: {\n            overview: {\n              totalUsers: totalUsers?.count || 0,\n              totalCalls: totalCalls?.count || 0,\n              totalWebhooks: totalWebhooks?.count || 0,\n              activeCalls: activeCalls?.count || 0,\n            },\n            recentUsers: (recentUsers.results || []).map((u: any) => ({\n              id: u.id,\n              email: u.email,\n              name: u.name,\n              created_at: u.created_at,\n              last_login_at: u.last_login_at\n            }))\n          }\n        });\n      }\n\n      // Admin - Get all users\n      if (url.pathname === '/api/admin/users' && request.method === 'GET') {\n        const userId = await getUserFromToken(request, env);\n        if (!userId) {\n          return jsonResponse({ error: 'Unauthorized' }, 401);\n        }\n\n        const isAdmin = await checkAdminAccess(userId);\n        if (!isAdmin) {\n          return jsonResponse({ error: 'Admin access required' }, 403);\n        }\n\n        const users = await env.DB.prepare(\n          'SELECT id, email, name, created_at, last_login_at FROM users ORDER BY created_at DESC'\n        ).all();\n\n        return jsonResponse({\n          success: true,\n          data: users.results || []\n        });\n      }\n\n      // ============================================\n      // PUBLIC DOCUMENTATION ROUTES (No Auth Required)\n      // ============================================\n\n      // Serve Salesforce Integration User Guide (Raw Markdown)\n      if (url.pathname === '/docs/salesforce-integration' && request.method === 'GET') {\n        const markdown = `# Salesforce Integration Guide\n\n## \uD83C\uDFAF What This Integration Does\n\nWhen you connect Salesforce to your Voice AI Dashboard, every incoming call is automatically logged in Salesforce. Here's what happens:\n\n1. **Search by Phone Number** - We find the existing Lead or Contact in Salesforce using the caller's phone number\n2. **Create Call Log** - We create a Task (call log) on that Lead/Contact record with the full call details\n3. **Schedule Appointments** - If your Voice AI schedules an appointment during the call, we create an Event (appointment) in Salesforce automatically\n\n**Best Part**: Zero programming required on your Salesforce side - just a simple OAuth connection!\n\n---\n\n## \uD83D\uDCCB How It Works\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         SALESFORCE INTEGRATION                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n   One-Time Setup                      Automatic (Every Call)\n   ==============                      ======================\n\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502   You Click  \u2502                   \u2502  Customer Calls      \u2502\n   \u2502  \"Connect    \u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u2502 Salesforce\"  \u2502                              \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                              \u2502\n          \u2502                                      \u25BC\n          \u2502                          \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u25BC                          \u2502 1. Search Salesforce        \u2502\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502    by Phone Number          \u2502\n   \u2502  Salesforce  \u2502                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u2502  Login Page  \u2502                               \u2502\n   \u2502  Opens       \u2502                               \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BC\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                            \u2502 Lead/Contact Found? \u2502\n          \u2502                            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u25BC                                       \u2502\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              YES\n   \u2502  Click       \u2502                               \u2502\n   \u2502  \"Allow\"     \u2502                               \u25BC\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                           \u2502 2. Create Task (Call Log)   \u2502\n          \u2502                           \u2502    on that record           \u2502\n          \u25BC                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                               \u2502\n   \u2502  \u2705 Connected\u2502                               \u2502\n   \u2502  Done!       \u2502                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BC\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2502 Appointment booked? \u2502\n                                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                  \u2502\n                                         \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                         \u2502                 \u2502\n                                        YES               NO\n                                         \u2502                 \u2502\n                                         \u25BC                 \u25BC\n                              \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                              \u2502 3. Create Event  \u2502  \u2502  Done \u2713  \u2502\n                              \u2502    (Appointment) \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n                                  \u2705 All Done!\n                          Call log + Appointment in Salesforce\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDD10 Simple OAuth Connection\n\n### Why This Is Easy\n\nNo manual API key copying, no developer console needed. Just click and authorize!\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         OAUTH SETUP FLOW                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n Your Dashboard              Salesforce               Result\n ==============              ==========               ======\n\n      \u2502                         \u2502                       \u2502\n      \u2502  1. Click \"Connect      \u2502                       \u2502\n      \u2502     Salesforce\"         \u2502                       \u2502\n      \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  2. Popup Opens         \u2502                       \u2502\n      \u2502     Login to Salesforce \u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  3. See Permission      \u2502                       \u2502\n      \u2502     Request:            \u2502                       \u2502\n      \u2502     \"Allow Voice AI     \u2502                       \u2502\n      \u2502      to access your     \u2502                       \u2502\n      \u2502      data?\"             \u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  4. Click \"Allow\"       \u2502                       \u2502\n      \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502                         \u2502  5. Authorization     \u2502\n      \u2502                         \u2502     Granted           \u2502\n      \u2502                         \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  6. Connected! \u2705       \u2502                       \u2502  \u2705 All calls now\n      \u2502     Popup Closes        \u2502                       \u2502    auto-log to\n      \u2502                         \u2502                       \u2502    Salesforce!\n      \u2502\u25C4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n      \u2502                         \u2502                       \u2502\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDD0D How Phone Number Search Works\n\nWe use Salesforce's powerful search to find your Leads and Contacts, even with different phone formats!\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   PHONE NUMBER SEARCH                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nIncoming Call: +1 (555) 123-4567\n\nStep 1: Clean Phone Number\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Remove: +, (, ), -, spaces\n  Result: \"15551234567\"\n\nStep 2: Search Salesforce\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Search ALL phone fields in:\n  \u2192 Leads (Phone, Mobile)\n  \u2192 Contacts (Phone, Mobile)\n\n  Salesforce automatically matches:\n  \u2022 \"+1 (555) 123-4567\"  \u2713\n  \u2022 \"555-123-4567\"        \u2713\n  \u2022 \"5551234567\"          \u2713\n  \u2022 \"+15551234567\"        \u2713\n  \u2022 \"(555) 123-4567\"      \u2713\n\nStep 3: Priority\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  1. Check Leads first (new prospects)\n  2. Then check Contacts (existing customers)\n  3. Use first match found\n\nStep 4: Create Call Log\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Task created on the Lead/Contact\n  \u2705 Appears in Activity Timeline!\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDCDE Call Logging\n\nEvery call creates a Task in Salesforce with complete details:\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              WHAT GETS LOGGED IN SALESFORCE                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nLead/Contact: John Smith\nPhone: (555) 123-4567\n\nActivity Timeline:\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  \u260E\uFE0F  Task: Inbound Call                                     \u2502\n\u2502                                                              \u2502\n\u2502      Subject:          Inbound Call                          \u2502\n\u2502      Status:           Completed                             \u2502\n\u2502      Type:             Call                                  \u2502\n\u2502      Call Type:        Inbound                               \u2502\n\u2502      Date/Time:        Today at 10:45 AM                     \u2502\n\u2502      Duration:         3 min 42 sec                          \u2502\n\u2502                                                              \u2502\n\u2502      Description:      [Full call summary from Voice AI]    \u2502\n\u2502                       Customer inquired about premium        \u2502\n\u2502                       service. Interested in pricing.        \u2502\n\u2502                       Follow-up needed.                      \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDCC5 Appointment Scheduling\n\nWhen your Voice AI schedules an appointment during a call, we automatically create both a call log AND a calendar event!\n\n### How It Works\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    APPOINTMENT BOOKING FLOW                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n  During Call                   After Call Ends           In Salesforce\n  ===========                   ===============           =============\n\n      \u2502                              \u2502                         \u2502\n      \u2502 Customer:                    \u2502                         \u2502\n      \u2502 \"I'd like to schedule        \u2502                         \u2502\n      \u2502  an appointment for          \u2502                         \u2502\n      \u2502  next Monday at 2pm\"         \u2502                         \u2502\n      \u2502                              \u2502                         \u2502\n      \u2502 AI:                          \u2502                         \u2502\n      \u2502 \"Great! I've booked you      \u2502                         \u2502\n      \u2502  for January 15th at         \u2502                         \u2502\n      \u2502  2:00 PM\"                    \u2502                         \u2502\n      \u2502                              \u2502                         \u2502\n      \u2502 [Call Ends]                  \u2502                         \u2502\n      \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502                         \u2502\n      \u2502                              \u2502                         \u2502\n      \u2502                              \u2502 1. Find Lead/Contact    \u2502\n      \u2502                              \u2502    by phone             \u2502\n      \u2502                              \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502\n      \u2502                              \u2502                         \u2502\n      \u2502                              \u2502 2. Create Task          \u2502\n      \u2502                              \u2502    (Call Log) \u2713         \u2502\n      \u2502                              \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502\n      \u2502                              \u2502                         \u2502\n      \u2502                              \u2502 3. Create Event         \u2502\n      \u2502                              \u2502    (Appointment) \u2713      \u2502\n      \u2502                              \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502\n      \u2502                              \u2502                         \u2502\n\n  Result in Salesforce:\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  Lead: Sarah Johnson\n  \u2514\u2500\u2500 Activity Timeline\n      \u251C\u2500\u2500 \u2705 Task: \"Inbound Call - Scheduled Appointment\"\n      \u2502   Today at 10:30 AM\n      \u2502   Duration: 3 min 45 sec\n      \u2502\n      \u2514\u2500\u2500 \uD83D\uDCC5 Event: \"Consultation Appointment\"\n          Monday, Jan 15 at 2:00 PM - 3:00 PM\n          \uD83D\uDD14 Reminder: 1 hour before\n          Shows in Salesforce Calendar!\n\n\\`\\`\\`\n\n### Task vs Event: What's The Difference?\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  TASK VS EVENT IN SALESFORCE                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nTask (Call Log)                    Event (Appointment)\n===============                    ===================\n\n\u260E\uFE0F  Phone Icon                     \uD83D\uDCC5 Calendar Icon\n\nPurpose:                           Purpose:\n  Record past activity               Schedule future activity\n\nStatus:                            Status:\n  Completed \u2713                        Scheduled/Planned\n\nTime:                              Time:\n  When call happened                 When appointment is\n\nShows In:                          Shows In:\n  \u2022 Activity History                 \u2022 Activity History\n  \u2022 Task List                        \u2022 Salesforce Calendar\n                                     \u2022 Outlook/Google Calendar sync\n\nExample:                           Example:\n  \"Customer called today             \"Consultation scheduled for\n   about pricing\"                     Jan 15 at 2:00 PM\"\n\n\\`\\`\\`\n\n### What Gets Captured\n\nWhen an appointment is booked during a call, we capture:\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              APPOINTMENT EVENT IN SALESFORCE                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nEvent Details:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Subject:       \"Consultation Appointment\"\n  Date:          January 15, 2025\n  Start Time:    2:00 PM\n  End Time:      3:00 PM (1 hour duration)\n  Type:          Meeting\n  Status:        Scheduled\n\n  Description:   Appointment scheduled during call.\n\n                 Notes: Bring ID and insurance card\n\n                 Call Summary:\n                 Customer called to schedule consultation.\n                 Interested in premium service package.\n\n  Reminder:      Set for 1 hour before (1:00 PM)\n\nVisibility:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Shows in Salesforce Activity Timeline\n  \u2713 Shows in Salesforce Calendar\n  \u2713 Syncs to Outlook/Google Calendar (if enabled)\n  \u2713 Rep receives reminder notification\n\n\\`\\`\\`\n\n---\n\n## \uD83C\uDFAF What You See in Salesforce\n\n### Activity Timeline View\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Lead: Michael Rodriguez                                     \u2502\n\u2502  Phone: (555) 987-6543                                       \u2502\n\u2502  Company: Tech Solutions Inc.                                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Activity Timeline                           [Filter] [Sort] \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                               \u2502\n\u2502  \uD83D\uDCC5 Upcoming                                                 \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                                                   \u2502\n\u2502                                                               \u2502\n\u2502  Monday, Jan 15 at 2:00 PM                                   \u2502\n\u2502  \uD83D\uDCC5  Consultation Appointment - Scheduled via Voice AI       \u2502\n\u2502      Duration: 1 hour (2:00 PM - 3:00 PM)                    \u2502\n\u2502      \uD83D\uDD14 Reminder set for 1:00 PM                             \u2502\n\u2502      [View Details] [Reschedule] [Cancel]                    \u2502\n\u2502                                                               \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                               \u2502\n\u2502  \u2705 Past Activity                                            \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                                              \u2502\n\u2502                                                               \u2502\n\u2502  Today at 10:30 AM                                           \u2502\n\u2502  \u260E\uFE0F  Inbound Call - Scheduled Appointment                    \u2502\n\u2502      Status: Completed                                       \u2502\n\u2502      Duration: 3 min 45 sec                                  \u2502\n\u2502      Call Type: Inbound                                      \u2502\n\u2502                                                               \u2502\n\u2502      Description:                                            \u2502\n\u2502      Customer called to schedule consultation. Discussed     \u2502\n\u2502      premium service options. Very interested. Appointment   \u2502\n\u2502      created for next week. Requested reminder to bring ID.  \u2502\n\u2502                                                               \u2502\n\u2502      [View Full Details]                                     \u2502\n\u2502                                                               \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                               \u2502\n\u2502  Jan 10 at 3:15 PM                                           \u2502\n\u2502  \u260E\uFE0F  Inbound Call - Information Request                      \u2502\n\u2502      Status: Completed                                       \u2502\n\u2502      Duration: 2 min 18 sec                                  \u2502\n\u2502      ...                                                     \u2502\n\u2502                                                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\\`\\`\\`\n\n### Calendar View\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Salesforce Calendar                          January 2025   \u2502\n\u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                               \u2502\n\u2502  Mon 13   Tue 14   Wed 15   Thu 16   Fri 17                 \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2500\u2500\u2500\u2500\u2500\u2500\u2500                \u2502\n\u2502                                                               \u2502\n\u2502                     \uD83D\uDCC5 2:00 PM                                \u2502\n\u2502                     Consultation                              \u2502\n\u2502                     with Michael R.                           \u2502\n\u2502                     (Voice AI)                                \u2502\n\u2502                                                               \u2502\n\u2502                                                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nClick event to see:\n  \u2022 Full appointment details\n  \u2022 Related Lead/Contact\n  \u2022 Call notes from booking\n  \u2022 Reschedule/Cancel options\n\n\\`\\`\\`\n\n---\n\n## \u2705 Benefits\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   WHAT YOU GET                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nFor Sales Reps:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Complete call history on every Lead/Contact\n  \u2713 No manual data entry after calls\n  \u2713 Automatic appointment scheduling\n  \u2713 Calendar reminders for appointments\n  \u2713 Full call transcripts and summaries\n  \u2713 All data in one place (Salesforce)\n\nFor Managers:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Track all inbound calls automatically\n  \u2713 See which Leads are being contacted\n  \u2713 Monitor appointment booking rate\n  \u2713 Complete activity history\n  \u2713 No missed follow-ups\n\nFor Everyone:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Zero manual work\n  \u2713 No training needed\n  \u2713 Works automatically 24/7\n  \u2713 Sync happens in real-time\n  \u2713 Nothing to configure after initial setup\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDD12 Security & Privacy\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   YOUR DATA IS SAFE                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nSecure OAuth Connection:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Industry-standard OAuth 2.0\n  \u2713 No API keys to copy/paste\n  \u2713 You control permissions\n  \u2713 Can disconnect anytime\n\nWhat We Access:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Read Leads (to find by phone)\n  \u2713 Read Contacts (to find by phone)\n  \u2713 Create Tasks (to log calls)\n  \u2713 Create Events (to schedule appointments)\n\nWhat We DON'T Access:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2717 Cannot delete records\n  \u2717 Cannot modify existing data\n  \u2717 No access to other objects\n  \u2717 No admin permissions\n  \u2717 Cannot see other users' data\n\nWorkspace Isolation:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Each workspace has separate connection\n  \u2713 No cross-workspace data sharing\n  \u2713 Tokens stored securely server-side\n  \u2713 Auto-refresh for uninterrupted service\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDE80 Setup Requirements\n\n### What You Need\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   SETUP REQUIREMENTS                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nSalesforce Account:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 Any Salesforce edition (including Professional)\n  \u2022 User must have:\n    \u2192 Read access to Leads\n    \u2192 Read access to Contacts\n    \u2192 Create access to Tasks\n    \u2192 Create access to Events\n  \u2022 NO System Administrator required!\n  \u2022 NO Developer Console access needed!\n  \u2022 NO Apex programming required!\n\nTypical User Profiles That Work:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2713 Standard User\n  \u2713 Sales User\n  \u2713 Service User\n  \u2713 Salesforce Platform\n  \u2713 Any custom profile with object permissions above\n\nTime Required:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 Initial admin setup: 10 minutes (one-time)\n  \u2022 User connection: 30 seconds (per user)\n  \u2022 Zero ongoing maintenance!\n\n\\`\\`\\`\n\n---\n\n## \uD83C\uDF93 Setup Process Overview\n\n### For Salesforce Admins (One-Time Setup)\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              ADMIN SETUP (10 MINUTES, ONE-TIME)                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nStep 1: Create Connected App in Salesforce\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Navigate: Setup \u2192 Apps \u2192 App Manager \u2192 New Connected App\n\n  Fill in:\n    \u2022 App Name: \"Voice AI Dashboard\"\n    \u2022 Contact Email: your@email.com\n    \u2022 Enable OAuth Settings: \u2713\n    \u2022 Callback URL: (provided by us)\n    \u2022 OAuth Scopes:\n      - Access and manage your data (api)\n      - Perform requests at any time (refresh_token)\n\nStep 2: Get Credentials\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Copy:\n    \u2022 Consumer Key (Client ID)\n    \u2022 Consumer Secret (Client Secret)\n\n  Provide these to us for configuration\n\nStep 3: Done!\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  All workspace members can now connect their accounts\n\n\\`\\`\\`\n\n### For Users (30 Seconds)\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                USER CONNECTION (30 SECONDS)                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nStep 1: Go to Integrations\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Dashboard \u2192 Integrations \u2192 Salesforce\n\nStep 2: Click \"Connect\"\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Popup window opens to Salesforce\n\nStep 3: Login & Allow\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 Login to your Salesforce account\n  \u2022 Review permissions\n  \u2022 Click \"Allow\"\n\nStep 4: Done! \u2705\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Connected! All calls now auto-log to Salesforce.\n\n\\`\\`\\`\n\n---\n\n## \uD83D\uDD04 How Auto-Refresh Works\n\nYou never have to reconnect! Our system automatically maintains your connection.\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              AUTOMATIC CONNECTION MAINTENANCE                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nInitial Connection:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  You: Click \"Connect\" \u2192 Login \u2192 Allow\n  Result: \u2705 Connected\n\nBehind The Scenes:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 We receive access token (expires in 2 hours)\n  \u2022 We receive refresh token (never expires)\n  \u2022 We store both securely\n\nEvery Time A Call Comes In:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  1. Check if access token is still valid\n  2. If expired, automatically refresh it\n  3. Use new token to create Task/Event\n  4. You never notice any interruption!\n\nYou Never Need To:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2717 Re-login\n  \u2717 Re-authorize\n  \u2717 Manually refresh\n  \u2717 Enter credentials again\n\nThe connection works until:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 You click \"Disconnect\" in our dashboard\n  \u2022 You revoke access in Salesforce\n  \u2022 Admin disables the Connected App\n\nOtherwise: Always connected, always working! \u2705\n\n\\`\\`\\`\n\n---\n\n## \u2753 Frequently Asked Questions\n\n### General Questions\n\n**Q: Do I need to be a Salesforce Admin?**\nA: No! Regular users can connect their own accounts. An admin only needs to do the one-time Connected App setup.\n\n**Q: Will this work with Leads and Contacts?**\nA: Yes! We search both Leads and Contacts by phone number and create call logs on whichever one we find.\n\n**Q: What if the phone number isn't in Salesforce?**\nA: We'll log a warning but won't create a Task. The call data is still saved in your Voice AI Dashboard.\n\n**Q: Can I disconnect anytime?**\nA: Yes! Click \"Disconnect\" in the Integrations page anytime. Your existing call logs in Salesforce won't be deleted.\n\n### Phone Number Questions\n\n**Q: Do phone formats need to match exactly?**\nA: No! Salesforce's search handles different formats automatically:\n- \\`+1 (555) 123-4567\\`\n- \\`555-123-4567\\`\n- \\`5551234567\\`\n- All of these will match!\n\n**Q: What if a Lead has multiple phone numbers?**\nA: We search Phone AND Mobile Phone fields. If the incoming call matches either, we'll find it.\n\n**Q: Can I test with a specific phone number?**\nA: Yes! Use the \"Test Sync\" button in the integration settings to manually test any phone number.\n\n### Appointment Questions\n\n**Q: How does appointment scheduling work?**\nA: If your Voice AI detects and confirms an appointment during the call, we automatically create both:\n1. A Task (call log)\n2. An Event (appointment on the calendar)\n\n**Q: Can I customize the appointment duration?**\nA: Yes! The default is 1 hour, but your Voice AI can specify different durations (30 min, 2 hours, etc.)\n\n**Q: Will the sales rep get reminded?**\nA: Yes! We set a reminder for 1 hour before the appointment. Reps will get Salesforce notifications.\n\n**Q: What if the appointment needs to be rescheduled?**\nA: The rep can reschedule directly in Salesforce. The Event is a normal Salesforce Event with all standard features.\n\n### Technical Questions\n\n**Q: Does this require Apex code?**\nA: No! This is pure OAuth + REST API integration. Zero coding required.\n\n**Q: Will this slow down my calls?**\nA: No! The Salesforce sync happens after the call ends, so there's no impact on call quality or speed.\n\n**Q: What Salesforce edition do I need?**\nA: Professional Edition or higher. The integration uses standard Salesforce objects (Leads, Contacts, Tasks, Events).\n\n**Q: How long does it take for calls to appear?**\nA: Usually within 30 seconds of the call ending. It's near real-time!\n\n---\n\n## \uD83D\uDCCA Success Metrics\n\nAfter connecting Salesforce, you'll see:\n\n\\`\\`\\`\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   MEASURABLE RESULTS                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nData Quality:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 100% of calls automatically logged\n  \u2022 Zero manual data entry\n  \u2022 Complete call transcripts saved\n  \u2022 No missed follow-ups\n\nTime Savings:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 ~5 minutes saved per call (no manual logging)\n  \u2022 ~10 calls/day = 50 minutes saved daily\n  \u2022 ~250 calls/month = 20+ hours saved monthly!\n\nSales Performance:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 Complete Lead activity history\n  \u2022 Never miss a scheduled appointment\n  \u2022 Better follow-up rates\n  \u2022 Improved customer experience\n\nVisibility:\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \u2022 Real-time call tracking\n  \u2022 Appointment booking metrics\n  \u2022 Lead engagement scores\n  \u2022 Full audit trail\n\n\\`\\`\\`\n\n---\n\n## \uD83C\uDF89 Get Started\n\nReady to connect Salesforce?\n\n1. **Ask your Salesforce Admin** to set up the Connected App (takes 10 minutes)\n2. **Go to Integrations** in your Voice AI Dashboard\n3. **Click \"Connect Salesforce\"**\n4. **Login and Allow**\n5. **Done!** Calls start auto-logging immediately\n\nNeed help? Contact our support team anytime!\n\n---\n\n*Last Updated: January 2025*\n*Voice AI Dashboard - Salesforce Integration*`;\n\n        return new Response(markdown, {\n          status: 200,\n          headers: {\n            'Content-Type': 'text/markdown; charset=utf-8',\n            ...corsHeaders,\n          },\n        });\n      }\n\n      // Serve Salesforce Integration User Guide (HTML)\n      if (url.pathname === '/docs/salesforce-integration/html' && request.method === 'GET') {\n        const htmlContent = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Salesforce Integration Guide - Voice AI Dashboard</title>\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      line-height: 1.6;\n      color: #1f2937;\n      background: #f9fafb;\n      padding: 20px;\n    }\n\n    .container {\n      max-width: 900px;\n      margin: 0 auto;\n      background: white;\n      padding: 40px;\n      border-radius: 12px;\n      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n    }\n\n    h1 {\n      font-size: 2.5rem;\n      margin-bottom: 0.5rem;\n      color: #111827;\n      border-bottom: 3px solid #3b82f6;\n      padding-bottom: 0.5rem;\n    }\n\n    h2 {\n      font-size: 1.875rem;\n      margin-top: 2.5rem;\n      margin-bottom: 1rem;\n      color: #1f2937;\n      display: flex;\n      align-items: center;\n      gap: 0.5rem;\n    }\n\n    h3 {\n      font-size: 1.5rem;\n      margin-top: 2rem;\n      margin-bottom: 0.75rem;\n      color: #374151;\n    }\n\n    p {\n      margin-bottom: 1rem;\n      color: #4b5563;\n    }\n\n    pre {\n      background: #1f2937;\n      color: #e5e7eb;\n      padding: 1.5rem;\n      border-radius: 8px;\n      overflow-x: auto;\n      margin: 1.5rem 0;\n      font-family: 'Courier New', monospace;\n      font-size: 0.875rem;\n      line-height: 1.5;\n    }\n\n    code {\n      background: #f3f4f6;\n      padding: 0.2rem 0.4rem;\n      border-radius: 4px;\n      font-family: 'Courier New', monospace;\n      font-size: 0.875rem;\n      color: #e11d48;\n    }\n\n    pre code {\n      background: transparent;\n      padding: 0;\n      color: #e5e7eb;\n    }\n\n    ul, ol {\n      margin: 1rem 0 1rem 2rem;\n    }\n\n    li {\n      margin-bottom: 0.5rem;\n      color: #4b5563;\n    }\n\n    strong {\n      color: #111827;\n      font-weight: 600;\n    }\n\n    hr {\n      border: none;\n      border-top: 1px solid #e5e7eb;\n      margin: 2.5rem 0;\n    }\n\n    .info-box {\n      background: #eff6ff;\n      border-left: 4px solid #3b82f6;\n      padding: 1rem 1.5rem;\n      margin: 1.5rem 0;\n      border-radius: 4px;\n    }\n\n    .success-box {\n      background: #f0fdf4;\n      border-left: 4px solid #22c55e;\n      padding: 1rem 1.5rem;\n      margin: 1.5rem 0;\n      border-radius: 4px;\n    }\n\n    .warning-box {\n      background: #fffbeb;\n      border-left: 4px solid #f59e0b;\n      padding: 1rem 1.5rem;\n      margin: 1.5rem 0;\n      border-radius: 4px;\n    }\n\n    a {\n      color: #3b82f6;\n      text-decoration: none;\n    }\n\n    a:hover {\n      text-decoration: underline;\n    }\n\n    .faq-question {\n      font-weight: 600;\n      color: #111827;\n      margin-top: 1.5rem;\n      margin-bottom: 0.5rem;\n    }\n\n    .faq-answer {\n      color: #4b5563;\n      margin-bottom: 1rem;\n      padding-left: 1rem;\n    }\n\n    @media (max-width: 768px) {\n      .container {\n        padding: 20px;\n      }\n\n      h1 {\n        font-size: 2rem;\n      }\n\n      h2 {\n        font-size: 1.5rem;\n      }\n\n      pre {\n        padding: 1rem;\n        font-size: 0.75rem;\n      }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h1>Salesforce Integration Guide</h1>\n\n    <h2>\uD83C\uDFAF What This Integration Does</h2>\n    <p>When you connect Salesforce to your Voice AI Dashboard, every incoming call is automatically logged in Salesforce. Here's what happens:</p>\n    <ol>\n      <li><strong>Search by Phone Number</strong> - We find the existing Lead or Contact in Salesforce using the caller's phone number</li>\n      <li><strong>Create Call Log</strong> - We create a Task (call log) on that Lead/Contact record with the full call details</li>\n      <li><strong>Schedule Appointments</strong> - If your Voice AI schedules an appointment during the call, we create an Event (appointment) in Salesforce automatically</li>\n    </ol>\n\n    <div class=\"success-box\">\n      <strong>Best Part:</strong> Zero programming required on your Salesforce side - just a simple OAuth connection!\n    </div>\n\n    <hr>\n\n    <h2>\uD83D\uDCCB How It Works</h2>\n    <pre>\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         SALESFORCE INTEGRATION                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n   One-Time Setup                      Automatic (Every Call)\n   ==============                      ======================\n\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2502   You Click  \u2502                   \u2502  Customer Calls      \u2502\n   \u2502  \"Connect    \u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u2502 Salesforce\"  \u2502                              \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                              \u2502\n          \u2502                                      \u25BC\n          \u2502                          \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u25BC                          \u2502 1. Search Salesforce        \u2502\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502    by Phone Number          \u2502\n   \u2502  Salesforce  \u2502                 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u2502  Login Page  \u2502                               \u2502\n   \u2502  Opens       \u2502                               \u2502\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BC\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                            \u2502 Lead/Contact Found? \u2502\n          \u2502                            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u25BC                                       \u2502\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                              YES\n   \u2502  Click       \u2502                               \u2502\n   \u2502  \"Allow\"     \u2502                               \u25BC\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502                           \u2502 2. Create Task (Call Log)   \u2502\n          \u2502                           \u2502    on that record           \u2502\n          \u25BC                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                               \u2502\n   \u2502  \u2705 Connected\u2502                               \u2502\n   \u2502  Done!       \u2502                    \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BC\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                    \u2502 Appointment booked? \u2502\n                                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                  \u2502\n                                         \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                         \u2502                 \u2502\n                                        YES               NO\n                                         \u2502                 \u2502\n                                         \u25BC                 \u25BC\n                              \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                              \u2502 3. Create Event  \u2502  \u2502  Done \u2713  \u2502\n                              \u2502    (Appointment) \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n                                  \u2705 All Done!\n                          Call log + Appointment in Salesforce\n    </pre>\n\n    <hr>\n\n    <h2>\uD83D\uDD10 Simple OAuth Connection</h2>\n    <h3>Why This Is Easy</h3>\n    <p>No manual API key copying, no developer console needed. Just click and authorize!</p>\n    <pre>\n\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         OAUTH SETUP FLOW                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n Your Dashboard              Salesforce               Result\n ==============              ==========               ======\n\n      \u2502                         \u2502                       \u2502\n      \u2502  1. Click \"Connect      \u2502                       \u2502\n      \u2502     Salesforce\"         \u2502                       \u2502\n      \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  2. Popup Opens         \u2502                       \u2502\n      \u2502     Login to Salesforce \u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  3. See Permission      \u2502                       \u2502\n      \u2502     Request:            \u2502                       \u2502\n      \u2502     \"Allow Voice AI     \u2502                       \u2502\n      \u2502      to access your     \u2502                       \u2502\n      \u2502      data?\"             \u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  4. Click \"Allow\"       \u2502                       \u2502\n      \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502                       \u2502\n      \u2502                         \u2502                       \u2502\n      \u2502                         \u2502  5. Authorization     \u2502\n      \u2502                         \u2502     Granted           \u2502\n      \u2502                         \u251C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA\u2502\n      \u2502                         \u2502                       \u2502\n      \u2502  6. Connected! \u2705       \u2502                       \u2502  \u2705 All calls now\n      \u2502     Popup Closes        \u2502                       \u2502    auto-log to\n      \u2502                         \u2502                       \u2502    Salesforce!\n      \u2502\u25C4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n      \u2502                         \u2502                       \u2502\n    </pre>\n\n    <hr>\n\n    <h2>\u2705 Benefits</h2>\n    <h3>For Sales Reps:</h3>\n    <ul>\n      <li>Complete call history on every Lead/Contact</li>\n      <li>No manual data entry after calls</li>\n      <li>Automatic appointment scheduling</li>\n      <li>Calendar reminders for appointments</li>\n      <li>Full call transcripts and summaries</li>\n      <li>All data in one place (Salesforce)</li>\n    </ul>\n\n    <h3>For Managers:</h3>\n    <ul>\n      <li>Track all inbound calls automatically</li>\n      <li>See which Leads are being contacted</li>\n      <li>Monitor appointment booking rate</li>\n      <li>Complete activity history</li>\n      <li>No missed follow-ups</li>\n    </ul>\n\n    <h3>For Everyone:</h3>\n    <ul>\n      <li>Zero manual work</li>\n      <li>No training needed</li>\n      <li>Works automatically 24/7</li>\n      <li>Sync happens in real-time</li>\n      <li>Nothing to configure after initial setup</li>\n    </ul>\n\n    <hr>\n\n    <h2>\uD83D\uDD12 Security & Privacy</h2>\n\n    <div class=\"info-box\">\n      <h3>Secure OAuth Connection:</h3>\n      <ul>\n        <li>Industry-standard OAuth 2.0</li>\n        <li>No API keys to copy/paste</li>\n        <li>You control permissions</li>\n        <li>Can disconnect anytime</li>\n      </ul>\n    </div>\n\n    <h3>What We Access:</h3>\n    <ul>\n      <li>Read Leads (to find by phone)</li>\n      <li>Read Contacts (to find by phone)</li>\n      <li>Create Tasks (to log calls)</li>\n      <li>Create Events (to schedule appointments)</li>\n    </ul>\n\n    <h3>What We DON'T Access:</h3>\n    <ul>\n      <li>Cannot delete records</li>\n      <li>Cannot modify existing data</li>\n      <li>No access to other objects</li>\n      <li>No admin permissions</li>\n      <li>Cannot see other users' data</li>\n    </ul>\n\n    <hr>\n\n    <h2>\u2753 Frequently Asked Questions</h2>\n\n    <h3>General Questions</h3>\n\n    <div class=\"faq-question\">Q: Do I need to be a Salesforce Admin?</div>\n    <div class=\"faq-answer\">A: No! Regular users can connect their own accounts. An admin only needs to do the one-time Connected App setup.</div>\n\n    <div class=\"faq-question\">Q: Will this work with Leads and Contacts?</div>\n    <div class=\"faq-answer\">A: Yes! We search both Leads and Contacts by phone number and create call logs on whichever one we find.</div>\n\n    <div class=\"faq-question\">Q: What if the phone number isn't in Salesforce?</div>\n    <div class=\"faq-answer\">A: We'll log a warning but won't create a Task. The call data is still saved in your Voice AI Dashboard.</div>\n\n    <div class=\"faq-question\">Q: Can I disconnect anytime?</div>\n    <div class=\"faq-answer\">A: Yes! Click \"Disconnect\" in the Integrations page anytime. Your existing call logs in Salesforce won't be deleted.</div>\n\n    <h3>Phone Number Questions</h3>\n\n    <div class=\"faq-question\">Q: Do phone formats need to match exactly?</div>\n    <div class=\"faq-answer\">A: No! Salesforce's search handles different formats automatically (e.g., +1 (555) 123-4567, 555-123-4567, 5551234567 - all will match!)</div>\n\n    <div class=\"faq-question\">Q: What if a Lead has multiple phone numbers?</div>\n    <div class=\"faq-answer\">A: We search Phone AND Mobile Phone fields. If the incoming call matches either, we'll find it.</div>\n\n    <h3>Appointment Questions</h3>\n\n    <div class=\"faq-question\">Q: How does appointment scheduling work?</div>\n    <div class=\"faq-answer\">A: If your Voice AI detects and confirms an appointment during the call, we automatically create both: 1. A Task (call log) 2. An Event (appointment on the calendar)</div>\n\n    <div class=\"faq-question\">Q: Can I customize the appointment duration?</div>\n    <div class=\"faq-answer\">A: Yes! The default is 1 hour, but your Voice AI can specify different durations (30 min, 2 hours, etc.)</div>\n\n    <div class=\"faq-question\">Q: Will the sales rep get reminded?</div>\n    <div class=\"faq-answer\">A: Yes! We set a reminder for 1 hour before the appointment. Reps will get Salesforce notifications.</div>\n\n    <h3>Technical Questions</h3>\n\n    <div class=\"faq-question\">Q: Does this require Apex code?</div>\n    <div class=\"faq-answer\">A: No! This is pure OAuth + REST API integration. Zero coding required.</div>\n\n    <div class=\"faq-question\">Q: Will this slow down my calls?</div>\n    <div class=\"faq-answer\">A: No! The Salesforce sync happens after the call ends, so there's no impact on call quality or speed.</div>\n\n    <div class=\"faq-question\">Q: What Salesforce edition do I need?</div>\n    <div class=\"faq-answer\">A: Professional Edition or higher. The integration uses standard Salesforce objects (Leads, Contacts, Tasks, Events).</div>\n\n    <div class=\"faq-question\">Q: How long does it take for calls to appear?</div>\n    <div class=\"faq-answer\">A: Usually within 30 seconds of the call ending. It's near real-time!</div>\n\n    <hr>\n\n    <h2>\uD83C\uDF89 Get Started</h2>\n    <p>Ready to connect Salesforce?</p>\n    <ol>\n      <li><strong>Ask your Salesforce Admin</strong> to set up the Connected App (takes 10 minutes)</li>\n      <li><strong>Go to Integrations</strong> in your Voice AI Dashboard</li>\n      <li><strong>Click \"Connect Salesforce\"</strong></li>\n      <li><strong>Login and Allow</strong></li>\n      <li><strong>Done!</strong> Calls start auto-logging immediately</li>\n    </ol>\n\n    <div class=\"success-box\">\n      <p><strong>Need help?</strong> Contact our support team anytime!</p>\n    </div>\n\n    <hr>\n\n    <p style=\"text-align: center; color: #6b7280; font-size: 0.875rem; margin-top: 3rem;\">\n      <em>Last Updated: January 2025</em><br>\n      <em>Voice AI Dashboard - Salesforce Integration</em>\n    </p>\n  </div>\n</body>\n</html>`;\n\n        return new Response(htmlContent, {\n          status: 200,\n          headers: {\n            'Content-Type': 'text/html; charset=utf-8',\n            ...corsHeaders,\n          },\n        });\n      }\n\n      // ============================================\n      // PUBLIC WEBHOOK RECEIVER (No Auth Required)\n      // ============================================\n\n      // Receive VAPI webhook data\n      if (url.pathname.startsWith('/webhook/') && request.method === 'POST') {\n        const webhookId = url.pathname.split('/').pop();\n\n        // Validate webhook exists and is active\n        const webhook = await env.DB.prepare(\n          'SELECT id, user_id FROM webhooks WHERE id = ? AND is_active = 1'\n        ).bind(webhookId).first() as any;\n\n        if (!webhook) {\n          return jsonResponse({ error: 'Webhook not found or inactive' }, 404);\n        }\n\n        // Parse VAPI payload\n        let payload: any;\n        try {\n          payload = await request.json();\n        } catch (error) {\n          // Log error\n          await env.DB.prepare(\n            'INSERT INTO webhook_logs (id, webhook_id, status, http_status, error_message, created_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(\n            generateId(),\n            webhookId,\n            'error',\n            400,\n            'Invalid JSON payload',\n            now()\n          ).run();\n\n          return jsonResponse({ error: 'Invalid JSON payload' }, 400);\n        }\n\n        // Extract fields from VAPI payload\n        const message = payload.message || {};\n        const messageType = message.type || 'end-of-call-report';\n        const call = message.call || {};\n        const customer = call.customer || {};\n        const phoneNumber = call.phoneNumber || {};\n        const artifact = message.artifact || {};\n        const analysis = message.analysis || {};\n\n        const timestamp = now();\n\n        // Log incoming webhook for debugging\n        console.log('[Webhook Debug] Message Type:', messageType);\n        console.log('[Webhook Debug] Call ID:', call.id);\n        console.log('[Webhook Debug] Status:', message.status);\n\n        // Handle status-update events (real-time call status)\n        if (messageType === 'status-update') {\n          const callStatus = message.status; // 'queued', 'ringing', 'in-progress', 'forwarding', 'ended'\n          const vapiCallId = call.id;\n          const customerNumber = customer.number || null;\n\n          // Track active calls (ringing, in-progress, or forwarding)\n          if (callStatus === 'ringing' || callStatus === 'in-progress' || callStatus === 'forwarding') {\n            // Enrich caller data with Twilio Lookup\n            let twilioData: TwilioCallerInfo | null = null;\n            if (customerNumber) {\n              try {\n                const wsSettings = await getWorkspaceSettingsForUser(env, webhook.user_id);\n\n                if (wsSettings?.twilio_account_sid && wsSettings?.twilio_auth_token) {\n                  twilioData = await lookupCallerWithTwilio(\n                    customerNumber,\n                    wsSettings.twilio_account_sid,\n                    wsSettings.twilio_auth_token\n                  );\n                }\n              } catch (error) {\n                console.error('Error enriching caller data:', error);\n              }\n            }\n\n            // Insert or update active call\n            await env.DB.prepare(\n              `INSERT OR REPLACE INTO active_calls\n              (id, user_id, vapi_call_id, customer_number, caller_name, carrier_name, line_type, status, started_at, updated_at)\n              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n            ).bind(\n              vapiCallId,\n              webhook.user_id,\n              vapiCallId,\n              customerNumber,\n              twilioData?.callerName || null,\n              twilioData?.carrierName || null,\n              twilioData?.lineType || null,\n              callStatus,\n              timestamp,\n              timestamp\n            ).run();\n\n            console.log('[Webhook Debug] Active call inserted/updated:', vapiCallId, 'Status:', callStatus, 'Caller:', twilioData?.callerName || 'Unknown');\n\n            // Invalidate cache\n            const cache = new VoiceAICache(env.CACHE);\n            await cache.invalidateUserCache(webhook.user_id);\n\n            // Dispatch call.started event to outbound webhooks (only for ringing status, not in-progress)\n            if (callStatus === 'ringing') {\n              ctx.waitUntil(\n                dispatchToOutboundWebhooks(env, webhook.user_id, 'call.started', {\n                  callId: vapiCallId,\n                  customerPhone: customerNumber,\n                  assistantName: call.assistant?.name || 'AI Assistant',\n                })\n              );\n            }\n\n            return jsonResponse({ success: true, message: 'Call status updated' });\n\n          } else if (callStatus === 'ended') {\n            // Remove from active calls\n            await env.DB.prepare(\n              'DELETE FROM active_calls WHERE vapi_call_id = ? AND user_id = ?'\n            ).bind(vapiCallId, webhook.user_id).run();\n\n            // Invalidate cache\n            const cache = new VoiceAICache(env.CACHE);\n            await cache.invalidateUserCache(webhook.user_id);\n\n            return jsonResponse({ success: true, message: 'Call ended, removed from active calls' });\n          }\n\n          return jsonResponse({ success: true, message: 'Status update received' });\n        }\n\n        // Handle end-of-call-report (existing logic)\n        const callId = generateId();\n\n        // Enrich caller data with Twilio Lookup (if configured)\n        let twilioData: TwilioCallerInfo | null = null;\n        const customerNumber = customer.number || null;\n\n        if (customerNumber) {\n          try {\n            const wsSettings = await getWorkspaceSettingsForUser(env, webhook.user_id);\n\n            if (wsSettings?.twilio_account_sid && wsSettings?.twilio_auth_token) {\n              twilioData = await lookupCallerWithTwilio(\n                customerNumber,\n                wsSettings.twilio_account_sid,\n                wsSettings.twilio_auth_token\n              );\n            }\n          } catch (error) {\n            console.error('Error enriching caller data with Twilio:', error);\n          }\n        }\n\n        // Filter out test calls - skip saving if there's no customer number\n        if (!customerNumber) {\n          console.log('[Webhook] Skipping test call - no customer number present');\n          return jsonResponse({ success: true, message: 'Test call ignored (no customer number)' });\n        }\n\n        // Calculate duration - check multiple locations in payload\n        let durationSeconds: number | null = null;\n\n        // First, try to use durationSeconds directly from message\n        if (message.durationSeconds) {\n          durationSeconds = Math.floor(message.durationSeconds);\n        }\n        // Fallback: try message.startedAt and message.endedAt (actual payload structure)\n        else if (message.startedAt && message.endedAt) {\n          try {\n            const startTime = new Date(message.startedAt).getTime();\n            const endTime = new Date(message.endedAt).getTime();\n            durationSeconds = Math.floor((endTime - startTime) / 1000); // Convert to seconds\n          } catch (error) {\n            console.error('Error calculating call duration from message timestamps:', error);\n          }\n        }\n        // Last fallback: try call.startedAt and call.endedAt (older structure)\n        else if (call.startedAt && call.endedAt) {\n          try {\n            const startTime = new Date(call.startedAt).getTime();\n            const endTime = new Date(call.endedAt).getTime();\n            durationSeconds = Math.floor((endTime - startTime) / 1000); // Convert to seconds\n          } catch (error) {\n            console.error('Error calculating call duration from call timestamps:', error);\n          }\n        }\n\n        // Store call data\n        try {\n          await env.DB.prepare(\n            `INSERT INTO webhook_calls (\n              id, webhook_id, user_id, vapi_call_id, phone_number, customer_number,\n              recording_url, ended_reason, summary, structured_data, raw_payload, created_at,\n              caller_name, caller_type, carrier_name, line_type, duration_seconds\n            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`\n          ).bind(\n            callId,\n            webhookId,\n            webhook.user_id,\n            call.id || null,\n            phoneNumber.number || null,  // AI agent's phone number\n            customer.number || null,      // Customer's phone number\n            message.recordingUrl || artifact.recordingUrl || null,\n            message.endedReason || call.endedReason || 'unknown',\n            analysis.summary || message.summary || '',\n            JSON.stringify(analysis.structuredData || {}),\n            JSON.stringify(payload),\n            timestamp,\n            twilioData?.callerName || null,\n            twilioData?.callerType || null,\n            twilioData?.carrierName || null,\n            twilioData?.lineType || null,\n            durationSeconds\n          ).run();\n\n          // Log success\n          await env.DB.prepare(\n            'INSERT INTO webhook_logs (id, webhook_id, status, http_status, payload_size, created_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(\n            generateId(),\n            webhookId,\n            'success',\n            200,\n            JSON.stringify(payload).length,\n            timestamp\n          ).run();\n\n          // Invalidate user cache for new data\n          const cache = new VoiceAICache(env.CACHE);\n          await cache.invalidateUserCache(webhook.user_id);\n\n          // Dispatch to outbound webhooks in the background (call.ended event)\n          ctx.waitUntil(\n            dispatchToOutboundWebhooks(env, webhook.user_id, 'call.ended', {\n              callId: call.id || callId,\n              customerPhone: customer.number,\n              assistantName: message.assistant?.name || call.assistant?.name || 'AI Assistant',\n              durationSeconds,\n              endedReason: message.endedReason || call.endedReason || 'unknown',\n              summary: analysis.summary || message.summary || '',\n              structuredData: analysis.structuredData || {},\n              rawPayload: payload,\n              recordingUrl: message.recordingUrl || artifact.recordingUrl || null,\n            })\n          );\n\n          // Trigger OpenAI analysis and addons in the background (don't wait for them)\n          ctx.waitUntil(\n            (async () => {\n              try {\n                // First, extract appointment data from VAPI's structured data\n                const structuredData = analysis.structuredData || {};\n                let vapiAppointmentDate = structuredData.appointmentDate || structuredData.appointment_date || null;\n                let vapiAppointmentTime = structuredData.appointmentTime || structuredData.appointment_time || null;\n                let vapiAppointmentType = structuredData.appointmentType || structuredData.appointment_type || null;\n                let vapiCustomerName = structuredData.customerName || structuredData.customer_name || null;\n                let vapiCustomerEmail = structuredData.customerEmail || structuredData.customer_email || null;\n\n                // Get workspace OpenAI API key\n                const wsSettings = await getWorkspaceSettingsForUser(env, webhook.user_id);\n\n                if (wsSettings?.openai_api_key) {\n                  const transcript = artifact.transcript || '';\n                  const summary = analysis.summary || message.summary || '';\n\n                  // Analyze with OpenAI\n                  const analysisResult = await analyzeCallWithOpenAI(\n                    summary,\n                    transcript,\n                    wsSettings.openai_api_key\n                  );\n\n                  if (analysisResult) {\n                    // Extract and store keywords from transcript with sentiment\n                    if (transcript) {\n                      const keywords = extractKeywords(transcript);\n                      await storeKeywords(keywords, webhook.user_id, analysisResult.sentiment, env.DB);\n                    }\n                    // Prioritize VAPI structured data over OpenAI analysis for appointments\n                    const finalAppointmentDate = vapiAppointmentDate || analysisResult.appointment_date;\n                    const finalAppointmentTime = vapiAppointmentTime || analysisResult.appointment_time;\n                    const finalAppointmentType = vapiAppointmentType || analysisResult.appointment_type;\n                    const finalCustomerName = vapiCustomerName || analysisResult.customer_name;\n                    const finalCustomerEmail = vapiCustomerEmail || analysisResult.customer_email;\n\n                    // Calculate appointment_datetime if both date and time are present\n                    let appointmentDatetime: number | null = null;\n                    if (finalAppointmentDate && finalAppointmentTime) {\n                      try {\n                        const dateTimeStr = `${finalAppointmentDate} ${finalAppointmentTime}`;\n                        appointmentDatetime = Math.floor(new Date(dateTimeStr).getTime() / 1000);\n                      } catch (e) {\n                        console.error('Error parsing appointment datetime:', e);\n                      }\n                    }\n\n                    // Update call with analysis results\n                    await env.DB.prepare(\n                      `UPDATE webhook_calls\n                       SET intent = ?, sentiment = ?, outcome = ?,\n                           customer_name = ?, customer_email = ?,\n                           appointment_date = ?, appointment_time = ?, appointment_datetime = ?,\n                           appointment_type = ?, appointment_notes = ?,\n                           analysis_completed = 1, analyzed_at = ?\n                       WHERE id = ?`\n                    ).bind(\n                      analysisResult.intent,\n                      analysisResult.sentiment,\n                      analysisResult.outcome,\n                      finalCustomerName,\n                      finalCustomerEmail,\n                      finalAppointmentDate,\n                      finalAppointmentTime,\n                      appointmentDatetime,\n                      finalAppointmentType,\n                      analysisResult.appointment_notes,\n                      now(),\n                      callId\n                    ).run();\n\n                    // Invalidate cache for this specific call since analysis is now complete\n                    const cache = new VoiceAICache(env.CACHE);\n                    await cache.invalidateCallCache(webhook.user_id, callId);\n\n                    // Trigger Scheduling Webhook if appointment was booked\n                    if (analysisResult.intent === 'Scheduling' && finalAppointmentDate && finalAppointmentTime) {\n                      await triggerSchedulingWebhook(env, webhook.user_id, callId);\n                    }\n                  }\n                } else if (vapiAppointmentDate && vapiAppointmentTime) {\n                  // No OpenAI API key, but we have VAPI appointment data\n                  let appointmentDatetime: number | null = null;\n                  try {\n                    const dateTimeStr = `${vapiAppointmentDate} ${vapiAppointmentTime}`;\n                    appointmentDatetime = Math.floor(new Date(dateTimeStr).getTime() / 1000);\n                  } catch (e) {\n                    console.error('Error parsing appointment datetime:', e);\n                  }\n\n                  // Update call with VAPI appointment data only\n                  await env.DB.prepare(\n                    `UPDATE webhook_calls\n                     SET customer_name = ?, customer_email = ?,\n                         appointment_date = ?, appointment_time = ?, appointment_datetime = ?,\n                         appointment_type = ?,\n                         analysis_completed = 1, analyzed_at = ?\n                     WHERE id = ?`\n                  ).bind(\n                    vapiCustomerName,\n                    vapiCustomerEmail,\n                    vapiAppointmentDate,\n                    vapiAppointmentTime,\n                    appointmentDatetime,\n                    vapiAppointmentType,\n                    now(),\n                    callId\n                  ).run();\n\n                  // Invalidate cache\n                  const cache = new VoiceAICache(env.CACHE);\n                  await cache.invalidateCallCache(webhook.user_id, callId);\n\n                  // Trigger Scheduling Webhook\n                  await triggerSchedulingWebhook(env, webhook.user_id, callId);\n                }\n\n                // Process addons (Enhanced Data, etc.)\n                await processAddonsForCall(\n                  env,\n                  webhook.user_id,\n                  callId,\n                  customer.number\n                );\n\n                // Define hasSummary once for both HubSpot and Dynamics sync\n                const hasSummary = analysis?.summary || message.summary;\n\n                // Sync to HubSpot if connected\n                try {\n                  const hubspotTokens = await env.DB.prepare(\n                    'SELECT access_token FROM hubspot_oauth_tokens WHERE user_id = ? AND workspace_id = ?'\n                  ).bind(webhook.user_id, wsSettings?.workspace_id).first() as any;\n\n                  if (hubspotTokens && customer.number && hasSummary) {\n                    console.log('[HubSpot] Syncing call to HubSpot...');\n\n                    // Extract conversation from artifact messages\n                    const messages = artifact?.messages || [];\n                    const conversation = messages\n                      .filter((msg: any) => msg.role === 'user' || msg.role === 'bot' || msg.role === 'assistant')\n                      .map((msg: any) => ({\n                        role: msg.role === 'bot' ? 'assistant' : msg.role,\n                        message: msg.message || msg.content || '',\n                      }));\n\n                    // Extract structured outputs (VAPI format)\n                    const structuredOutputs = analysis?.structuredOutputs || artifact?.structuredOutputs || null;\n\n                    await syncCallToHubSpot(\n                      env.DB,\n                      webhook.user_id,\n                      wsSettings?.workspace_id || '',\n                      callId,\n                      {\n                        phoneNumber: customer.number,\n                        summary: analysis?.summary || message.summary || '',\n                        structuredData: analysis?.structuredData || {},\n                        conversation,\n                        structuredOutputs,\n                      },\n                      env\n                    );\n                  } else {\n                    console.log('[HubSpot] Skipping sync - missing required data:', {\n                      hasTokens: !!hubspotTokens,\n                      hasPhone: !!customer.number,\n                      hasSummary,\n                    });\n                  }\n                } catch (hubspotError) {\n                  console.error('[HubSpot] Sync error:', hubspotError);\n                  // Don't fail the webhook if HubSpot sync fails\n                }\n\n                // ============================================\n                // DYNAMICS 365 SYNC\n                // ============================================\n                try {\n                  console.log('[Dynamics 365] Starting sync check...', {\n                    workspaceId: wsSettings?.workspace_id,\n                    customerNumber: customer.number,\n                    hasSummary,\n                  });\n\n                  // Check if Dynamics 365 is connected\n                  const dynamicsSettings = await env.DB.prepare(\n                    'SELECT dynamics_access_token, dynamics_refresh_token, dynamics_token_expires_at, dynamics_instance_url FROM workspace_settings WHERE workspace_id = ?'\n                  ).bind(wsSettings?.workspace_id || '').first();\n\n                  console.log('[Dynamics 365] Settings check:', {\n                    hasSettings: !!dynamicsSettings,\n                    hasAccessToken: !!(dynamicsSettings && dynamicsSettings.dynamics_access_token),\n                    hasRefreshToken: !!(dynamicsSettings && dynamicsSettings.dynamics_refresh_token),\n                  });\n\n                  const hasDynamicsTokens = dynamicsSettings && dynamicsSettings.dynamics_access_token && dynamicsSettings.dynamics_refresh_token;\n\n                  if (hasDynamicsTokens && customer.number && hasSummary) {\n                    console.log('[Dynamics 365] All checks passed, syncing call to Dynamics 365...');\n\n                    // Parse appointment data if available\n                    let appointmentData = null;\n                    const structuredOutputs = analysis?.structuredOutputs || artifact?.structuredOutputs || null;\n\n                    if (structuredOutputs && typeof structuredOutputs === 'object') {\n                      // Check for appointment in various possible locations\n                      const appointment =\n                        structuredOutputs.appointment ||\n                        structuredOutputs.scheduled_appointment ||\n                        structuredOutputs.appointmentDetails;\n\n                      if (appointment && appointment.date && appointment.time) {\n                        appointmentData = {\n                          date: appointment.date,\n                          time: appointment.time,\n                          type: appointment.type || appointment.appointmentType || 'Call',\n                          notes: appointment.notes || appointment.description || '',\n                          duration: appointment.duration || 60, // Default 60 minutes\n                        };\n                      }\n                    }\n\n                    await syncCallToDynamics(\n                      env.DB,\n                      wsSettings?.workspace_id || '',\n                      callId,\n                      {\n                        phoneNumber: customer.number,\n                        duration: Math.floor(call.duration || 0),\n                        summary: analysis?.summary || message.summary || '',\n                        callType: call.type === 'outboundPhoneCall' ? 'outbound' : 'inbound',\n                        callStartTime: call.startedAt || new Date().toISOString(),\n                        appointmentData,\n                      },\n                      env\n                    );\n                  } else {\n                    console.log('[Dynamics 365] Skipping sync - missing required data:', {\n                      hasTokens: !!hasDynamicsTokens,\n                      hasPhone: !!customer.number,\n                      hasSummary,\n                    });\n                  }\n                } catch (dynamicsError) {\n                  console.error('[Dynamics 365] Sync error:', dynamicsError);\n                  // Don't fail the webhook if Dynamics sync fails\n                }\n              } catch (error) {\n                console.error('Background processing error:', error);\n              }\n            })()\n          );\n\n          return jsonResponse({\n            received: true,\n            call_id: callId\n          });\n\n        } catch (error: any) {\n          // Log error\n          await env.DB.prepare(\n            'INSERT INTO webhook_logs (id, webhook_id, status, http_status, error_message, created_at) VALUES (?, ?, ?, ?, ?, ?)'\n          ).bind(\n            generateId(),\n            webhookId,\n            'error',\n            500,\n            error.message || 'Database error',\n            timestamp\n          ).run();\n\n          return jsonResponse({ error: 'Failed to store call data' }, 500);\n        }\n      }\n\n      // Default 404\n      return jsonResponse({ error: 'Not found' }, 404);\n\n    } catch (error: any) {\n      console.error('Worker error:', error);\n      return jsonResponse({ error: error.message || 'Internal server error' }, 500);\n    }\n  },\n\n  /**\n   * Scheduled handler for cleanup jobs\n   * Runs every 6 hours to clean up stale active calls\n   */\n  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext): Promise<void> {\n    console.log('[Scheduled] Running cleanup job at:', new Date(event.scheduledTime).toISOString());\n\n    try {\n      // Clean up active calls older than 24 hours\n      const twentyFourHoursAgo = Math.floor(Date.now() / 1000) - (24 * 60 * 60);\n\n      const result = await env.DB.prepare(\n        `DELETE FROM active_calls WHERE updated_at < ?`\n      ).bind(twentyFourHoursAgo).run();\n\n      console.log('[Scheduled] Cleanup complete:', {\n        deletedCalls: result.meta.changes,\n        threshold: new Date(twentyFourHoursAgo * 1000).toISOString()\n      });\n    } catch (error) {\n      console.error('[Scheduled] Cleanup job failed:', error);\n    }\n  },\n};\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/workers/index.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"/Users/benjiemalinao/.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"/Users/benjiemalinao/.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/workers/index.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/.wrangler/tmp/bundle-0Xm69E/middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"/Users/benjiemalinao/.nvm/versions/node/v22.12.0/lib/node_modules/wrangler/templates/middleware/common.ts\";\nimport type { WorkerEntrypointConstructor } from \"/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/.wrangler/tmp/bundle-0Xm69E/middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"/Users/benjiemalinao/Documents/WORKING PROTOTYPE/Voice AI Performance & Config Dashboard/.wrangler/tmp/bundle-0Xm69E/middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": ";;;;AAKO,SAAS,aAAqB;AACnC,SAAO,OAAO,WAAW;AAC3B;AAFgB;AAOhB,eAAsB,aAAa,UAAmC;AACpE,QAAM,UAAU,IAAI,YAAY;AAChC,QAAM,OAAO,QAAQ,OAAO,QAAQ;AACpC,QAAM,OAAO,MAAM,OAAO,OAAO,OAAO,WAAW,IAAI;AACvD,SAAO,MAAM,KAAK,IAAI,WAAW,IAAI,CAAC,EACnC,IAAI,OAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EACxC,KAAK,EAAE;AACZ;AAPsB;AAYtB,eAAsB,eAAe,UAAkB,MAAgC;AACrF,QAAM,eAAe,MAAM,aAAa,QAAQ;AAChD,SAAO,iBAAiB;AAC1B;AAHsB;AAStB,eAAsB,cAAc,QAAgB,QAAiC;AACnF,QAAM,SAAS;AAAA,IACb,KAAK;AAAA,IACL,KAAK;AAAA,EACP;AAEA,QAAM,UAAU;AAAA,IACd;AAAA,IACA,KAAK,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,IACjC,KAAK,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAK,IAAI,KAAK,KAAK;AAAA;AAAA,EACtD;AAEA,QAAM,gBAAgB,KAAK,KAAK,UAAU,MAAM,CAAC;AACjD,QAAM,iBAAiB,KAAK,KAAK,UAAU,OAAO,CAAC;AACnD,QAAM,OAAO,GAAG,aAAa,IAAI,cAAc;AAG/C,QAAM,UAAU,IAAI,YAAY;AAChC,QAAM,MAAM,MAAM,OAAO,OAAO;AAAA,IAC9B;AAAA,IACA,QAAQ,OAAO,MAAM;AAAA,IACrB,EAAE,MAAM,QAAQ,MAAM,UAAU;AAAA,IAChC;AAAA,IACA,CAAC,MAAM;AAAA,EACT;AAEA,QAAM,YAAY,MAAM,OAAO,OAAO;AAAA,IACpC;AAAA,IACA;AAAA,IACA,QAAQ,OAAO,IAAI;AAAA,EACrB;AAEA,QAAM,mBAAmB,KAAK,OAAO,aAAa,GAAG,IAAI,WAAW,SAAS,CAAC,CAAC;AAC/E,SAAO,GAAG,IAAI,IAAI,gBAAgB;AACpC;AAlCsB;AAuCtB,eAAsB,YAAY,OAAe,QAAoD;AACnG,MAAI;AACF,UAAM,QAAQ,MAAM,MAAM,GAAG;AAC7B,QAAI,MAAM,WAAW,EAAG,QAAO;AAE/B,UAAM,CAAC,eAAe,gBAAgB,gBAAgB,IAAI;AAC1D,UAAM,OAAO,GAAG,aAAa,IAAI,cAAc;AAG/C,UAAM,UAAU,IAAI,YAAY;AAChC,UAAM,MAAM,MAAM,OAAO,OAAO;AAAA,MAC9B;AAAA,MACA,QAAQ,OAAO,MAAM;AAAA,MACrB,EAAE,MAAM,QAAQ,MAAM,UAAU;AAAA,MAChC;AAAA,MACA,CAAC,QAAQ;AAAA,IACX;AAEA,UAAM,YAAY,WAAW,KAAK,KAAK,gBAAgB,GAAG,OAAK,EAAE,WAAW,CAAC,CAAC;AAC9E,UAAM,QAAQ,MAAM,OAAO,OAAO;AAAA,MAChC;AAAA,MACA;AAAA,MACA;AAAA,MACA,QAAQ,OAAO,IAAI;AAAA,IACrB;AAEA,QAAI,CAAC,MAAO,QAAO;AAGnB,UAAM,UAAU,KAAK,MAAM,KAAK,cAAc,CAAC;AAG/C,QAAI,QAAQ,OAAO,QAAQ,MAAM,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,GAAG;AAC9D,aAAO;AAAA,IACT;AAEA,WAAO,EAAE,QAAQ,QAAQ,OAAO;AAAA,EAClC,SAAS,OAAO;AACd,WAAO;AAAA,EACT;AACF;AAxCsB;AA0If,SAAS,eAAuB;AACrC,QAAM,QAAQ,IAAI,WAAW,EAAE;AAC/B,SAAO,gBAAgB,KAAK;AAC5B,SAAO,MAAM,KAAK,KAAK,EACpB,IAAI,OAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EACxC,KAAK,EAAE;AACZ;AANgB;AAaT,SAAS,4BAAoC;AAClD,QAAM,QAAQ;AAAA,IACZ;AAAA,IAAS;AAAA,IAAU;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAW;AAAA,IAAS;AAAA,IAAS;AAAA,IACjE;AAAA,IAAS;AAAA,IAAS;AAAA,IAAS;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAS;AAAA,IAC9D;AAAA,IAAS;AAAA,IAAW;AAAA,IAAW;AAAA,IAAU;AAAA,IAAS;AAAA,IAAS;AAAA,IAAU;AAAA,EACvE;AAEA,QAAM,eAAe;AAGrB,QAAM,QAAQ,MAAM,KAAK,MAAM,KAAK,OAAO,IAAI,MAAM,MAAM,CAAC;AAC5D,QAAM,QAAQ,MAAM,KAAK,MAAM,KAAK,OAAO,IAAI,MAAM,MAAM,CAAC;AAC5D,QAAM,QAAQ,MAAM,KAAK,MAAM,KAAK,OAAO,IAAI,MAAM,MAAM,CAAC;AAG5D,QAAM,SAAS,KAAK,MAAM,KAAK,OAAO,IAAI,GAAG,EAAE,SAAS,EAAE,SAAS,GAAG,GAAG;AAGzE,QAAM,UAAU,aAAa,KAAK,MAAM,KAAK,OAAO,IAAI,aAAa,MAAM,CAAC;AAE5E,SAAO,GAAG,KAAK,IAAI,KAAK,IAAI,KAAK,IAAI,MAAM,GAAG,OAAO;AACvD;AArBgB;;;AC9MT,IAAM,eAAN,MAAmB;AAAA,EAjB1B,OAiB0B;AAAA;AAAA;AAAA,EAChB;AAAA,EACA;AAAA,EAER,YAAY,IAAiB,aAAqB,KAAK;AACrD,SAAK,KAAK;AACV,SAAK,aAAa;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKQ,iBAAiB,QAAgB,OAAe,GAAG,QAAgB,IAAY;AACrF,WAAO,mBAAmB,MAAM,SAAS,IAAI,UAAU,KAAK;AAAA,EAC9D;AAAA;AAAA;AAAA;AAAA,EAKQ,WAAW,QAAgB,QAAwB;AACzD,WAAO,mBAAmB,MAAM,SAAS,MAAM;AAAA,EACjD;AAAA;AAAA;AAAA;AAAA,EAKQ,aAAa,QAAgB,QAAwB;AAC3D,WAAO,eAAe,MAAM,aAAa,MAAM;AAAA,EACjD;AAAA;AAAA;AAAA;AAAA,EAKQ,oBAAoB,QAAwB;AAClD,WAAO,eAAe,MAAM;AAAA,EAC9B;AAAA;AAAA;AAAA;AAAA,EAKQ,mBAAmB,QAAgB,QAAwB;AACjE,WAAO,iBAAiB,MAAM,SAAS,MAAM;AAAA,EAC/C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,IAAO,KAAgC;AAC3C,QAAI;AACF,YAAM,SAAS,MAAM,KAAK,GAAG,IAAI,KAAK,MAAM;AAE5C,UAAI,CAAC,QAAQ;AACX,eAAO;AAAA,MACT;AAGA,YAAMA,OAAM,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACxC,UAAI,OAAO,YAAY,OAAO,MAAMA,MAAK;AAEvC,cAAM,KAAK,GAAG,OAAO,GAAG;AACxB,eAAO;AAAA,MACT;AAEA,aAAO,OAAO;AAAA,IAChB,SAAS,OAAO;AACd,cAAQ,MAAM,oBAAoB,KAAK;AACvC,aAAO;AAAA,IACT;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,IAAO,KAAa,MAAS,UAAwB,CAAC,GAAkB;AAC5E,QAAI;AACF,YAAM,MAAM,QAAQ,OAAO,KAAK;AAChC,YAAM,QAAuB;AAAA,QAC3B;AAAA,QACA,WAAW,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,QACvC;AAAA,QACA,MAAM,QAAQ;AAAA,MAChB;AAEA,YAAM,KAAK,GAAG,IAAI,KAAK,KAAK,UAAU,KAAK,GAAG;AAAA,QAC5C,eAAe;AAAA,MACjB,CAAC;AAAA,IACH,SAAS,OAAO;AACd,cAAQ,MAAM,oBAAoB,KAAK;AAAA,IACzC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,OAAO,KAA4B;AACvC,QAAI;AACF,YAAM,KAAK,GAAG,OAAO,GAAG;AAAA,IAC1B,SAAS,OAAO;AACd,cAAQ,MAAM,uBAAuB,KAAK;AAAA,IAC5C;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,oBAAoB,QAA+B;AACvD,QAAI;AAEF,YAAM,OAAO,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,mBAAmB,MAAM,IAAI,CAAC;AACxE,YAAM,aAAa,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,eAAe,MAAM,IAAI,CAAC;AAC1E,YAAM,eAAe,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,iBAAiB,MAAM,IAAI,CAAC;AAG9E,YAAM,eAAe;AAAA,QACnB,GAAG,KAAK,KAAK,IAAI,OAAK,EAAE,IAAI;AAAA,QAC5B,GAAG,WAAW,KAAK,IAAI,OAAK,EAAE,IAAI;AAAA,QAClC,GAAG,aAAa,KAAK,IAAI,OAAK,EAAE,IAAI;AAAA,MACtC;AAEA,YAAM,QAAQ,IAAI,aAAa,IAAI,SAAO,KAAK,GAAG,OAAO,GAAG,CAAC,CAAC;AAAA,IAChE,SAAS,OAAO;AACd,cAAQ,MAAM,6BAA6B,KAAK;AAAA,IAClD;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBACJ,QACA,YACA,OAAe,GACf,QAAgB,IAChB,MAAc,KACC;AACf,UAAM,MAAM,KAAK,iBAAiB,QAAQ,MAAM,KAAK;AACrD,UAAM,KAAK,IAAI,KAAK,YAAY,EAAE,IAAI,CAAC;AAAA,EACzC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,oBAAoB,QAAgB,OAAe,GAAG,QAAgB,IAA2B;AACrG,UAAM,MAAM,KAAK,iBAAiB,QAAQ,MAAM,KAAK;AACrD,WAAO,MAAM,KAAK,IAAW,GAAG;AAAA,EAClC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,UAAU,QAAgB,QAAgB,UAAe,MAAc,KAAoB;AAC/F,UAAM,MAAM,KAAK,WAAW,QAAQ,MAAM;AAC1C,UAAM,KAAK,IAAI,KAAK,UAAU,EAAE,IAAI,CAAC;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,cAAc,QAAgB,QAAqC;AACvE,UAAM,MAAM,KAAK,WAAW,QAAQ,MAAM;AAC1C,WAAO,MAAM,KAAK,IAAS,GAAG;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,oBAAoB,QAAgB,QAAgB,YAAiB,MAAc,KAAoB;AAC3G,UAAM,MAAM,KAAK,aAAa,QAAQ,MAAM;AAC5C,UAAM,KAAK,IAAI,KAAK,YAAY,EAAE,IAAI,CAAC;AAAA,EACzC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,wBAAwB,QAAgB,QAAqC;AACjF,UAAM,MAAM,KAAK,aAAa,QAAQ,MAAM;AAC5C,WAAO,MAAM,KAAK,IAAS,GAAG;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,mBAAmB,QAAgB,aAAkB,MAAc,KAAoB;AAC3F,UAAM,MAAM,KAAK,oBAAoB,MAAM;AAC3C,UAAM,KAAK,IAAI,KAAK,aAAa,EAAE,IAAI,CAAC;AAAA,EAC1C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,uBAAuB,QAAqC;AAChE,UAAM,MAAM,KAAK,oBAAoB,MAAM;AAC3C,WAAO,MAAM,KAAK,IAAS,GAAG;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,kBAAkB,QAAgB,QAAgB,cAAmB,MAAc,MAAqB;AAC5G,UAAM,MAAM,KAAK,mBAAmB,QAAQ,MAAM;AAClD,UAAM,KAAK,IAAI,KAAK,cAAc,EAAE,IAAI,CAAC;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,sBAAsB,QAAgB,QAAqC;AAC/E,UAAM,MAAM,KAAK,mBAAmB,QAAQ,MAAM;AAClD,WAAO,MAAM,KAAK,IAAS,GAAG;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,oBAAoB,QAAgB,QAA+B;AACvE,UAAM,QAAQ,IAAI;AAAA,MAChB,KAAK,OAAO,KAAK,WAAW,QAAQ,MAAM,CAAC;AAAA,MAC3C,KAAK,OAAO,KAAK,aAAa,QAAQ,MAAM,CAAC;AAAA,MAC7C,KAAK,OAAO,KAAK,mBAAmB,QAAQ,MAAM,CAAC;AAAA,IACrD,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,gBAKH;AACD,QAAI;AACF,YAAM,iBAAiB,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,cAAc,CAAC;AACnE,YAAM,aAAa,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,UAAU,CAAC;AAC3D,YAAM,eAAe,MAAM,KAAK,GAAG,KAAK,EAAE,QAAQ,YAAY,CAAC;AAE/D,aAAO;AAAA,QACL,WAAW,eAAe,KAAK,SAAS,WAAW,KAAK,SAAS,aAAa,KAAK;AAAA,QACnF,gBAAgB,eAAe,KAAK;AAAA,QACpC,YAAY,WAAW,KAAK;AAAA,QAC5B,cAAc,aAAa,KAAK;AAAA,MAClC;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,sBAAsB,KAAK;AACzC,aAAO;AAAA,QACL,WAAW;AAAA,QACX,gBAAgB;AAAA,QAChB,YAAY;AAAA,QACZ,cAAc;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AACF;AAKO,IAAM,YAAY;AAAA,EACvB,YAAY;AAAA;AAAA,EACZ,cAAc;AAAA;AAAA,EACd,iBAAiB;AAAA;AAAA,EACjB,gBAAgB;AAAA;AAAA,EAChB,eAAe;AAAA;AACjB;;;AClQA,IAAM,qBAAqB;AAG3B,IAAM,mBAAmB;AACzB,IAAM,oBAAoB;AAUnB,SAAS,aAAa,aAAqB,KAAkB;AAClE,QAAM,SAAS;AAAA,IACb;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,IACA;AAAA;AAAA,EACF;AAEA,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW,IAAI;AAAA,IACf,cAAc;AAAA,IACd,OAAO,OAAO,KAAK,GAAG;AAAA,IACtB,OAAO;AAAA;AAAA,EACT,CAAC;AAED,SAAO,GAAG,gBAAgB,IAAI,OAAO,SAAS,CAAC;AACjD;AAhBgB;AAsBhB,eAAsB,qBAAqB,MAAc,KAItD;AACD,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,YAAY;AAAA,IACZ;AAAA,IACA,WAAW,IAAI;AAAA,IACf,eAAe,IAAI;AAAA,IACnB,cAAc;AAAA,EAChB,CAAC;AAED,QAAM,WAAW,MAAM,MAAM,mBAAmB;AAAA,IAC9C,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,OAAO,SAAS;AAAA,EACxB,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,UAAM,IAAI,MAAM,wCAAwC,KAAK,EAAE;AAAA,EACjE;AAEA,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO;AAAA,IACL,cAAc,KAAK;AAAA,IACnB,eAAe,KAAK;AAAA,IACpB,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI,KAAK;AAAA,EACnD;AACF;AAhCsB;AAsCtB,eAAsB,mBAAmB,cAAsB,KAG5D;AACD,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,YAAY;AAAA,IACZ,eAAe;AAAA,IACf,WAAW,IAAI;AAAA,IACf,eAAe,IAAI;AAAA,EACrB,CAAC;AAED,QAAM,WAAW,MAAM,MAAM,mBAAmB;AAAA,IAC9C,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,OAAO,SAAS;AAAA,EACxB,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,UAAM,IAAI,MAAM,iCAAiC,KAAK,EAAE;AAAA,EAC1D;AAEA,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO;AAAA,IACL,cAAc,KAAK;AAAA,IACnB,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI,KAAK;AAAA,EACnD;AACF;AA7BsB;AAkCtB,eAAsB,iBACpB,IACA,QACA,aACA,KACiB;AAEjB,QAAM,QAAQ,MAAM,GAAG;AAAA,IACrB;AAAA,EACF,EAAE,KAAK,QAAQ,WAAW,EAAE,MAAM;AAElC,MAAI,CAAC,SAAS,CAAC,MAAM,eAAe;AAClC,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACvD;AAEA,QAAMC,OAAM,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACxC,QAAM,YAAY,MAAM,cAAc;AAGtC,MAAIA,QAAO,YAAY,KAAK;AAC1B,YAAQ,IAAI,+CAA+C;AAC3D,UAAM,YAAY,MAAM,mBAAmB,MAAM,eAAe,GAAG;AAGnE,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,UAAU;AAAA,MACV,UAAU;AAAA,MACV,KAAK,IAAI;AAAA,MACT;AAAA,MACA;AAAA,IACF,EAAE,IAAI;AAEN,WAAO,UAAU;AAAA,EACnB;AAEA,SAAO,MAAM;AACf;AAtCsB;AAgDtB,eAAsB,qBACpB,aACA,aACiD;AAEjD,QAAM,aAAa,YAAY,QAAQ,OAAO,EAAE;AAChD,QAAM,SAAS,WAAW,UAAU,KAAK,WAAW,MAAM,GAAG,IAAI;AAEjE,UAAQ,IAAI,kCAAkC,aAAa,iBAAiB,YAAY,cAAc,MAAM;AAG5G,QAAM,eAAe,CAAC;AACtB,MAAI,WAAW,WAAW,MAAM,WAAW,WAAW,GAAG,GAAG;AAE1D,UAAM,WAAW,OAAO,MAAM,GAAG,CAAC;AAClC,UAAM,SAAS,OAAO,MAAM,GAAG,CAAC;AAChC,UAAM,OAAO,OAAO,MAAM,GAAG,EAAE;AAC/B,iBAAa;AAAA,MACX,OAAO,QAAQ,KAAK,MAAM,IAAI,IAAI;AAAA;AAAA,MAClC,KAAK,QAAQ,GAAG,MAAM,GAAG,IAAI;AAAA;AAAA,MAC7B,IAAI,QAAQ,GAAG,MAAM,GAAG,IAAI;AAAA;AAAA,MAC5B,GAAG,QAAQ,GAAG,MAAM,GAAG,IAAI;AAAA;AAAA,MAC3B,IAAI,QAAQ,KAAK,MAAM,IAAI,IAAI;AAAA;AAAA,MAC/B,GAAG,QAAQ,IAAI,MAAM,IAAI,IAAI;AAAA;AAAA,IAC/B;AAAA,EACF,WAAW,WAAW,WAAW,IAAI;AAEnC,UAAM,WAAW,WAAW,MAAM,GAAG,CAAC;AACtC,UAAM,SAAS,WAAW,MAAM,GAAG,CAAC;AACpC,UAAM,OAAO,WAAW,MAAM,GAAG,EAAE;AACnC,iBAAa;AAAA,MACX,OAAO,QAAQ,KAAK,MAAM,IAAI,IAAI;AAAA,MAClC,IAAI,QAAQ,KAAK,MAAM,IAAI,IAAI;AAAA,MAC/B,GAAG,QAAQ,IAAI,MAAM,IAAI,IAAI;AAAA,MAC7B,GAAG,QAAQ,GAAG,MAAM,GAAG,IAAI;AAAA,IAC7B;AAAA,EACF;AAGA,QAAM,eAAe,OAAO,UAAU,GAAG,CAAC;AAC1C,UAAQ,IAAI,wDAAwD,YAAY;AAEhF,MAAI,gBAAgB;AAAA,IAClB,OAAO;AAAA,IACP,cAAc,CAAC;AAAA,IACf,YAAY,CAAC,SAAS,eAAe,aAAa,YAAY,OAAO;AAAA,IACrE,OAAO;AAAA;AAAA,EACT;AAEA,MAAI,WAAW,MAAM,MAAM,yDAAyD;AAAA,IAClF,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,KAAK,UAAU,aAAa;AAAA,EACpC,CAAC;AAED,MAAI,SAAS,IAAI;AACf,UAAM,OAAO,MAAM,SAAS,KAAK;AACjC,YAAQ,IAAI,gCAAgC,KAAK,SAAS,UAAU,CAAC,UAAU;AAE/E,QAAI,KAAK,WAAW,KAAK,QAAQ,SAAS,GAAG;AAE3C,iBAAW,WAAW,KAAK,SAAS;AAClC,cAAM,eAAe,QAAQ,WAAW,SAAS;AACjD,cAAM,gBAAgB,QAAQ,WAAW,eAAe;AACxD,cAAM,oBAAoB,aAAa,QAAQ,OAAO,EAAE;AACxD,cAAM,qBAAqB,cAAc,QAAQ,OAAO,EAAE;AAE1D,gBAAQ,IAAI,+BAA+B,QAAQ,IAAI,YAAY,cAAc,aAAa,aAAa;AAG3G,YAAI,kBAAkB,MAAM,GAAG,MAAM,UAAU,mBAAmB,MAAM,GAAG,MAAM,QAAQ;AACvF,kBAAQ,IAAI,2CAA2C,QAAQ,EAAE;AACjE,iBAAO;AAAA,YACL,KAAK,SAAS,QAAQ,EAAE;AAAA,YACxB,OAAO,gBAAgB;AAAA,UACzB;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAGA,UAAQ,IAAI,oEAAoE,MAAM;AAEtF,kBAAgB;AAAA,IACd,cAAc;AAAA,MACZ;AAAA,QACE,SAAS,CAAC,EAAE,cAAc,SAAS,UAAU,kBAAkB,OAAO,OAAO,CAAC;AAAA,MAChF;AAAA,MACA;AAAA,QACE,SAAS,CAAC,EAAE,cAAc,eAAe,UAAU,kBAAkB,OAAO,OAAO,CAAC;AAAA,MACtF;AAAA,IACF;AAAA,IACA,YAAY,CAAC,SAAS,eAAe,aAAa,YAAY,OAAO;AAAA,IACrE,OAAO;AAAA,EACT;AAEA,aAAW,MAAM,MAAM,yDAAyD;AAAA,IAC9E,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,KAAK,UAAU,aAAa;AAAA,EACpC,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,YAAQ,MAAM,oCAAoC,KAAK;AACvD,UAAM,IAAI,MAAM,kCAAkC,KAAK,EAAE;AAAA,EAC3D;AAEA,MAAI,QAAQ,MAAM,SAAS,KAAK;AAChC,UAAQ,IAAI,6CAA6C,KAAK,UAAU,KAAK,CAAC;AAG9E,MAAI,MAAM,WAAW,MAAM,QAAQ,SAAS,GAAG;AAC7C,YAAQ,IAAI,mBAAmB,MAAM,QAAQ,MAAM,wCAAwC;AAE3F,eAAW,WAAW,MAAM,SAAS;AACnC,YAAM,eAAe,QAAQ,WAAW,SAAS;AACjD,YAAM,gBAAgB,QAAQ,WAAW,eAAe;AACxD,YAAM,oBAAoB,aAAa,QAAQ,OAAO,EAAE;AACxD,YAAM,qBAAqB,cAAc,QAAQ,OAAO,EAAE;AAE1D,cAAQ,IAAI,uBAAuB,QAAQ,IAAI,YAAY,cAAc,aAAa,aAAa;AACnG,cAAQ,IAAI,2CAA2C,mBAAmB,qBAAqB,oBAAoB,yBAAyB,MAAM;AAGlJ,YAAM,qBAAqB,kBAAkB,MAAM,GAAG;AACtD,YAAM,sBAAsB,mBAAmB,MAAM,GAAG;AAExD,cAAQ,IAAI,iDAAiD,oBAAoB,qBAAqB,qBAAqB,aAAa,MAAM;AAE9I,UAAI,uBAAuB,UAAU,wBAAwB,QAAQ;AACnE,gBAAQ,IAAI,qCAAqC,QAAQ,EAAE,EAAE;AAC7D,eAAO;AAAA,UACL,KAAK,SAAS,QAAQ,EAAE;AAAA,UACxB,OAAO,gBAAgB;AAAA,QACzB;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,UAAQ,IAAI,yCAAyC,WAAW;AAChE,SAAO;AACT;AArJsB;AA+JtB,eAAsB,iBACpB,aACA,WACA,SACA,gBACA,cACA,mBACyB;AACzB,MAAI,WAAW;AAAA;AAAA,EAAwB,OAAO;AAG9C,MAAI,kBAAkB,OAAO,KAAK,cAAc,EAAE,SAAS,GAAG;AAC5D,gBAAY;AAEZ,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,cAAc,GAAG;AACzD,UAAI,UAAU,QAAQ,UAAU,UAAa,UAAU,IAAI;AAEzD,cAAM,eAAe,IAClB,QAAQ,YAAY,KAAK,EACzB,QAAQ,MAAM,GAAG,EACjB,QAAQ,SAAS,CAAC,MAAM,EAAE,YAAY,CAAC,EACvC,KAAK;AAGR,YAAI,iBAAiB;AACrB,YAAI,OAAO,UAAU,UAAU;AAC7B,2BAAiB,KAAK,UAAU,OAAO,MAAM,CAAC;AAAA,QAChD;AAEA,oBAAY;AAAA,MAAS,YAAY,OAAO,cAAc;AAAA,MACxD;AAAA,IACF;AAAA,EACF;AAGA,MAAI,qBAAqB,OAAO,KAAK,iBAAiB,EAAE,SAAS,GAAG;AAClE,gBAAY;AAEZ,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,iBAAiB,GAAG;AAC5D,UAAI,UAAU,QAAQ,UAAU,QAAW;AAEzC,YAAI,YAAY;AAChB,YAAI,aAAa;AAEjB,YAAI,OAAO,UAAU,YAAY,UAAU,MAAM;AAE/C,cAAI,UAAU,SAAS,YAAY,OAAO;AACxC,wBAAY,MAAM;AAClB,yBAAa,MAAM;AAAA,UACrB,OAAO;AACL,yBAAa,KAAK,UAAU,OAAO,MAAM,CAAC;AAAA,UAC5C;AAAA,QACF;AAGA,YAAI,eAAe;AACnB,YAAI,OAAO,eAAe,WAAW;AACnC,yBAAe,aAAa,QAAQ;AAAA,QACtC,WAAW,OAAO,eAAe,UAAU;AACzC,yBAAe;AAAA,QACjB,WAAW,OAAO,eAAe,UAAU;AACzC,yBAAe,WAAW,SAAS;AAAA,QACrC,OAAO;AACL,yBAAe,KAAK,UAAU,UAAU;AAAA,QAC1C;AAEA,oBAAY;AAAA,MAAS,SAAS,OAAO,YAAY;AAAA,MACnD;AAAA,IACF;AAAA,EACF;AAGA,MAAI,gBAAgB,aAAa,SAAS,GAAG;AAC3C,gBAAY;AAEZ,eAAW,QAAQ,cAAc;AAC/B,YAAM,UAAU,KAAK,SAAS,cAAc,iBAAiB;AAC7D,kBAAY;AAAA,IAAO,OAAO,OAAO,KAAK,OAAO;AAAA;AAAA,IAC/C;AAAA,EACF;AAEA,QAAM,oBAAoB;AAAA,IACxB,YAAY;AAAA,MACV,QAAQ;AAAA,MACR,MAAM;AAAA,MACN,WAAW,KAAK,IAAI;AAAA,IACtB;AAAA,IACA,cAAc;AAAA,MACZ,YAAY,CAAC,SAAS;AAAA,IACxB;AAAA,IACA,UAAU;AAAA,MACR,MAAM;AAAA,IACR;AAAA,EACF;AAEA,QAAM,WAAW,MAAM,MAAM,qDAAqD;AAAA,IAChF,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,KAAK,UAAU,iBAAiB;AAAA,EACxC,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,YAAQ,MAAM,yCAAyC,KAAK;AAC5D,UAAM,IAAI,MAAM,uCAAuC,KAAK,EAAE;AAAA,EAChE;AAEA,QAAM,SAAS,MAAM,SAAS,KAAK;AACnC,UAAQ,IAAI,iCAAiC,OAAO,WAAW,EAAE;AACjE,SAAO,EAAE,IAAI,OAAO,WAAW,GAAG;AACpC;AAjHsB;AA4HtB,eAAsB,kBACpB,IACA,QACA,aACA,QACA,UAOA,KAMC;AACD,MAAI;AAEF,UAAM,cAAc,MAAM,iBAAiB,IAAI,QAAQ,aAAa,GAAG;AAGvE,UAAM,UAAU,MAAM,qBAAqB,aAAa,SAAS,WAAW;AAE5E,QAAI,CAAC,SAAS;AAEZ,YAAM,GAAG;AAAA,QACP;AAAA,MACF,EAAE;AAAA,QACA,MAAM,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,GAAG,EAAE,CAAC;AAAA,QAC/D;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT,KAAK,IAAI;AAAA,MACX,EAAE,IAAI;AAEN,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MACT;AAAA,IACF;AAGA,UAAM,aAAa,MAAM;AAAA,MACvB;AAAA,MACA,QAAQ;AAAA,MACR,SAAS;AAAA,MACT,SAAS;AAAA,MACT,SAAS;AAAA,MACT,SAAS;AAAA,IACX;AAGA,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,MAAM,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,MACA,QAAQ,IAAI,SAAS;AAAA,MACrB,WAAW,GAAG,SAAS;AAAA,MACvB;AAAA,MACA,SAAS;AAAA,MACT,KAAK,IAAI;AAAA,IACX,EAAE,IAAI;AAEN,YAAQ,IAAI,uCAAuC;AACnD,WAAO;AAAA,MACL,SAAS;AAAA,MACT,WAAW,QAAQ;AAAA,MACnB,cAAc,WAAW;AAAA,IAC3B;AAAA,EACF,SAAS,OAAY;AAEnB,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,MAAM,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,MAAM;AAAA,MACN,SAAS;AAAA,MACT,KAAK,IAAI;AAAA,IACX,EAAE,IAAI;AAEN,YAAQ,MAAM,0BAA0B,MAAM,OAAO;AACrD,WAAO;AAAA,MACL,SAAS;AAAA,MACT,OAAO,MAAM;AAAA,IACf;AAAA,EACF;AACF;AAnGsB;;;AChctB,SAAS,gBAAwB;AAC/B,SAAO,WAAW,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AACzE;AAFS;AAIT,SAAS,MAAc;AACrB,SAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACrC;AAFS;AAOT,eAAe,yBACb,KACA,cACA,QACwB;AACxB,MAAI,CAAC,aAAc,QAAO;AAE1B,MAAI;AACF,YAAQ,IAAI,yCAAyC,YAAY,EAAE;AAGnE,UAAM,WAAW,MAAM,MAAM,YAAY;AACzC,QAAI,CAAC,SAAS,IAAI;AAChB,cAAQ,MAAM,sCAAsC,SAAS,MAAM,EAAE;AACrE,aAAO;AAAA,IACT;AAGA,UAAM,QAAQ,cAAc,MAAM;AAGlC,UAAM,IAAI,WAAW,IAAI,OAAO,SAAS,MAAM;AAAA,MAC7C,cAAc;AAAA,QACZ,aAAa;AAAA,MACf;AAAA,IACF,CAAC;AAED,YAAQ,IAAI,+BAA+B,KAAK,EAAE;AAGlD,WAAO,gDAAgD,KAAK;AAAA,EAC9D,SAAS,OAAO;AACd,YAAQ,MAAM,gCAAgC,KAAK;AACnD,WAAO;AAAA,EACT;AACF;AAnCe;AAwCf,SAAS,qBACP,WACA,MAYK;AACL,QAAM,cAAc;AAAA,IAClB,OAAO;AAAA,IACP,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,IAClC,SAAS,KAAK;AAAA,IACd,gBAAgB,KAAK,iBAAiB;AAAA,IACtC,gBAAgB,KAAK,iBAAiB;AAAA,EACxC;AAEA,MAAI,cAAc,gBAAgB;AAChC,WAAO;AAAA,MACL,GAAG;AAAA,MACH,QAAQ;AAAA,IACV;AAAA,EACF;AAGA,SAAO;AAAA,IACL,GAAG;AAAA,IACH,kBAAkB,KAAK,mBAAmB;AAAA,IAC1C,cAAc,KAAK,eAAe;AAAA,IAClC,cAAc,KAAK,WAAW;AAAA,IAC9B,cAAc,KAAK,kBAAkB,CAAC;AAAA,IACtC,oBAAoB,KAAK,qBAAqB,CAAC;AAAA,IAC/C,yBAAyB,KAAK,gBAAgB,CAAC;AAAA,IAC/C,eAAe,KAAK,gBAAgB;AAAA,EACtC;AACF;AAzCS;AA8CT,SAAS,oBAAoB,UAA2D;AACtF,MAAI,CAAC,YAAY,CAAC,MAAM,QAAQ,QAAQ,EAAG,QAAO,CAAC;AAEnD,SAAO,SACJ,OAAO,CAAC,QAAa,IAAI,SAAS,UAAU,IAAI,SAAS,SAAS,IAAI,SAAS,WAAW,EAC1F,IAAI,CAAC,SAAc;AAAA,IAClB,MAAM,IAAI,SAAS,QAAQ,cAAc,IAAI;AAAA,IAC7C,SAAS,IAAI,WAAW,IAAI,WAAW;AAAA,EACzC,EAAE;AACN;AATS;AAcT,eAAe,wBACb,KACA,iBACA,SACA,WACA,QACe;AACf,QAAM,QAAQ,cAAc;AAC5B,QAAM,YAAY,IAAI;AAEtB,MAAI;AACF,YAAQ,IAAI,kCAAkC,SAAS,OAAO,gBAAgB,eAAe,EAAE;AAE/F,UAAM,WAAW,MAAM,MAAM,gBAAgB,iBAAiB;AAAA,MAC5D,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,cAAc;AAAA,MAChB;AAAA,MACA,MAAM,KAAK,UAAU,OAAO;AAAA,MAC5B,QAAQ,YAAY,QAAQ,GAAK;AAAA;AAAA,IACnC,CAAC;AAED,UAAM,eAAe,MAAM,SAAS,KAAK;AAGzC,UAAM,IAAI,GAAG;AAAA,MACX;AAAA;AAAA;AAAA,IAGF,EAAE;AAAA,MACA;AAAA,MACA,gBAAgB;AAAA,MAChB;AAAA,MACA;AAAA,MACA,SAAS,KAAK,YAAY;AAAA,MAC1B,SAAS;AAAA,MACT,aAAa,UAAU,GAAG,GAAI;AAAA;AAAA,MAC9B;AAAA,IACF,EAAE,IAAI;AAEN,YAAQ,IAAI,+BAA+B,SAAS,MAAM,KAAK,aAAa,UAAU,GAAG,GAAG,CAAC,EAAE;AAAA,EACjG,SAAS,OAAY;AACnB,YAAQ,MAAM,6BAA6B,KAAK;AAGhD,UAAM,IAAI,GAAG;AAAA,MACX;AAAA;AAAA;AAAA,IAGF,EAAE;AAAA,MACA;AAAA,MACA,gBAAgB;AAAA,MAChB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,MAAM,WAAW,OAAO,KAAK;AAAA,MAC7B;AAAA,IACF,EAAE,IAAI;AAAA,EACR;AACF;AA7De;AAkEf,eAAsB,2BACpB,KACA,QACA,WACA,UAWe;AACf,UAAQ,IAAI,sDAAsD,MAAM,YAAY,SAAS,EAAE;AAC/F,MAAI;AAEF,UAAM,WAAW,MAAM,IAAI,GAAG;AAAA,MAC5B;AAAA;AAAA,IAEF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,QAAI,CAAC,SAAS,WAAW,SAAS,QAAQ,WAAW,GAAG;AACtD,cAAQ,IAAI,kDAAkD,MAAM,EAAE;AACtE;AAAA,IACF;AAEA,YAAQ,IAAI,4BAA4B,SAAS,QAAQ,MAAM,+BAA+B,MAAM,EAAE;AAGtG,QAAI,iBAAiB,SAAS;AAC9B,QAAI,cAAc,gBAAgB,SAAS,cAAc;AACvD,YAAM,WAAW,MAAM,yBAAyB,KAAK,SAAS,cAAc,SAAS,MAAM;AAC3F,UAAI,UAAU;AACZ,yBAAiB;AACjB,gBAAQ,IAAI,iDAAiD,cAAc;AAAA,MAC7E;AAAA,IACF;AAGA,YAAQ,IAAI,wCAAwC,WAAW,iBAAiB,CAAC,CAAC,gBAAgB,aAAa,CAAC,CAAC,SAAS,eAAe,eAAe,CAAC,CAAC,SAAS,OAAO;AAG1K,QAAI;AACF,YAAM,IAAI,GAAG;AAAA,QACX;AAAA,MACF,EAAE;AAAA,QACA,SAAS,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,GAAG,EAAE,CAAC;AAAA,QAClE;AAAA,QACA;AAAA,QACA,SAAS;AAAA,QACT;AAAA,QACA,SAAS,SAAS,WAAW,iBAAiB,QAAQ,IAAI,UAAU,SAAS,iBAAiB,IAAI,YAAY,SAAS,UAAU,QAAQ,IAAI;AAAA,QAC7I,SAAS,iBAAiB;AAAA,QAC1B,KAAK,IAAI;AAAA,MACX,EAAE,IAAI;AAAA,IACR,SAAS,GAAG;AACV,cAAQ,MAAM,qCAAqC,CAAC;AAAA,IACtD;AAEA,QAAI,cAAc,gBAAgB,kBAAkB,SAAS,iBAAiB,SAAS,SAAS;AAC9F,UAAI;AAEF,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,gBAAQ,IAAI,iCAAiC,UAAU;AAGvD,cAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,UACjC;AAAA,QACF,EAAE,KAAK,QAAQ,YAAY,YAAY,EAAE,MAAM;AAE/C,gBAAQ,IAAI,6BAA6B,gBAAgB,UAAU,WAAW;AAE9E,YAAI,eAAe;AACjB,kBAAQ,IAAI,iDAAiD,cAAc;AAC3E,gBAAM;AAAA,YACJ,IAAI;AAAA,YACJ;AAAA,YACA,YAAY,gBAAgB;AAAA,YAC5B,SAAS;AAAA,YACT;AAAA,cACE,aAAa,SAAS;AAAA,cACtB,SAAS,SAAS;AAAA,cAClB,cAAc;AAAA;AAAA,YAChB;AAAA,YACA;AAAA,UACF;AAAA,QACF,OAAO;AACL,kBAAQ,IAAI,6DAA6D,MAAM;AAAA,QACjF;AAAA,MACF,SAAS,cAAc;AACrB,gBAAQ,MAAM,6CAA6C,YAAY;AAAA,MACzE;AAAA,IACF,OAAO;AACL,cAAQ,IAAI,mDAAmD;AAAA,IACjE;AAGA,eAAW,WAAW,SAAS,SAAS;AAEtC,YAAM,mBAAmB,QAAQ,QAAQ,MAAM,GAAG,KAAK,CAAC,YAAY;AACpE,UAAI,CAAC,iBAAiB,SAAS,SAAS,GAAG;AACzC,gBAAQ,IAAI,+BAA+B,QAAQ,eAAe,wBAAwB,SAAS,EAAE;AACrG;AAAA,MACF;AAGA,UAAI,eAAyD,CAAC;AAC9D,UAAI,oBAAyB,CAAC;AAE9B,UAAI,cAAc,gBAAgB,SAAS,YAAY;AACrD,cAAM,WAAW,SAAS,YAAY,SAAS,UAAU,YAAY,CAAC;AACtE,uBAAe,oBAAoB,QAAQ;AAG3C,cAAM,WAAW,SAAS,YAAY,SAAS,YAAY,CAAC;AAC5D,cAAM,WAAW,SAAS,YAAY,SAAS,YAAY,CAAC;AAC5D,4BAAoB,UAAU,qBAAqB,UAAU,qBAAqB,CAAC;AAAA,MACrF;AAGA,YAAM,UAAU,qBAAqB,WAAW;AAAA,QAC9C,GAAG;AAAA,QACH;AAAA,QACA;AAAA,QACA,cAAc;AAAA,MAChB,CAAC;AAGD,YAAM,wBAAwB,KAAK,SAAS,SAAS,WAAW,SAAS,MAAM;AAAA,IACjF;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,2DAA2D,KAAK;AAAA,EAChF;AACF;AA3IsB;;;ACvLtB,SAASC,cAAqB;AAC5B,SAAO,QAAQ,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AACtE;AAFS,OAAAA,aAAA;AAIT,SAASC,OAAc;AACrB,SAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACrC;AAFS,OAAAA,MAAA;AAIT,SAAS,aAAa,MAAW,SAAS,KAAK;AAC7C,QAAMC,eAAc;AAAA,IAClB,+BAA+B;AAAA,IAC/B,gCAAgC;AAAA,IAChC,gCAAgC;AAAA,EAClC;AAEA,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACxC;AAAA,IACA,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,GAAGA;AAAA,IACL;AAAA,EACF,CAAC;AACH;AAdS;AAoBT,eAAsB,sBAAsB,SAAkB,KAAU,QAAmC;AACzG,MAAI;AACF,UAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,UAAM,EAAE,MAAM,iBAAiB,OAAO,IAAI;AAE1C,QAAI,CAAC,QAAQ,CAAC,iBAAiB;AAC7B,aAAO,aAAa,EAAE,OAAO,iDAAiD,GAAG,GAAG;AAAA,IACtF;AAGA,QAAI;AACF,UAAI,IAAI,eAAe;AAAA,IACzB,SAAS,GAAG;AACV,aAAO,aAAa,EAAE,OAAO,0BAA0B,GAAG,GAAG;AAAA,IAC/D;AAGA,UAAM,cAAc,CAAC,gBAAgB,YAAY;AACjD,UAAM,YAAY,SAAS,OAAO,MAAM,GAAG,EAAE,IAAI,CAAC,MAAc,EAAE,KAAK,CAAC,IAAI,CAAC,YAAY;AACzF,eAAW,SAAS,WAAW;AAC7B,UAAI,CAAC,YAAY,SAAS,KAAK,GAAG;AAChC,eAAO,aAAa,EAAE,OAAO,kBAAkB,KAAK,mBAAmB,YAAY,KAAK,IAAI,CAAC,GAAG,GAAG,GAAG;AAAA,MACxG;AAAA,IACF;AAEA,UAAM,YAAYF,YAAW;AAC7B,UAAM,YAAYC,KAAI;AAEtB,UAAM,IAAI,GAAG;AAAA,MACX;AAAA;AAAA;AAAA,IAGF,EAAE;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA;AAAA,MACA,UAAU,KAAK,GAAG;AAAA,MAClB;AAAA,MACA;AAAA,IACF,EAAE,IAAI;AAEN,WAAO,aAAa;AAAA,MAClB,IAAI;AAAA,MACJ;AAAA,MACA;AAAA,MACA,WAAW;AAAA,MACX,QAAQ;AAAA,MACR,YAAY;AAAA,IACd,GAAG,GAAG;AAAA,EACR,SAAS,OAAY;AACnB,YAAQ,MAAM,yCAAyC,KAAK;AAC5D,WAAO,aAAa,EAAE,OAAO,MAAM,WAAW,oCAAoC,GAAG,GAAG;AAAA,EAC1F;AACF;AAvDsB;AA6DtB,eAAsB,qBAAqB,KAAU,QAAmC;AACtF,MAAI;AACF,UAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,MAC/B;AAAA;AAAA;AAAA;AAAA,IAIF,EAAE,KAAK,MAAM,EAAE,IAAI;AAGnB,UAAM,YAAY,WAAW,CAAC,GAAG,IAAI,CAAC,aAAkB;AAAA,MACtD,GAAG;AAAA,MACH,QAAQ,QAAQ,SAAS,QAAQ,OAAO,MAAM,GAAG,IAAI,CAAC,YAAY;AAAA,MAClE,WAAW,QAAQ,QAAQ,SAAS;AAAA,IACtC,EAAE;AAEF,WAAO,aAAa,EAAE,SAAS,CAAC;AAAA,EAClC,SAAS,OAAY;AACnB,YAAQ,MAAM,uCAAuC,KAAK;AAC1D,WAAO,aAAa,EAAE,OAAO,MAAM,WAAW,mCAAmC,GAAG,GAAG;AAAA,EACzF;AACF;AArBsB;AA2BtB,eAAsB,sBAAsB,SAAkB,KAAU,QAAgB,WAAsC;AAC5H,MAAI;AAEF,UAAM,UAAU,MAAM,IAAI,GAAG;AAAA,MAC3B;AAAA,IACF,EAAE,KAAK,SAAS,EAAE,MAAM;AAExB,QAAI,CAAC,SAAS;AACZ,aAAO,aAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,IAClE;AAEA,QAAI,QAAQ,YAAY,QAAQ;AAC9B,aAAO,aAAa,EAAE,OAAO,YAAY,GAAG,GAAG;AAAA,IACjD;AAEA,UAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,UAAM,EAAE,MAAM,iBAAiB,WAAW,OAAO,IAAI;AAGrD,UAAM,UAAoB,CAAC;AAC3B,UAAM,SAAgB,CAAC;AAEvB,QAAI,SAAS,QAAW;AACtB,cAAQ,KAAK,UAAU;AACvB,aAAO,KAAK,IAAI;AAAA,IAClB;AAEA,QAAI,oBAAoB,QAAW;AACjC,UAAI;AACF,YAAI,IAAI,eAAe;AAAA,MACzB,SAAS,GAAG;AACV,eAAO,aAAa,EAAE,OAAO,0BAA0B,GAAG,GAAG;AAAA,MAC/D;AACA,cAAQ,KAAK,qBAAqB;AAClC,aAAO,KAAK,eAAe;AAAA,IAC7B;AAEA,QAAI,cAAc,QAAW;AAC3B,cAAQ,KAAK,eAAe;AAC5B,aAAO,KAAK,YAAY,IAAI,CAAC;AAAA,IAC/B;AAEA,QAAI,WAAW,QAAW;AACxB,YAAM,cAAc,CAAC,gBAAgB,YAAY;AACjD,YAAM,YAAY,MAAM,QAAQ,MAAM,IAAI,SAAS,OAAO,MAAM,GAAG,EAAE,IAAI,CAAC,MAAc,EAAE,KAAK,CAAC;AAChG,iBAAW,SAAS,WAAW;AAC7B,YAAI,CAAC,YAAY,SAAS,KAAK,GAAG;AAChC,iBAAO,aAAa,EAAE,OAAO,kBAAkB,KAAK,GAAG,GAAG,GAAG;AAAA,QAC/D;AAAA,MACF;AACA,cAAQ,KAAK,YAAY;AACzB,aAAO,KAAK,UAAU,KAAK,GAAG,CAAC;AAAA,IACjC;AAEA,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO,aAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,IAC3D;AAEA,YAAQ,KAAK,gBAAgB;AAC7B,WAAO,KAAKA,KAAI,CAAC;AAEjB,WAAO,KAAK,SAAS;AAErB,UAAM,IAAI,GAAG;AAAA,MACX,gCAAgC,QAAQ,KAAK,IAAI,CAAC;AAAA,IACpD,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAEtB,WAAO,aAAa,EAAE,SAAS,wCAAwC,CAAC;AAAA,EAC1E,SAAS,OAAY;AACnB,YAAQ,MAAM,yCAAyC,KAAK;AAC5D,WAAO,aAAa,EAAE,OAAO,MAAM,WAAW,oCAAoC,GAAG,GAAG;AAAA,EAC1F;AACF;AAxEsB;AA8EtB,eAAsB,sBAAsB,KAAU,QAAgB,WAAsC;AAC1G,MAAI;AAEF,UAAM,UAAU,MAAM,IAAI,GAAG;AAAA,MAC3B;AAAA,IACF,EAAE,KAAK,SAAS,EAAE,MAAM;AAExB,QAAI,CAAC,SAAS;AACZ,aAAO,aAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,IAClE;AAEA,QAAI,QAAQ,YAAY,QAAQ;AAC9B,aAAO,aAAa,EAAE,OAAO,YAAY,GAAG,GAAG;AAAA,IACjD;AAEA,UAAM,IAAI,GAAG;AAAA,MACX;AAAA,IACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,WAAO,aAAa,EAAE,SAAS,wCAAwC,CAAC;AAAA,EAC1E,SAAS,OAAY;AACnB,YAAQ,MAAM,yCAAyC,KAAK;AAC5D,WAAO,aAAa,EAAE,OAAO,MAAM,WAAW,oCAAoC,GAAG,GAAG;AAAA,EAC1F;AACF;AAxBsB;AA8BtB,eAAsB,uBAAuB,KAAU,QAAgB,WAAsC;AAC3G,MAAI;AAEF,UAAM,UAAU,MAAM,IAAI,GAAG;AAAA,MAC3B;AAAA,IACF,EAAE,KAAK,SAAS,EAAE,MAAM;AAExB,QAAI,CAAC,SAAS;AACZ,aAAO,aAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,IAClE;AAEA,QAAI,QAAQ,YAAY,QAAQ;AAC9B,aAAO,aAAa,EAAE,OAAO,YAAY,GAAG,GAAG;AAAA,IACjD;AAGA,UAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,MAC/B;AAAA;AAAA;AAAA;AAAA;AAAA,IAKF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,WAAO,aAAa,EAAE,MAAM,WAAW,CAAC,EAAE,CAAC;AAAA,EAC7C,SAAS,OAAY;AACnB,YAAQ,MAAM,2CAA2C,KAAK;AAC9D,WAAO,aAAa,EAAE,OAAO,MAAM,WAAW,6BAA6B,GAAG,GAAG;AAAA,EACnF;AACF;AA7BsB;;;ACjNtB,IAAME,sBAAqB;AAG3B,IAAM,sBAAsB;AAC5B,IAAM,uBAAuB;AAUtB,SAASC,cAAa,aAAqB,KAAkB;AAClE,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,eAAe;AAAA,IACf,WAAW,IAAI;AAAA,IACf,cAAcD;AAAA,IACd,OAAO;AAAA,IACP,OAAO;AAAA;AAAA,EACT,CAAC;AAED,SAAO,GAAG,mBAAmB,IAAI,OAAO,SAAS,CAAC;AACpD;AAVgB,OAAAC,eAAA;AAgBhB,eAAsBC,sBAAqB,MAAc,KAKtD;AACD,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,YAAY;AAAA,IACZ;AAAA,IACA,WAAW,IAAI;AAAA,IACf,eAAe,IAAI;AAAA,IACnB,cAAcF;AAAA,EAChB,CAAC;AAED,QAAM,WAAW,MAAM,MAAM,sBAAsB;AAAA,IACjD,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,OAAO,SAAS;AAAA,EACxB,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,UAAM,IAAI,MAAM,2CAA2C,KAAK,EAAE;AAAA,EACpE;AAEA,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO;AAAA,IACL,cAAc,KAAK;AAAA,IACnB,eAAe,KAAK;AAAA,IACpB,cAAc,KAAK;AAAA,IACnB,YAAY,KAAK,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI,OAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI;AAAA;AAAA,EACtG;AACF;AAlCsB,OAAAE,uBAAA;;;AC7BtB,IAAMC,sBAAqB;AAG3B,IAAM,oBAAoB;AAC1B,IAAM,qBAAqB;AAUpB,SAASC,cAAa,aAAqB,KAAU,aAA6B;AACvF,QAAM,UAAU,kBAAkB,QAAQ,YAAY,IAAI,kBAAkB;AAE5E,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW,IAAI;AAAA,IACf,eAAe;AAAA,IACf,cAAcD;AAAA,IACd,eAAe;AAAA,IACf,OAAO,GAAG,WAAW;AAAA,IACrB,OAAO,GAAG,WAAW,IAAI,WAAW;AAAA;AAAA,EACtC,CAAC;AAED,SAAO,GAAG,OAAO,IAAI,OAAO,SAAS,CAAC;AACxC;AAbgB,OAAAC,eAAA;AAmBhB,eAAsBC,sBACpB,MACA,KACA,aAKC;AACD,QAAM,WAAW,mBAAmB,QAAQ,YAAY,IAAI,kBAAkB;AAE9E,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW,IAAI;AAAA,IACf,eAAe,IAAI;AAAA,IACnB,YAAY;AAAA,IACZ;AAAA,IACA,cAAcF;AAAA,IACd,OAAO,GAAG,WAAW;AAAA,EACvB,CAAC;AAED,QAAM,WAAW,MAAM,MAAM,UAAU;AAAA,IACrC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,OAAO,SAAS;AAAA,EACxB,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,UAAM,IAAI,MAAM,6CAA6C,KAAK,EAAE;AAAA,EACtE;AAEA,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO;AAAA,IACL,cAAc,KAAK;AAAA,IACnB,eAAe,KAAK;AAAA,IACpB,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,KAAK,KAAK,cAAc;AAAA,EAClE;AACF;AAvCsB,OAAAE,uBAAA;AA6CtB,eAAsBC,oBACpB,cACA,KACA,aAIC;AACD,QAAM,WAAW,mBAAmB,QAAQ,YAAY,IAAI,kBAAkB;AAE9E,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW,IAAI;AAAA,IACf,eAAe,IAAI;AAAA,IACnB,YAAY;AAAA,IACZ,eAAe;AAAA,IACf,OAAO,GAAG,WAAW;AAAA,EACvB,CAAC;AAED,QAAM,WAAW,MAAM,MAAM,UAAU;AAAA,IACrC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,IACA,MAAM,OAAO,SAAS;AAAA,EACxB,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,UAAM,IAAI,MAAM,sCAAsC,KAAK,EAAE;AAAA,EAC/D;AAEA,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO;AAAA,IACL,cAAc,KAAK;AAAA,IACnB,YAAY,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,KAAK,KAAK,cAAc;AAAA,EAClE;AACF;AApCsB,OAAAA,qBAAA;AAyCtB,eAAsBC,kBACpB,IACA,aACA,KACuD;AAEvD,QAAM,WAAW,MAAM,GAAG;AAAA,IACxB;AAAA,EACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,MAAI,CAAC,YAAY,CAAC,SAAS,wBAAwB;AACjD,UAAM,IAAI,MAAM,+CAA+C;AAAA,EACjE;AAEA,QAAMC,OAAM,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACxC,QAAM,YAAY,SAAS,6BAA6B;AAGxD,MAAIA,QAAO,YAAY,KAAK;AAC1B,YAAQ,IAAI,oDAAoD;AAChE,UAAM,YAAY,MAAMF;AAAA,MACtB,SAAS;AAAA,MACT;AAAA,MACA,SAAS;AAAA,IACX;AAGA,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,UAAU;AAAA,MACV,UAAU;AAAA,MACV;AAAA,IACF,EAAE,IAAI;AAEN,WAAO;AAAA,MACL,aAAa,SAAS;AAAA,MACtB,aAAa,UAAU;AAAA,IACzB;AAAA,EACF;AAEA,SAAO;AAAA,IACL,aAAa,SAAS;AAAA,IACtB,aAAa,SAAS;AAAA,EACxB;AACF;AA7CsB,OAAAC,mBAAA;AAwDtB,eAAsB,cACpB,aACA,aACA,aAC0D;AAE1D,QAAM,aAAa,YAAY,QAAQ,OAAO,EAAE;AAGhD,QAAM,aAAa,gCAAgC,UAAU,+BAA+B,UAAU,8BAA8B,UAAU;AAE9I,QAAM,eAAe,MAAM;AAAA,IACzB,GAAG,WAAW,wBAAwB,UAAU;AAAA,IAChD;AAAA,MACE,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,iBAAiB,UAAU,WAAW;AAAA,QACtC,UAAU;AAAA,QACV,oBAAoB;AAAA,QACpB,iBAAiB;AAAA,MACnB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,aAAa,IAAI;AACnB,UAAM,WAAW,MAAM,aAAa,KAAK;AACzC,QAAI,SAAS,SAAS,SAAS,MAAM,SAAS,GAAG;AAC/C,cAAQ,IAAI,8BAA8B,SAAS,MAAM,CAAC,EAAE,MAAM,EAAE;AACpE,aAAO;AAAA,QACL,IAAI,SAAS,MAAM,CAAC,EAAE;AAAA,QACtB,MAAM;AAAA,MACR;AAAA,IACF;AAAA,EACF;AAGA,QAAM,gBAAgB,gCAAgC,UAAU,+BAA+B,UAAU,8BAA8B,UAAU;AAEjJ,QAAM,kBAAkB,MAAM;AAAA,IAC5B,GAAG,WAAW,2BAA2B,aAAa;AAAA,IACtD;AAAA,MACE,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,iBAAiB,UAAU,WAAW;AAAA,QACtC,UAAU;AAAA,QACV,oBAAoB;AAAA,QACpB,iBAAiB;AAAA,MACnB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,gBAAgB,IAAI;AACtB,UAAM,cAAc,MAAM,gBAAgB,KAAK;AAC/C,QAAI,YAAY,SAAS,YAAY,MAAM,SAAS,GAAG;AACrD,cAAQ,IAAI,iCAAiC,YAAY,MAAM,CAAC,EAAE,SAAS,EAAE;AAC7E,aAAO;AAAA,QACL,IAAI,YAAY,MAAM,CAAC,EAAE;AAAA,QACzB,MAAM;AAAA,MACR;AAAA,IACF;AAAA,EACF;AAEA,UAAQ,IAAI,sDAAsD,WAAW;AAC7E,SAAO;AACT;AAhEsB;AAyEtB,eAAsB,cACpB,aACA,aACA,UAMiB;AAEjB,QAAM,UAAU,SAAS,WAAW,mBAAmB,SAAS,WAAW;AAE3E,QAAM,UAAe;AAAA,IACnB,YAAY,SAAS;AAAA,IACrB;AAAA,IACA,gBAAgB;AAAA;AAAA,IAChB,aAAa,uCAAsC,oBAAI,KAAK,GAAE,eAAe,CAAC;AAAA,EAChF;AAGA,MAAI,SAAS,UAAU;AACrB,UAAM,YAAY,SAAS,SAAS,KAAK,EAAE,MAAM,GAAG;AACpD,QAAI,UAAU,WAAW,GAAG;AAC1B,cAAQ,WAAW,UAAU,CAAC;AAAA,IAChC,OAAO;AACL,cAAQ,YAAY,UAAU,MAAM,GAAG,EAAE,EAAE,KAAK,GAAG;AACnD,cAAQ,WAAW,UAAU,UAAU,SAAS,CAAC;AAAA,IACnD;AAAA,EACF,OAAO;AAEL,YAAQ,WAAW,SAAS;AAAA,EAC9B;AAGA,MAAI,SAAS,aAAa;AACxB,YAAQ,cAAc,SAAS;AAAA,EACjC;AAEA,UAAQ,IAAI,qCAAqC,OAAO;AAExD,QAAM,WAAW,MAAM,MAAM,GAAG,WAAW,wBAAwB;AAAA,IACjE,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,UAAU;AAAA,MACV,gBAAgB;AAAA,MAChB,oBAAoB;AAAA,MACpB,iBAAiB;AAAA,MACjB,UAAU;AAAA,IACZ;AAAA,IACA,MAAM,KAAK,UAAU,OAAO;AAAA,EAC9B,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,YAAY,MAAM,SAAS,KAAK;AACtC,UAAM,IAAI,MAAM,0BAA0B,SAAS,MAAM,IAAI,SAAS,EAAE;AAAA,EAC1E;AAEA,QAAM,UAAU,MAAM,SAAS,KAAK;AACpC,QAAM,SAAS,QAAQ;AAEvB,UAAQ,IAAI,6CAA6C,MAAM,EAAE;AACjE,SAAO;AACT;AAhEsB;AA0EtB,eAAsB,sBACpB,aACA,aACA,UACA,YACA,UAOiB;AACjB,QAAM,kBAAkB,KAAK,MAAM,SAAS,WAAW,EAAE;AAGzD,QAAM,iBAAiB,eAAe,SAClC,gDACA;AAEJ,QAAM,iBAAiB,eAAe,SAClC,UAAU,QAAQ,MAClB,aAAa,QAAQ;AAEzB,QAAM,kBAAkB;AAAA,IACtB,SAAS;AAAA,IACT,CAAC,cAAc,GAAG;AAAA,IAClB,aAAa,SAAS;AAAA,IACtB,uBAAuB;AAAA,IACvB,aAAa,SAAS;AAAA,IACtB,WAAW,IAAI,KAAK,IAAI,KAAK,SAAS,aAAa,EAAE,QAAQ,IAAI,SAAS,WAAW,GAAI,EAAE,YAAY;AAAA,IACvG,aAAa,kBAAkB,eAAe,QAAQ,SAAS,WAAW,EAAE;AAAA,SAAgB,SAAS,WAAW;AAAA;AAAA,EAAO,SAAS,OAAO;AAAA,IACvI,eAAe,SAAS,aAAa;AAAA,IACrC,WAAW;AAAA;AAAA,IACX,YAAY;AAAA;AAAA,EACd;AAEA,QAAM,WAAW,MAAM,MAAM,GAAG,WAAW,6BAA6B;AAAA,IACtE,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,iBAAiB,UAAU,WAAW;AAAA,MACtC,UAAU;AAAA,MACV,gBAAgB;AAAA,MAChB,oBAAoB;AAAA,MACpB,iBAAiB;AAAA,IACnB;AAAA,IACA,MAAM,KAAK,UAAU,eAAe;AAAA,EACtC,CAAC;AAED,MAAI,CAAC,SAAS,IAAI;AAChB,UAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,YAAQ,MAAM,8CAA8C,KAAK;AACjE,UAAM,IAAI,MAAM,4CAA4C,KAAK,EAAE;AAAA,EACrE;AAEA,QAAM,aAAa,SAAS,QAAQ,IAAI,gBAAgB,GAAG,MAAM,aAAa,IAAI,CAAC,KAAK;AACxF,UAAQ,IAAI,sCAAsC,UAAU;AAC5D,SAAO;AACT;AA1DsB;AAmEtB,SAAS,yBAAyB,MAAc,MAAoB;AAClE,MAAI;AAEJ,MAAI,sBAAsB,KAAK,IAAI,GAAG;AACpC,cAAU,IAAI,KAAK,IAAI;AAAA,EACzB,OAAO;AACL,cAAU,IAAI,KAAK,IAAI;AAAA,EACzB;AAEA,QAAM,YAAY,KAAK,MAAM,iCAAiC;AAC9D,MAAI,CAAC,WAAW;AACd,UAAM,IAAI,MAAM,wBAAwB,IAAI,EAAE;AAAA,EAChD;AAEA,MAAI,QAAQ,SAAS,UAAU,CAAC,CAAC;AACjC,QAAM,UAAU,SAAS,UAAU,CAAC,KAAK,GAAG;AAC5C,QAAM,OAAO,UAAU,CAAC,GAAG,YAAY;AAEvC,MAAI,SAAS,QAAQ,UAAU,IAAI;AACjC,aAAS;AAAA,EACX,WAAW,SAAS,QAAQ,UAAU,IAAI;AACxC,YAAQ;AAAA,EACV;AAEA,UAAQ,SAAS,OAAO,SAAS,GAAG,CAAC;AACrC,SAAO;AACT;AA1BS;AAgCT,eAAsB,0BACpB,aACA,aACA,UACA,YACA,iBAOA,aACwB;AACxB,MAAI;AACF,UAAM,gBAAgB;AAAA,MACpB,gBAAgB;AAAA,MAChB,gBAAgB;AAAA,IAClB;AAEA,UAAM,WAAW,gBAAgB,YAAY;AAC7C,UAAM,cAAc,IAAI,KAAK,cAAc,QAAQ,IAAI,WAAW,GAAK;AAEvE,UAAM,iBAAiB,eAAe,SAClC,kDACA;AAEJ,UAAM,iBAAiB,eAAe,SAClC,UAAU,QAAQ,MAClB,aAAa,QAAQ;AAEzB,UAAM,qBAAqB;AAAA,MACzB,SAAS,GAAG,gBAAgB,QAAQ,aAAa;AAAA,MACjD,CAAC,cAAc,GAAG;AAAA,MAClB,gBAAgB,cAAc,YAAY;AAAA,MAC1C,cAAc,YAAY,YAAY;AAAA,MACtC,aAAa;AAAA;AAAA,EAAyC,gBAAgB,QAAQ,UAAU,gBAAgB,KAAK;AAAA;AAAA,IAAS,EAAE;AAAA,EAAkB,WAAW;AAAA,MACrJ,WAAW;AAAA;AAAA,MACX,YAAY;AAAA;AAAA,IACd;AAEA,UAAM,WAAW,MAAM,MAAM,GAAG,WAAW,+BAA+B;AAAA,MACxE,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,iBAAiB,UAAU,WAAW;AAAA,QACtC,UAAU;AAAA,QACV,gBAAgB;AAAA,QAChB,oBAAoB;AAAA,QACpB,iBAAiB;AAAA,MACnB;AAAA,MACA,MAAM,KAAK,UAAU,kBAAkB;AAAA,IACzC,CAAC;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,YAAM,QAAQ,MAAM,SAAS,KAAK;AAClC,cAAQ,MAAM,+CAA+C,KAAK;AAClE,YAAM,IAAI,MAAM,6CAA6C,KAAK,EAAE;AAAA,IACtE;AAEA,UAAM,aAAa,SAAS,QAAQ,IAAI,gBAAgB,GAAG,MAAM,aAAa,IAAI,CAAC,KAAK;AACxF,YAAQ,IAAI,uCAAuC,UAAU;AAC7D,WAAO;AAAA,EACT,SAAS,OAAY;AACnB,YAAQ,MAAM,8CAA8C,MAAM,OAAO;AACzE,WAAO;AAAA,EACT;AACF;AAlEsB;AA8EtB,eAAsB,mBACpB,IACA,aACA,QACA,UAcA,KAOC;AACD,MAAI;AAEF,UAAM,EAAE,aAAa,YAAY,IAAI,MAAMA,kBAAiB,IAAI,aAAa,GAAG;AAGhF,QAAI,SAAS,MAAM,cAAc,aAAa,aAAa,SAAS,WAAW;AAC/E,QAAI,cAAc;AAElB,QAAI,CAAC,QAAQ;AAEX,cAAQ,IAAI,2DAA2D,SAAS,WAAW;AAE3F,UAAI;AACF,cAAM,YAAY,MAAM,cAAc,aAAa,aAAa;AAAA,UAC9D,aAAa,SAAS;AAAA,UACtB,SAAS,mBAAmB,SAAS,WAAW;AAAA,QAClD,CAAC;AAED,iBAAS;AAAA,UACP,IAAI;AAAA,UACJ,MAAM;AAAA,QACR;AACA,sBAAc;AAEd,gBAAQ,IAAI,oCAAoC,SAAS;AAAA,MAC3D,SAAS,aAAkB;AACzB,gBAAQ,MAAM,6CAA6C,YAAY,OAAO;AAG9E,cAAM,GAAG;AAAA,UACP;AAAA,QACF,EAAE;AAAA,UACA,OAAO,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAAA,UAC5D;AAAA,UACA;AAAA,UACA;AAAA,UACA,0BAA0B,YAAY,OAAO;AAAA,UAC7C,SAAS;AAAA,UACT,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,QAC9B,EAAE,IAAI;AAEN,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO,0BAA0B,YAAY,OAAO;AAAA,QACtD;AAAA,MACF;AAAA,IACF;AAGA,UAAM,aAAa,MAAM;AAAA,MACvB;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP,OAAO;AAAA,MACP;AAAA,IACF;AAGA,QAAI,gBAA+B;AACnC,QAAI,SAAS,iBAAiB;AAC5B,sBAAgB,MAAM;AAAA,QACpB;AAAA,QACA;AAAA,QACA,OAAO;AAAA,QACP,OAAO;AAAA,QACP,SAAS;AAAA,QACT,SAAS;AAAA,MACX;AAAA,IACF;AAGA,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,OAAO,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAAA,MAC5D;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA,gBAAgB,IAAI;AAAA,MACpB,cAAc,IAAI;AAAA,MAClB;AAAA,MACA,SAAS;AAAA,MACT,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,IAC9B,EAAE,IAAI;AAEN,YAAQ,IAAI,4CAA4C;AACxD,WAAO;AAAA,MACL,SAAS;AAAA,MACT,kBAAkB,OAAO;AAAA,MACzB,oBAAoB;AAAA,MACpB,uBAAuB,iBAAiB;AAAA,IAC1C;AAAA,EACF,SAAS,OAAY;AAEnB,UAAM,GAAG;AAAA,MACP;AAAA,IACF,EAAE;AAAA,MACA,OAAO,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,OAAO,GAAG,CAAC,CAAC;AAAA,MAC5D;AAAA,MACA;AAAA,MACA;AAAA,MACA,MAAM;AAAA,MACN,SAAS;AAAA,MACT,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAAA,IAC9B,EAAE,IAAI;AAEN,YAAQ,MAAM,+BAA+B,MAAM,OAAO;AAC1D,WAAO;AAAA,MACL,SAAS;AAAA,MACT,OAAO,MAAM;AAAA,IACf;AAAA,EACF;AACF;AA5IsB;;;AC7ZtB,IAAM,cAAc;AAAA,EAClB,+BAA+B;AAAA,EAC/B,gCAAgC;AAAA,EAChC,gCAAgC;AAClC;AAGA,SAASE,cAAa,MAAW,SAAS,KAAK;AAC7C,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACxC;AAAA,IACA,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,GAAG;AAAA,IACL;AAAA,EACF,CAAC;AACH;AARS,OAAAA,eAAA;AAWT,SAASC,OAAc;AACrB,SAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACrC;AAFS,OAAAA,MAAA;AAiBT,eAAe,sBACb,SACA,YACA,cACoC;AACpC,MAAI;AACF,UAAM,WAAW,MAAM,MAAM,8CAA8C;AAAA,MACzE,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,iBAAiB,UAAU,YAAY;AAAA,MACzC;AAAA,MACA,MAAM,KAAK,UAAU;AAAA,QACnB,OAAO;AAAA,QACP,UAAU;AAAA,UACR;AAAA,YACE,MAAM;AAAA,YACN,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAoBX;AAAA,UACA;AAAA,YACE,MAAM;AAAA,YACN,SAAS,iBAAiB,OAAO;AAAA;AAAA;AAAA,EAAyB,UAAU;AAAA,UACtE;AAAA,QACF;AAAA,QACA,aAAa;AAAA,QACb,iBAAiB,EAAE,MAAM,cAAc;AAAA,MACzC,CAAC;AAAA,IACH,CAAC;AAED,QAAI,CAAC,SAAS,IAAI;AAChB,cAAQ,MAAM,qBAAqB,MAAM,SAAS,KAAK,CAAC;AACxD,aAAO;AAAA,IACT;AAEA,UAAM,OAAO,MAAM,SAAS,KAAK;AACjC,UAAM,SAAS,KAAK,MAAM,KAAK,QAAQ,CAAC,EAAE,QAAQ,OAAO;AAEzD,WAAO;AAAA,MACL,QAAQ,OAAO,UAAU;AAAA,MACzB,WAAW,OAAO,aAAa;AAAA,MAC/B,SAAS,OAAO,WAAW;AAAA,MAC3B,eAAe,OAAO,iBAAiB;AAAA,MACvC,gBAAgB,OAAO,kBAAkB;AAAA,MACzC,kBAAkB,OAAO,oBAAoB;AAAA,MAC7C,kBAAkB,OAAO,oBAAoB;AAAA,MAC7C,kBAAkB,OAAO,oBAAoB;AAAA,MAC7C,mBAAmB,OAAO,qBAAqB;AAAA,IACjD;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,qCAAqC,KAAK;AACxD,WAAO;AAAA,EACT;AACF;AAvEe;AA0Ef,SAAS,gBAAgB,YAA8B;AACrD,MAAI,CAAC,cAAc,WAAW,KAAK,EAAE,WAAW,GAAG;AACjD,WAAO,CAAC;AAAA,EACV;AAGA,QAAM,YAAY,oBAAI,IAAI;AAAA,IACxB;AAAA,IAAK;AAAA,IAAM;AAAA,IAAM;AAAA,IAAU;AAAA,IAAM;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAa;AAAA,IAAO;AAAA,IAAQ;AAAA,IAC5E;AAAA,IAAY;AAAA,IAAc;AAAA,IAAM;AAAA,IAAO;AAAA,IAAO;AAAA,IAAW;AAAA,IAAO;AAAA,IAAO;AAAA,IACvE;AAAA,IAAW;AAAA,IAAM;AAAA,IAAO;AAAA,IAAU;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAU;AAAA,IACrE;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAS;AAAA,IAAM;AAAA,IAAM;AAAA,IAC9E;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAM;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAO;AAAA,IAAU;AAAA,IAAM;AAAA,IAC5E;AAAA,IAAO;AAAA,IAAS;AAAA,IAAK;AAAA,IAAM;AAAA,IAAO;AAAA,IAAO;AAAA,IAAO;AAAA,IAAM;AAAA,IAAM;AAAA,IAAW;AAAA,IAAM;AAAA,IAC7E;AAAA,IAAS;AAAA,IAAM;AAAA,IAAM;AAAA,IAAM;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAW;AAAA,IAAW;AAAA,IACzE;AAAA,IAAW;AAAA,IAAU;AAAA,IAAU;AAAA,IAAS;AAAA,IAAS;AAAA,IAAS;AAAA,IAAM;AAAA,IAAQ;AAAA,IAAM;AAAA,IAC9E;AAAA,IAAM;AAAA,IAAO;AAAA,IAAM;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAS;AAAA,IAAW;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAC/E;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAO;AAAA,IAAO;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAQ;AAAA,IAC9E;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAM;AAAA,IAAO;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAM;AAAA,IAC1E;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAK;AAAA,IAAK;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAU;AAAA,IAAO;AAAA,IACxE;AAAA,IAAO;AAAA,IAAQ;AAAA,IAAM;AAAA,IAAM;AAAA,IAAM;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAS;AAAA,IAAO;AAAA,IAAO;AAAA,IACxE;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAM;AAAA,IAAS;AAAA,IAAQ;AAAA,IAAO;AAAA,IAAO;AAAA,IAAO;AAAA,EAC9E,CAAC;AAGD,QAAM,QAAQ,WACX,YAAY,EACZ,QAAQ,YAAY,GAAG,EACvB,MAAM,KAAK,EACX;AAAA,IAAO,UACN,KAAK,SAAS;AAAA,IACd,CAAC,UAAU,IAAI,IAAI,KACnB,CAAC,QAAQ,KAAK,IAAI;AAAA;AAAA,EACpB;AAGF,QAAM,YAAY,oBAAI,IAAoB;AAC1C,QAAM,QAAQ,UAAQ;AACpB,cAAU,IAAI,OAAO,UAAU,IAAI,IAAI,KAAK,KAAK,CAAC;AAAA,EACpD,CAAC;AAGD,QAAM,WAAW,MAAM,KAAK,UAAU,QAAQ,CAAC,EAC5C,OAAO,CAAC,CAAC,GAAG,KAAK,MAAM,SAAS,CAAC,EACjC,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,CAAC,EAC1B,MAAM,GAAG,EAAE,EACX,IAAI,CAAC,CAAC,IAAI,MAAM,IAAI;AAEvB,SAAO;AACT;AAhDS;AAmDT,eAAe,cACb,UACA,QACA,WACA,IACe;AACf,MAAI,SAAS,WAAW,EAAG;AAE3B,QAAM,YAAY,KAAK,IAAI;AAI3B,MAAI,iBAAiB;AACrB,MAAI,cAAc,WAAY,kBAAiB;AAAA,WACtC,cAAc,WAAY,kBAAiB;AAEpD,aAAW,WAAW,UAAU;AAC9B,QAAI;AAEF,YAAM,WAAW,MAAM,GAAG;AAAA,QACxB;AAAA;AAAA,MAEF,EAAE,KAAK,QAAQ,OAAO,EAAE,MAAM;AAE9B,UAAI,UAAU;AAEZ,cAAM,mBAAmB,SAAS,kBAAkB,cAAc,aAAa,IAAI;AACnF,cAAM,kBAAkB,SAAS,iBAAiB,cAAc,YAAY,IAAI;AAChF,cAAM,mBAAmB,SAAS,kBAAkB,cAAc,aAAa,IAAI;AACnF,cAAM,gBAAgB,SAAS,QAAQ;AAGvC,cAAM,mBAAoB,SAAS,gBAAgB,SAAS,QAAS,kBAAkB;AAGvF,cAAM,GAAG;AAAA,UACP;AAAA;AAAA;AAAA;AAAA,QAIF,EAAE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,SAAS;AAAA,QACX,EAAE,IAAI;AAAA,MACR,OAAO;AAEL,cAAM,uBAAuB,cAAc,aAAa,IAAI;AAC5D,cAAM,sBAAsB,cAAc,YAAY,IAAI;AAC1D,cAAM,uBAAuB,cAAc,aAAa,IAAI;AAE5D,cAAM,GAAG;AAAA,UACP;AAAA;AAAA;AAAA;AAAA,QAIF,EAAE;AAAA,UACA,WAAW;AAAA,UACX;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF,EAAE,IAAI;AAAA,MACR;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,0BAA0B,SAAS,KAAK;AAAA,IACxD;AAAA,EACF;AACF;AA5Ee;AAsFf,eAAe,uBACb,aACA,kBACA,iBACkC;AAClC,MAAI;AAEF,UAAM,cAAc,YAAY,QAAQ,WAAW,EAAE;AAErD,UAAM,WAAW,MAAM;AAAA,MACrB,8CAA8C,mBAAmB,WAAW,CAAC;AAAA,MAC7E;AAAA,QACE,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,iBAAiB,WAAW,KAAK,GAAG,gBAAgB,IAAI,eAAe,EAAE;AAAA,QAC3E;AAAA,MACF;AAAA,IACF;AAEA,QAAI,CAAC,SAAS,IAAI;AAChB,cAAQ,MAAM,qBAAqB,SAAS,QAAQ,MAAM,SAAS,KAAK,CAAC;AACzE,aAAO;AAAA,IACT;AAEA,UAAM,OAAO,MAAM,SAAS,KAAK;AAEjC,WAAO;AAAA,MACL,YAAY,KAAK,aAAa,eAAe;AAAA,MAC7C,YAAY,KAAK,aAAa,eAAe;AAAA,MAC7C,aAAa,KAAK,wBAAwB,gBAAgB;AAAA,MAC1D,UAAU,KAAK,wBAAwB,QAAQ;AAAA,IACjD;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,wCAAwC,KAAK;AAC3D,WAAO;AAAA,EACT;AACF;AApCe;AAuCf,eAAe,yBAAyB,KAAU,QAAgB,QAA+B;AAC/F,MAAI;AAEF,UAAM,WAAW,MAAM,IAAI,GAAG;AAAA,MAC5B;AAAA,IACF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,QAAI,CAAC,SAAS,WAAW,SAAS,QAAQ,WAAW,GAAG;AACtD,cAAQ,IAAI,iDAAiD,MAAM;AACnE;AAAA,IACF;AAGA,UAAM,OAAO,MAAM,IAAI,GAAG,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAOjC,EAAE,KAAK,MAAM,EAAE,MAAM;AAEtB,QAAI,CAAC,MAAM;AACT,cAAQ,MAAM,mBAAmB,MAAM;AACvC;AAAA,IACF;AAGA,UAAM,UAAe;AAAA,MACnB,MAAM,KAAK,iBAAiB;AAAA,MAC5B,OAAO,KAAK,kBAAkB;AAAA,MAC9B,OAAO,KAAK,mBAAmB,KAAK,gBAAgB;AAAA,MACpD,oBAAoB,KAAK,gBAAgB;AAAA,MACzC,kBAAkB,KAAK;AAAA,MACvB,kBAAkB,KAAK;AAAA,MACvB,kBAAkB,KAAK,oBAAoB;AAAA,MAC3C,mBAAmB,KAAK,qBAAqB;AAAA,MAC7C,WAAW,KAAK,iBAAiB;AAAA,MACjC,cAAc,KAAK,WAAW;AAAA,MAC9B,SAAS,KAAK;AAAA,MACd,QAAQ,KAAK;AAAA,MACb,WAAW,KAAK;AAAA,MAChB,SAAS,KAAK;AAAA,IAChB;AAGA,eAAW,WAAW,SAAS,SAAS;AACtC,YAAM,cAAc;AAEpB,UAAI,YAAY,sBAAsB,KAAK,eAAe;AACxD,YAAI;AACF,kBAAQ,gBAAgB,KAAK,MAAM,KAAK,aAAa;AAAA,QACvD,SAAS,GAAG;AACV,kBAAQ,MAAM,gCAAgC,CAAC;AAAA,QACjD;AAAA,MACF;AAGA,UAAI;AACF,cAAM,WAAW,MAAM,MAAM,YAAY,iBAAiB;AAAA,UACxD,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,YAChB,kBAAkB;AAAA,YAClB,aAAa;AAAA,UACf;AAAA,UACA,MAAM,KAAK,UAAU,OAAO;AAAA,QAC9B,CAAC;AAED,cAAM,eAAe,MAAM,SAAS,KAAK;AACzC,cAAM,QAAQ,WAAW;AAGzB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA,QAGF,EAAE;AAAA,UACA;AAAA,UACA,YAAY;AAAA,UACZ;AAAA,UACA,SAAS,KAAK,YAAY;AAAA,UAC1B,SAAS;AAAA,UACT,aAAa,UAAU,GAAG,GAAI;AAAA;AAAA,UAC9B,SAAS,KAAK,OAAO,QAAQ,SAAS,MAAM,KAAK,YAAY;AAAA,UAC7D,KAAK,UAAU,OAAO;AAAA,UACtBA,KAAI;AAAA,QACN,EAAE,IAAI;AAEN,gBAAQ,IAAI,8BAA8B,YAAY,eAAe,KAAK,SAAS,MAAM,EAAE;AAAA,MAC7F,SAAS,OAAY;AACnB,cAAM,QAAQ,WAAW;AAGzB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA,QAGF,EAAE;AAAA,UACA;AAAA,UACA,YAAY;AAAA,UACZ;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,MAAM,WAAW;AAAA,UACjB,KAAK,UAAU,OAAO;AAAA,UACtBA,KAAI;AAAA,QACN,EAAE,IAAI;AAEN,gBAAQ,MAAM,qCAAqC,KAAK;AAAA,MAC1D;AAAA,IACF;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,sCAAsC,KAAK;AAAA,EAC3D;AACF;AApHe;AAuHf,eAAe,iBAAiB,SAAkB,KAAkC;AAClF,QAAM,aAAa,QAAQ,QAAQ,IAAI,eAAe;AACtD,MAAI,CAAC,cAAc,CAAC,WAAW,WAAW,SAAS,GAAG;AACpD,WAAO;AAAA,EACT;AAEA,QAAM,QAAQ,WAAW,UAAU,CAAC;AACpC,QAAM,SAAS,IAAI,cAAc;AACjC,QAAM,UAAU,MAAM,YAAY,OAAO,MAAM;AAE/C,MAAI,CAAC,SAAS;AACZ,WAAO;AAAA,EACT;AAEA,SAAO,QAAQ;AACjB;AAfe;AAmBf,eAAe,mBAAmB,KAAU,QAAmF;AAC7H,QAAM,WAAW,MAAM,IAAI,GAAG;AAAA,IAC5B;AAAA,EACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,MAAI,CAAC,YAAY,CAAC,SAAS,uBAAuB;AAChD,WAAO,EAAE,iBAAiB,QAAQ,oBAAoB,MAAM;AAAA,EAC9D;AAGA,QAAM,YAAY,MAAM,IAAI,GAAG;AAAA,IAC7B;AAAA,EACF,EAAE,KAAK,SAAS,qBAAqB,EAAE,MAAM;AAE7C,MAAI,CAAC,WAAW;AACd,WAAO,EAAE,iBAAiB,QAAQ,oBAAoB,MAAM;AAAA,EAC9D;AAGA,QAAM,UAAU,UAAU,kBAAkB;AAC5C,QAAM,aAAa,MAAM,IAAI,GAAG;AAAA,IAC9B;AAAA,EACF,EAAE,KAAK,SAAS,uBAAuB,MAAM,EAAE,MAAM;AAErD,MAAI,WAAW,YAAY;AACzB,WAAO,EAAE,iBAAiB,UAAU,eAAe,oBAAoB,KAAK;AAAA,EAC9E;AAGA,SAAO,EAAE,iBAAiB,QAAQ,oBAAoB,MAAM;AAC9D;AA9Be;AAiCf,eAAe,4BAA4B,KAAU,QAM3C;AAER,QAAM,eAAe,MAAM,IAAI,GAAG;AAAA,IAChC;AAAA,EACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,MAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AAExD,UAAM,iBAAiB,MAAM,IAAI,GAAG;AAAA,MAClC;AAAA,IACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,QAAI,gBAAgB;AAClB,YAAMC,cAAa,MAAM,IAAI,GAAG;AAAA,QAC9B;AAAA,MACF,EAAE,KAAK,eAAe,EAAE,EAAE,MAAM;AAChC,aAAOA,eAAc;AAAA,IACvB;AACA,WAAO;AAAA,EACT;AAEA,QAAM,cAAc,aAAa;AACjC,MAAI,aAAa,MAAM,IAAI,GAAG;AAAA,IAC5B;AAAA,EACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAG1B,MAAI,CAAC,cAAc,CAAC,WAAW,aAAa;AAC1C,UAAM,YAAY,MAAM,IAAI,GAAG;AAAA,MAC7B;AAAA,IACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,QAAI,WAAW;AACb,YAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,QACjC;AAAA,MACF,EAAE,KAAK,UAAU,aAAa,EAAE,MAAM;AAEtC,UAAI,iBAAiB,cAAc,aAAa;AAC9C,qBAAa;AAAA,MACf;AAAA,IACF;AAAA,EACF;AAEA,SAAO,cAAc;AACvB;AAlDe;AAqDf,eAAe,yBACb,aACc;AACd,MAAI;AACF,UAAM,WAAW,MAAM;AAAA,MACrB,8DAA8D,mBAAmB,WAAW,CAAC;AAAA,MAC7F;AAAA,QACE,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,gBAAgB;AAAA,QAClB;AAAA,MACF;AAAA,IACF;AAEA,QAAI,CAAC,SAAS,IAAI;AAChB,aAAO;AAAA,IACT;AAEA,WAAO,MAAM,SAAS,KAAK;AAAA,EAC7B,SAAS,OAAO;AACd,YAAQ,MAAM,8BAA8B,KAAK;AACjD,WAAO;AAAA,EACT;AACF;AAvBe;AA0Bf,eAAe,qBACb,KACA,QACA,QACA,eACe;AACf,MAAI,CAAC,eAAe;AAClB;AAAA,EACF;AAEA,MAAI;AAEF,UAAM,QAAQ,IAAI,aAAa,IAAI,KAAK;AAGxC,UAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,MACjC;AAAA,IACF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,QAAI,CAAC,cAAc,WAAW,cAAc,QAAQ,WAAW,GAAG;AAChE;AAAA,IACF;AAGA,eAAW,SAAS,cAAc,SAAkB;AAClD,YAAM,YAAY,KAAK,IAAI;AAC3B,UAAI,SAAS;AACb,UAAI,aAAa;AACjB,UAAI,eAA8B;AAElC,UAAI;AACF,YAAI,MAAM,eAAe,iBAAiB;AAExC,gBAAM,aAAa,MAAM,MAAM,sBAAsB,QAAQ,MAAM;AACnE,cAAI,YAAY;AACd,oBAAQ,IAAI,uCAAuC,MAAM,EAAE;AAC3D,yBAAa;AACb,qBAAS;AAAA,UACX,OAAO;AACL,oBAAQ,IAAI,wCAAwC,MAAM,EAAE;AAC5D,yBAAa,MAAM,yBAAyB,aAAa;AACzD,qBAAS,aAAa,YAAY;AAClC,gBAAI,CAAC,YAAY;AACf,6BAAe;AAAA,YACjB,OAAO;AAEL,oBAAM,MAAM,kBAAkB,QAAQ,QAAQ,YAAY,UAAU,aAAa;AAAA,YACnF;AAAA,UACF;AAAA,QACF;AAAA,MAEF,SAAS,OAAY;AACnB,uBAAe,MAAM,WAAW;AAAA,MAClC;AAEA,YAAM,gBAAgB,KAAK,IAAI,IAAI;AAGnC,YAAM,IAAI,GAAG;AAAA,QACX;AAAA;AAAA;AAAA,MAGF,EAAE;AAAA,QACA,WAAW;AAAA,QACX;AAAA,QACA;AAAA,QACA,MAAM;AAAA,QACN;AAAA,QACA,aAAa,KAAK,UAAU,UAAU,IAAI;AAAA,QAC1C;AAAA,QACA;AAAA,QACAD,KAAI;AAAA,MACN,EAAE,IAAI;AAAA,IACR;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,4BAA4B,KAAK;AAAA,EACjD;AACF;AA7Ee;AA+Ef,IAAO,kBAAQ;AAAA,EACb,MAAM,MAAM,SAAkB,KAAU,KAA0C;AAChF,UAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAG/B,QAAI,QAAQ,WAAW,WAAW;AAChC,aAAO,IAAI,SAAS,MAAM,EAAE,SAAS,YAAY,CAAC;AAAA,IACpD;AAEA,QAAI;AAMF,UAAI,IAAI,aAAa,wBAAwB,QAAQ,WAAW,QAAQ;AACtE,cAAM,EAAE,OAAO,UAAU,KAAK,IAAI,MAAM,QAAQ,KAAK;AAErD,YAAI,CAAC,SAAS,CAAC,UAAU;AACvB,iBAAOD,cAAa,EAAE,OAAO,8BAA8B,GAAG,GAAG;AAAA,QACnE;AAGA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,KAAK,EAAE,MAAM;AAEpB,YAAI,UAAU;AACZ,iBAAOA,cAAa,EAAE,OAAO,2BAA2B,GAAG,GAAG;AAAA,QAChE;AAGA,cAAM,SAAS,WAAW;AAC1B,cAAM,eAAe,MAAM,aAAa,QAAQ;AAChD,cAAM,YAAYC,KAAI;AAEtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,QAAQ,OAAO,cAAc,QAAQ,MAAM,WAAW,SAAS,EAAE,IAAI;AAG5E,cAAM,SAAS,IAAI,cAAc;AACjC,cAAM,QAAQ,MAAM,cAAc,QAAQ,MAAM;AAGhD,cAAM,YAAY,WAAW;AAC7B,cAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,cAAM,YAAY,YAAa,IAAI,KAAK,KAAK;AAE7C,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,WAAW,QAAQ,WAAW,WAAW,SAAS,EAAE,IAAI;AAG/D,cAAM,qBAAqB,MAAM,IAAI,GAAG;AAAA,UACtC;AAAA,QACF,EAAE,KAAK,OAAO,SAAS,EAAE,IAAI;AAE7B,YAAI,qBAAoC;AAExC,YAAI,mBAAmB,WAAW,mBAAmB,QAAQ,SAAS,GAAG;AAEvE,qBAAW,cAAc,mBAAmB,SAAkB;AAE5D,kBAAM,eAAe,WAAW;AAChC,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA,YACF,EAAE;AAAA,cACA;AAAA,cACA,WAAW;AAAA,cACX;AAAA,cACA,WAAW;AAAA,cACX;AAAA;AAAA,cACA;AAAA,cACA;AAAA,cACA;AAAA,cACA;AAAA,YACF,EAAE,IAAI;AAGN,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA,YACF,EAAE,KAAK,WAAW,WAAW,EAAE,EAAE,IAAI;AAGrC,gBAAI,CAAC,oBAAoB;AACvB,mCAAqB,WAAW;AAAA,YAClC;AAAA,UACF;AAAA,QACF;AAGA,YAAI,CAAC,oBAAoB;AACvB,gBAAM,cAAc,QAAQ,WAAW;AACvC,gBAAM,gBAAgB,MAAM,KAAK,KAAK,MAAM,MAAM,GAAG,EAAE,CAAC,KAAK;AAC7D,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,aAAa,eAAe,QAAQ,WAAW,SAAS,EAAE,IAAI;AACrE,+BAAqB;AAAA,QACvB;AAGA,cAAM,aAAa,WAAW;AAC9B,cAAM,iBAAiB,aAAa;AAEpC,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,YAAY,QAAQ,gBAAgB,oBAAoB,WAAW,SAAS,EAAE,IAAI;AAEzF,eAAOD,cAAa;AAAA,UAClB;AAAA,UACA,MAAM;AAAA,YACJ,IAAI;AAAA,YACJ;AAAA,YACA,MAAM,QAAQ;AAAA,UAChB;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,qBAAqB,QAAQ,WAAW,QAAQ;AACnE,cAAM,EAAE,OAAO,SAAS,IAAI,MAAM,QAAQ,KAAK;AAE/C,YAAI,CAAC,SAAS,CAAC,UAAU;AACvB,iBAAOA,cAAa,EAAE,OAAO,8BAA8B,GAAG,GAAG;AAAA,QACnE;AAGA,cAAM,OAAO,MAAM,IAAI,GAAG;AAAA,UACxB;AAAA,QACF,EAAE,KAAK,KAAK,EAAE,MAAM;AAEpB,YAAI,CAAC,MAAM;AACT,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAGA,cAAM,QAAQ,MAAM,eAAe,UAAU,KAAK,aAAa;AAC/D,YAAI,CAAC,OAAO;AACV,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAGA,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAKC,KAAI,GAAG,KAAK,EAAE,EAAE,IAAI;AAG3B,cAAM,SAAS,IAAI,cAAc;AACjC,cAAM,QAAQ,MAAM,cAAc,KAAK,IAAI,MAAM;AAGjD,cAAM,YAAY,WAAW;AAC7B,cAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,cAAM,YAAYA,KAAI;AACtB,cAAM,YAAY,YAAa,IAAI,KAAK,KAAK;AAE7C,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,WAAW,KAAK,IAAI,WAAW,WAAW,SAAS,EAAE,IAAI;AAEhE,eAAOD,cAAa;AAAA,UAClB;AAAA,UACA,MAAM;AAAA,YACJ,IAAI,KAAK;AAAA,YACT,OAAO,KAAK;AAAA,YACZ,MAAM,KAAK;AAAA,UACb;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,sBAAsB,QAAQ,WAAW,QAAQ;AACpE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,eAAOA,cAAa,EAAE,SAAS,0BAA0B,CAAC;AAAA,MAC5D;AAGA,UAAI,IAAI,aAAa,kBAAkB,QAAQ,WAAW,OAAO;AAC/D,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,OAAO,MAAM,IAAI,GAAG;AAAA,UACxB;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,MAAM;AACT,iBAAOA,cAAa,EAAE,OAAO,iBAAiB,GAAG,GAAG;AAAA,QACtD;AAEA,eAAOA,cAAa;AAAA,UAClB,IAAI,KAAK;AAAA,UACT,OAAO,KAAK;AAAA,UACZ,MAAM,KAAK;AAAA,UACX,WAAW,KAAK;AAAA,QAClB,CAAC;AAAA,MACH;AAQA,UAAI,IAAI,aAAa,mBAAmB,QAAQ,WAAW,OAAO;AAChE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AAExD,iBAAOA,cAAa;AAAA,YAClB,YAAY;AAAA,YACZ,WAAW;AAAA,YACX,qBAAqB;AAAA,YACrB,iBAAiB;AAAA,YACjB,eAAe;AAAA,YACf,qBAAqB;AAAA,YACrB,cAAc;AAAA,YACd,kBAAkB;AAAA,YAClB,iBAAiB;AAAA,YACjB,qBAAqB;AAAA,UACvB,CAAC;AAAA,QACH;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAGA,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAG1B,YAAI,gBAAgB;AACpB,YAAI,CAAC,cAAc,CAAC,WAAW,aAAa;AAC1C,gBAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,YACjC;AAAA,UACF,EAAE,KAAK,UAAU,aAAa,EAAE,MAAM;AAEtC,cAAI,iBAAiB,cAAc,aAAa;AAC9C,4BAAgB;AAGhB,gBAAI,SAAS;AACX,oBAAM,YAAY,KAAK,IAAI;AAC3B,oBAAM,eAAe,WAAW;AAEhC,oBAAM,IAAI,GAAG;AAAA,gBACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAMF,EAAE;AAAA,gBACA;AAAA,gBACA;AAAA,gBACA,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd,cAAc;AAAA,gBACd;AAAA,gBACA;AAAA,cACF,EAAE,IAAI;AAEN,sBAAQ,IAAI,wCAAwC,WAAW,EAAE;AAAA,YACnE;AAAA,UACF;AAAA,QACF;AAEA,eAAOA,cAAa;AAAA,UAClB,YAAY,eAAe,eAAe;AAAA,UAC1C,WAAW,eAAe,cAAc;AAAA,UACxC,qBAAqB,eAAe,yBAAyB;AAAA,UAC7D,iBAAiB,eAAe,qBAAqB;AAAA,UACrD,eAAe,eAAe,mBAAmB;AAAA,UACjD,qBAAqB;AAAA,UACrB,cAAc,eAAe,kBAAkB;AAAA,UAC/C,kBAAkB,eAAe,sBAAsB;AAAA,UACvD,iBAAiB,eAAe,qBAAqB;AAAA,UACrD,qBAAqB,eAAe,yBAAyB;AAAA,UAC7D,kBAAkB;AAAA,QACpB,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,mBAAmB,QAAQ,WAAW,OAAO;AAChE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM;AAAA,UACJ;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACF,IAAI,MAAM,QAAQ,KAAK;AAGvB,YAAI,CAAC,qBAAqB;AACxB,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,GAAG,GAAG;AAAA,QACvE;AAGA,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,mBAAmB,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,YAAI,UAAU,kBAAkB,QAAQ;AACtC,iBAAOA,cAAa,EAAE,OAAO,kDAAkD,GAAG,GAAG;AAAA,QACvF;AAEA,cAAM,YAAYC,KAAI;AAGtB,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,mBAAmB,EAAE,MAAM;AAElC,YAAI,UAAU;AACZ,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE;AAAA,YACA,cAAc;AAAA,YACd,aAAa;AAAA,YACb,uBAAuB;AAAA,YACvB,mBAAmB;AAAA,YACnB,iBAAiB;AAAA,YACjB,gBAAgB;AAAA,YAChB,oBAAoB;AAAA,YACpB,mBAAmB;AAAA,YACnB,uBAAuB;AAAA,YACvB;AAAA,YACA;AAAA,UACF,EAAE,IAAI;AAAA,QACR,OAAO;AACL,gBAAM,aAAa,WAAW;AAC9B,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE;AAAA,YACA;AAAA,YACA;AAAA,YACA,cAAc;AAAA,YACd,aAAa;AAAA,YACb,uBAAuB;AAAA,YACvB,mBAAmB;AAAA,YACnB,iBAAiB;AAAA,YACjB,gBAAgB;AAAA,YAChB,oBAAoB;AAAA,YACpB,mBAAmB;AAAA,YACnB,uBAAuB;AAAA,YACvB;AAAA,YACA;AAAA,UACF,EAAE,IAAI;AAAA,QACR;AAGA,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,qBAAqB,WAAW,MAAM,EAAE,IAAI;AAEnD,eAAOD,cAAa,EAAE,SAAS,gCAAgC,CAAC;AAAA,MAClE;AAKA,UAAI,IAAI,aAAa,oBAAoB,QAAQ,WAAW,QAAQ;AAClE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,MAAM,eAAe,IAAI,MAAM,QAAQ,KAAK;AAEpD,YAAI,CAAC,QAAQ,CAAC,gBAAgB;AAC5B,iBAAOA,cAAa,EAAE,OAAO,gDAAgD,GAAG,GAAG;AAAA,QACrF;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,oBAAoB,MAAM,IAAI,GAAG;AAAA,UACrC;AAAA,QACF,EAAE,KAAK,aAAa,qBAAqB,EAAE,MAAM;AAEjD,YAAI,CAAC,qBAAqB,CAAC,kBAAkB,gBAAgB;AAC3D,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT,OAAO;AAAA,UACT,CAAC;AAAA,QACH;AAEA,YAAI;AAEF,gBAAM,iBAAiB,MAAM,MAAM,8CAA8C;AAAA,YAC/E,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,gBAAgB;AAAA,cAChB,iBAAiB,UAAU,kBAAkB,cAAc;AAAA,YAC7D;AAAA,YACA,MAAM,KAAK,UAAU;AAAA,cACnB,OAAO;AAAA,cACP,UAAU;AAAA,gBACR;AAAA,kBACE,MAAM;AAAA,kBACN,SAAS,8EAA8E,cAAc;AAAA,gBACvG;AAAA,gBACA;AAAA,kBACE,MAAM;AAAA,kBACN,SAAS;AAAA,gBACX;AAAA,cACF;AAAA,cACA,aAAa;AAAA,YACf,CAAC;AAAA,UACH,CAAC;AAED,cAAI,CAAC,eAAe,IAAI;AACtB,kBAAM,YAAY,MAAM,eAAe,KAAK;AAC5C,kBAAM,IAAI,MAAM,qBAAqB,eAAe,MAAM,IAAI,SAAS,EAAE;AAAA,UAC3E;AAEA,gBAAM,OAAO,MAAM,eAAe,KAAK;AACvC,gBAAM,iBAAiB,KAAK,QAAQ,CAAC,EAAE,QAAQ;AAE/C,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,wBAAwB,KAAK;AAC3C,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT,OAAO,MAAM,WAAW;AAAA,UAC1B,CAAC;AAAA,QACH;AAAA,MACF;AAOA,UAAI,IAAI,aAAa,oCAAoC,QAAQ,WAAW,OAAO;AACjF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,UAAUG,cAAa,aAAa,GAAG;AAE7C,eAAOH,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,oCAAoC,QAAQ,WAAW,OAAO;AACjF,YAAI;AAEF,gBAAM,OAAO,IAAI,aAAa,IAAI,MAAM;AACxC,gBAAM,cAAc,IAAI,aAAa,IAAI,OAAO;AAEhD,cAAI,CAAC,QAAQ,CAAC,aAAa;AACzB,mBAAO,IAAI,SAAS,mCAAmC,EAAE,QAAQ,IAAI,CAAC;AAAA,UACxE;AAGA,gBAAM,SAAS,MAAMI,sBAAqB,MAAM,GAAG;AAGnD,gBAAM,YAAYH,KAAI;AACtB,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAOF,EAAE;AAAA,YACA,OAAO;AAAA,YACP,OAAO;AAAA,YACP,OAAO;AAAA,YACP,OAAO;AAAA,YACP;AAAA,YACA;AAAA,UACF,EAAE,IAAI;AAGN,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY;AAAA,YACd;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,6BAA6B,KAAK;AAEhD,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY,oFAAoF,mBAAmB,MAAM,OAAO,CAAC;AAAA,YACnI;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,OAAO;AACzE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOD,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA;AAAA;AAAA;AAAA,QAIF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,cAAM,YAAY,CAAC,EAAE,YAAY,SAAS;AAC1C,cAAM,iBAAiB,UAAU,+BAA+B;AAEhE,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,UACA,aAAa,YAAY,SAAS,0BAA0B;AAAA,UAC5D;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,gCAAgC,QAAQ,WAAW,UAAU;AAChF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAYC,KAAI;AACtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOF,EAAE,KAAK,WAAW,WAAW,EAAE,IAAI;AAEnC,eAAOD,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,+BAA+B,QAAQ,WAAW,OAAO;AAC5E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,QAAQ,KAAK,IAAI,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,IAAI,GAAG,GAAG;AAC3E,cAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,cAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAG5C,YAAI,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOZ,cAAM,SAAgB,CAAC,WAAW;AAElC,YAAI,QAAQ;AACV,mBAAS;AACT,iBAAO,KAAK,MAAM;AAAA,QACpB;AAEA,iBAAS;AACT,eAAO,KAAK,OAAO,MAAM;AAEzB,cAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAG7D,YAAI,aAAa;AACjB,cAAM,cAAqB,CAAC,WAAW;AAEvC,YAAI,QAAQ;AACV,wBAAc;AACd,sBAAY,KAAK,MAAM;AAAA,QACzB;AAEA,cAAM,cAAc,MAAM,IAAI,GAAG,QAAQ,UAAU,EAAE,KAAK,GAAG,WAAW,EAAE,MAAM;AAEhF,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM,KAAK,WAAW,CAAC;AAAA,UACvB,OAAO,aAAa,SAAS;AAAA,UAC7B;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH;AAOA,UAAI,IAAI,aAAa,iCAAiC,QAAQ,WAAW,OAAO;AAC9E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,UAAU,aAAoB,aAAa,GAAG;AAEpD,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,iCAAiC,QAAQ,WAAW,OAAO;AAC9E,YAAI;AAEF,gBAAM,OAAO,IAAI,aAAa,IAAI,MAAM;AACxC,gBAAM,cAAc,IAAI,aAAa,IAAI,OAAO;AAEhD,cAAI,CAAC,QAAQ,CAAC,aAAa;AACzB,mBAAO,IAAI,SAAS,mCAAmC,EAAE,QAAQ,IAAI,CAAC;AAAA,UACxE;AAGA,gBAAM,SAAS,MAAM,qBAA4B,MAAM,GAAG;AAG1D,gBAAM,YAAY,MAAM,IAAI,GAAG;AAAA,YAC7B;AAAA,UACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,cAAI,CAAC,WAAW;AACd,mBAAO,IAAI,SAAS,uBAAuB,EAAE,QAAQ,IAAI,CAAC;AAAA,UAC5D;AAEA,gBAAM,SAAS,UAAU;AAGzB,gBAAM,WAAW,MAAM,IAAI,GAAG;AAAA,YAC5B;AAAA,UACF,EAAE,KAAK,QAAQ,WAAW,EAAE,MAAM;AAElC,gBAAM,YAAYC,KAAI;AACtB,gBAAM,UAAU,WAAW;AAE3B,cAAI,UAAU;AAEZ,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAMF,EAAE;AAAA,cACA,OAAO;AAAA,cACP,OAAO;AAAA,cACP,OAAO;AAAA,cACP;AAAA,cACA;AAAA,cACA;AAAA,YACF,EAAE,IAAI;AAAA,UACR,OAAO;AAEL,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA;AAAA;AAAA;AAAA,YAIF,EAAE;AAAA,cACA;AAAA,cACA;AAAA,cACA;AAAA,cACA,OAAO;AAAA,cACP,OAAO;AAAA,cACP,OAAO;AAAA,cACP;AAAA,cACA;AAAA,YACF,EAAE,IAAI;AAAA,UACR;AAGA,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY;AAAA,cACZ,GAAG;AAAA,YACL;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,0BAA0B,KAAK;AAC7C,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY,qEAAqE,mBAAmB,MAAM,OAAO,CAAC;AAAA,cAClH,GAAG;AAAA,YACL;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,yBAAyB,QAAQ,WAAW,OAAO;AACtE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOD,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,SAAS,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA,QACF,EAAE,KAAK,QAAQ,WAAW,EAAE,MAAM;AAElC,cAAM,YAAY,CAAC,EAAE,UAAU,OAAO;AACtC,cAAM,iBAAiB,QAAQ,cAAc;AAE7C,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,UAAU;AAC7E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,QAAQ,WAAW,EAAE,IAAI;AAEhC,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,OAAO;AACzE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,QAAQ,KAAK,IAAI,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,IAAI,GAAG,GAAG;AAC3E,cAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,cAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAG5C,YAAI,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAMZ,cAAM,SAAgB,CAAC,QAAQ,WAAW;AAE1C,YAAI,QAAQ;AACV,mBAAS;AACT,iBAAO,KAAK,MAAM;AAAA,QACpB;AAEA,iBAAS;AACT,eAAO,KAAK,OAAO,MAAM;AAEzB,cAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAG7D,YAAI,aAAa;AACjB,cAAM,cAAqB,CAAC,QAAQ,WAAW;AAE/C,YAAI,QAAQ;AACV,wBAAc;AACd,sBAAY,KAAK,MAAM;AAAA,QACzB;AAEA,cAAM,cAAc,MAAM,IAAI,GAAG,QAAQ,UAAU,EAAE,KAAK,GAAG,WAAW,EAAE,MAAM;AAEhF,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM,KAAK,WAAW,CAAC;AAAA,UACvB,OAAO,aAAa,SAAS;AAAA,UAC7B;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH;AAOA,UAAI,IAAI,aAAa,kCAAkC,QAAQ,WAAW,OAAO;AAC/E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,cAAc,IAAI,aAAa,IAAI,aAAa;AACtD,YAAI,CAAC,aAAa;AAChB,iBAAOA,cAAa,EAAE,OAAO,2BAA2B,GAAG,GAAG;AAAA,QAChE;AAGA,cAAM,UAAUG,cAAqB,aAAa,KAAK,WAAW;AAElE,eAAOH,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,kCAAkC,QAAQ,WAAW,OAAO;AAC/E,YAAI;AAEF,gBAAM,OAAO,IAAI,aAAa,IAAI,MAAM;AACxC,gBAAM,QAAQ,IAAI,aAAa,IAAI,OAAO;AAE1C,cAAI,CAAC,QAAQ,CAAC,OAAO;AACnB,mBAAO,IAAI,SAAS,mCAAmC,EAAE,QAAQ,IAAI,CAAC;AAAA,UACxE;AAGA,gBAAM,CAAC,aAAa,WAAW,IAAI,MAAM,MAAM,GAAG;AAGlD,gBAAM,SAAS,MAAMI,sBAA6B,MAAM,KAAK,WAAW;AAGxE,gBAAM,YAAYH,KAAI;AACtB,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAOF,EAAE;AAAA,YACA;AAAA,YACA,OAAO;AAAA,YACP,OAAO;AAAA,YACP,OAAO;AAAA,YACP;AAAA,YACA;AAAA,UACF,EAAE,IAAI;AAGN,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY;AAAA,YACd;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,+BAA+B,KAAK;AAElD,iBAAO,IAAI,SAAS,MAAM;AAAA,YACxB,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,YAAY,kFAAkF,mBAAmB,MAAM,OAAO,CAAC;AAAA,YACjI;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,0BAA0B,QAAQ,WAAW,OAAO;AACvE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOD,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA;AAAA;AAAA;AAAA,QAIF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,cAAM,YAAY,CAAC,EAAE,YAAY,SAAS;AAC1C,cAAM,iBAAiB,UAAU,6BAA6B;AAE9D,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT;AAAA,UACA,aAAa,YAAY,SAAS,wBAAwB;AAAA,UAC1D;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,8BAA8B,QAAQ,WAAW,UAAU;AAC9E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAYC,KAAI;AACtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOF,EAAE,KAAK,WAAW,WAAW,EAAE,IAAI;AAEnC,eAAOD,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,OAAO;AAC1E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,QAAQ,KAAK,IAAI,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,IAAI,GAAG,GAAG;AAC3E,cAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,cAAM,SAAS,IAAI,aAAa,IAAI,QAAQ;AAG5C,YAAI,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOZ,cAAM,SAAgB,CAAC,WAAW;AAElC,YAAI,QAAQ;AACV,mBAAS;AACT,iBAAO,KAAK,MAAM;AAAA,QACpB;AAEA,iBAAS;AACT,eAAO,KAAK,OAAO,MAAM;AAEzB,cAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAG7D,YAAI,aAAa;AACjB,cAAM,cAAqB,CAAC,WAAW;AAEvC,YAAI,QAAQ;AACV,wBAAc;AACd,sBAAY,KAAK,MAAM;AAAA,QACzB;AAEA,cAAM,cAAc,MAAM,IAAI,GAAG,QAAQ,UAAU,EAAE,KAAK,GAAG,WAAW,EAAE,MAAM;AAEhF,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM,KAAK,WAAW,CAAC;AAAA,UACvB,OAAO,aAAa,SAAS;AAAA,UAC7B;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH;AAOA,UAAI,IAAI,aAAa,qBAAqB,QAAQ,WAAW,OAAO;AAClE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUd,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,QAAQ,QAAQ,QAAQ,QAAQ,MAAM,EAAE,IAAI;AACjG,eAAOA,cAAa,EAAE,YAAY,WAAW,CAAC,EAAE,CAAC;AAAA,MACnD;AAIA,UAAI,IAAI,aAAa,qBAAqB,QAAQ,WAAW,QAAQ;AACnE,eAAOA,cAAa,EAAE,OAAO,iGAAiG,GAAG,GAAG;AAAA,MACtI;AAGA,UAAI,IAAI,SAAS,WAAW,kBAAkB,KAAK,IAAI,SAAS,SAAS,SAAS,KAAK,QAAQ,WAAW,QAAQ;AAChH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ,IAAI,SAAS,MAAM,GAAG;AACpC,cAAM,cAAc,MAAM,CAAC;AAC3B,cAAM,EAAE,OAAO,KAAK,IAAI,MAAM,QAAQ,KAAK;AAC3C,YAAI,CAAC,OAAO;AACV,iBAAOA,cAAa,EAAE,OAAO,oBAAoB,GAAG,GAAG;AAAA,QACzD;AAGA,cAAM,KAAK,MAAM,IAAI,GAAG,QAAQ,mDAAmD,EAAE,KAAK,WAAW,EAAE,MAAM;AAC7G,YAAI,CAAC,IAAI;AACP,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AACA,YAAI,GAAG,kBAAkB,QAAQ;AAC/B,gBAAM,aAAa,MAAM,IAAI,GAAG;AAAA,YAC9B;AAAA,UACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAClC,cAAI,CAAC,cAAe,WAAW,SAAS,WAAW,WAAW,SAAS,SAAU;AAC/E,mBAAOA,cAAa,EAAE,OAAO,YAAY,GAAG,GAAG;AAAA,UACjD;AAAA,QACF;AAEA,cAAM,YAAYC,KAAI;AAGtB,cAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,sCAAsC,EAAE,KAAK,KAAK,EAAE,MAAM;AAE5F,YAAI,MAAM;AAER,gBAAM,eAAe,WAAW;AAChC,cAAI;AACF,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA,YACF,EAAE,KAAK,cAAc,aAAa,KAAK,IAAI,QAAQ,UAAU,QAAQ,WAAW,WAAW,WAAW,SAAS,EAAE,IAAI;AAAA,UACvH,SAAS,GAAG;AAEV,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA,YACF,EAAE,KAAK,QAAQ,UAAU,QAAQ,WAAW,WAAW,WAAW,aAAa,KAAK,EAAE,EAAE,IAAI;AAAA,UAC9F;AACA,iBAAOD,cAAa,EAAE,SAAS,MAAM,SAAS,0BAA0B,CAAC;AAAA,QAC3E,OAAO;AAEL,gBAAM,oBAAoB,0BAA0B;AACpD,gBAAM,eAAe,MAAM,aAAa,iBAAiB;AACzD,gBAAM,YAAY,WAAW;AAG7B,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,WAAW,OAAO,cAAc,MAAM,WAAW,SAAS,EAAE,IAAI;AAGvE,gBAAM,qBAAqB,QAAQ,WAAW;AAC9C,gBAAM,gBAAgB,MAAM,MAAM,GAAG,EAAE,CAAC,KAAK;AAC7C,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,oBAAoB,eAAe,WAAW,WAAW,SAAS,EAAE,IAAI;AAG/E,gBAAM,aAAa,WAAW;AAC9B,gBAAM,iBAAiB,aAAa;AACpC,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,YAAY,WAAW,gBAAgB,aAAa,WAAW,SAAS,EAAE,IAAI;AAGrF,gBAAM,eAAe,WAAW;AAChC,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,cAAc,aAAa,WAAW,QAAQ,UAAU,QAAQ,WAAW,WAAW,WAAW,SAAS,EAAE,IAAI;AAGvH,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,WAAW,OAAO,WAAW,EAAE,IAAI;AAE1C,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT,SAAS;AAAA,YACT,aAAa;AAAA,cACX;AAAA,cACA;AAAA,YACF;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,kBAAkB,KAAK,IAAI,SAAS,SAAS,UAAU,KAAK,QAAQ,WAAW,OAAO;AAChH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ,IAAI,SAAS,MAAM,GAAG;AACpC,cAAM,cAAc,MAAM,CAAC;AAG3B,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,YAAY,CAAC,cAAc,WAAW,WAAW,WAAW;AAC/D,iBAAOA,cAAa,EAAE,OAAO,gBAAgB,GAAG,GAAG;AAAA,QACrD;AAGA,cAAM,QAAQ,MAAM,IAAI,GAAG;AAAA,UACzB;AAAA,QACF,EAAE,KAAK,UAAU,aAAa,EAAE,MAAM;AAGtC,cAAM,UAAU,MAAM,IAAI,GAAG,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAOpC,EAAE,KAAK,WAAW,EAAE,IAAI;AAEzB,cAAM,eAAe,QAAQ,WAAW,CAAC,GAAG,IAAI,CAAC,OAAY;AAAA,UAC3D,IAAI,EAAE;AAAA,UACN,OAAO,EAAE;AAAA,UACT,MAAM,EAAE;AAAA,UACR,MAAM,EAAE;AAAA,UACR,QAAQ,EAAE;AAAA,UACV,UAAU,EAAE;AAAA,QACd,EAAE;AAGF,cAAM,cAAc,YAAY,KAAK,CAAC,MAAW,EAAE,OAAO,MAAM,EAAE;AAClE,YAAI,CAAC,aAAa;AAChB,sBAAY,QAAQ;AAAA,YAClB,IAAI,MAAM;AAAA,YACV,OAAO,MAAM;AAAA,YACb,MAAM,MAAM;AAAA,YACZ,MAAM;AAAA,YACN,QAAQ;AAAA,YACR,UAAU;AAAA,UACZ,CAAC;AAAA,QACH;AAEA,eAAOA,cAAa;AAAA,UAClB,WAAW,EAAE,IAAI,aAAa,MAAM,UAAU,KAAK;AAAA,UACnD,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,SAAS,SAAS,kBAAkB,KAAK,IAAI,SAAS,SAAS,WAAW,KAAK,QAAQ,WAAW,UAAU;AAClH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ,IAAI,SAAS,MAAM,GAAG;AACpC,cAAM,cAAc,MAAM,CAAC;AAC3B,cAAM,WAAW,MAAM,CAAC;AAGxB,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,YAAY,CAAC,cAAc,WAAW,SAAS,UAAU;AAC5D,iBAAOA,cAAa,EAAE,OAAO,4CAA4C,GAAG,GAAG;AAAA,QACjF;AAGA,YAAI,aAAa,UAAU,eAAe;AACxC,iBAAOA,cAAa,EAAE,OAAO,gCAAgC,GAAG,GAAG;AAAA,QACrE;AAGA,cAAM,SAAS,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA,QACF,EAAE,KAAK,UAAU,WAAW,EAAE,MAAM;AAEpC,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,mBAAmB,GAAG,GAAG;AAAA,QACxD;AAGA,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,UAAU,WAAW,EAAE,IAAI;AAElC,eAAOA,cAAa,EAAE,SAAS,MAAM,SAAS,8BAA8B,CAAC;AAAA,MAC/E;AAGA,UAAI,IAAI,SAAS,SAAS,kBAAkB,KAAK,IAAI,SAAS,SAAS,WAAW,KAAK,QAAQ,WAAW,SAAS;AACjH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ,IAAI,SAAS,MAAM,GAAG;AACpC,cAAM,cAAc,MAAM,CAAC;AAC3B,cAAM,WAAW,MAAM,CAAC;AACxB,cAAM,EAAE,KAAK,IAAI,MAAM,QAAQ,KAAK;AAEpC,YAAI,CAAC,QAAQ,CAAC,CAAC,UAAU,OAAO,EAAE,SAAS,IAAI,GAAG;AAChD,iBAAOA,cAAa,EAAE,OAAO,4CAA4C,GAAG,GAAG;AAAA,QACjF;AAGA,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,YAAI,UAAU,kBAAkB,QAAQ;AACtC,iBAAOA,cAAa,EAAE,OAAO,wCAAwC,GAAG,GAAG;AAAA,QAC7E;AAGA,cAAM,SAAS,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA,QACF,EAAE,KAAK,UAAU,WAAW,EAAE,MAAM;AAEpC,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,mBAAmB,GAAG,GAAG;AAAA,QACxD;AAGA,cAAM,YAAYC,KAAI;AACtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,MAAM,WAAW,UAAU,WAAW,EAAE,IAAI;AAEnD,eAAOD,cAAa,EAAE,SAAS,MAAM,SAAS,mCAAmC,CAAC;AAAA,MACpF;AAOA,UAAI,IAAI,aAAa,+BAA+B,QAAQ,WAAW,OAAO;AAC5E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,0DAA0D,GAAG,GAAG;AAAA,QAC/F;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,sBAAsB,CAAC,SAAS,mBAAmB;AAC5E,iBAAOA,cAAa,EAAE,OAAO,6GAA6G,GAAG,GAAG;AAAA,QAClJ;AAEA,YAAI;AAEF,gBAAM,YAAY,8CAA8C,SAAS,kBAAkB;AAC3F,gBAAM,aAAa,KAAK,GAAG,SAAS,kBAAkB,IAAI,SAAS,iBAAiB,EAAE;AAEtF,gBAAM,iBAAiB,MAAM,MAAM,WAAW;AAAA,YAC5C,SAAS;AAAA,cACP,iBAAiB,SAAS,UAAU;AAAA,YACtC;AAAA,UACF,CAAC;AAED,cAAI,CAAC,eAAe,IAAI;AACtB,kBAAM,YAAY,MAAM,eAAe,KAAK;AAC5C,mBAAOA,cAAa,EAAE,OAAO,qBAAqB,eAAe,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UACjG;AAEA,gBAAM,aAAa,MAAM,eAAe,KAAK;AAG7C,gBAAM,gBAAgB,WAAW,0BAA0B,CAAC,GAAG;AAAA,YAAO,CAAC,QACrE,IAAI,cAAc,UAAU;AAAA,UAC9B,EAAE,IAAI,CAAC,SAAc;AAAA,YACnB,KAAK,IAAI;AAAA,YACT,aAAa,IAAI;AAAA,YACjB,cAAc,IAAI;AAAA,YAClB,cAAc;AAAA,cACZ,OAAO,IAAI,cAAc,SAAS;AAAA,cAClC,KAAK,IAAI,cAAc,OAAO;AAAA,YAChC;AAAA,UACF,EAAE;AAEF,iBAAOA,cAAa,YAAY;AAAA,QAClC,SAAS,OAAY;AACnB,kBAAQ,MAAM,kCAAkC,KAAK;AACrD,iBAAOA,cAAa,EAAE,OAAO,mCAAmC,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACxF;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,QAAQ;AAC3E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,KAAK,aAAa,KAAK,IAAI,MAAM,QAAQ,KAAK;AAEtD,YAAI,CAAC,OAAO,CAAC,aAAa;AACxB,iBAAOA,cAAa,EAAE,OAAO,wCAAwC,GAAG,GAAG;AAAA,QAC7E;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,0DAA0D,GAAG,GAAG;AAAA,QAC/F;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,oHAAoH,GAAG,GAAG;AAAA,QACzJ;AAEA,YAAI,CAAC,SAAS,sBAAsB,CAAC,SAAS,mBAAmB;AAC/D,iBAAOA,cAAa,EAAE,OAAO,6GAA6G,GAAG,GAAG;AAAA,QAClJ;AAEA,YAAI;AAGF,gBAAM,UAAU;AAChB,gBAAM,UAAe;AAAA,YACnB,UAAU;AAAA,YACV,kBAAkB,SAAS;AAAA,YAC3B,iBAAiB,SAAS;AAAA,UAC5B;AAEA,cAAI,KAAK;AACP,oBAAQ,uBAAuB;AAAA,UACjC,WAAW,aAAa;AACtB,oBAAQ,SAAS;AAAA,UACnB;AAEA,cAAI,MAAM;AACR,oBAAQ,OAAO;AAAA,UACjB;AAGA,kBAAQ,aAAa;AAErB,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,OAAO;AAAA,UAC9B,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOA,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAEA,gBAAM,WAAW,MAAM,aAAa,KAAK;AAEzC,iBAAOA,cAAa;AAAA,YAClB,IAAI,SAAS;AAAA,YACb,QAAQ,SAAS,UAAU,SAAS;AAAA,YACpC,MAAM,SAAS,QAAQ;AAAA,UACzB,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,kCAAkC,KAAK;AACrD,iBAAOA,cAAa,EAAE,OAAO,mCAAmC,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACxF;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,QAAQ;AAC1E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,UAAU,KAAK,IAAI,MAAM,QAAQ,KAAK;AAE9C,YAAI,CAAC,YAAY,CAAC,UAAU,KAAK,QAAQ,GAAG;AAC1C,iBAAOA,cAAa,EAAE,OAAO,sCAAsC,GAAG,GAAG;AAAA,QAC3E;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,0DAA0D,GAAG,GAAG;AAAA,QAC/F;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,oHAAoH,GAAG,GAAG;AAAA,QACzJ;AAEA,YAAI;AAIF,gBAAM,UAAU;AAChB,gBAAM,UAAe;AAAA,YACnB,UAAU;AAAA,YACV,uBAAuB;AAAA;AAAA,UACzB;AAEA,cAAI,MAAM;AACR,oBAAQ,OAAO;AAAA,UACjB;AAGA,cAAI,SAAS,uBAAuB;AAClC,oBAAQ,sBAAsB;AAAA,cAC5B,MAAM;AAAA,cACN,QAAQ,SAAS;AAAA,YACnB;AAAA,UACF;AAEA,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,OAAO;AAAA,UAC9B,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,gBAAI,YAAY,MAAM,aAAa,KAAK;AACxC,gBAAI;AAEF,oBAAM,YAAY,KAAK,MAAM,SAAS;AACtC,kBAAI,UAAU,SAAS;AACrB,4BAAY,UAAU;AAAA,cACxB,WAAW,UAAU,OAAO;AAC1B,4BAAY,UAAU;AAAA,cACxB;AAAA,YACF,QAAQ;AAAA,YAER;AACA,mBAAOA,cAAa,EAAE,OAAO,UAAU,GAAG,GAAG;AAAA,UAC/C;AAEA,gBAAM,WAAW,MAAM,aAAa,KAAK;AAEzC,iBAAOA,cAAa;AAAA,YAClB,IAAI,SAAS;AAAA,YACb,QAAQ,SAAS,UAAU,SAAS;AAAA,YACpC,MAAM,SAAS,QAAQ;AAAA,UACzB,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,kDAAkD,KAAK;AACrE,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACvF;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,yBAAyB,KAAK,IAAI,SAAS,SAAS,YAAY,KAAK,QAAQ,WAAW,SAAS;AAC3H,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,OAAO,OAAO;AACxD,cAAM,gBAAgB,UAAU,UAAU,IAAI,UAAU,CAAC,IAAI;AAC7D,cAAM,EAAE,YAAY,IAAI,MAAM,QAAQ,KAAK;AAE3C,YAAI,CAAC,eAAe;AAClB,iBAAOA,cAAa,EAAE,OAAO,2BAA2B,GAAG,GAAG;AAAA,QAChE;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,0DAA0D,GAAG,GAAG;AAAA,QAC/F;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,YAAI,WAAW,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAG1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,gBAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,YACjC;AAAA,UACF,EAAE,KAAK,UAAU,aAAa,EAAE,MAAM;AAEtC,cAAI,iBAAiB,cAAc,aAAa;AAC9C,uBAAW;AAAA,UACb;AAAA,QACF;AAEA,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,oHAAoH,GAAG,GAAG;AAAA,QACzJ;AAEA,YAAI;AAEF,gBAAM,UAAU,oCAAoC,aAAa;AACjE,gBAAM,UAAe,CAAC;AAItB,cAAI,gBAAgB,QAAQ,gBAAgB,UAAa,gBAAgB,IAAI;AAC3E,oBAAQ,cAAc;AAAA,UACxB,OAAO;AACL,oBAAQ,cAAc;AAAA,UACxB;AAEA,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,OAAO;AAAA,UAC9B,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOA,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAEA,gBAAM,WAAW,MAAM,aAAa,KAAK;AAEzC,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT,aAAa;AAAA,cACX,IAAI,SAAS;AAAA,cACb,QAAQ,SAAS,UAAU,SAAS;AAAA,cACpC,aAAa,SAAS,eAAe;AAAA,YACvC;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAY;AACnB,kBAAQ,MAAM,0CAA0C,KAAK;AAC7D,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACvF;AAAA,MACF;AAOA,UAAI,IAAI,aAAa,qBAAqB,QAAQ,WAAW,OAAO;AAClE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,UAAU;AACb,iBAAOA,cAAa,EAAE,OAAO,0BAA0B,GAAG,GAAG;AAAA,QAC/D;AAGA,YAAI,kBAAkB;AACtB,YAAI,aAA4B;AAGhC,YAAI,SAAS,uBAAuB;AAElC,gBAAM,YAAY,MAAM,IAAI,GAAG;AAAA,YAC7B;AAAA,UACF,EAAE,KAAK,SAAS,qBAAqB,EAAE,MAAM;AAE7C,cAAI,WAAW;AAEb,kBAAM,UAAU,UAAU,kBAAkB;AAC5C,kBAAM,aAAa,MAAM,IAAI,GAAG;AAAA,cAC9B;AAAA,YACF,EAAE,KAAK,SAAS,uBAAuB,MAAM,EAAE,MAAM;AAErD,gBAAI,WAAW,YAAY;AAEzB,oBAAM,aAAa,MAAM,IAAI,GAAG;AAAA,gBAC9B;AAAA,cACF,EAAE,KAAK,SAAS,qBAAqB,EAAE,MAAM;AAE7C,kBAAI,cAAc,WAAW,aAAa;AACxC,6BAAa,WAAW;AACxB,kCAAkB,UAAU;AAAA,cAC9B,OAAO;AAEL,uBAAOA,cAAa,EAAE,YAAY,CAAC,EAAE,CAAC;AAAA,cACxC;AAAA,YACF,OAAO;AACL,qBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,YAClE;AAAA,UACF,OAAO;AAEL,mBAAOA,cAAa,EAAE,YAAY,CAAC,EAAE,CAAC;AAAA,UACxC;AAAA,QACF,OAAO;AAEL,iBAAOA,cAAa,EAAE,YAAY,CAAC,EAAE,CAAC;AAAA,QACxC;AAEA,YAAI,CAAC,YAAY;AAEf,iBAAOA,cAAa,EAAE,YAAY,CAAC,EAAE,CAAC;AAAA,QACxC;AAEA,YAAI;AAEF,gBAAM,YAAY,MAAM,IAAI,GAAG;AAAA,YAC7B;AAAA,UACF,EAAE,KAAK,eAAe,EAAE,IAAI;AAG5B,cAAI,aAAa,UAAU,WAAW,UAAU,QAAQ,SAAS,GAAG;AAClE,kBAAM,gBAAgBC,KAAI,IAAK,IAAI;AACnC,kBAAM,kBAAkB,UAAU,QAAQ,CAAC;AAG3C,gBAAI,gBAAgB,YAAY,eAAe;AAC7C,oBAAMI,cAAa,UAAU,QAAQ,IAAI,CAAC,QAAa,KAAK,MAAM,IAAI,SAAS,CAAC;AAChF,qBAAOL,cAAa,EAAE,YAAAK,aAAY,QAAQ,KAAK,CAAC;AAAA,YAClD;AAAA,UACF;AAGA,gBAAM,UAAU;AAChB,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,UAAU;AAAA,cACrC,gBAAgB;AAAA,YAClB;AAAA,UACF,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOL,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAEA,gBAAM,aAAa,MAAM,aAAa,KAAK;AAC3C,gBAAM,YAAYC,KAAI;AAGtB,qBAAW,aAAa,YAAY;AAClC,kBAAM,IAAI,GAAG;AAAA,cACX;AAAA,YACF,EAAE;AAAA,cACA,UAAU;AAAA,cACV;AAAA,cACA,KAAK,UAAU,SAAS;AAAA,cACxB;AAAA,cACA,IAAI,KAAK,UAAU,aAAa,UAAU,SAAS,EAAE,QAAQ,IAAI,OAAQ;AAAA,YAC3E,EAAE,IAAI;AAAA,UACR;AAEA,iBAAOD,cAAa,EAAE,YAAY,QAAQ,MAAM,CAAC;AAAA,QACnD,SAAS,OAAY;AACnB,kBAAQ,MAAM,8BAA8B,KAAK;AACjD,iBAAOA,cAAa,EAAE,OAAO,+BAA+B,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACpF;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,kBAAkB,KAAK,IAAI,aAAa,qBAAqB,QAAQ,WAAW,OAAO;AACjH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,cAAc,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAChD,YAAI,CAAC,aAAa;AAChB,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,2CAA2C,GAAG,GAAG;AAAA,QAChF;AAEA,cAAM,kBAAkB,UAAU;AAElC,YAAI;AAEF,gBAAM,SAAS,MAAM,IAAI,GAAG;AAAA,YAC1B;AAAA,UACF,EAAE,KAAK,aAAa,eAAe,EAAE,MAAM;AAE3C,cAAI,QAAQ;AACV,kBAAM,WAAWC,KAAI,IAAI,OAAO;AAEhC,gBAAI,WAAW,IAAI,IAAI;AACrB,qBAAOD,cAAa,EAAE,WAAW,KAAK,MAAM,OAAO,SAAS,GAAG,QAAQ,KAAK,CAAC;AAAA,YAC/E;AAAA,UACF;AAGA,gBAAM,UAAU,iCAAiC,WAAW;AAC5D,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,UACF,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOA,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAEA,gBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,gBAAM,YAAYC,KAAI;AAGtB,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE;AAAA,YACA,UAAU;AAAA,YACV;AAAA,YACA,KAAK,UAAU,SAAS;AAAA,YACxB;AAAA,YACA,IAAI,KAAK,UAAU,aAAa,UAAU,SAAS,EAAE,QAAQ,IAAI,OAAQ;AAAA,UAC3E,EAAE,IAAI;AAEN,iBAAOD,cAAa,EAAE,WAAW,QAAQ,MAAM,CAAC;AAAA,QAClD,SAAS,OAAY;AACnB,kBAAQ,MAAM,6BAA6B,KAAK;AAChD,iBAAOA,cAAa,EAAE,OAAO,8BAA8B,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACnF;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,kBAAkB,KAAK,IAAI,aAAa,qBAAqB,QAAQ,WAAW,SAAS;AACnH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,cAAc,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAChD,cAAM,UAAU,MAAM,QAAQ,KAAK;AAEnC,YAAI,CAAC,aAAa;AAChB,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI;AAGJ,YAAI,cAAc,uBAAuB;AACvC,gBAAM,cAAc,aAAa;AAGjC,gBAAM,YAAY,MAAM,IAAI,GAAG;AAAA,YAC7B;AAAA,UACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,cAAI,CAAC,WAAW;AACd,mBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,UAC3D;AAEA,gBAAM,UAAU,UAAU,kBAAkB;AAC5C,gBAAM,aAAa,MAAM,IAAI,GAAG;AAAA,YAC9B;AAAA,UACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,cAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,mBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,UAClE;AAGA,qBAAW,MAAM,IAAI,GAAG;AAAA,YACtB;AAAA,UACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAG1B,cAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,kBAAM,gBAAgB,MAAM,IAAI,GAAG;AAAA,cACjC;AAAA,YACF,EAAE,KAAK,UAAU,aAAa,EAAE,MAAM;AAEtC,gBAAI,iBAAiB,cAAc,aAAa;AAC9C,yBAAW;AAAA,YACb;AAAA,UACF;AAAA,QACF,OAAO;AAEL,qBAAW,MAAM,IAAI,GAAG;AAAA,YACtB;AAAA,UACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAAA,QACvB;AAEA,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,2CAA2C,GAAG,GAAG;AAAA,QAChF;AAEA,YAAI;AAEF,gBAAM,UAAU,iCAAiC,WAAW;AAC5D,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,OAAO;AAAA,UAC9B,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOA,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAEA,gBAAM,mBAAmB,MAAM,aAAa,KAAK;AACjD,gBAAM,YAAYC,KAAI;AAGtB,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE;AAAA,YACA,iBAAiB;AAAA,YACjB;AAAA,YACA,KAAK,UAAU,gBAAgB;AAAA,YAC/B;AAAA,YACA,IAAI,KAAK,iBAAiB,aAAa,iBAAiB,SAAS,EAAE,QAAQ,IAAI,OAAQ;AAAA,UACzF,EAAE,IAAI;AAEN,iBAAOD,cAAa,EAAE,WAAW,iBAAiB,CAAC;AAAA,QACrD,SAAS,OAAY;AACnB,kBAAQ,MAAM,6BAA6B,KAAK;AAChD,iBAAOA,cAAa,EAAE,OAAO,+BAA+B,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACpF;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,qBAAqB,QAAQ,WAAW,QAAQ;AACnE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,gBAAgB,MAAM,QAAQ,KAAK;AAGzC,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,0DAA0D,GAAG,GAAG;AAAA,QAC/F;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,6FAA6F,GAAG,GAAG;AAAA,QAClI;AAEA,YAAI;AAEF,gBAAM,UAAU;AAChB,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,aAAa;AAAA,UACpC,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,gBAAI,YAAY,MAAM,aAAa,KAAK;AACxC,gBAAI;AAEF,oBAAM,YAAY,KAAK,MAAM,SAAS;AACtC,kBAAI,UAAU,SAAS;AACrB,4BAAY,UAAU;AAAA,cACxB,WAAW,UAAU,OAAO;AAC1B,4BAAY,UAAU;AAAA,cACxB;AAAA,YACF,QAAQ;AAAA,YAER;AACA,mBAAOA,cAAa,EAAE,OAAO,UAAU,GAAG,GAAG;AAAA,UAC/C;AAEA,gBAAM,eAAe,MAAM,aAAa,KAAK;AAC7C,gBAAM,YAAYC,KAAI;AAGtB,gBAAM,kBAAkB,UAAU;AAClC,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE;AAAA,YACA,aAAa;AAAA,YACb;AAAA,YACA,KAAK,UAAU,YAAY;AAAA,YAC3B;AAAA,YACA,IAAI,KAAK,aAAa,aAAa,aAAa,SAAS,EAAE,QAAQ,IAAI,OAAQ;AAAA,UACjF,EAAE,IAAI;AAEN,iBAAOD,cAAa,EAAE,WAAW,aAAa,CAAC;AAAA,QACjD,SAAS,OAAY;AACnB,kBAAQ,MAAM,6BAA6B,KAAK;AAChD,iBAAOA,cAAa,EAAE,OAAO,+BAA+B,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACpF;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,kBAAkB,KAAK,IAAI,aAAa,qBAAqB,QAAQ,WAAW,UAAU;AACpH,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,cAAc,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAChD,YAAI,CAAC,aAAa;AAChB,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAGA,cAAM,eAAe,MAAM,IAAI,GAAG;AAAA,UAChC;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,gBAAgB,CAAC,aAAa,uBAAuB;AACxD,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,cAAc,aAAa;AAGjC,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,UAAU,UAAU,kBAAkB;AAC5C,cAAM,aAAa,MAAM,IAAI,GAAG;AAAA,UAC9B;AAAA,QACF,EAAE,KAAK,aAAa,MAAM,EAAE,MAAM;AAElC,YAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,iBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,GAAG;AAAA,QAClE;AAEA,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,WAAW,EAAE,MAAM;AAE1B,YAAI,CAAC,YAAY,CAAC,SAAS,aAAa;AACtC,iBAAOA,cAAa,EAAE,OAAO,2CAA2C,GAAG,GAAG;AAAA,QAChF;AAEA,cAAM,kBAAkB,UAAU;AAElC,YAAI;AAEF,gBAAM,UAAU,iCAAiC,WAAW;AAC5D,gBAAM,eAAe,MAAM,MAAM,SAAS;AAAA,YACxC,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,cAC/C,gBAAgB;AAAA,YAClB;AAAA,UACF,CAAC;AAED,cAAI,CAAC,aAAa,IAAI;AACpB,kBAAM,YAAY,MAAM,aAAa,KAAK;AAC1C,mBAAOA,cAAa,EAAE,OAAO,gCAAgC,aAAa,MAAM,MAAM,SAAS,GAAG,GAAG,GAAG;AAAA,UAC1G;AAGA,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,aAAa,eAAe,EAAE,IAAI;AAEzC,iBAAOA,cAAa,EAAE,SAAS,KAAK,CAAC;AAAA,QACvC,SAAS,OAAY;AACnB,kBAAQ,MAAM,6BAA6B,KAAK;AAChD,iBAAOA,cAAa,EAAE,OAAO,+BAA+B,MAAM,OAAO,GAAG,GAAG,GAAG;AAAA,QACpF;AAAA,MACF;AAOA,UAAI,IAAI,aAAa,iBAAiB,QAAQ,WAAW,OAAO;AAC9D,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,eAAOA,cAAa,EAAE,QAAQ,WAAW,CAAC,EAAE,CAAC;AAAA,MAC/C;AAGA,UAAI,IAAI,aAAa,wBAAwB,QAAQ,WAAW,QAAQ;AACtE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,WAAW,QAAQ,IAAI,MAAM,QAAQ,KAAK;AAElD,YAAI,CAAC,WAAW;AACd,iBAAOA,cAAa,EAAE,OAAO,sBAAsB,GAAG,GAAG;AAAA,QAC3D;AAEA,cAAM,YAAYC,KAAI;AAGtB,cAAM,WAAW,MAAM,IAAI,GAAG;AAAA,UAC5B;AAAA,QACF,EAAE,KAAK,QAAQ,SAAS,EAAE,MAAM;AAEhC,YAAI,UAAU;AAEZ,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,UAAU,IAAI,GAAG,WAAW,QAAQ,SAAS,EAAE,IAAI;AAAA,QAC5D,OAAO;AAEL,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,WAAW,GAAG,QAAQ,WAAW,UAAU,IAAI,GAAG,WAAW,SAAS,EAAE,IAAI;AAAA,QACrF;AAEA,eAAOD,cAAa,EAAE,SAAS,8BAA8B,QAAQ,CAAC;AAAA,MACxE;AAGA,UAAI,IAAI,SAAS,WAAW,qBAAqB,KAAK,QAAQ,WAAW,OAAO;AAC9E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,SAAS,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAE3C,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA,QACF,EAAE,KAAK,QAAQ,MAAM,EAAE,IAAI;AAE3B,eAAOA,cAAa,EAAE,SAAS,WAAW,CAAC,EAAE,CAAC;AAAA,MAChD;AAOA,UAAI,IAAI,aAAa,8BAA8B,QAAQ,WAAW,OAAO;AAC3E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,IAAI;AAEnB,eAAOA,cAAa,WAAW,CAAC,CAAC;AAAA,MACnC;AAGA,UAAI,IAAI,aAAa,8BAA8B,QAAQ,WAAW,QAAQ;AAC5E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,MAAM,iBAAiB,mBAAmB,IAAI,MAAM,QAAQ,KAAK;AAEzE,YAAI,CAAC,QAAQ,CAAC,iBAAiB;AAC7B,iBAAOA,cAAa,EAAE,OAAO,wCAAwC,GAAG,GAAG;AAAA,QAC7E;AAEA,cAAM,YAAY,WAAW;AAC7B,cAAM,YAAYC,KAAI;AAEtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA,QAEF,EAAE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,qBAAqB,IAAI;AAAA,UACzB;AAAA;AAAA,UACA;AAAA,UACA;AAAA,QACF,EAAE,IAAI;AAEN,eAAOD,cAAa,EAAE,IAAI,WAAW,SAAS,0CAA0C,CAAC;AAAA,MAC3F;AAGA,UAAI,IAAI,SAAS,WAAW,2BAA2B,KAAK,QAAQ,WAAW,OAAO;AACpF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAC9C,cAAM,EAAE,MAAM,iBAAiB,oBAAoB,UAAU,IAAI,MAAM,QAAQ,KAAK;AAEpF,cAAM,IAAI,GAAG;AAAA,UACX;AAAA;AAAA;AAAA,QAGF,EAAE;AAAA,UACA;AAAA,UACA;AAAA,UACA,qBAAqB,IAAI;AAAA,UACzB,YAAY,IAAI;AAAA,UAChBC,KAAI;AAAA,UACJ;AAAA,UACA;AAAA,QACF,EAAE,IAAI;AAEN,eAAOD,cAAa,EAAE,SAAS,0CAA0C,CAAC;AAAA,MAC5E;AAGA,UAAI,IAAI,SAAS,WAAW,2BAA2B,KAAK,QAAQ,WAAW,UAAU;AACvF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAE9C,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,WAAW,MAAM,EAAE,IAAI;AAE9B,eAAOA,cAAa,EAAE,SAAS,0CAA0C,CAAC;AAAA,MAC5E;AAGA,UAAI,IAAI,aAAa,kCAAkC,QAAQ,WAAW,OAAO;AAC/E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,YAAY,IAAI,aAAa,IAAI,YAAY;AAEnD,YAAI,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQZ,cAAM,SAAS,CAAC,MAAM;AAEtB,YAAI,WAAW;AACb,mBAAS;AACT,iBAAO,KAAK,SAAS;AAAA,QACvB;AAEA,iBAAS;AAET,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAEpE,eAAOA,cAAa,WAAW,CAAC,CAAC;AAAA,MACnC;AAOA,UAAI,IAAI,SAAS,WAAW,uBAAuB,KAAK,QAAQ,WAAW,OAAO;AAChF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,UAAU,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAE5C,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA,QACF,EAAE,KAAK,OAAO,EAAE,IAAI;AAEpB,eAAOA,cAAa,WAAW,CAAC,CAAC;AAAA,MACnC;AAGA,UAAI,IAAI,aAAa,0BAA0B,QAAQ,WAAW,QAAQ;AACxE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,UAAU,cAAc,WAAW,WAAW,OAAO,IAAI,MAAM,QAAQ,KAAK;AAEpF,YAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,WAAW;AAC5C,iBAAOA,cAAa,EAAE,OAAO,0BAA0B,GAAG,GAAG;AAAA,QAC/D;AAEA,cAAM,KAAK,WAAW;AACtB,cAAM,YAAYC,KAAI;AAEtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,IAAI,UAAU,cAAc,WAAW,aAAa,GAAG,UAAU,SAAS,WAAW,SAAS,EAAE,IAAI;AAE3G,eAAOD,cAAa;AAAA,UAClB;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,WAAW,aAAa;AAAA,UACxB,QAAQ,UAAU;AAAA,UAClB,YAAY;AAAA,UACZ,YAAY;AAAA,QACd,GAAG,GAAG;AAAA,MACR;AAGA,UAAI,IAAI,SAAS,WAAW,uBAAuB,KAAK,QAAQ,WAAW,UAAU;AACnF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,KAAK,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAEvC,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,EAAE,EAAE,IAAI;AAEf,eAAOA,cAAa,EAAE,SAAS,4BAA4B,CAAC;AAAA,MAC9D;AAOA,UAAI,IAAI,aAAa,mBAAmB,QAAQ,WAAW,QAAQ;AACjE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,EAAE,KAAK,IAAI,MAAM,QAAQ,KAAK;AAEpC,YAAI,CAAC,MAAM;AACT,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAGA,cAAM,YAAY,QAAQ,WAAW;AACrC,cAAM,aAAa,0DAA0D,SAAS;AACtF,cAAM,YAAYC,KAAI;AAEtB,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,WAAW,QAAQ,YAAY,MAAM,GAAG,WAAW,SAAS,EAAE,IAAI;AAEzE,eAAOD,cAAa;AAAA,UAClB,IAAI;AAAA,UACJ,KAAK;AAAA,UACL;AAAA,UACA,WAAW;AAAA,UACX,YAAY;AAAA,QACd,GAAG,GAAG;AAAA,MACR;AAGA,UAAI,IAAI,aAAa,mBAAmB,QAAQ,WAAW,OAAO;AAChE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAEhE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAYF,EAAE,KAAK,eAAe,EAAE,IAAI;AAE5B,eAAOA,cAAa,WAAW,CAAC,CAAC;AAAA,MACnC;AAGA,UAAI,IAAI,SAAS,WAAW,gBAAgB,KAAK,QAAQ,WAAW,UAAU;AAC5E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAG9C,cAAM,UAAU,MAAM,IAAI,GAAG;AAAA,UAC3B;AAAA,QACF,EAAE,KAAK,SAAS,EAAE,MAAM;AAExB,YAAI,CAAC,SAAS;AACZ,iBAAOA,cAAa,EAAE,OAAO,oBAAoB,GAAG,GAAG;AAAA,QACzD;AAEA,YAAI,QAAQ,YAAY,QAAQ;AAC9B,iBAAOA,cAAa,EAAE,OAAO,YAAY,GAAG,GAAG;AAAA,QACjD;AAGA,cAAM,IAAI,GAAG;AAAA,UACX;AAAA,QACF,EAAE,KAAK,SAAS,EAAE,IAAI;AAEtB,eAAOA,cAAa,EAAE,SAAS,+BAA+B,CAAC;AAAA,MACjE;AAOA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,QAAQ;AAC1E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AACA,eAAO,MAAM,sBAAsB,SAAS,KAAK,MAAM;AAAA,MACzD;AAGA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,OAAO;AACzE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AACA,eAAO,MAAM,qBAAqB,KAAK,MAAM;AAAA,MAC/C;AAGA,UAAI,IAAI,SAAS,WAAW,yBAAyB,KAAK,QAAQ,WAAW,SAAS;AACpF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AACA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAC9C,eAAO,MAAM,sBAAsB,SAAS,KAAK,QAAQ,SAAS;AAAA,MACpE;AAGA,UAAI,IAAI,SAAS,WAAW,yBAAyB,KAAK,QAAQ,WAAW,UAAU;AACrF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AACA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,IAAI;AAC9C,eAAO,MAAM,sBAAsB,KAAK,QAAQ,SAAS;AAAA,MAC3D;AAGA,UAAI,IAAI,SAAS,MAAM,yCAAyC,KAAK,QAAQ,WAAW,OAAO;AAC7F,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AACA,cAAM,YAAY,IAAI,SAAS,MAAM,GAAG,EAAE,CAAC;AAC3C,eAAO,MAAM,uBAAuB,KAAK,QAAQ,SAAS;AAAA,MAC5D;AAOA,UAAI,IAAI,aAAa,wBAAwB,QAAQ,WAAW,OAAO;AACrE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAEhE,cAAM,YAAY,IAAI,aAAa,IAAI,YAAY;AACnD,cAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,KAAK;AAC7D,cAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,cAAM,OAAO,KAAK,MAAM,SAAS,KAAK,IAAI;AAG1C,cAAM,QAAQ,IAAI,aAAa,IAAI,KAAK;AAGxC,cAAM,YAAY,IAAI,aAAa,IAAI,IAAI;AAI3C,YAAI,CAAC,aAAa,SAAS,OAAO,CAAC,WAAW;AAC5C,gBAAM,SAAS,MAAM,MAAM,oBAAoB,iBAAiB,MAAM,KAAK;AAC3E,cAAI,QAAQ;AACV,oBAAQ,IAAI,kCAAkC,eAAe,UAAU,IAAI,WAAW,KAAK,EAAE;AAC7F,mBAAOA,cAAa,MAAM;AAAA,UAC5B;AAAA,QACF;AAEA,gBAAQ,IAAI,mCAAmC,eAAe,UAAU,IAAI,WAAW,KAAK,GAAG,YAAY,4BAA4B,EAAE,EAAE;AAI3I,YAAI,QAAQ,IAAI,GAAG;AAAA,UACjB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YA4BE,YAAY,0BAA0B,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAM5C;AAEA,cAAM,SAAS,YACX,CAAC,iBAAiB,WAAW,OAAO,MAAM,IAC1C,CAAC,iBAAiB,OAAO,MAAM;AAEnC,cAAM,EAAE,QAAQ,IAAI,MAAM,MAAM,KAAK,GAAG,MAAM,EAAE,IAAI;AAGpD,cAAM,iBAAiB,WAAW,CAAC,GAAG,IAAI,CAAC,SAAc;AAAA,UACvD,GAAG;AAAA,UACH,iBAAiB,IAAI,kBAAkB,KAAK,MAAM,IAAI,eAAe,IAAI;AAAA,UACzE,aAAa,IAAI,cAAc,KAAK,MAAM,IAAI,WAAW,IAAI;AAAA,UAC7D,eAAe,IAAI,gBAAgB,KAAK,MAAM,IAAI,aAAa,IAAI;AAAA,QACrE,EAAE;AAIF,YAAI,CAAC,aAAa,SAAS,KAAK;AAC9B,gBAAM,MAAM,gBAAgB,iBAAiB,eAAe,MAAM,OAAO,UAAU,UAAU;AAAA,QAC/F;AAEA,eAAOA,cAAa,aAAa;AAAA,MACnC;AAKA,UAAI,IAAI,aAAa,uBAAuB,QAAQ,WAAW,OAAO;AACpE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAGhE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAaF,EAAE,KAAK,eAAe,EAAE,IAAI;AAE5B,eAAOA,cAAa,OAAO;AAAA,MAC7B;AAGA,UAAI,IAAI,aAAa,+BAA+B,QAAQ,WAAW,QAAQ;AAC7E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAGhE,cAAM,cAAc,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAK,IAAI,KAAK;AAE9D,cAAM,SAAS,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA,QACF,EAAE,KAAK,iBAAiB,WAAW,EAAE,IAAI;AAEzC,gBAAQ,IAAI,yCAAyC;AAAA,UACnD,QAAQ;AAAA,UACR,cAAc,OAAO,KAAK;AAAA,UAC1B,WAAW,IAAI,KAAK,cAAc,GAAI,EAAE,YAAY;AAAA,QACtD,CAAC;AAED,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,cAAc,OAAO,KAAK;AAAA,UAC1B,SAAS,WAAW,OAAO,KAAK,OAAO;AAAA,QACzC,CAAC;AAAA,MACH;AAIA,UAAI,IAAI,aAAa,2BAA2B,QAAQ,WAAW,OAAO;AACxE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAGhE,cAAM,oBAAoB,MAAM,IAAI,GAAG;AAAA,UACrC;AAAA,QACF,EAAE,KAAK,eAAe,EAAE,MAAM;AAE9B,cAAM,oBAAoB,mBAAmB,SAAS;AAKtD,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOF,EAAE,KAAK,eAAe,EAAE,IAAI;AAE5B,YAAI,iBAAiB;AAErB,YAAI,WAAW,QAAQ,SAAS,GAAG;AAEjC,gBAAM,aAAoD,CAAC;AAE3D,qBAAW,OAAO,SAAkB;AAClC,gBAAI;AACF,oBAAM,UAAU,OAAO,IAAI,gBAAgB,WACvC,KAAK,MAAM,IAAI,WAAW,IAC1B,IAAI;AAER,oBAAM,YAAY,QAAQ,SAAS,MAAM;AACzC,oBAAM,UAAU,QAAQ,SAAS,MAAM;AAEvC,kBAAI,aAAa,SAAS;AACxB,sBAAM,YAAY,IAAI,KAAK,SAAS,EAAE,QAAQ;AAC9C,sBAAM,UAAU,IAAI,KAAK,OAAO,EAAE,QAAQ;AAC1C,oBAAI,aAAa,WAAW,YAAY,SAAS;AAC/C,6BAAW,KAAK,EAAE,OAAO,WAAW,KAAK,QAAQ,CAAC;AAAA,gBACpD;AAAA,cACF;AAAA,YACF,SAAS,OAAO;AAEd;AAAA,YACF;AAAA,UACF;AAGA,cAAI,WAAW,SAAS,GAAG;AAEzB,kBAAM,aAAa,oBAAI,IAAY;AACnC,uBAAW,QAAQ,WAAS;AAC1B,yBAAW,IAAI,MAAM,KAAK;AAC1B,yBAAW,IAAI,MAAM,GAAG;AAAA,YAC1B,CAAC;AAGD,kBAAM,mBAAmB,MAAM,KAAK,UAAU,EAAE,KAAK,CAAC,GAAG,MAAM,IAAI,CAAC;AAEpE,uBAAW,aAAa,kBAAkB;AACxC,oBAAM,aAAa,WAAW;AAAA,gBAAO,WACnC,MAAM,SAAS,aAAa,MAAM,MAAM;AAAA,cAC1C,EAAE;AAEF,kBAAI,aAAa,gBAAgB;AAC/B,iCAAiB;AAAA,cACnB;AAAA,YACF;AAAA,UACF;AAAA,QACF;AAEA,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM;AAAA,QACR,CAAC;AAAA,MACH;AAIA,UAAI,IAAI,aAAa,sCAAsC,QAAQ,WAAW,OAAO;AACnF,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAEhE,cAAM,cAAc,IAAI,aAAa,IAAI,aAAa,KAAK;AAC3D,cAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,MAAM;AAI9D,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAOF,EAAE,KAAK,iBAAiB,KAAK,EAAE,IAAI;AAEnC,YAAI,CAAC,WAAW,QAAQ,WAAW,GAAG;AACpC,iBAAOA,cAAa,EAAE,MAAM,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC;AAAA,QAC9C;AAGA,cAAM,aAAoD,CAAC;AAE3D,mBAAW,OAAO,SAAkB;AAClC,cAAI;AACF,kBAAM,UAAU,OAAO,IAAI,gBAAgB,WACvC,KAAK,MAAM,IAAI,WAAW,IAC1B,IAAI;AAER,kBAAM,YAAY,QAAQ,SAAS,MAAM;AACzC,kBAAM,UAAU,QAAQ,SAAS,MAAM;AAEvC,gBAAI,aAAa,SAAS;AACxB,oBAAM,YAAY,IAAI,KAAK,SAAS,EAAE,QAAQ;AAC9C,oBAAM,UAAU,IAAI,KAAK,OAAO,EAAE,QAAQ;AAC1C,kBAAI,aAAa,WAAW,YAAY,SAAS;AAC/C,2BAAW,KAAK,EAAE,OAAO,WAAW,KAAK,QAAQ,CAAC;AAAA,cACpD;AAAA,YACF;AAAA,UACF,SAAS,OAAO;AACd;AAAA,UACF;AAAA,QACF;AAEA,YAAI,WAAW,WAAW,GAAG;AAC3B,iBAAOA,cAAa,EAAE,MAAM,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC;AAAA,QAC9C;AAGA,cAAM,WAAW,WAAW,QAAQ,OAAK,CAAC,EAAE,OAAO,EAAE,GAAG,CAAC;AACzD,cAAM,UAAU,KAAK,IAAI,GAAG,QAAQ;AACpC,cAAM,UAAU,KAAK,IAAI,GAAG,QAAQ;AAGpC,YAAI;AACJ,YAAI;AAEJ,YAAI,gBAAgB,UAAU;AAC5B,uBAAa,KAAK;AAClB,0BAAgB,wBAAC,MAAM,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,EAAE,QAAQ,KAAK,GAAG,GAApD;AAAA,QAClB,WAAW,gBAAgB,QAAQ;AACjC,uBAAa,KAAK,KAAK;AACvB,0BAAgB,wBAAC,MAAM,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,IAAI,OAAtC;AAAA,QAClB,OAAO;AACL,uBAAa,KAAK,KAAK,KAAK;AAC5B,0BAAgB,wBAAC,MAAM,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,GAAnC;AAAA,QAClB;AAGA,cAAM,UAAU,oBAAI,IAAoB;AACxC,cAAM,cAAc,KAAK,MAAM,UAAU,WAAW,UAAU;AAE9D,iBAAS,IAAI,GAAG,KAAK,aAAa,KAAK;AACrC,gBAAM,aAAa,UAAW,IAAI;AAClC,gBAAM,YAAY,cAAc,IAAI,KAAK,UAAU,CAAC;AACpD,kBAAQ,IAAI,WAAW,CAAC;AAAA,QAC1B;AAGA,iBAAS,IAAI,GAAG,KAAK,aAAa,KAAK;AACrC,gBAAM,aAAa,UAAW,IAAI;AAClC,gBAAM,WAAW,aAAc,aAAa;AAC5C,gBAAM,aAAa,WAAW;AAAA,YAAO,WACnC,MAAM,SAAS,YAAY,MAAM,MAAM;AAAA,UACzC,EAAE;AAEF,gBAAM,YAAY,cAAc,IAAI,KAAK,UAAU,CAAC;AACpD,kBAAQ,IAAI,WAAW,UAAU;AAAA,QACnC;AAGA,cAAM,SAAS,MAAM,KAAK,QAAQ,KAAK,CAAC;AACxC,cAAM,OAAO,MAAM,KAAK,QAAQ,OAAO,CAAC;AAExC,eAAOA,cAAa,EAAE,MAAM,OAAO,CAAC;AAAA,MACtC;AAGA,UAAI,IAAI,aAAa,4BAA4B,QAAQ,WAAW,OAAO;AACzE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAKhE,cAAM,SAAS,MAAM,IAAI,GAAG;AAAA,UAC1B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAeF,EAAE,KAAK,eAAe,EAAE,MAAM;AAE9B,YAAI,CAAC,QAAQ;AAEX,iBAAOA,cAAa;AAAA,YAClB,YAAY;AAAA,YACZ,eAAe;AAAA,YACf,iBAAiB;AAAA,YACjB,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,kBAAkB;AAAA,YAClB,qBAAqB;AAAA,YACrB,sBAAsB;AAAA,YACtB,kBAAkB;AAAA,YAClB,eAAe;AAAA,YACf,eAAe;AAAA,YACf,cAAc;AAAA,UAChB,CAAC;AAAA,QACH;AAGA,eAAOA,cAAa;AAAA,UAClB,YAAY,OAAO,eAAe;AAAA,UAClC,eAAe,OAAO,kBAAkB;AAAA,UACxC,iBAAiB,OAAO,oBAAoB;AAAA,UAC5C,YAAY,OAAO,eAAe;AAAA,UAClC,iBAAiB,OAAO,qBAAqB;AAAA,UAC7C,kBAAkB,OAAO,sBAAsB;AAAA,UAC/C,qBAAqB,OAAO,yBAAyB;AAAA,UACrD,sBAAsB,OAAO,yBAAyB;AAAA,UACtD,kBAAkB,OAAO,sBAAsB;AAAA,UAC/C,eAAe,OAAO,kBAAkB;AAAA,UACxC,eAAe,OAAO,kBAAkB;AAAA,UACxC,cAAc,OAAO,iBAAiB;AAAA,QACxC,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,OAAO;AAC1E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAIhE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAUF,EAAE,KAAK,eAAe,EAAE,IAAI;AAE5B,eAAOA,cAAa,WAAW,CAAC,CAAC;AAAA,MACnC;AAIA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,OAAO;AAC1E,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAEhE,cAAM,YAAY,IAAI,aAAa,IAAI,YAAY;AACnD,cAAM,UAAU,IAAI,aAAa,IAAI,UAAU;AAK/C,YAAI,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUf,cAAM,SAAgB,CAAC,eAAe;AAEtC,YAAI,WAAW;AACb,sBAAY;AACZ,iBAAO,KAAK,SAAS;AAAA,QACvB;AACA,YAAI,SAAS;AACX,sBAAY;AACZ,iBAAO,KAAK,OAAO;AAAA,QACrB;AAEA,oBAAY;AAEZ,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG,QAAQ,QAAQ,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAEvE,YAAI,CAAC,WAAW,QAAQ,WAAW,GAAG;AACpC,iBAAOA,cAAa,EAAE,OAAO,CAAC,GAAG,SAAS,CAAC,GAAG,QAAQ,CAAC,EAAE,CAAC;AAAA,QAC5D;AAGA,cAAM,UAAU,oBAAI,IAAY;AAChC,cAAM,aAAa,oBAAI,IAAY;AACnC,cAAM,UAAU,oBAAI,IAAiC;AAErD,mBAAW,OAAO,SAAkB;AAClC,gBAAM,OAAO,IAAI;AACjB,gBAAM,SAAS,IAAI,gBAAgB;AACnC,gBAAM,QAAQ,IAAI,SAAS;AAE3B,kBAAQ,IAAI,IAAI;AAChB,qBAAW,IAAI,MAAM;AAErB,cAAI,CAAC,QAAQ,IAAI,IAAI,GAAG;AACtB,oBAAQ,IAAI,MAAM,oBAAI,IAAI,CAAC;AAAA,UAC7B;AACA,kBAAQ,IAAI,IAAI,EAAG,IAAI,QAAQ,KAAK;AAAA,QACtC;AAGA,cAAM,QAAQ,MAAM,KAAK,OAAO,EAAE,KAAK;AAGvC,cAAM,UAAU,MAAM,KAAK,UAAU;AACrC,cAAM,eAAuC,CAAC;AAC9C,cAAM,eAAe;AAAA,UACnB;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,UACA;AAAA;AAAA,QACF;AAEA,gBAAQ,QAAQ,CAAC,QAAQ,QAAQ;AAC/B,uBAAa,MAAM,IAAI,aAAa,MAAM,aAAa,MAAM;AAAA,QAC/D,CAAC;AAGD,cAAM,aAAuC,CAAC;AAC9C,gBAAQ,QAAQ,YAAU;AACxB,qBAAW,MAAM,IAAI,MAAM,IAAI,UAAQ;AACrC,kBAAM,WAAW,QAAQ,IAAI,IAAI;AACjC,mBAAO,UAAU,IAAI,MAAM,KAAK;AAAA,UAClC,CAAC;AAAA,QACH,CAAC;AAED,eAAOA,cAAa;AAAA,UAClB;AAAA,UACA,SAAS;AAAA,UACT,QAAQ;AAAA,QACV,CAAC;AAAA,MACH;AAIA,UAAI,IAAI,aAAa,mBAAmB,QAAQ,WAAW,OAAO;AAChE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAGhE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAYF,EAAE,KAAK,eAAe,EAAE,IAAI;AAE5B,eAAOA,cAAa,OAAO;AAAA,MAC7B;AAGA,UAAI,IAAI,SAAS,WAAW,aAAa,KAAK,IAAI,SAAS,SAAS,SAAS,KAAK,QAAQ,WAAW,OAAO;AAC1G,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,SAAS,IAAI,SAAS,MAAM,GAAG,EAAE,CAAC;AAExC,gBAAQ,IAAI,4CAA4C;AAAA,UACtD;AAAA,UACA;AAAA,QACF,CAAC;AAGD,cAAM,WAAW,MAAM,4BAA4B,KAAK,MAAM;AAE9D,YAAI,CAAC,UAAU,aAAa;AAC1B,kBAAQ,IAAI,8DAA8D,MAAM;AAChF,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,GAAG,GAAG;AAAA,QACvE;AAGA,YAAI;AACF,kBAAQ,IAAI,qDAAqD,MAAM;AAEvE,gBAAM,kBAAkB,MAAM,MAAM,4BAA4B,MAAM,IAAI;AAAA,YACxE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,YACjD;AAAA,UACF,CAAC;AAED,cAAI,CAAC,gBAAgB,IAAI;AACvB,kBAAM,QAAQ,MAAM,gBAAgB,KAAK;AACzC,oBAAQ,MAAM,gDAAgD;AAAA,cAC5D;AAAA,cACA,QAAQ,gBAAgB;AAAA,cACxB;AAAA,YACF,CAAC;AACD,mBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,gBAAgB,MAAM;AAAA,UACrF;AAEA,gBAAM,cAAc,MAAM,gBAAgB,KAAK;AAC/C,gBAAM,YAAY,YAAY,SAAS;AAEvC,kBAAQ,IAAI,4CAA4C;AAAA,YACtD;AAAA,YACA,cAAc,CAAC,CAAC;AAAA,UAClB,CAAC;AAED,cAAI,CAAC,WAAW;AACd,oBAAQ,MAAM,qDAAqD;AACnE,mBAAOA,cAAa,EAAE,OAAO,yCAAyC,GAAG,GAAG;AAAA,UAC9E;AAEA,iBAAOA,cAAa;AAAA,YAClB,SAAS;AAAA,YACT;AAAA,YACA;AAAA,UACF,CAAC;AAAA,QACH,SAAS,OAAO;AACd,kBAAQ,MAAM,8CAA8C;AAAA,YAC1D;AAAA,YACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,UAC9D,CAAC;AACD,iBAAOA,cAAa,EAAE,OAAO,2BAA2B,GAAG,GAAG;AAAA,QAChE;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,aAAa,KAAK,IAAI,SAAS,SAAS,MAAM,KAAK,QAAQ,WAAW,QAAQ;AACxG,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,SAAS,IAAI,SAAS,MAAM,GAAG,EAAE,CAAC;AAExC,gBAAQ,IAAI,6CAA6C;AAAA,UACvD;AAAA,UACA;AAAA,QACF,CAAC;AAGD,cAAM,WAAW,MAAM,4BAA4B,KAAK,MAAM;AAE9D,YAAI,CAAC,UAAU,aAAa;AAC1B,kBAAQ,IAAI,4DAA4D,MAAM;AAC9E,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,GAAG,GAAG;AAAA,QACvE;AAGA,YAAI;AAEF,kBAAQ,IAAI,wDAAwD,MAAM;AAE1E,gBAAM,kBAAkB,MAAM,MAAM,4BAA4B,MAAM,IAAI;AAAA,YACxE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,YACjD;AAAA,UACF,CAAC;AAED,cAAI,CAAC,gBAAgB,IAAI;AACvB,kBAAM,QAAQ,MAAM,gBAAgB,KAAK;AACzC,oBAAQ,MAAM,8CAA8C;AAAA,cAC1D;AAAA,cACA,QAAQ,gBAAgB;AAAA,cACxB;AAAA,YACF,CAAC;AACD,mBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,gBAAgB,MAAM;AAAA,UACrF;AAEA,gBAAM,cAAc,MAAM,gBAAgB,KAAK;AAC/C,gBAAM,aAAa,YAAY,SAAS;AAExC,kBAAQ,IAAI,0CAA0C;AAAA,YACpD;AAAA,YACA,eAAe,CAAC,CAAC;AAAA,UACnB,CAAC;AAED,cAAI,CAAC,YAAY;AACf,oBAAQ,MAAM,oDAAoD;AAClE,mBAAOA,cAAa,EAAE,OAAO,iCAAiC,GAAG,GAAG;AAAA,UACtE;AAGA,gBAAM,iBAAiB;AAAA,YACrB,MAAM;AAAA,UACR;AAEA,kBAAQ,IAAI,0DAA0D;AAAA,YACpE;AAAA,YACA,SAAS;AAAA,UACX,CAAC;AAED,gBAAM,kBAAkB,MAAM,MAAM,YAAY;AAAA,YAC9C,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,cAAc;AAAA,UACrC,CAAC;AAED,cAAI,CAAC,gBAAgB,IAAI;AACvB,kBAAM,QAAQ,MAAM,gBAAgB,KAAK;AACzC,oBAAQ,MAAM,2CAA2C;AAAA,cACvD;AAAA,cACA,QAAQ,gBAAgB;AAAA,cACxB;AAAA,YACF,CAAC;AACD,mBAAOA,cAAa,EAAE,OAAO,qBAAqB,GAAG,gBAAgB,MAAM;AAAA,UAC7E;AAEA,kBAAQ,IAAI,2CAA2C,MAAM;AAE7D,iBAAOA,cAAa,EAAE,SAAS,MAAM,SAAS,0BAA0B,CAAC;AAAA,QAC3E,SAAS,OAAO;AACd,kBAAQ,MAAM,qCAAqC;AAAA,YACjD;AAAA,YACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,UAC9D,CAAC;AACD,iBAAOA,cAAa,EAAE,OAAO,qBAAqB,GAAG,GAAG;AAAA,QAC1D;AAAA,MACF;AAGA,UAAI,IAAI,SAAS,WAAW,aAAa,KAAK,IAAI,SAAS,SAAS,WAAW,KAAK,QAAQ,WAAW,QAAQ;AAC7G,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,SAAS,IAAI,SAAS,MAAM,GAAG,EAAE,CAAC;AACxC,cAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,cAAM,iBAAiB,KAAK;AAE5B,gBAAQ,IAAI,kDAAkD;AAAA,UAC5D;AAAA,UACA;AAAA,UACA;AAAA,QACF,CAAC;AAED,YAAI,CAAC,gBAAgB;AACnB,kBAAQ,IAAI,wCAAwC;AACpD,iBAAOA,cAAa,EAAE,OAAO,iCAAiC,GAAG,GAAG;AAAA,QACtE;AAGA,cAAM,WAAW,MAAM,4BAA4B,KAAK,MAAM;AAE9D,YAAI,CAAC,UAAU,aAAa;AAC1B,kBAAQ,IAAI,4DAA4D,MAAM;AAC9E,iBAAOA,cAAa,EAAE,OAAO,kCAAkC,GAAG,GAAG;AAAA,QACvE;AAGA,YAAI;AAEF,kBAAQ,IAAI,wDAAwD,MAAM;AAE1E,gBAAM,kBAAkB,MAAM,MAAM,4BAA4B,MAAM,IAAI;AAAA,YACxE,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,iBAAiB,UAAU,SAAS,WAAW;AAAA,YACjD;AAAA,UACF,CAAC;AAED,cAAI,CAAC,gBAAgB,IAAI;AACvB,kBAAM,QAAQ,MAAM,gBAAgB,KAAK;AACzC,oBAAQ,MAAM,8CAA8C;AAAA,cAC1D;AAAA,cACA,QAAQ,gBAAgB;AAAA,cACxB;AAAA,YACF,CAAC;AACD,mBAAOA,cAAa,EAAE,OAAO,6BAA6B,GAAG,gBAAgB,MAAM;AAAA,UACrF;AAEA,gBAAM,cAAc,MAAM,gBAAgB,KAAK;AAC/C,gBAAM,aAAa,YAAY,SAAS;AAExC,kBAAQ,IAAI,0CAA0C;AAAA,YACpD;AAAA,YACA,eAAe,CAAC,CAAC;AAAA,UACnB,CAAC;AAED,cAAI,CAAC,YAAY;AACf,oBAAQ,MAAM,oDAAoD;AAClE,mBAAOA,cAAa,EAAE,OAAO,iCAAiC,GAAG,GAAG;AAAA,UACtE;AAGA,gBAAM,kBAAkB;AAAA,YACtB,MAAM;AAAA,YACN,aAAa;AAAA,cACX,MAAM;AAAA,cACN,QAAQ;AAAA,YACV;AAAA,UACF;AAEA,kBAAQ,IAAI,0DAA0D;AAAA,YACpE;AAAA,YACA;AAAA,YACA,SAAS;AAAA,UACX,CAAC;AAED,gBAAM,mBAAmB,MAAM,MAAM,YAAY;AAAA,YAC/C,QAAQ;AAAA,YACR,SAAS;AAAA,cACP,gBAAgB;AAAA,YAClB;AAAA,YACA,MAAM,KAAK,UAAU,eAAe;AAAA,UACtC,CAAC;AAED,cAAI,CAAC,iBAAiB,IAAI;AACxB,kBAAM,QAAQ,MAAM,iBAAiB,KAAK;AAC1C,oBAAQ,MAAM,2CAA2C;AAAA,cACvD;AAAA,cACA;AAAA,cACA,QAAQ,iBAAiB;AAAA,cACzB;AAAA,YACF,CAAC;AACD,mBAAOA,cAAa,EAAE,OAAO,0BAA0B,GAAG,iBAAiB,MAAM;AAAA,UACnF;AAEA,kBAAQ,IAAI,iDAAiD;AAAA,YAC3D;AAAA,YACA;AAAA,UACF,CAAC;AAED,iBAAOA,cAAa,EAAE,SAAS,MAAM,SAAS,gCAAgC,CAAC;AAAA,QACjF,SAAS,OAAO;AACd,kBAAQ,MAAM,2CAA2C;AAAA,YACvD;AAAA,YACA;AAAA,YACA,OAAO,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AAAA,UAC9D,CAAC;AACD,iBAAOA,cAAa,EAAE,OAAO,0BAA0B,GAAG,GAAG;AAAA,QAC/D;AAAA,MACF;AAGA,UAAI,IAAI,aAAa,0BAA0B,QAAQ,WAAW,OAAO;AACvE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAEhE,cAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,KAAK;AAC7D,cAAM,SAAS,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK,GAAG;AAC7D,cAAM,OAAO,KAAK,MAAM,SAAS,KAAK,IAAI;AAG1C,cAAM,QAAQ,IAAI,aAAa,IAAI,KAAK;AAGxC,YAAI,SAAS,KAAK;AAChB,gBAAM,SAAS,MAAM,MAAM,uBAAuB,eAAe;AACjE,cAAI,QAAQ;AACV,oBAAQ,IAAI,uCAAuC,eAAe,EAAE;AACpE,mBAAOA,cAAa,MAAM;AAAA,UAC5B;AAAA,QACF;AAEA,gBAAQ,IAAI,wCAAwC,eAAe,EAAE;AAIrE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QA6BF,EAAE,KAAK,iBAAiB,OAAO,MAAM,EAAE,IAAI;AAG3C,cAAM,YAAY,MAAM,IAAI,GAAG;AAAA,UAC7B;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAGrB,cAAM,2BAA2B,wBAAC,UAAkB;AAClD,gBAAM,eAAe;AAAA,YACnB;AAAA,cACE,WAAW;AAAA,cACX,UAAU;AAAA,cACV,SAAS;AAAA,cACT,MAAM;AAAA,cACN,OAAO;AAAA,cACP,KAAK;AAAA,cACL,YAAY;AAAA,cACZ,QAAQ;AAAA,cACR,KAAK;AAAA,cACL,QAAQ,CAAC;AAAA,gBACP,OAAO;AAAA,gBACP,SAAS;AAAA,gBACT,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,gBAAgB;AAAA,gBAChB,qBAAqB;AAAA,cACvB,CAAC;AAAA,cACD,MAAM;AAAA,gBACJ,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,iBAAiB;AAAA,gBACjB,eAAe;AAAA,gBACf,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,KAAK;AAAA,cACP;AAAA,cACA,YAAY,CAAC;AAAA,gBACX,cAAc;AAAA,gBACd,OAAO;AAAA,gBACP,gBAAgB;AAAA,gBAChB,WAAW;AAAA,gBACX,UAAU;AAAA,gBACV,OAAO;AAAA,gBACP,UAAU;AAAA,gBACV,YAAY;AAAA,cACd,CAAC;AAAA,YACH;AAAA,YACA;AAAA,cACE,WAAW;AAAA,cACX,UAAU;AAAA,cACV,SAAS;AAAA,cACT,MAAM;AAAA,cACN,OAAO;AAAA,cACP,KAAK;AAAA,cACL,YAAY;AAAA,cACZ,QAAQ;AAAA,cACR,KAAK;AAAA,cACL,QAAQ,CAAC;AAAA,gBACP,OAAO;AAAA,gBACP,SAAS;AAAA,gBACT,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,gBAAgB;AAAA,gBAChB,qBAAqB;AAAA,cACvB,CAAC;AAAA,cACD,MAAM;AAAA,gBACJ,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,iBAAiB;AAAA,gBACjB,eAAe;AAAA,gBACf,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,KAAK;AAAA,cACP;AAAA,cACA,YAAY,CAAC;AAAA,gBACX,cAAc;AAAA,gBACd,OAAO;AAAA,gBACP,gBAAgB;AAAA,gBAChB,WAAW;AAAA,gBACX,UAAU;AAAA,gBACV,OAAO;AAAA,gBACP,UAAU;AAAA,gBACV,YAAY;AAAA,cACd,CAAC;AAAA,YACH;AAAA,YACA;AAAA,cACE,WAAW;AAAA,cACX,UAAU;AAAA,cACV,SAAS;AAAA,cACT,MAAM;AAAA,cACN,OAAO;AAAA,cACP,KAAK;AAAA,cACL,YAAY;AAAA,cACZ,QAAQ;AAAA,cACR,KAAK;AAAA,cACL,QAAQ,CAAC;AAAA,gBACP,OAAO;AAAA,gBACP,SAAS;AAAA,gBACT,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,gBAAgB;AAAA,gBAChB,qBAAqB;AAAA,cACvB,CAAC;AAAA,cACD,MAAM;AAAA,gBACJ,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,aAAa;AAAA,gBACb,iBAAiB;AAAA,gBACjB,eAAe;AAAA,gBACf,WAAW;AAAA,gBACX,WAAW;AAAA,gBACX,KAAK;AAAA,cACP;AAAA,cACA,YAAY,CAAC;AAAA,gBACX,cAAc;AAAA,gBACd,OAAO;AAAA,gBACP,gBAAgB;AAAA,gBAChB,WAAW;AAAA,gBACX,UAAU;AAAA,gBACV,OAAO;AAAA,gBACP,UAAU;AAAA,gBACV,YAAY;AAAA,cACd,CAAC;AAAA,YACH;AAAA,UACF;AAEA,iBAAO;AAAA,YACL,YAAY,CAAC,aAAa,QAAQ,aAAa,MAAM,CAAC;AAAA,UACxD;AAAA,QACF,GA5HiC;AA+HjC,cAAM,iBAAiB,WAAW,CAAC,GAAG,IAAI,CAAC,KAAU,UAAkB;AACrE,cAAI,eAAe,IAAI,gBAAgB,KAAK,MAAM,IAAI,aAAa,IAAI;AAGvE,cAAI,WAAW,UAAU,+BAA+B,CAAC,cAAc;AACrE,2BAAe,yBAAyB,KAAK;AAAA,UAC/C;AAGA,cAAI,oBAAoB,CAAC;AACzB,cAAI,IAAI,aAAa;AACnB,kBAAM,aAAa,KAAK,MAAM,IAAI,WAAW;AAC7C,kBAAM,WAAW,YAAY,SAAS,YAAY,CAAC;AACnD,kBAAM,WAAW,YAAY,SAAS,YAAY,CAAC;AACnD,gCAAoB,UAAU,qBAAqB,UAAU,qBAAqB,CAAC;AAAA,UACrF;AAEA,iBAAO;AAAA,YACL,GAAG;AAAA,YACH,iBAAiB,IAAI,kBAAkB,KAAK,MAAM,IAAI,eAAe,IAAI;AAAA,YACzE,aAAa,IAAI,cAAc,KAAK,MAAM,IAAI,WAAW,IAAI;AAAA,YAC7D,eAAe;AAAA,YACf,oBAAoB;AAAA,UACtB;AAAA,QACF,CAAC;AAGD,cAAM,aAAa,cAAc;AACjC,cAAM,gBAAgB,cAAc,OAAO,UAAQ,KAAK,aAAa,EAAE;AACvE,cAAM,gBAAgB,aAAa,IAC/B,cAAc,OAAO,CAAC,KAAK,SAAS,MAAM,IAAI,CAAC,IAAI,aACnD;AAEJ,cAAM,qBAAqB,cAAc,OAAO,CAAC,KAAK,SAAS;AAC7D,cAAI,KAAK,MAAM,KAAK,IAAI,KAAK,MAAM,KAAK,KAAK;AAC7C,iBAAO;AAAA,QACT,GAAG,CAAC,CAA2B;AAE/B,cAAM,cAAc;AAAA,UAClB,OAAO;AAAA,UACP,OAAO;AAAA,YACL;AAAA,YACA;AAAA,YACA,eAAe,KAAK,MAAM,aAAa;AAAA,YACvC,oBAAoB,OAAO,QAAQ,kBAAkB,EAAE,IAAI,CAAC,CAAC,QAAQ,KAAK,OAAO;AAAA,cAC/E;AAAA,cACA;AAAA,YACF,EAAE;AAAA,UACJ;AAAA,QACF;AAGA,YAAI,SAAS,KAAK;AAEhB,gBAAM,MAAM,mBAAmB,iBAAiB,aAAa,UAAU,cAAc;AAAA,QACvF;AAEA,eAAOA,cAAa,WAAW;AAAA,MACjC;AAGA,UAAI,IAAI,aAAa,uBAAuB,QAAQ,WAAW,OAAO;AACpE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,EAAE,gBAAgB,IAAI,MAAM,mBAAmB,KAAK,MAAM;AAGhE,cAAM,EAAE,QAAQ,IAAI,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,QAeF,EAAE,KAAK,eAAe,EAAE,IAAI;AAG5B,cAAM,gBAAgB,WAAW,CAAC,GAAG,IAAI,CAAC,QAAa;AACrD,cAAI;AACF,kBAAM,aAAa,IAAI,cAAc,KAAK,MAAM,IAAI,WAAW,IAAI;AACnE,kBAAM,oBAAoB,YAAY,SAAS,UAAU,qBAChC,YAAY,SAAS,UAAU,qBAAqB,CAAC;AAG9E,gBAAI,kBAAkB;AACtB,gBAAI,kBAAkB;AACtB,gBAAI,eAAe;AACnB,gBAAI,YAAY;AAChB,gBAAI,qBAAqB;AACzB,gBAAI,qBAAqB;AACzB,gBAAI,cAAc;AAClB,gBAAI,UAAU;AAGd,mBAAO,QAAQ,iBAAiB,EAAE,QAAQ,CAAC,CAAC,KAAK,KAAK,MAAqB;AACzE,kBAAI,OAAO,UAAU,YAAY,UAAU,QAAQ,UAAU,SAAS,YAAY,OAAO;AACvF,sBAAM,OAAO,MAAM,KAAK,YAAY;AACpC,sBAAM,SAAS,MAAM;AAErB,oBAAI,KAAK,SAAS,kBAAkB,KAAK,KAAK,SAAS,iBAAiB,GAAG;AACzE,oCAAkB;AAAA,gBACpB,WAAW,KAAK,SAAS,kBAAkB,KAAK,KAAK,SAAS,iBAAiB,GAAG;AAChF,oCAAkB;AAAA,gBACpB,WAAW,KAAK,SAAS,eAAe,KAAK,KAAK,SAAS,cAAc,GAAG;AAC1E,iCAAe,OAAO,WAAW,WAAW,SAAS,SAAS,MAAM;AAAA,gBACtE,WAAW,KAAK,SAAS,YAAY,KAAK,KAAK,SAAS,WAAW,GAAG;AACpE,8BAAY;AAAA,gBACd,WAAW,KAAK,SAAS,qBAAqB,KAAK,KAAK,SAAS,oBAAoB,GAAG;AACtF,uCAAqB,OAAO,WAAW,YAAY,SAAS,WAAW;AAAA,gBACzE,WAAW,KAAK,SAAS,qBAAqB,KAAK,KAAK,SAAS,oBAAoB,GAAG;AACtF,uCAAqB,OAAO,WAAW,YAAY,SAAS,WAAW;AAAA,gBACzE,WAAW,KAAK,SAAS,cAAc,KAAK,KAAK,SAAS,aAAa,KAAK,KAAK,SAAS,SAAS,GAAG;AACpG,gCAAc;AAAA,gBAChB,WAAW,KAAK,SAAS,SAAS,GAAG;AACnC,4BAAU;AAAA,gBACZ;AAAA,cACF;AAAA,YACF,CAAC;AAGD,gBAAI,IAAI,iBAAiB;AACvB,kBAAI;AACF,sBAAM,iBAAiB,KAAK,MAAM,IAAI,eAAe;AACrD,oBAAI,CAAC,SAAS;AACZ,4BAAU,gBAAgB,WAAW;AAAA,gBACvC;AACA,oBAAI,CAAC,iBAAiB;AACpB,oCAAkB,iBAAiB,kBAAkB,KACpC,iBAAiB,kBAAkB,KACnC,iBAAiB,iBAAiB,KAAK;AAAA,gBAC1D;AAAA,cACF,SAAS,GAAG;AAAA,cAEZ;AAAA,YACF;AAGA,kBAAM,cAAc,IAAI,mBAAmB,IAAI,gBAAgB;AAE/D,mBAAO;AAAA,cACL,IAAI,IAAI;AAAA,cACR,cAAc,IAAI;AAAA,cAClB,cAAc;AAAA,cACd,eAAe,IAAI;AAAA,cACnB,kBAAkB;AAAA,cAClB,kBAAkB;AAAA,cAClB,eAAe;AAAA,cACf,YAAY;AAAA,cACZ,qBAAqB;AAAA,cACrB,qBAAqB;AAAA,cACrB,cAAc;AAAA,cACd;AAAA,cACA,YAAY,IAAI;AAAA,YAClB;AAAA,UACF,SAAS,OAAO;AACd,oBAAQ,MAAM,mCAAmC,KAAK;AACtD,mBAAO;AAAA,UACT;AAAA,QACF,CAAC,EAAE,OAAO,CAAC,QAAa;AACtB,cAAI,CAAC,IAAK,QAAO;AACjB,cAAI,CAAC,IAAI,oBAAoB,CAAC,IAAI,aAAc,QAAO;AAGvD,cAAI,IAAI,kBAAkB;AACxB,gBAAI;AACF,oBAAM,kBAAkB,IAAI,KAAK,IAAI,gBAAgB;AACrD,oBAAM,QAAQ,oBAAI,KAAK;AACvB,oBAAM,SAAS,GAAG,GAAG,GAAG,CAAC;AAGzB,kBAAI,kBAAkB,OAAO;AAC3B,uBAAO;AAAA,cACT;AAAA,YACF,SAAS,GAAG;AAAA,YAEZ;AAAA,UACF;AAEA,iBAAO;AAAA,QACT,CAAC;AAED,eAAOA,cAAa,YAAY;AAAA,MAClC;AAGA,UAAI,IAAI,aAAa,6BAA6B,QAAQ,WAAW,QAAQ;AAC3E,cAAM,gBAAgB,MAAM,iBAAiB,SAAS,GAAG;AACzD,YAAI,CAAC,eAAe;AAClB,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAGA,cAAM,UAAU,MAAM,IAAI,GAAG;AAAA,UAC3B;AAAA,QACF,EAAE,KAAK,2BAA2B,EAAE,MAAM;AAE1C,YAAI,CAAC,SAAS;AACZ,iBAAOA,cAAa,EAAE,OAAO,yBAAyB,GAAG,GAAG;AAAA,QAC9D;AAEA,cAAM,SAAS,QAAQ;AAGvB,YAAI,UAAU,MAAM,IAAI,GAAG;AAAA,UACzB;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,SAAS;AACZ,gBAAM,YAAY,WAAW;AAC7B,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA,UACF,EAAE,KAAK,WAAW,QAAQ,2DAA2D,SAAS,IAAI,gBAAgB,KAAK,IAAI,GAAG,KAAK,IAAI,CAAC,EAAE,IAAI;AAC9I,oBAAU,EAAE,IAAI,UAAU;AAAA,QAC5B;AAEA,cAAM,YAAY,KAAK,IAAI;AAC3B,cAAM,YAAY;AAAA,UAChB;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB,IAAI,KAAK,KAAK,IAAI,IAAI,IAAI,KAAQ,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAAA,YAC/E,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB,IAAI,KAAK,KAAK,IAAI,IAAI,IAAI,KAAQ,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAAA,YAC/E,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB,IAAI,KAAK,KAAK,IAAI,IAAI,IAAI,KAAQ,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAAA,YAC/E,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB;AAAA,YACjB,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,UACA;AAAA,YACE,IAAI,cAAc;AAAA,YAClB,MAAM;AAAA,YACN,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,SAAS;AAAA,YACT,SAAS;AAAA,YACT,YAAY;AAAA,YACZ,iBAAiB,IAAI,KAAK,KAAK,IAAI,IAAI,IAAI,KAAQ,EAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC;AAAA,YAC/E,iBAAiB;AAAA,YACjB,UAAU;AAAA,UACZ;AAAA,QACF;AAGA,mBAAW,QAAQ,WAAW;AAC5B,gBAAM,gBAAgB,YAAa,KAAK,WAAW;AACnD,gBAAM,aAAa,KAAK,UAAU;AAAA,YAChC,SAAS;AAAA,cACP,UAAU;AAAA,gBACR,YAAY,KAAK;AAAA,cACnB;AAAA,YACF;AAAA,UACF,CAAC;AAED,gBAAM,IAAI,GAAG;AAAA,YACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAOF,EAAE;AAAA,YACA,KAAK;AAAA,YACL,QAAQ;AAAA,YACR;AAAA,YACA,KAAK;AAAA,YACL;AAAA,YACA,KAAK;AAAA,YACL;AAAA;AAAA,YACA;AAAA,YACA,KAAK;AAAA,YACL,KAAK;AAAA,YACL,KAAK;AAAA,YACL,KAAK;AAAA,YACL;AAAA,YACA,KAAK,MAAM,gBAAgB,GAAI;AAAA,YAC/B,KAAK;AAAA,YACL;AAAA,YACA,KAAK;AAAA,YACL,KAAK;AAAA,YACL,KAAK,kBAAkB,iBAAiB;AAAA,YACxC;AAAA,YACA;AAAA,YACA,KAAK,MAAM,gBAAgB,GAAI;AAAA,UACjC,EAAE,IAAI;AAAA,QACR;AAGA,cAAM,QAAQ,IAAI,aAAa,IAAI,KAAK;AACxC,cAAM,MAAM,oBAAoB,MAAM;AAEtC,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,SAAS,WAAW,UAAU,MAAM;AAAA,UACpC,cAAc,UAAU;AAAA,QAC1B,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,sBAAsB,QAAQ,WAAW,OAAO;AACnE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,QAAQ,IAAI,aAAa,IAAI,KAAK;AACxC,cAAM,QAAQ,MAAM,MAAM,cAAc;AAExC,eAAOA,cAAa;AAAA,UAClB,GAAG;AAAA,UACH,KAAK;AAAA,YACH,YAAY,UAAU;AAAA,YACtB,aAAa,UAAU;AAAA,YACvB,gBAAgB,UAAU;AAAA,YAC1B,eAAe,UAAU;AAAA,YACzB,cAAc,UAAU;AAAA,UAC1B;AAAA,QACF,CAAC;AAAA,MACH;AAOA,YAAM,mBAAmB,8BAAO,WAA4C;AAC1E,YAAI,CAAC,OAAQ,QAAO;AAGpB,cAAM,OAAO,MAAM,IAAI,GAAG;AAAA,UACxB;AAAA,QACF,EAAE,KAAK,MAAM,EAAE,MAAM;AAErB,YAAI,CAAC,QAAQ,CAAC,KAAK,MAAO,QAAO;AAKjC,cAAM,cAAc,4BAA4B,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC;AAC5E,eAAO,YAAY;AAAA,UAAK,gBACtB,KAAK,MAAM,YAAY,MAAM,WAAW,YAAY,KACpD,KAAK,MAAM,YAAY,EAAE,SAAS,WAAW,YAAY,CAAC;AAAA,QAC5D;AAAA,MACF,GAlByB;AAqBzB,UAAI,IAAI,aAAa,0BAA0B,QAAQ,WAAW,OAAO;AACvE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,UAAU,MAAM,iBAAiB,MAAM;AAC7C,YAAI,CAAC,SAAS;AACZ,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAGA,cAAM,aAAa,MAAM,IAAI,GAAG,QAAQ,qCAAqC,EAAE,MAAM;AACrF,cAAM,aAAa,MAAM,IAAI,GAAG,QAAQ,6CAA6C,EAAE,MAAM;AAC7F,cAAM,gBAAgB,MAAM,IAAI,GAAG,QAAQ,wCAAwC,EAAE,MAAM;AAC3F,cAAM,cAAc,MAAM,IAAI,GAAG,QAAQ,4CAA4C,EAAE,MAAM;AAG7F,cAAM,cAAc,MAAM,IAAI,GAAG;AAAA,UAC/B;AAAA,QACF,EAAE,IAAI;AAEN,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM;AAAA,YACJ,UAAU;AAAA,cACR,YAAY,YAAY,SAAS;AAAA,cACjC,YAAY,YAAY,SAAS;AAAA,cACjC,eAAe,eAAe,SAAS;AAAA,cACvC,aAAa,aAAa,SAAS;AAAA,YACrC;AAAA,YACA,cAAc,YAAY,WAAW,CAAC,GAAG,IAAI,CAAC,OAAY;AAAA,cACxD,IAAI,EAAE;AAAA,cACN,OAAO,EAAE;AAAA,cACT,MAAM,EAAE;AAAA,cACR,YAAY,EAAE;AAAA,cACd,eAAe,EAAE;AAAA,YACnB,EAAE;AAAA,UACJ;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,sBAAsB,QAAQ,WAAW,OAAO;AACnE,cAAM,SAAS,MAAM,iBAAiB,SAAS,GAAG;AAClD,YAAI,CAAC,QAAQ;AACX,iBAAOA,cAAa,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,QACpD;AAEA,cAAM,UAAU,MAAM,iBAAiB,MAAM;AAC7C,YAAI,CAAC,SAAS;AACZ,iBAAOA,cAAa,EAAE,OAAO,wBAAwB,GAAG,GAAG;AAAA,QAC7D;AAEA,cAAM,QAAQ,MAAM,IAAI,GAAG;AAAA,UACzB;AAAA,QACF,EAAE,IAAI;AAEN,eAAOA,cAAa;AAAA,UAClB,SAAS;AAAA,UACT,MAAM,MAAM,WAAW,CAAC;AAAA,QAC1B,CAAC;AAAA,MACH;AAOA,UAAI,IAAI,aAAa,kCAAkC,QAAQ,WAAW,OAAO;AAC/E,cAAM,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA6uBjB,eAAO,IAAI,SAAS,UAAU;AAAA,UAC5B,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,YAChB,GAAG;AAAA,UACL;AAAA,QACF,CAAC;AAAA,MACH;AAGA,UAAI,IAAI,aAAa,uCAAuC,QAAQ,WAAW,OAAO;AACpF,cAAM,cAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA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",
  "names": ["now", "now", "generateId", "now", "corsHeaders", "OAUTH_CALLBACK_URL", "buildAuthUrl", "exchangeCodeForToken", "OAUTH_CALLBACK_URL", "buildAuthUrl", "exchangeCodeForToken", "refreshAccessToken", "ensureValidToken", "now", "jsonResponse", "now", "wsSettings", "buildAuthUrl", "exchangeCodeForToken", "assistants", "customerNumber", "twilioData", "cache"]
}
